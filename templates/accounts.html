<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <title>ğŸ“’ Ø¯Ù„ÙŠÙ„ Ø§Ù„Ø­Ø³Ø§Ø¨Ø§Øª</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <style>
    :root {
      --bg1:#0d6efd;
      --bg2:#6c63ff;
      --card:#ffffff;
      --ink:#111827;
      --muted:#6b7280;
      --border:#e5e7eb;
      --accent:#0d6efd;
      --danger:#dc2626;
      --success:#16a34a;
    }

    * { box-sizing: border-box; }

    body {
      margin: 0;
      min-height: 100vh;
      font-family: "Tajawal", system-ui, -apple-system, "Segoe UI", sans-serif;
      background: linear-gradient(135deg, var(--bg1), var(--bg2));
      color: var(--ink);
      display: flex;
      justify-content: center;
      padding: 16px;
    }

    .container {
      width: 100%;
      max-width: 1100px;
      background: radial-gradient(circle at top left, rgba(255,255,255,0.35), transparent 55%),
                  radial-gradient(circle at bottom right, rgba(15,23,42,0.35), transparent 55%),
                  #0b1120;
      border-radius: 18px;
      padding: 20px;
      box-shadow: 0 20px 60px rgba(0,0,0,0.35);
      color: #f9fafb;
    }

    .header {
      display: flex;
      flex-wrap: wrap;
      align-items: center;
      justify-content: space-between;
      gap: 12px;
      margin-bottom: 18px;
    }

    .title-group h1 {
      margin: 0;
      font-size: 1.6rem;
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .title-group p {
      margin: 4px 0 0;
      font-size: 0.9rem;
      color: #e5e7eb;
    }

    .btn-back {
      padding: 8px 14px;
      border-radius: 999px;
      border: 1px solid rgba(148,163,184,0.6);
      background: rgba(15,23,42,0.85);
      color: #e5e7eb;
      cursor: pointer;
      font-size: 0.9rem;
      display: inline-flex;
      align-items: center;
      gap: 6px;
      transition: 0.2s ease;
      text-decoration: none;
    }

    .btn-back:hover {
      background: rgba(15,23,42,1);
      transform: translateY(-1px);
    }

    .layout {
      display: grid;
      grid-template-columns: minmax(0, 1.1fr) minmax(0, 1.4fr);
      gap: 18px;
    }

    @media (max-width: 900px) {
      .layout {
        grid-template-columns: 1fr;
      }
    }

    .card {
      background: rgba(15,23,42,0.92);
      border-radius: 14px;
      padding: 16px 16px 14px;
      border: 1px solid rgba(148,163,184,0.4);
      box-shadow: 0 10px 30px rgba(0,0,0,0.4);
    }

    .card-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 10px;
      gap: 10px;
    }

    .card-header h2 {
      margin: 0;
      font-size: 1rem;
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .card-header span.badge {
      padding: 3px 9px;
      border-radius: 999px;
      font-size: 0.75rem;
      background: rgba(37,99,235,0.12);
      border: 1px solid rgba(59,130,246,0.4);
      color: #dbeafe;
    }

    .card-body {
      font-size: 0.9rem;
    }

    label {
      display: block;
      margin-bottom: 4px;
      font-size: 0.85rem;
      color: #e5e7eb;
    }

    .field {
      margin-bottom: 10px;
    }

    input[type="text"],
    select {
      width: 100%;
      padding: 7px 9px;
      border-radius: 9px;
      border: 1px solid rgba(148,163,184,0.6);
      background: rgba(15,23,42,0.9);
      color: #f9fafb;
      font-size: 0.9rem;
      outline: none;
      transition: 0.15s ease;
    }

    input[type="text"]:focus,
    select:focus {
      border-color: var(--accent);
      box-shadow: 0 0 0 1px rgba(37,99,235,0.4);
    }

    .hint {
      font-size: 0.78rem;
      color: #9ca3af;
    }

    .field-inline {
      display: grid;
      grid-template-columns: repeat(2, minmax(0, 1fr));
      gap: 10px;
    }

    @media (max-width: 600px) {
      .field-inline {
        grid-template-columns: 1fr;
      }
    }

    .actions {
      margin-top: 8px;
      display: flex;
      justify-content: flex-start;
      gap: 8px;
      flex-wrap: wrap;
    }

    .btn {
      border-radius: 999px;
      padding: 7px 14px;
      font-size: 0.85rem;
      border: none;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      gap: 6px;
      transition: 0.15s ease;
    }

    .btn-primary {
      background: linear-gradient(135deg, #2563eb, #4f46e5);
      color: white;
      box-shadow: 0 8px 20px rgba(37,99,235,0.4);
    }

    .btn-primary:hover {
      filter: brightness(1.08);
      transform: translateY(-1px);
    }

    .btn-ghost {
      background: transparent;
      color: #e5e7eb;
      border: 1px solid rgba(148,163,184,0.7);
    }

    .btn-ghost:hover {
      background: rgba(15,23,42,0.9);
    }

    .message {
      margin-top: 8px;
      font-size: 0.8rem;
      padding: 6px 9px;
      border-radius: 9px;
      display: none;
    }

    .message.error {
      background: rgba(220,38,38,0.08);
      border: 1px solid rgba(220,38,38,0.8);
      color: #fecaca;
    }

    .message.success {
      background: rgba(22,163,74,0.08);
      border: 1px solid rgba(22,163,74,0.8);
      color: #bbf7d0;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      font-size: 0.85rem;
    }

    thead {
      background: rgba(15,23,42,0.95);
    }

    th, td {
      padding: 6px 8px;
      border-bottom: 1px solid rgba(55,65,81,0.7);
      text-align: right;
      white-space: nowrap;
    }

    th {
      font-weight: 600;
      color: #e5e7eb;
      font-size: 0.8rem;
    }

    tbody tr:nth-child(odd) {
      background: rgba(15,23,42,0.75);
    }

    tbody tr:nth-child(even) {
      background: rgba(15,23,42,0.55);
    }

    tbody tr:hover {
      background: rgba(37,99,235,0.22);
    }

    .pill-type {
      padding: 2px 8px;
      border-radius: 999px;
      font-size: 0.75rem;
      border: 1px solid rgba(148,163,184,0.7);
      color: #e5e7eb;
    }

    .pill-type.asset { border-color:#22c55e; color:#bbf7d0; }
    .pill-type.liability { border-color:#f97316; color:#fed7aa; }
    .pill-type.revenue { border-color:#38bdf8; color:#bae6fd; }
    .pill-type.expense { border-color:#f97373; color:#fecaca; }

    .pill-struct {
      padding: 2px 8px;
      border-radius: 999px;
      font-size: 0.75rem;
      border: 1px solid rgba(148,163,184,0.7);
      color: #e5e7eb;
    }

    .pill-struct.group {
      border-color:#eab308;
      color:#fef9c3;
    }

    .pill-struct.detail {
      border-color:#a855f7;
      color:#e9d5ff;
    }

    .tree-name {
      font-family: inherit;
      font-size: 0.85rem;
    }

    .tree-indent {
      opacity: 0.7;
      font-size: 0.78rem;
    }

    .empty-state {
      text-align: center;
      padding: 12px 4px;
      font-size: 0.85rem;
      color: #9ca3af;
    }

    .badge-count {
      font-size: 0.8rem;
      color: #9ca3af;
    }
  </style>
</head>

<body>
  <div class="container">
    <!-- Header -->
    <div class="header">
      <div class="title-group">
        <h1>ğŸ“’ Ø¯Ù„ÙŠÙ„ Ø§Ù„Ø­Ø³Ø§Ø¨Ø§Øª</h1>
        <p>
          Ø¥Ø¹Ø¯Ø§Ø¯ Ø´Ø¬Ø±Ø© Ø§Ù„Ø­Ø³Ø§Ø¨Ø§Øª: Ø£ØµÙˆÙ„ / Ø§Ù„ØªØ²Ø§Ù…Ø§Øª / Ø¥ÙŠØ±Ø§Ø¯ / Ù…ØµØ±ÙˆÙØ§ØªØŒ Ù…Ø¹ Ø¥Ù…ÙƒØ§Ù†ÙŠØ© Ø¥Ø¶Ø§ÙØ© Ø­Ø³Ø§Ø¨Ø§Øª ÙØ±Ø¹ÙŠØ© Ù…Ø«Ù„ Ø­Ø³Ø§Ø¨Ø§Øª Ø§Ù„Ø³Ø§Ø¦Ù‚ÙŠÙ†.
        </p>
      </div>
      <a href="/" class="btn-back">
        <span>ğŸ </span>
        <span>Ø§Ù„Ø±Ø¬ÙˆØ¹ Ù„Ù„ÙˆØ­Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</span>
      </a>
    </div>

    <div class="layout">
      <!-- Form card -->
      <div class="card">
        <div class="card-header">
          <h2>â• Ø¥Ø¶Ø§ÙØ© / Ø¨Ù†Ø§Ø¡ Ø­Ø³Ø§Ø¨ Ø¬Ø¯ÙŠØ¯</h2>
          <span class="badge">Ø´Ø¬Ø±Ø© Ø§Ù„Ø­Ø³Ø§Ø¨Ø§Øª</span>
        </div>
        <div class="card-body">
          <form id="accountForm">
            <div class="field">
              <label for="accName">Ø§Ø³Ù… Ø§Ù„Ø­Ø³Ø§Ø¨</label>
              <input id="accName" type="text" placeholder="Ù…Ø«Ø§Ù„: Ø§Ù„Ø£ØµÙˆÙ„ / Ø­Ø³Ø§Ø¨Ø§Øª Ø§Ù„Ø³Ø§Ø¦Ù‚ÙŠÙ† / Ø³Ø§Ø¦Ù‚: Ø£Ø­Ù…Ø¯ Ø¹Ù„ÙŠ" />
              <div class="hint">Ù‡Ø°Ø§ Ø§Ù„Ø§Ø³Ù… Ø³ÙŠØ¸Ù‡Ø± ÙÙŠ Ø§Ù„ÙŠÙˆÙ…ÙŠØ© ÙˆØ¯ÙØªØ± Ø§Ù„Ø£Ø³ØªØ§Ø° ÙƒÙ…Ø§ Ù‡Ùˆ.</div>
            </div>

            <div class="field">
              <label for="accType">Ø§Ù„Ù†ÙˆØ¹ Ø§Ù„Ù…Ø­Ø§Ø³Ø¨ÙŠ (ØªØµÙ†ÙŠÙ Ø§Ù„Ù‚ÙˆØ§Ø¦Ù…)</label>
              <select id="accType">
                <option value="">Ø§Ø®ØªØ± Ù†ÙˆØ¹ Ø§Ù„Ø­Ø³Ø§Ø¨</option>
                <option value="asset">Ø£ØµÙ„ (Asset)</option>
                <option value="liability">Ø§Ù„ØªØ²Ø§Ù… (Liability)</option>
                <option value="revenue">Ø¥ÙŠØ±Ø§Ø¯ (Revenue)</option>
                <option value="expense">Ù…ØµØ±ÙˆÙ (Expense)</option>
              </select>
              <div class="hint">Ù…Ø«Ø§Ù„: Ø§Ù„Ø£ØµÙˆÙ„ / Ø­Ø³Ø§Ø¨Ø§Øª Ø§Ù„Ø³Ø§Ø¦Ù‚ÙŠÙ† / Ø§Ù„ØµÙ†Ø¯ÙˆÙ‚ ÙƒÙ„Ù‡Ø§ Ù…Ù† Ù†ÙˆØ¹ Ø£ØµÙ„ (Asset).</div>
            </div>

            <div class="field-inline">
              <div class="field">
                <label for="parentAccount">Ø§Ù„Ø­Ø³Ø§Ø¨ Ø§Ù„Ø£Ø¨ (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)</label>
                <select id="parentAccount">
                  <option value="">Ø¨Ø¯ÙˆÙ† (Ø­Ø³Ø§Ø¨ Ù…Ù† Ø§Ù„Ù…Ø³ØªÙˆÙ‰ Ø§Ù„Ø£ÙˆÙ„)</option>
                </select>
                <div class="hint">
                  Ù…Ø«Ø§Ù„: &quot;Ø­Ø³Ø§Ø¨Ø§Øª Ø§Ù„Ø³Ø§Ø¦Ù‚ÙŠÙ†&quot; ÙŠÙƒÙˆÙ† Ø£Ø¨ Ù„Ù€ &quot;Ø³Ø§Ø¦Ù‚: Ø£Ø­Ù…Ø¯ Ø¹Ù„ÙŠ&quot;.
                </div>
              </div>

              <div class="field">
                <label for="isGroup">Ù‡ÙŠÙƒÙ„ Ø§Ù„Ø­Ø³Ø§Ø¨</label>
                <select id="isGroup">
                  <option value="">Ø§Ø®ØªØ± Ù†ÙˆØ¹ Ø§Ù„Ù‡ÙŠÙƒÙ„</option>
                  <option value="group">Ø­Ø³Ø§Ø¨ Ø±Ø¦ÙŠØ³ÙŠ / Ù…Ø¬Ù…ÙˆØ¹Ø© (Group)</option>
                  <option value="detail">Ø­Ø³Ø§Ø¨ ØªÙØµÙŠÙ„ÙŠ (Detail)</option>
                </select>
                <div class="hint">
                  Ø§Ù„Ø­Ø³Ø§Ø¨ Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠ ØªÙÙØªØ­ ØªØ­ØªÙ‡ Ø­Ø³Ø§Ø¨Ø§Øª ÙØ±Ø¹ÙŠØ©ØŒ Ø£Ù…Ø§ Ø§Ù„ØªÙØµÙŠÙ„ÙŠ ÙŠÙØ³ØªØ®Ø¯Ù… Ù…Ø¨Ø§Ø´Ø±Ø© ÙÙŠ Ø§Ù„Ù‚ÙŠÙˆØ¯.
                </div>
              </div>
            </div>

            <div class="actions">
              <button type="submit" class="btn btn-primary">
                ğŸ’¾ Ø­ÙØ¸ Ø§Ù„Ø­Ø³Ø§Ø¨
              </button>
              <button type="button" class="btn btn-ghost" id="btnReset">
                â™»ï¸ Ù…Ø³Ø­ Ø§Ù„Ø­Ù‚ÙˆÙ„
              </button>
            </div>

            <div id="formMessage" class="message"></div>
          </form>
        </div>
      </div>

      <!-- Table card -->
      <div class="card">
        <div class="card-header">
          <h2>ğŸ“‹ Ø´Ø¬Ø±Ø© Ø§Ù„Ø­Ø³Ø§Ø¨Ø§Øª</h2>
          <span class="badge-count" id="accountsCount">â€”</span>
        </div>
        <div class="card-body">
          <div style="max-height: 360px; overflow: auto; border-radius: 10px; border: 1px solid rgba(55,65,81,0.7);">
            <table>
              <thead>
                <tr>
                  <th>#</th>
                  <th>Ø§Ø³Ù… Ø§Ù„Ø­Ø³Ø§Ø¨ (Ù‡Ø±Ù…ÙŠ)</th>
                  <th>Ø§Ù„Ù†ÙˆØ¹ Ø§Ù„Ù…Ø­Ø§Ø³Ø¨ÙŠ</th>
                  <th>Ø§Ù„Ø­Ø³Ø§Ø¨ Ø§Ù„Ø£Ø¨</th>
                  <th>Ø§Ù„Ù‡ÙŠÙƒÙ„</th>
                  <th>ID Ø¯Ø§Ø®Ù„ÙŠ</th>
                </tr>
              </thead>
              <tbody id="accountsTableBody">
                <tr>
                  <td colspan="6" class="empty-state">
                    Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø­Ø³Ø§Ø¨Ø§Øª...
                  </td>
                </tr>
              </tbody>
            </table>
          </div>
          <div class="hint" style="margin-top:8px;">
            Ù…Ù„Ø§Ø­Ø¸Ø§Øª:
            <br/>â€¢ ÙŠÙØ¶Ù‘Ù„ ØªØ«Ø¨ÙŠØª Ø£Ø³Ù…Ø§Ø¡ Ø§Ù„Ø­Ø³Ø§Ø¨Ø§Øª Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ© Ù…Ø«Ù„ &quot;Ø§Ù„Ø£ØµÙˆÙ„&quot;ØŒ &quot;Ø§Ù„Ø§Ù„ØªØ²Ø§Ù…Ø§Øª&quot;ØŒ &quot;Ø¥ÙŠØ±Ø§Ø¯ Ø¥ÙŠØ¬Ø§Ø± Ø³ÙŠØ§Ø±Ø§Øª&quot;ØŒ &quot;Ø­Ø³Ø§Ø¨Ø§Øª Ø§Ù„Ø³Ø§Ø¦Ù‚ÙŠÙ†&quot;.
            <br/>â€¢ ÙŠÙ…ÙƒÙ†Ùƒ Ù„Ø§Ø­Ù‚Ù‹Ø§ Ø±Ø¨Ø· Ø­Ø³Ø§Ø¨Ø§Øª Ø§Ù„Ø³Ø§Ø¦Ù‚ÙŠÙ† Ø§Ù„ÙØ±Ø¹ÙŠØ© Ø¨Ø§Ù„Ø³Ø§Ø¦Ù‚ÙŠÙ† Ù…Ù† Ø´Ø§Ø´Ø© Ø§Ù„Ø³Ø§Ø¦Ù‚ÙŠÙ†.
          </div>
        </div>
      </div>
    </div>
  </div>

  <script>
    const form = document.getElementById("accountForm");
    const accNameInput = document.getElementById("accName");
    const accTypeSelect = document.getElementById("accType");
    const parentSelect = document.getElementById("parentAccount");
    const isGroupSelect = document.getElementById("isGroup");
    const formMessage = document.getElementById("formMessage");
    const resetBtn = document.getElementById("btnReset");
    const tableBody = document.getElementById("accountsTableBody");
    const accountsCount = document.getElementById("accountsCount");

    let accountsCache = [];

    function showMessage(text, type = "success") {
      formMessage.textContent = text;
      formMessage.className = "message " + type;
      formMessage.style.display = "block";
    }

    function clearMessage() {
      formMessage.textContent = "";
      formMessage.style.display = "none";
    }

    function typeLabel(type) {
      switch (type) {
        case "asset": return "Ø£ØµÙ„ (Asset)";
        case "liability": return "Ø§Ù„ØªØ²Ø§Ù… (Liability)";
        case "revenue": return "Ø¥ÙŠØ±Ø§Ø¯ (Revenue)";
        case "expense": return "Ù…ØµØ±ÙˆÙ (Expense)";
        default: return type || "ØºÙŠØ± Ù…Ø­Ø¯Ø¯";
      }
    }

    function typePillClass(type) {
      if (!type) return "pill-type";
      return "pill-type " + type;
    }

    function structLabel(is_group) {
      if (is_group === true) return "Ù…Ø¬Ù…ÙˆØ¹Ø© (Group)";
      if (is_group === false) return "ØªÙØµÙŠÙ„ÙŠ (Detail)";
      return "ØºÙŠØ± Ù…Ø­Ø¯Ø¯";
    }

    function structClass(is_group) {
      if (is_group === true) return "pill-struct group";
      if (is_group === false) return "pill-struct detail";
      return "pill-struct";
    }

    function buildAccountsMap(accounts) {
      const map = {};
      (accounts || []).forEach(acc => {
        map[acc.id] = acc;
      });
      return map;
    }

    function getDepth(acc, map, maxDepth = 5) {
      let depth = 0;
      let current = acc;
      while (current && current.parent_id && depth < maxDepth) {
        current = map[current.parent_id];
        depth++;
      }
      return depth;
    }

    function formatTreeName(acc, depth) {
      const indentUnits = "&nbsp;&nbsp;&nbsp;".repeat(depth);
      const branch = depth > 0 ? "<span class='tree-indent'>â†³</span>&nbsp;" : "";
      return `<span class="tree-name">${indentUnits}${branch}${acc.name}</span>`;
    }

    async function loadAccounts() {
      try {
        const res = await fetch("/api/accounts");
        if (!res.ok) {
          throw new Error("Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø­Ø³Ø§Ø¨Ø§Øª");
        }
        const data = await res.json();
        accountsCache = data || [];
        renderAccountsTable(accountsCache);
        fillParentSelect(accountsCache);
      } catch (err) {
        console.error(err);
        tableBody.innerHTML = `
          <tr>
            <td colspan="6" class="empty-state">
              âš ï¸ Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø­Ø³Ø§Ø¨Ø§ØªØŒ Ø­Ø§ÙˆÙ„ ØªØ­Ø¯ÙŠØ« Ø§Ù„ØµÙØ­Ø©.
            </td>
          </tr>
        `;
        accountsCount.textContent = "Ø®Ø·Ø£ ÙÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„";
      }
    }

    function fillParentSelect(accounts) {
      parentSelect.innerHTML = `<option value="">Ø¨Ø¯ÙˆÙ† (Ø­Ø³Ø§Ø¨ Ù…Ù† Ø§Ù„Ù…Ø³ØªÙˆÙ‰ Ø§Ù„Ø£ÙˆÙ„)</option>`;
      if (!accounts || accounts.length === 0) return;

      // ØªØ±ØªÙŠØ¨ Ø¨Ø³ÙŠØ· Ø­Ø³Ø¨ Ø§Ù„Ø§Ø³Ù… Ù„ØªØ³Ù‡ÙŠÙ„ Ø§Ù„Ø§Ø®ØªÙŠØ§Ø±
      const sorted = [...accounts].sort((a, b) => (a.name || "").localeCompare(b.name || "", "ar"));

      sorted.forEach(acc => {
        const opt = document.createElement("option");
        const typeText = acc.type ? ` - ${typeLabel(acc.type)}` : "";
        const groupText = acc.is_group ? " (Ù…Ø¬Ù…ÙˆØ¹Ø©)" : "";
        opt.value = acc.id;
        opt.innerText = `${acc.name}${typeText}${groupText}`;
        parentSelect.appendChild(opt);
      });
    }

    function renderAccountsTable(accounts) {
      if (!accounts || accounts.length === 0) {
        tableBody.innerHTML = `
          <tr>
            <td colspan="6" class="empty-state">
              Ù„Ø§ ØªÙˆØ¬Ø¯ Ø­Ø³Ø§Ø¨Ø§Øª Ù…Ø³Ø¬Ù‘ÙÙ„Ø© Ø­ØªÙ‰ Ø§Ù„Ø¢Ù†. Ø§Ø¨Ø¯Ø£ Ø¨Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø£ØµÙˆÙ„ / Ø§Ù„Ø§Ù„ØªØ²Ø§Ù…Ø§Øª / Ø§Ù„Ø¥ÙŠØ±Ø§Ø¯ / Ø§Ù„Ù…ØµØ±ÙˆÙØ§Øª ÙƒØ­Ø³Ø§Ø¨Ø§Øª Ø±Ø¦ÙŠØ³ÙŠØ©.
            </td>
          </tr>
        `;
        accountsCount.textContent = "0 Ø­Ø³Ø§Ø¨";
        return;
      }

      const map = buildAccountsMap(accounts);
      accountsCount.textContent = `${accounts.length} Ø­Ø³Ø§Ø¨/Ø­Ø³Ø§Ø¨Ø§Øª`;

      // Ù…Ù…ÙƒÙ† Ù†Ø±ØªÙ‘Ø¨ Ø§Ù„Ø­Ø³Ø§Ø¨Ø§Øª Ø¨Ø­ÙŠØ« Ø§Ù„Ø£Ø¨ ÙŠØ¸Ù‡Ø± Ù‚Ø¨Ù„ Ø§Ù„Ø£Ø¨Ù†Ø§Ø¡ (ØªÙ‚Ø±ÙŠØ¨Ù‹Ø§)
      const sorted = [...accounts].sort((a, b) => {
        const depthA = getDepth(a, map);
        const depthB = getDepth(b, map);
        if (depthA !== depthB) return depthA - depthB;
        return (a.name || "").localeCompare(b.name || "", "ar");
      });

      tableBody.innerHTML = "";
      sorted.forEach((acc, index) => {
        const depth = getDepth(acc, map);
        const parentName = acc.parent_id && map[acc.parent_id] ? map[acc.parent_id].name : " â€” ";

        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td>${index + 1}</td>
          <td>${formatTreeName(acc, depth)}</td>
          <td><span class="${typePillClass(acc.type)}">${typeLabel(acc.type)}</span></td>
          <td>${parentName}</td>
          <td><span class="${structClass(acc.is_group)}">${structLabel(acc.is_group)}</span></td>
          <td>${acc.id}</td>
        `;
        tableBody.appendChild(tr);
      });
    }

    form.addEventListener("submit", async (e) => {
      e.preventDefault();
      clearMessage();

      const name = accNameInput.value.trim();
      const type = accTypeSelect.value;
      let parent_id = parentSelect.value || null;
      const structValue = isGroupSelect.value;

      if (!name) {
        showMessage("Ø§Ø³Ù… Ø§Ù„Ø­Ø³Ø§Ø¨ Ù…Ø·Ù„ÙˆØ¨.", "error");
        return;
      }

      if (!type) {
        showMessage("Ù…Ù† ÙØ¶Ù„Ùƒ Ø§Ø®ØªØ± Ø§Ù„Ù†ÙˆØ¹ Ø§Ù„Ù…Ø­Ø§Ø³Ø¨ÙŠ Ù„Ù„Ø­Ø³Ø§Ø¨.", "error");
        return;
      }

      if (!structValue) {
        showMessage("Ù…Ù† ÙØ¶Ù„Ùƒ Ø§Ø®ØªØ± Ù‡Ù„ Ø§Ù„Ø­Ø³Ø§Ø¨ Ù…Ø¬Ù…ÙˆØ¹Ø© Ø£Ù… ØªÙØµÙŠÙ„ÙŠ.", "error");
        return;
      }

      if (parent_id) {
        parent_id = parseInt(parent_id, 10);
        if (Number.isNaN(parent_id)) {
          parent_id = null;
        }
      }

      let is_group = null;
      if (structValue === "group") is_group = true;
      else if (structValue === "detail") is_group = false;

      try {
        const res = await fetch("/api/accounts", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({
            name,
            type,
            parent_id,
            is_group
          })
        });

        const data = await res.json();

        if (!res.ok) {
          showMessage(data.error || "Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø­Ø³Ø§Ø¨.", "error");
          return;
        }

        showMessage("âœ… ØªÙ… Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø­Ø³Ø§Ø¨ Ø¨Ù†Ø¬Ø§Ø­.", "success");
        accNameInput.value = "";
        accTypeSelect.value = "";
        parentSelect.value = "";
        isGroupSelect.value = "";
        accNameInput.focus();
        await loadAccounts();
      } catch (err) {
        console.error(err);
        showMessage("âš ï¸ ØªØ¹Ø°Ø± Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø³ÙŠØ±ÙØ±ØŒ Ø­Ø§ÙˆÙ„ Ù…Ø±Ø© Ø£Ø®Ø±Ù‰.", "error");
      }
    });

    resetBtn.addEventListener("click", () => {
      accNameInput.value = "";
      accTypeSelect.value = "";
      parentSelect.value = "";
      isGroupSelect.value = "";
      clearMessage();
      accNameInput.focus();
    });

    // Ø£ÙˆÙ„ Ù…Ø§ Ø§Ù„ØµÙØ­Ø© ØªÙØªØ­
    loadAccounts();
  </script>
</body>
</html>
