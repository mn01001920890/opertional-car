<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>ğŸ‘¤ Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø³Ø§Ø¦Ù‚ÙŠÙ†</title>

  <style>
    :root {
      --main-blue: #0d6efd;
      --main-purple: #6c63ff;
      --card-radius: 14px;
      --shadow: 0 4px 12px rgba(0,0,0,0.25);
      --muted: #6b7280;
      --success: #16a34a;
      --danger: #dc2626;
    }

    * {
      box-sizing: border-box;
    }

    body {
      font-family: "Tajawal", system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      margin: 0;
      background: linear-gradient(135deg, var(--main-blue), var(--main-purple));
      color: #fff;
      min-height: 100vh;
    }

    /* ğŸ” Ø´Ø±ÙŠØ· Ø¹Ù„ÙˆÙŠ Ø«Ø§Ø¨Øª + Ø²Ø± Ø±Ø¬ÙˆØ¹ */
    .top-bar {
      position: fixed;
      top: 0;
      right: 0;
      left: 0;
      z-index: 1000;
      background: rgba(0, 0, 0, 0.25);
      backdrop-filter: blur(8px);
      padding: 10px 16px;
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .back-btn {
      border: none;
      border-radius: 999px;
      padding: 8px 16px;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      background: #fff;
      color: var(--main-blue);
      display: inline-flex;
      align-items: center;
      gap: 6px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.25);
      transition: 0.2s ease;
      white-space: nowrap;
    }

    .back-btn:hover {
      background: var(--main-blue);
      color: #fff;
      transform: translateY(-1px);
    }

    .page-title {
      margin: 0;
      font-size: 18px;
      font-weight: 700;
      flex: 1;
      text-align: center;
      color: #fff;
    }

    .top-right-actions {
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .small-link-btn {
      border: none;
      border-radius: 999px;
      padding: 7px 12px;
      font-size: 12px;
      font-weight: 600;
      cursor: pointer;
      background: rgba(255,255,255,0.14);
      color: #e5e7eb;
      transition: 0.2s ease;
      white-space: nowrap;
    }

    .small-link-btn:hover {
      background: rgba(255,255,255,0.26);
    }

    /* Ù…Ø­ØªÙˆÙ‰ Ø§Ù„ØµÙØ­Ø© */
    .page-content {
      max-width: 1150px;
      margin: 0 auto;
      padding: 80px 16px 24px; /* space Ø¹Ù„Ø´Ø§Ù† Ø§Ù„Ø´Ø±ÙŠØ· Ø§Ù„Ø«Ø§Ø¨Øª */
    }

    h2 {
      text-align: center;
      margin-bottom: 6px;
      font-size: 24px;
      color: #fff;
    }

    .subtitle {
      text-align: center;
      font-size: 14px;
      opacity: 0.9;
      margin-bottom: 16px;
    }

    /* Ø´Ø±ÙŠØ· Ø§Ù„Ø£Ø¯ÙˆØ§Øª: Ø¨Ø­Ø« + Ø¹Ø¯Ø§Ø¯ */
    .toolbar {
      margin-bottom: 12px;
    }

    .toolbar-card {
      background: rgba(255,255,255,0.96);
      color: #111827;
      border-radius: var(--card-radius);
      box-shadow: var(--shadow);
      padding: 10px 12px;
      display: flex;
      flex-wrap: wrap;
      align-items: center;
      gap: 10px;
    }

    .counter-pill {
      border-radius: 999px;
      padding: 6px 12px;
      background: #ecfdf3;
      color: #166534;
      font-size: 13px;
      font-weight: 700;
      display: inline-flex;
      align-items: center;
      gap: 6px;
      white-space: nowrap;
    }

    .search-group {
      display: flex;
      align-items: center;
      gap: 6px;
      flex: 1;
      min-width: 220px;
    }

    .search-input {
      width: 100%;
      border-radius: 999px;
      border: 1px solid #e5e7eb;
      padding: 7px 12px;
      font-size: 13px;
      outline: none;
      font-family: inherit;
    }

    .search-input:focus {
      border-color: var(--main-blue);
      box-shadow: 0 0 0 2px rgba(13,110,253,0.18);
    }

    .search-label {
      font-size: 12px;
      color: var(--muted);
      white-space: nowrap;
    }

    .badge {
      font-size: 11px;
      border-radius: 999px;
      padding: 4px 8px;
      background: #eff6ff;
      color: #1d4ed8;
      white-space: nowrap;
    }

    /* â• ÙƒØ§Ø±Øª Ø¥Ø¶Ø§ÙØ© Ø³Ø§Ø¦Ù‚ */
    .add-driver-card {
      background: rgba(255,255,255,0.98);
      color: #111827;
      padding: 14px 14px 10px;
      border-radius: var(--card-radius);
      margin-bottom: 14px;
      box-shadow: var(--shadow);
    }

    .add-driver-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 10px;
      margin-bottom: 8px;
    }

    .add-driver-header-title {
      margin: 0;
      font-size: 15px;
      font-weight: 700;
    }

    .add-driver-header-note {
      margin: 0;
      font-size: 12px;
      color: var(--muted);
    }

    .add-driver-row {
      display: grid;
      grid-template-columns: repeat(4, minmax(0, 1fr)) auto;
      gap: 8px;
    }

    @media (max-width: 900px) {
      .add-driver-row {
        grid-template-columns: repeat(2, minmax(0, 1fr));
      }
    }

    @media (max-width: 640px) {
      .add-driver-row {
        grid-template-columns: 1fr;
      }
    }

    .add-driver-row input {
      width: 100%;
      padding: 8px 10px;
      border-radius: 9px;
      border: 1px solid #d1d5db;
      font-size: 13px;
      font-family: inherit;
      outline: none;
      transition: 0.15s ease;
    }

    .add-driver-row input:focus {
      border-color: var(--main-blue);
      box-shadow: 0 0 0 1px rgba(37,99,235,0.35);
    }

    #addDriverBtn {
      background: linear-gradient(135deg, var(--main-blue), var(--main-purple));
      color: #fff;
      border: none;
      border-radius: 999px;
      padding: 9px 16px;
      cursor: pointer;
      font-size: 13px;
      font-weight: 700;
      white-space: nowrap;
      transition: 0.2s ease;
      box-shadow: 0 3px 8px rgba(0,0,0,0.25);
      align-self: stretch;
    }

    #addDriverBtn:hover {
      transform: translateY(-1px);
      opacity: 0.96;
    }

    #dAddMsg {
      margin-top: 6px;
      font-size: 12px;
      font-weight: 600;
    }

    .status-bar {
      margin-top: 8px;
      font-size: 13px;
      padding: 6px 10px;
      border-radius: 999px;
      display: none;
    }

    .status-bar.ok {
      display: block;
      background: #ecfdf3;
      color: #166534;
      border: 1px solid #bbf7d0;
    }

    .status-bar.err {
      display: block;
      background: #fef2f2;
      color: #b91c1c;
      border: 1px solid #fecaca;
    }

    /* ğŸ–¥ï¸ Ø¬Ø¯ÙˆÙ„ Ù„Ù„Ø³Ø§Ø¦Ù‚ÙŠÙ† (Ù„Ù„Ù‘Ø§Ø¨) */
    .table-wrapper {
      background: rgba(255,255,255,0.98);
      border-radius: var(--card-radius);
      box-shadow: var(--shadow);
      overflow: hidden;
      margin-bottom: 14px;
    }

    .drivers-table {
      width: 100%;
      border-collapse: collapse;
      font-size: 13px;
    }

    .drivers-table thead {
      background: #0f172a;
      color: #e5e7eb;
    }

    .drivers-table th,
    .drivers-table td {
      padding: 8px 10px;
      text-align: center;
      border-bottom: 1px solid #e5e7eb;
      white-space: nowrap;
    }

    .drivers-table th {
      font-weight: 700;
      font-size: 12px;
    }

    .drivers-table tbody tr:nth-child(even) {
      background: #f9fafb;
    }

    .drivers-table tbody tr:nth-child(odd) {
      background: #ffffff;
    }

    .drivers-table tbody tr:last-child td {
      border-bottom: none;
    }

    .td-notes {
      max-width: 200px;
      white-space: normal;
      text-align: right;
      font-size: 12px;
    }

    .td-actions {
      display: flex;
      flex-wrap: wrap;
      justify-content: center;
      gap: 4px;
    }

    .btn-xs {
      border-radius: 999px;
      border: none;
      padding: 4px 8px;
      font-size: 11px;
      font-weight: 600;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      gap: 4px;
      transition: 0.15s ease;
      white-space: nowrap;
    }

    .btn-xs-primary {
      background: linear-gradient(135deg, var(--main-blue), var(--main-purple));
      color: #fff;
    }

    .btn-xs-primary:hover {
      opacity: 0.9;
    }

    .btn-xs-soft {
      background: #eff6ff;
      color: #1d4ed8;
    }

    .btn-xs-soft:hover {
      background: #dbeafe;
    }

    .btn-xs-plain {
      background: #f3f4f6;
      color: #111827;
    }

    .btn-xs-plain:hover {
      background: #e5e7eb;
    }

    /* ğŸ“± ÙƒØ±ÙˆØª Ù„Ù„Ù…ÙˆØ¨Ø§ÙŠÙ„ */
    .card-list {
      display: none; /* ØªØ¸Ù‡Ø± ÙÙ‚Ø· ÙÙŠ Ø§Ù„Ù…ÙˆØ¨Ø§ÙŠÙ„ */
    }

    .driver-card {
      background: rgba(255,255,255,0.98);
      color: #111827;
      padding: 12px 12px 10px;
      border-radius: var(--card-radius);
      margin-bottom: 12px;
      box-shadow: var(--shadow);
      transition: 0.25s ease;
      border: 1px solid #e5e7eb;
    }

    .driver-card-header {
      display: flex;
      justify-content: space-between;
      gap: 6px;
      margin-bottom: 4px;
    }

    .driver-card-name {
      font-size: 14px;
      font-weight: 700;
      color: #111827;
    }

    .driver-card-id {
      font-size: 11px;
      border-radius: 999px;
      padding: 2px 8px;
      background: #eff6ff;
      color: #1d4ed8;
    }

    .row {
      margin: 3px 0;
      font-size: 13px;
      display: flex;
      justify-content: space-between;
      gap: 6px;
    }

    .label {
      font-weight: 600;
      color: var(--muted);
      margin-left: 4px;
    }

    .highlight {
      border: 2px solid #facc15;
      box-shadow: 0 0 0 2px rgba(250,204,21,0.5);
      transform: translateY(-2px);
    }

    .card-actions {
      margin-top: 6px;
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
    }

    /* Responsive */
    @media (max-width: 768px) {
      .page-title {
        font-size: 16px;
      }

      .table-wrapper {
        display: none;   /* Ø¥Ø®ÙØ§Ø¡ Ø§Ù„Ø¬Ø¯ÙˆÙ„ Ø¹Ù„Ù‰ Ø§Ù„Ù…ÙˆØ¨Ø§ÙŠÙ„ */
      }

      .card-list {
        display: block;  /* Ø¥Ø¸Ù‡Ø§Ø± Ø§Ù„ÙƒØ±ÙˆØª Ø¹Ù„Ù‰ Ø§Ù„Ù…ÙˆØ¨Ø§ÙŠÙ„ */
      }
    }

    @media (min-width: 769px) {
      .table-wrapper {
        display: block;  /* Ø¥Ø¸Ù‡Ø§Ø± Ø§Ù„Ø¬Ø¯ÙˆÙ„ Ø¹Ù„Ù‰ Ø§Ù„Ù„Ø§Ø¨ */
      }

      .card-list {
        display: none;   /* Ø¥Ø®ÙØ§Ø¡ Ø§Ù„ÙƒØ±ÙˆØª Ø¹Ù„Ù‰ Ø§Ù„Ù„Ø§Ø¨ */
      }
    }
  </style>
</head>

<body>

  <!-- ğŸ” Ø´Ø±ÙŠØ· Ø¹Ù„ÙˆÙŠ Ø«Ø§Ø¨Øª -->
  <header class="top-bar">
    <button class="back-btn" onclick="location.href='/'">
      ğŸ  Ø±Ø¬ÙˆØ¹
    </button>

    <h1 class="page-title">ğŸ‘¤ Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø³Ø§Ø¦Ù‚ÙŠÙ†</h1>

    <div class="top-right-actions">
      <button class="small-link-btn" onclick="location.href='/issue'">
        â• Ø¥ØµØ¯Ø§Ø± ØªÙÙˆÙŠØ¶ Ø¬Ø¯ÙŠØ¯
      </button>
      <button class="small-link-btn" onclick="location.href='/rented'">
        ğŸš— Ø§Ù„Ø³ÙŠØ§Ø±Ø§Øª Ø§Ù„Ù…Ø¤Ø¬Ø±Ø©
      </button>
      <button class="small-link-btn" onclick="location.href='/receipt'">
        ğŸ§¾ Ø³Ù†Ø¯ ØªØ­ØµÙŠÙ„
      </button>
    </div>
  </header>

  <main class="page-content">
    <h2>Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø³Ø§Ø¦Ù‚ÙŠÙ†</h2>
    <p class="subtitle">
      Ù‡Ø°Ù‡ Ø§Ù„Ø´Ø§Ø´Ø© Ù‡ÙŠ <strong>Ø¯Ù„ÙŠÙ„ Ø§Ù„Ø³Ø§Ø¦Ù‚ÙŠÙ†</strong> Ø§Ù„Ù…Ø±ØªØ¨Ø·ÙŠÙ† Ø¨ÙƒÙ„ Ø§Ù„ØªÙÙˆÙŠØ¶Ø§Øª ÙˆØ³Ù†Ø¯Ø§Øª Ø§Ù„ØªØ­ØµÙŠÙ„.
      Ù…Ù† Ù‡Ù†Ø§ ØªØ¶ÙŠÙ Ø§Ù„Ø³Ø§Ø¦Ù‚ Ù…Ø±Ø© ÙˆØ§Ø­Ø¯Ø© ÙˆØªØ³ØªØ®Ø¯Ù…Ù‡ ÙÙŠ
      <strong>Ø¥ØµØ¯Ø§Ø± Ø§Ù„ØªÙÙˆÙŠØ¶Ø§Øª</strong> Ùˆ <strong>Ø³Ù†Ø¯ Ø§Ù„ØªØ­ØµÙŠÙ„</strong>ØŒ ÙˆÙ…Ø¹ ÙƒÙ„ Ø³Ø§Ø¦Ù‚ Ø¬Ø¯ÙŠØ¯ ÙŠØªÙ… Ø¥Ù†Ø´Ø§Ø¡
      <strong>Ø­Ø³Ø§Ø¨ ÙØ±Ø¹ÙŠ ÙÙŠ Ø´Ø¬Ø±Ø© Ø§Ù„Ø­Ø³Ø§Ø¨Ø§Øª</strong> ØªÙ„Ù‚Ø§Ø¦ÙŠÙ‹Ø§.
    </p>

    <!-- Ø´Ø±ÙŠØ· Ø§Ù„Ø£Ø¯ÙˆØ§Øª: Ø¨Ø­Ø« + Ø¹Ø¯Ø§Ø¯ -->
    <section class="toolbar">
      <div class="toolbar-card">
        <div class="counter-pill">
          <span>Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø³Ø§Ø¦Ù‚ÙŠÙ†:</span>
          <span id="driversCount">0</span>
        </div>

        <div class="search-group">
          <span class="search-label">Ø¨Ø­Ø« Ø¨Ø§Ù„Ø§Ø³Ù… Ø£Ùˆ Ø§Ù„Ø¬ÙˆØ§Ù„ Ø£Ùˆ Ø±Ù‚Ù… Ø§Ù„Ø±Ø®ØµØ©:</span>
          <input
            id="search"
            type="text"
            class="search-input"
            placeholder="Ø§ÙƒØªØ¨ Ø¬Ø²Ø¡ Ù…Ù† Ø§Ø³Ù… Ø§Ù„Ø³Ø§Ø¦Ù‚ Ø£Ùˆ Ø±Ù‚Ù… Ø§Ù„Ø¬ÙˆØ§Ù„ Ø£Ùˆ Ø§Ù„Ø±Ø®ØµØ©..."
            oninput="filterDrivers()"
          />
        </div>

        <span class="badge">
          ğŸ‘¤ ÙƒÙ„ Ø³Ø§Ø¦Ù‚ Ù„Ù‡ Ø­Ø³Ø§Ø¨ ÙØ±Ø¹ÙŠ ØªÙ„Ù‚Ø§Ø¦ÙŠ ÙÙŠ Ø´Ø¬Ø±Ø© Ø§Ù„Ø­Ø³Ø§Ø¨Ø§Øª (Ø­Ø³Ø§Ø¨ Ø§Ù„Ø³Ø§Ø¦Ù‚ÙŠÙ†)
        </span>
      </div>
    </section>

    <!-- â• Ø¥Ø¶Ø§ÙØ© Ø³Ø§Ø¦Ù‚ Ø¬Ø¯ÙŠØ¯ -->
    <section class="add-driver-card">
      <div class="add-driver-header">
        <div>
          <p class="add-driver-header-title">â• Ø¥Ø¶Ø§ÙØ© Ø³Ø§Ø¦Ù‚ Ø¬Ø¯ÙŠØ¯</p>
          <p class="add-driver-header-note">
            Ø£Ø¶Ù Ø§Ù„Ø³Ø§Ø¦Ù‚ Ù…Ø±Ø© ÙˆØ§Ø­Ø¯Ø© Ø¨Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ© Ù„ÙŠÙØ³ØªØ®Ø¯Ù… ÙÙŠ Ø§Ù„ØªÙÙˆÙŠØ¶Ø§Øª ÙˆØ³Ù†Ø¯Ø§Øª Ø§Ù„ØªØ­ØµÙŠÙ„ØŒ ÙˆÙŠØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ø­Ø³Ø§Ø¨ Ù…Ø­Ø§Ø³Ø¨ÙŠ Ù„Ù‡ ØªÙ„Ù‚Ø§Ø¦ÙŠÙ‹Ø§.
          </p>
        </div>
      </div>

      <div class="add-driver-row">
        <input id="d_name"  placeholder="Ø§Ø³Ù… Ø§Ù„Ø³Ø§Ø¦Ù‚ (Ø¥Ø¬Ø¨Ø§Ø±ÙŠ)" />
        <input id="d_phone" placeholder="Ø±Ù‚Ù… Ø§Ù„Ø¬ÙˆØ§Ù„" />
        <input id="d_lic"   placeholder="Ø±Ù‚Ù… Ø§Ù„Ø±Ø®ØµØ©" />
        <input id="d_note"  placeholder="Ù…Ù„Ø§Ø­Ø¸Ø§Øª (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)" />
        <button id="addDriverBtn">ğŸ’¾ Ø­ÙØ¸ Ø§Ù„Ø³Ø§Ø¦Ù‚</button>
      </div>
      <div id="dAddMsg"></div>
    </section>

    <!-- ğŸ–¥ï¸ Ø¬Ø¯ÙˆÙ„ (Ù„Ù„Ù‘Ø§Ø¨) -->
    <section class="table-wrapper">
      <table class="drivers-table">
        <thead>
          <tr>
            <th>#</th>
            <th>Ø§Ø³Ù… Ø§Ù„Ø³Ø§Ø¦Ù‚</th>
            <th>Ø§Ù„Ø¬ÙˆØ§Ù„</th>
            <th>Ø±Ù‚Ù… Ø§Ù„Ø±Ø®ØµØ©</th>
            <th>Ù…Ù„Ø§Ø­Ø¸Ø§Øª</th>
            <th>Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª</th>
          </tr>
        </thead>
        <tbody id="driversTableBody">
          <!-- JS -->
        </tbody>
      </table>
    </section>

    <!-- ğŸ“± ÙƒØ±ÙˆØª (Ù„Ù„Ù…ÙˆØ¨Ø§ÙŠÙ„) -->
    <section class="card-list" id="driversCards"></section>

    <div id="statusBar" class="status-bar"></div>
  </main>

  <script>
    let driversData = [];
    let lastCreatedDriverId = null;

    const urlParams = new URLSearchParams(window.location.search);

    document.addEventListener("DOMContentLoaded", () => {
      loadDrivers();
    });

    // ğŸ”¹ Ø¹Ø±Ø¶ Ø±Ø³Ø§Ù„Ø© Ø­Ø§Ù„Ø© Ø¹Ø§Ù…Ø©
    function showStatus(message, isError = false) {
      const bar = document.getElementById("statusBar");
      if (!message) {
        bar.textContent = "";
        bar.style.display = "none";
        return;
      }
      bar.textContent = message;
      bar.className = "status-bar " + (isError ? "err" : "ok");
      bar.style.display = "block";
    }

    // â• Ø¥Ø¶Ø§ÙØ© Ø³Ø§Ø¦Ù‚ Ø¬Ø¯ÙŠØ¯
    document.getElementById("addDriverBtn").addEventListener("click", async () => {
      const name  = document.getElementById("d_name").value.trim();
      const phone = document.getElementById("d_phone").value.trim();
      const lic   = document.getElementById("d_lic").value.trim();
      const note  = document.getElementById("d_note").value.trim();

      const box = document.getElementById("dAddMsg");
      box.style.color = "#111827";

      if (!name) {
        box.textContent = "âŒ Ø§Ø³Ù… Ø§Ù„Ø³Ø§Ø¦Ù‚ Ù…Ø·Ù„ÙˆØ¨.";
        box.style.color = "#b91c1c";
        return;
      }

      const payload = {
        name:       name,
        phone:      phone || null,
        license_no: lic   || null,
        notes:      note  || null
      };

      box.textContent = "â³ Ø¬Ø§Ø±ÙŠ Ø­ÙØ¸ Ø§Ù„Ø³Ø§Ø¦Ù‚...";
      try {
        const res = await fetch("/api/drivers", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(payload)
        });

        let data = {};
        try { data = await res.json(); } catch (_) {}

        if (!res.ok) {
          box.style.color = "#b91c1c";
          box.textContent = "âŒ ÙØ´Ù„: " + (data.error || "Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø³Ø§Ø¦Ù‚.");
          return;
        }

        const driver = data; // Ù†ØªÙˆÙ‚Ø¹ ÙŠØ±Ø¬Ø¹ ÙƒØ§Ø¦Ù† Ø§Ù„Ø³Ø§Ø¦Ù‚ Ø§Ù„Ø¬Ø¯ÙŠØ¯
        lastCreatedDriverId = driver.id || null;

        // â­â­ Ù‡Ù†Ø§ Ø§Ù„Ø±Ø¨Ø· Ù…Ø¹ Ù…ÙˆØ¯ÙŠÙˆÙ„ Ø§Ù„Ù…Ø­Ø§Ø³Ø¨Ø© / accounts.html â­â­
        // Ù†Ø­Ø§ÙˆÙ„ Ø¥Ù†Ø´Ø§Ø¡ Ø­Ø³Ø§Ø¨ ÙØ±Ø¹ÙŠ Ù„Ù„Ø³Ø§Ø¦Ù‚ ÙÙŠ Ø´Ø¬Ø±Ø© Ø§Ù„Ø­Ø³Ø§Ø¨Ø§Øª Ø¹Ù† Ø·Ø±ÙŠÙ‚ API Ø®Ø§Øµ Ø¨Ø§Ù„Ù…Ø­Ø§Ø³Ø¨Ø©
        createDriverAccount(driver).catch(err => {
          console.warn("Ù„Ù… ÙŠØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ø­Ø³Ø§Ø¨ Ù…Ø­Ø§Ø³Ø¨ÙŠ Ù„Ù„Ø³Ø§Ø¦Ù‚:", err);
        });

        box.style.color = "#166534";
        box.textContent = "âœ… ØªÙ…Øª Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø³Ø§Ø¦Ù‚ ÙˆØ¥Ù†Ø´Ø§Ø¡ Ø­Ø³Ø§Ø¨Ù‡ Ø§Ù„Ù…Ø­Ø§Ø³Ø¨ÙŠ (Ø¥Ù† Ø£Ù…ÙƒÙ†).";

        // ØªÙØ±ÙŠØº Ø§Ù„Ø­Ù‚ÙˆÙ„
        document.getElementById("d_name").value  = "";
        document.getElementById("d_phone").value = "";
        document.getElementById("d_lic").value   = "";
        document.getElementById("d_note").value  = "";

        // Ø¥Ø¹Ø§Ø¯Ø© ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø©
        await loadDrivers(true);
      } catch (e) {
        console.error(e);
        box.style.color = "#b91c1c";
        box.textContent = "âš ï¸ Ù…Ø´ÙƒÙ„Ø© Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø®Ø§Ø¯Ù….";
      }
    });

    // ğŸ”— Ø¯Ø§Ù„Ø© Ø¥Ù†Ø´Ø§Ø¡ Ø­Ø³Ø§Ø¨ Ù…Ø­Ø§Ø³Ø¨ÙŠ ÙØ±Ø¹ÙŠ Ù„Ù„Ø³Ø§Ø¦Ù‚ ÙÙŠ Ø´Ø¬Ø±Ø© Ø§Ù„Ø­Ø³Ø§Ø¨Ø§Øª
    async function createDriverAccount(driver) {
      if (!driver || !driver.id) return;

      // ğŸ‘‰ Ù‡Ù†Ø§ Ù†ÙØªØ±Ø¶ Ø¥Ù† Ø¹Ù†Ø¯Ùƒ Endpoint ÙÙŠ Ø§Ù„Ø¨Ø§Ùƒ Ø¥Ù†Ø¯:
      // POST /api/accounts/driver
      // ÙˆÙ‡Ùˆ Ø§Ù„Ù„ÙŠ ÙØ¹Ù„ÙŠÙ‹Ø§ Ø¨ÙŠØ¶ÙŠÙ Ø­Ø³Ø§Ø¨ ÙÙŠ Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ø­Ø³Ø§Ø¨Ø§Øª ØªØ­Øª Ø­Ø³Ø§Ø¨ "Ø§Ù„Ø³Ø§Ø¦Ù‚ÙŠÙ†"
      const payload = {
        driver_id:   driver.id,
        driver_name: driver.name,
        phone:       driver.phone || null,
        license_no:  driver.license_no || null
        // Ù…Ù…ÙƒÙ† ØªØ¶ÙŠÙ Ø­Ù‚ÙˆÙ„ Ø²ÙŠØ§Ø¯Ø© Ù„Ùˆ Ø§Ù„Ø¨Ø§Ùƒ Ø¥Ù†Ø¯ Ù…Ø­ØªØ§Ø¬Ù‡Ø§ØŒ Ø²ÙŠ parent_account_code Ù„Ùˆ Ø­Ø§Ø¨Ø¨
        // parent_code: "113000"  // Ù…Ø«Ø§Ù„: ÙƒÙˆØ¯ Ø­Ø³Ø§Ø¨ "Ø§Ù„Ø³Ø§Ø¦Ù‚ÙŠÙ†" Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠ
      };

      const res = await fetch("/api/accounts/driver", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(payload)
      });

      // Ù…Ø´ Ù‡Ù†ÙˆÙ‚Ù Ø§Ù„Ø´Ø§Ø´Ø© Ù„Ùˆ Ø­ØµÙ„ Ø®Ø·Ø£ØŒ Ø¨Ø³ Ù‡Ù†Ø·Ø¨Ø¹ ÙÙŠ Ø§Ù„Ù€ console
      if (!res.ok) {
        let errMsg = "HTTP " + res.status;
        try {
          const data = await res.json();
          if (data && data.error) errMsg = data.error;
        } catch (_) {}
        console.warn("Ø®Ø·Ø£ ÙÙŠ Ø¥Ù†Ø´Ø§Ø¡ Ø­Ø³Ø§Ø¨ Ù…Ø­Ø§Ø³Ø¨ÙŠ Ù„Ù„Ø³Ø§Ø¦Ù‚:", errMsg);
      }
    }

    // ğŸ”„ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø³Ø§Ø¦Ù‚ÙŠÙ† Ù…Ù† Ø§Ù„Ù€ API
    async function loadDrivers(keepStatus = false) {
      const tableBody = document.getElementById("driversTableBody");
      const cardsBox  = document.getElementById("driversCards");
      const countEl   = document.getElementById("driversCount");

      tableBody.innerHTML = "<tr><td colspan='6' style='text-align:center'>â³ Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...</td></tr>";
      cardsBox.innerHTML  = "<p style='text-align:center; font-size:13px;'>â³ Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø³Ø§Ø¦Ù‚ÙŠÙ†...</p>";
      if (!keepStatus) {
        showStatus("Ø¬Ø§Ø±Ù ØªØ­Ù…ÙŠÙ„ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø³Ø§Ø¦Ù‚ÙŠÙ† Ù…Ù† Ø§Ù„Ø®Ø§Ø¯Ù…...", false);
      }

      try {
        const res = await fetch("/api/drivers");
        if (!res.ok) throw new Error("HTTP " + res.status);
        const data = await res.json();
        driversData = Array.isArray(data) ? data : [];

        countEl.textContent = driversData.length;
        renderDrivers(driversData);

        // Ø¯Ø¹Ù… ?driver_id= Ø£Ùˆ ?focus_id=
        autoFocusDriverByIdFromURL();
        showStatus(`ØªÙ… ØªØ­Ù…ÙŠÙ„ ${driversData.length} Ø³Ø§Ø¦Ù‚.`, false);
      } catch (err) {
        console.error(err);
        showStatus("ØªØ¹Ø°Ø± ØªØ­Ù…ÙŠÙ„ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø³Ø§Ø¦Ù‚ÙŠÙ† Ù…Ù† Ø§Ù„Ø®Ø§Ø¯Ù…. ØªØ£ÙƒØ¯ Ø£Ù† Ø§Ù„Ø¨Ø§Ùƒ Ø¥Ù†Ø¯ ÙŠØ¹Ù…Ù„.", true);
        tableBody.innerHTML = "<tr><td colspan='6' style='text-align:center'>âš ï¸ Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø³Ø§Ø¦Ù‚ÙŠÙ†.</td></tr>";
        cardsBox.innerHTML  = "<p style='text-align:center; font-size:13px;'>âš ï¸ Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø³Ø§Ø¦Ù‚ÙŠÙ†.</p>";
      }
    }

    // ğŸ¨ Ø±Ø³Ù… Ø§Ù„Ø¬Ø¯ÙˆÙ„ + Ø§Ù„ÙƒØ±ÙˆØª
    function renderDrivers(data) {
      const tableBody = document.getElementById("driversTableBody");
      const cardsBox  = document.getElementById("driversCards");

      tableBody.innerHTML = "";
      cardsBox.innerHTML  = "";

      if (!data || data.length === 0) {
        tableBody.innerHTML = "<tr><td colspan='6' style='text-align:center'>Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª Ø³Ø§Ø¦Ù‚ÙŠÙ† Ø­ØªÙ‰ Ø§Ù„Ø¢Ù†.</td></tr>";
        cardsBox.innerHTML  = "<p style='text-align:center; font-size:13px;'>Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª Ø³Ø§Ø¦Ù‚ÙŠÙ† Ø­ØªÙ‰ Ø§Ù„Ø¢Ù†.</p>";
        return;
      }

      data.forEach((d, index) => {
        const safeId = d.id != null ? String(d.id) : (d.name || "").replace(/\s+/g, "-").replace(/\W+/g, "-");
        const rowId  = "driver-row-"  + safeId;
        const cardId = "driver-card-" + safeId;

        // ğŸ–¥ï¸ ØµÙ ÙÙŠ Ø§Ù„Ø¬Ø¯ÙˆÙ„
        const tr = document.createElement("tr");
        tr.id = rowId;
        tr.innerHTML = `
          <td>${d.id != null ? d.id : (index + 1)}</td>
          <td>${d.name || "â€”"}</td>
          <td>${d.phone || "â€”"}</td>
          <td>${d.license_no || "â€”"}</td>
          <td class="td-notes">${d.notes || "â€”"}</td>
          <td>
            <div class="td-actions">
              <button class="btn-xs btn-xs-primary" onclick="goToIssue(${d.id})">
                â• ØªÙÙˆÙŠØ¶
              </button>
              <button class="btn-xs btn-xs-soft" onclick="goToRented(${d.id})">
                ğŸš— Ù…Ø¤Ø¬Ø±
              </button>
              <button class="btn-xs btn-xs-plain" onclick="goToReceipt(${d.id})">
                ğŸ§¾ Ø³Ù†Ø¯
              </button>
            </div>
          </td>
        `;
        tableBody.appendChild(tr);

        // ğŸ“± ÙƒØ§Ø±Øª Ù„Ù„Ù…ÙˆØ¨Ø§ÙŠÙ„
        const card = document.createElement("article");
        card.className = "driver-card";
        card.id = cardId;
        card.innerHTML = `
          <div class="driver-card-header">
            <span class="driver-card-name">${d.name || "Ø¨Ø¯ÙˆÙ† Ø§Ø³Ù…"}</span>
            <span class="driver-card-id">ID: ${d.id != null ? d.id : (index + 1)}</span>
          </div>
          <div class="row">
            <span class="label">Ø§Ù„Ø¬ÙˆØ§Ù„:</span>
            <span>${d.phone || "â€”"}</span>
          </div>
          <div class="row">
            <span class="label">Ø±Ù‚Ù… Ø§Ù„Ø±Ø®ØµØ©:</span>
            <span>${d.license_no || "â€”"}</span>
          </div>
          <div class="row">
            <span class="label">Ù…Ù„Ø§Ø­Ø¸Ø§Øª:</span>
            <span>${d.notes || "â€”"}</span>
          </div>
          <div class="card-actions">
            <button class="btn-xs btn-xs-primary" onclick="goToIssue(${d.id})">
              â• ØªÙÙˆÙŠØ¶
            </button>
            <button class="btn-xs btn-xs-soft" onclick="goToRented(${d.id})">
              ğŸš— Ù…Ø¤Ø¬Ø±
            </button>
            <button class="btn-xs btn-xs-plain" onclick="goToReceipt(${d.id})">
              ğŸ§¾ Ø³Ù†Ø¯
            </button>
          </div>
        `;
        cardsBox.appendChild(card);
      });
    }

    // ğŸ” ÙÙ„ØªØ±Ø© Ø­Ø³Ø¨ Ø§Ù„Ø§Ø³Ù… / Ø§Ù„Ø¬ÙˆØ§Ù„ / Ø§Ù„Ø±Ø®ØµØ©
    function filterDrivers() {
      const term = document.getElementById("search").value.trim().toLowerCase();
      if (!term) {
        renderDrivers(driversData);
        return;
      }
      const filtered = driversData.filter(d => {
        const name  = (d.name || "").toLowerCase();
        const phone = (d.phone || "").toLowerCase();
        const lic   = (d.license_no || "").toLowerCase();
        return name.includes(term) || phone.includes(term) || lic.includes(term);
      });
      renderDrivers(filtered);
    }

    // âœ¨ ØªØ¸Ù„ÙŠÙ„ Ø³Ø§Ø¦Ù‚ Ù…Ø¹ÙŠÙ‘Ù† Ø­Ø³Ø¨ ?driver_id Ø£Ùˆ ?focus_id
    function autoFocusDriverByIdFromURL() {
      const focusIdParam = urlParams.get("driver_id") || urlParams.get("focus_id");
      if (!focusIdParam && !lastCreatedDriverId) return;

      const focusId = focusIdParam || lastCreatedDriverId;
      const safeId  = String(focusId);
      const rowId   = "driver-row-"  + safeId;
      const cardId  = "driver-card-" + safeId;

      const rowEl  = document.getElementById(rowId);
      const cardEl = document.getElementById(cardId);
      const targetEl = rowEl || cardEl;

      if (targetEl) {
        targetEl.classList.add("highlight");
        targetEl.scrollIntoView({ behavior: "smooth", block: "center" });
        setTimeout(() => targetEl.classList.remove("highlight"), 3500);
      }
    }

    // ğŸ”— Ø§Ù†ØªÙ‚Ø§Ù„Ø§Øª Ø³Ø±ÙŠØ¹Ø© Ø¨ÙŠÙ† Ø§Ù„Ù…ÙˆØ¯ÙŠÙˆÙ„Ø§Øª

    function goToIssue(driverId) {
      if (!driverId) return;
      window.location.href = `/issue?driver_id=${driverId}`;
    }

    function goToRented(driverId) {
      if (!driverId) return;
      window.location.href = `/rented?driver_id=${driverId}`;
    }

    function goToReceipt(driverId) {
      if (!driverId) return;
      window.location.href = `/receipt?driver_id=${driverId}`;
    }
  </script>
</body>
</html>
