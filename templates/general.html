<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <title>ğŸ““ Ø§Ù„ÙŠÙˆÙ…ÙŠØ© Ø§Ù„Ø¹Ø§Ù…Ø©</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <style>
    :root {
      --bg1:#0d6efd;
      --bg2:#6c63ff;
      --card:#111827;
      --ink:#f9fafb;
      --muted:#9ca3af;
      --border:#374151;
      --accent:#2563eb;
      --danger:#dc2626;
      --success:#16a34a;
    }

    * { box-sizing: border-box; }

    body {
      margin: 0;
      min-height: 100vh;
      font-family: "Tajawal", system-ui, -apple-system, "Segoe UI", sans-serif;
      background: linear-gradient(135deg, var(--bg1), var(--bg2));
      color: var(--ink);
    }

    /* ğŸ” Ø´Ø±ÙŠØ· Ø¹Ù„ÙˆÙŠ Ø«Ø§Ø¨Øª */
    .top-bar {
      position: fixed;
      top: 0;
      right: 0;
      left: 0;
      z-index: 1000;
      background: rgba(0,0,0,0.25);
      backdrop-filter: blur(8px);
      padding: 10px 16px;
      display: flex;
      align-items: center;
      gap: 10px;
      flex-wrap: wrap;
    }

    .nav-group {
      display:flex;
      align-items:center;
      gap:8px;
      flex-wrap:wrap;
    }

    .nav-btn {
      border: none;
      border-radius: 999px;
      padding: 8px 14px;
      font-size: 13px;
      font-weight: 600;
      cursor: pointer;
      background: #fff;
      color: #0f172a;
      display: inline-flex;
      align-items: center;
      gap: 6px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.25);
      transition: 0.2s ease;
      white-space: nowrap;
      text-decoration:none;
    }

    .nav-btn:hover {
      background: var(--bg1);
      color: #fff;
      transform: translateY(-1px);
    }

    .nav-btn.active {
      background: var(--bg1);
      color:#fff;
      box-shadow: 0 0 0 1px rgba(191,219,254,0.8);
    }

    .page-title {
      margin: 0;
      font-size: 18px;
      font-weight: 700;
      flex: 1;
      text-align: center;
      color: #fff;
    }

    .top-right {
      display:flex;
      align-items:center;
      gap:8px;
      flex-wrap:wrap;
    }

    .top-small-note {
      font-size:11px;
      color:#e5e7eb;
      opacity:0.9;
    }

    /* Ø§Ù„Ø­Ø§ÙˆÙŠØ© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ© */
    .page-wrapper {
      display:flex;
      justify-content:center;
      padding: 80px 16px 16px; /* Ù…Ø³Ø§Ø­Ø© Ù„Ù„Ù‡ÙŠØ¯Ø± Ø§Ù„Ø«Ø§Ø¨Øª */
    }

    .container {
      width: 100%;
      max-width: 900px;
      background: radial-gradient(circle at top left, rgba(255,255,255,0.22), transparent 55%),
                  radial-gradient(circle at bottom right, rgba(15,23,42,0.6), transparent 55%),
                  #020617;
      border-radius: 18px;
      padding: 20px;
      box-shadow: 0 24px 70px rgba(0,0,0,0.45);
    }

    .header {
      margin-bottom: 14px;
    }

    .title-group h1 {
      margin: 0;
      font-size: 1.5rem;
      display:flex;
      align-items:center;
      gap:8px;
    }

    .title-group p {
      margin: 4px 0 0;
      font-size: 0.9rem;
      color: #e5e7eb;
    }

    .small-note-link {
      margin-top: 6px;
      font-size: 0.8rem;
      color: var(--muted);
    }

    .inline-link {
      color:#bfdbfe;
      text-decoration:underline;
      cursor:pointer;
    }

    .inline-link:hover {
      color:#f9fafb;
    }

    .card {
      background: var(--card);
      border-radius: 14px;
      padding: 14px 14px 12px;
      border: 1px solid rgba(148,163,184,0.45);
      box-shadow: 0 14px 40px rgba(0,0,0,0.48);
    }

    .card-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 10px;
      gap: 8px;
    }

    .card-header h2 {
      margin: 0;
      font-size: 1rem;
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .card-header span.badge {
      padding: 3px 9px;
      border-radius: 999px;
      font-size: 0.75rem;
      background: rgba(37,99,235,0.12);
      border: 1px solid rgba(59,130,246,0.4);
      color: #dbeafe;
      white-space:nowrap;
    }

    .card-body {
      font-size: 0.9rem;
    }

    label {
      display: block;
      margin-bottom: 4px;
      font-size: 0.85rem;
      color: #e5e7eb;
    }

    .field {
      margin-bottom: 8px;
    }

    input[type="text"],
    input[type="date"],
    input[type="number"],
    select {
      width: 100%;
      padding: 7px 9px;
      border-radius: 9px;
      border: 1px solid rgba(148,163,184,0.6);
      background: #020617;
      color: var(--ink);
      font-size: 0.9rem;
      outline: none;
      transition: 0.15s ease;
    }

    input[type="text"]:focus,
    input[type="date"]:focus,
    input[type="number"]:focus,
    select:focus {
      border-color: var(--accent);
      box-shadow: 0 0 0 1px rgba(37,99,235,0.45);
    }

    .hint {
      font-size: 0.78rem;
      color: var(--muted);
    }

    .hint-strong {
      font-size: 0.78rem;
      color: #facc15;
      margin-top: 4px;
    }

    .actions {
      margin-top: 8px;
      display: flex;
      justify-content: flex-start;
      gap: 8px;
      flex-wrap: wrap;
    }

    .btn {
      border-radius: 999px;
      padding: 7px 14px;
      font-size: 0.85rem;
      border: none;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      gap: 6px;
      transition: 0.15s ease;
      white-space: nowrap;
    }

    .btn-primary {
      background: linear-gradient(135deg, #2563eb, #4f46e5);
      color: white;
      box-shadow: 0 8px 20px rgba(37,99,235,0.4);
    }

    .btn-primary:hover {
      filter: brightness(1.08);
      transform: translateY(-1px);
    }

    .btn-ghost {
      background: transparent;
      color: #e5e7eb;
      border: 1px solid rgba(148,163,184,0.7);
    }

    .btn-ghost:hover {
      background: rgba(15,23,42,0.9);
    }

    .btn-line {
      padding: 4px 9px;
      font-size: 0.78rem;
      border-radius: 999px;
      border: 1px solid rgba(148,163,184,0.7);
      background: rgba(15,23,42,0.9);
      color: #e5e7eb;
      cursor: pointer;
      transition: 0.15s ease;
      white-space:nowrap;
    }

    .btn-line:hover {
      background: rgba(37,99,235,0.4);
    }

    .btn-remove {
      border-color: rgba(248,113,113,0.9);
      color: #fecaca;
    }

    .message {
      margin-top: 8px;
      font-size: 0.8rem;
      padding: 6px 9px;
      border-radius: 9px;
      display: none;
    }

    .message.error {
      background: rgba(220,38,38,0.08);
      border: 1px solid rgba(220,38,38,0.85);
      color: #fecaca;
    }

    .message.success {
      background: rgba(22,163,74,0.08);
      border: 1px solid rgba(22,163,74,0.9);
      color: #bbf7d0;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      font-size: 0.82rem;
    }

    th, td {
      padding: 6px 6px;
      border-bottom: 1px solid rgba(55,65,81,0.7);
      text-align: right;
    }

    thead {
      background: #020617;
    }

    th {
      font-weight: 600;
      color: #e5e7eb;
      font-size: 0.78rem;
      white-space: nowrap;
    }

    tbody tr:nth-child(odd) {
      background: rgba(15,23,42,0.8);
    }

    tbody tr:nth-child(even) {
      background: rgba(15,23,42,0.6);
    }

    tbody tr:hover {
      background: rgba(37,99,235,0.25);
    }

    .lines-table-wrapper {
      border-radius: 10px;
      border: 1px solid var(--border);
      overflow: auto;
      max-height: 260px;
      background: rgba(15,23,42,0.85);
      margin-top: 4px;
    }

    .small-input {
      max-width: 120px;
    }

    .footer-totals {
      margin-top: 6px;
      display: flex;
      justify-content: flex-start;
      gap: 16px;
      font-size: 0.82rem;
      color: var(--muted);
      flex-wrap: wrap;
    }

    .footer-totals span strong {
      color: #e5e7eb;
    }

    /* ğŸ” Ø®Ù„ÙŠØ© Ø§Ù„Ø­Ø³Ø§Ø¨ + Ø§Ù„Ø¨Ø­Ø« */
    .account-cell {
      display:flex;
      flex-direction:column;
      gap:4px;
    }

    .account-search {
      font-size:0.78rem;
      padding:5px 8px;
    }

    .account-search::placeholder {
      color:rgba(148,163,184,0.9);
    }

    @media print {
      body {
        background:#ffffff;
      }
      .top-bar {
        display:none;
      }
      .page-wrapper {
        padding-top:16px;
      }
      .btn, .btn-line {
        display:none !important;
      }
    }
  </style>
</head>

<body>

  <!-- ğŸ” Ø§Ù„Ù‡ÙŠØ¯Ø± Ø§Ù„Ø«Ø§Ø¨Øª -->
  <header class="top-bar">
    <div class="nav-group">
      <button class="nav-btn" onclick="location.href='/dashboard'">ğŸ  Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</button>
      <button class="nav-btn" onclick="location.href='/operations'">ğŸ§¾ Ø§Ù„Ø¹Ù…Ù„ÙŠØ§Øª</button>
      <button class="nav-btn" onclick="location.href='/receipt'">ğŸ§¾ Ø³Ù†Ø¯ ØªØ­ØµÙŠÙ„ Ø¬Ø¯ÙŠØ¯</button>
      <button class="nav-btn" onclick="location.href='/receipts-list'">ğŸ“‹ Ø³Ù†Ø¯Ø§Øª Ø§Ù„ØªØ­ØµÙŠÙ„</button>
      <button class="nav-btn" onclick="location.href='/accounts'">ğŸ“’ Ø¯Ù„ÙŠÙ„ Ø§Ù„Ø­Ø³Ø§Ø¨Ø§Øª</button>
      <button class="nav-btn" onclick="location.href='/ledger'">ğŸ“‘ Ø¯ÙØªØ± Ø§Ù„Ø£Ø³ØªØ§Ø°</button>
      <button class="nav-btn active" onclick="location.href='/general'">ğŸ““ Ø§Ù„ÙŠÙˆÙ…ÙŠØ© Ø§Ù„Ø¹Ø§Ù…Ø©</button>
      <button class="nav-btn" onclick="location.href='/journal-list'">ğŸ“œ Ø§Ù„Ù‚ÙŠÙˆØ¯ Ø§Ù„ÙŠØ¯ÙˆÙŠØ©</button>
    </div>

    <h1 class="page-title">ğŸ““ Ø§Ù„ÙŠÙˆÙ…ÙŠØ© Ø§Ù„Ø¹Ø§Ù…Ø©</h1>

    <div class="top-right">
      <span class="top-small-note">
        Ù‡Ø°Ù‡ Ø§Ù„Ø´Ø§Ø´Ø© Ø®Ø§ØµØ© Ø¨Ø§Ù„Ù‚ÙŠÙˆØ¯ Ø§Ù„ÙŠØ¯ÙˆÙŠØ© ÙÙ‚Ø· â€” Ø¨Ø§Ù‚ÙŠ Ø§Ù„Ù‚ÙŠÙˆØ¯ (Ø³Ù†Ø¯Ø§ØªØŒ ØªÙÙˆÙŠØ¶Ø§Øª) ØªØ£ØªÙŠ ØªÙ„Ù‚Ø§Ø¦ÙŠÙ‹Ø§ Ù…Ù† ØµÙØ­Ø§ØªÙ‡Ø§.
      </span>
    </div>
  </header>

  <div class="page-wrapper">
    <div class="container">
      <!-- Ø¹Ù†ÙˆØ§Ù† Ø§Ù„ØµÙØ­Ø© -->
      <div class="header">
        <div class="title-group">
          <h1>ğŸ““ Ù‚ÙŠØ¯ ÙŠÙˆÙ…ÙŠØ© ÙŠØ¯ÙˆÙŠ</h1>
          <p>
            Ø§Ø³ØªØ®Ø¯Ù… Ù‡Ø°Ù‡ Ø§Ù„Ø´Ø§Ø´Ø© Ù„ØªØ³Ø¬ÙŠÙ„ Ù‚ÙŠÙˆØ¯ ÙŠÙˆÙ…ÙŠØ© ÙŠØ¯ÙˆÙŠØ© (Ù…Ø¯ÙŠÙ†/Ø¯Ø§Ø¦Ù†).
            ØªØ£ÙƒØ¯ Ø£Ù† Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…Ø¯ÙŠÙ† = Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø¯Ø§Ø¦Ù† Ù‚Ø¨Ù„ Ø§Ù„Ø­ÙØ¸ØŒ ÙˆØ³ÙŠØªÙ… Ø±Ø¨Ø· Ø§Ù„Ù‚ÙŠØ¯ ØªÙ„Ù‚Ø§Ø¦ÙŠÙ‹Ø§
            Ø¨ØµÙØ­Ø© <strong>Ø§Ù„Ø¹Ù…Ù„ÙŠØ§Øª</strong> ÙˆØ¯ÙØªØ± Ø§Ù„Ø£Ø³ØªØ§Ø° Ø­Ø³Ø¨ Ø´Ø¬Ø±Ø© Ø§Ù„Ø­Ø³Ø§Ø¨Ø§Øª.
          </p>
        </div>
        <p class="small-note-link">
          Ù„Ø¹Ø±Ø¶ Ø§Ù„Ù‚ÙŠÙˆØ¯ Ø§Ù„ÙŠØ¯ÙˆÙŠØ© Ø§Ù„Ù…Ø³Ø¬Ù‘ÙÙ„Ø© Ù…Ø³Ø¨Ù‚Ù‹Ø§ØŒ Ø§Ø³ØªØ®Ø¯Ù… ØµÙØ­Ø©
          <a href="/journal-list" class="inline-link">Ø¹Ø±Ø¶ Ø§Ù„Ù‚ÙŠÙˆØ¯ Ø§Ù„ÙŠØ¯ÙˆÙŠØ©</a>.
        </p>
      </div>

      <!-- âœ… ÙƒØ±Øª ÙˆØ§Ø­Ø¯ Ù„Ù„ÙÙˆØ±Ù… ÙÙ‚Ø· -->
      <div class="card">
        <div class="card-header">
          <h2>â• Ù‚ÙŠØ¯ ÙŠÙˆÙ…ÙŠØ© Ø¬Ø¯ÙŠØ¯</h2>
          <span class="badge">Ù…Ø¯ÙŠÙ† / Ø¯Ø§Ø¦Ù† â€” Ù…Ù† Ø´Ø¬Ø±Ø© Ø§Ù„Ø­Ø³Ø§Ø¨Ø§Øª</span>
        </div>
        <div class="card-body">
          <form id="journalForm">
            <div class="field">
              <label for="jeDate">ØªØ§Ø±ÙŠØ® Ø§Ù„Ù‚ÙŠØ¯</label>
              <input id="jeDate" type="date" />
              <div class="hint">Ù„Ùˆ ØªØ±ÙƒØªÙ‡ ÙØ§Ø±ØºÙ‹Ø§ØŒ Ø³ÙŠØªÙ… Ø§Ø³ØªØ®Ø¯Ø§Ù… ØªØ§Ø±ÙŠØ® Ø§Ù„ÙŠÙˆÙ… ØªÙ„Ù‚Ø§Ø¦ÙŠÙ‹Ø§.</div>
            </div>

            <div class="field">
              <label for="jeDesc">ÙˆØµÙ Ø§Ù„Ù‚ÙŠØ¯</label>
              <input id="jeDesc" type="text" placeholder="Ù…Ø«Ø§Ù„: Ù‚ÙŠØ¯ ØªØ³ÙˆÙŠØ© / Ù‚ÙŠØ¯ ÙŠØ¯ÙˆÙŠ Ù„Ø¹Ù…ÙŠÙ„ Ù…Ø¹ÙŠÙ†..." />
            </div>

            <div class="field">
              <label>Ø¨Ù†ÙˆØ¯ Ø§Ù„Ù‚ÙŠØ¯ (Ù…Ø¯ÙŠÙ† / Ø¯Ø§Ø¦Ù†)</label>
              <div class="hint">
                Ø§Ø®ØªØ± ÙÙ‚Ø· Ø­Ø³Ø§Ø¨Ø§Øª ØªÙØµÙŠÙ„ÙŠØ© (ÙˆÙ„ÙŠØ³ Ø­Ø³Ø§Ø¨Ø§Øª ØªØ¬Ù…ÙŠØ¹ÙŠØ©)ØŒ ÙˆÙŠØ¬Ø¨ Ø£Ù† ÙŠÙƒÙˆÙ† Ù…Ø¬Ù…ÙˆØ¹ Ø§Ù„Ù…Ø¯ÙŠÙ† = Ù…Ø¬Ù…ÙˆØ¹ Ø§Ù„Ø¯Ø§Ø¦Ù† Ù‚Ø¨Ù„ Ø­ÙØ¸ Ø§Ù„Ù‚ÙŠØ¯.
              </div>

              <div class="lines-table-wrapper">
                <table>
                  <thead>
                    <tr>
                      <th style="width: 40%;">Ø§Ù„Ø­Ø³Ø§Ø¨</th>
                      <th style="width: 20%;">Ù…Ø¯ÙŠÙ†</th>
                      <th style="width: 20%;">Ø¯Ø§Ø¦Ù†</th>
                      <th style="width: 20%;">Ø¥Ø¬Ø±Ø§Ø¡</th>
                    </tr>
                  </thead>
                  <tbody id="linesBody">
                    <!-- ØµÙÙˆÙ Ø§Ù„Ø¨Ù†ÙˆØ¯ ØªØªØ¶Ø§Ù Ù‡Ù†Ø§ Ø¯ÙŠÙ†Ø§Ù…ÙŠÙƒÙŠØ§Ù‹ -->
                  </tbody>
                </table>
              </div>

              <div class="footer-totals">
                <span>Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…Ø¯ÙŠÙ†: <strong id="totalDebit">0.00</strong></span>
                <span>Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø¯Ø§Ø¦Ù†: <strong id="totalCredit">0.00</strong></span>
              </div>

              <div class="hint-strong" id="balanceHint">
                âš–ï¸ ÙŠØ¬Ø¨ Ø£Ù† ÙŠÙƒÙˆÙ† Ø§Ù„Ù‚ÙŠØ¯ Ù…ØªÙˆØ§Ø²Ù†Ù‹Ø§ (Ù…Ø¬Ù…ÙˆØ¹ Ø§Ù„Ù…Ø¯ÙŠÙ† = Ù…Ø¬Ù…ÙˆØ¹ Ø§Ù„Ø¯Ø§Ø¦Ù†).
              </div>

              <div style="margin-top:6px;">
                <button type="button" class="btn-line" id="btnAddLine">
                  â• Ø¥Ø¶Ø§ÙØ© Ø³Ø·Ø±
                </button>
              </div>
            </div>

                  <div class="actions">
                          <button type="submit" class="btn btn-primary">
                            ğŸ’¾ Ø­ÙØ¸ Ø§Ù„Ù‚ÙŠØ¯
                          </button>
                        
                          <button type="button" class="btn btn-ghost" id="btnResetForm">
                            â™»ï¸ Ù…Ø³Ø­ Ø§Ù„Ø­Ù‚ÙˆÙ„
                          </button>
                        
                          <!-- ğŸ–¨ï¸ Ø²Ø± Ø·Ø¨Ø§Ø¹Ø© Ø§Ù„Ù‚ÙŠØ¯ -->
                          <button type="button" class="btn btn-ghost" id="btnPrintEntry">
                            ğŸ–¨ï¸ Ø·Ø¨Ø§Ø¹Ø© Ø§Ù„Ù‚ÙŠØ¯
                          </button>
                  </div>


            <div id="formMessage" class="message"></div>
          </form>
        </div>
      </div>
    </div>
  </div>

  <script>
    // Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø­Ø³Ø§Ø¨Ø§Øª
    let accounts = [];

    // Ø¹Ù†Ø§ØµØ± Ø§Ù„ÙÙˆØ±Ù…
    const jeDateInput = document.getElementById("jeDate");
    const jeDescInput = document.getElementById("jeDesc");
    const linesBody = document.getElementById("linesBody");
    const totalDebitEl = document.getElementById("totalDebit");
    const totalCreditEl = document.getElementById("totalCredit");
    const balanceHint = document.getElementById("balanceHint");
    const formMessage = document.getElementById("formMessage");
    const journalForm = document.getElementById("journalForm");
    const btnAddLine = document.getElementById("btnAddLine");
    const btnResetForm = document.getElementById("btnResetForm");
    const btnPrintEntry = document.getElementById("btnPrintEntry");


    // Ø¶Ø¨Ø· ØªØ§Ø±ÙŠØ® Ø§Ù„ÙŠÙˆÙ… Ù…Ø¨Ø¯Ø¦ÙŠÙ‹Ø§
    (function setToday() {
      const today = new Date();
      const y = today.getFullYear();
      const m = String(today.getMonth() + 1).padStart(2, "0");
      const d = String(today.getDate()).padStart(2, "0");
      jeDateInput.value = `${y}-${m}-${d}`;
    })();

    function showFormMessage(text, type = "success", allowHtml = false) {
      if (allowHtml) {
        formMessage.innerHTML = text;
      } else {
        formMessage.textContent = text;
      }
      formMessage.className = "message " + type;
      formMessage.style.display = "block";
    }

    function clearFormMessage() {
      formMessage.textContent = "";
      formMessage.innerHTML = "";
      formMessage.style.display = "none";
    }

    function formatNumber(val) {
      const num = Number(val || 0);
      return num.toFixed(2);
    }

    function updateTotals() {
      let totalDebit = 0;
      let totalCredit = 0;

      const rows = linesBody.querySelectorAll("tr");
      rows.forEach(row => {
        const debitInput = row.querySelector(".line-debit");
        const creditInput = row.querySelector(".line-credit");
        const d = parseFloat(debitInput.value || "0");
        const c = parseFloat(creditInput.value || "0");
        if (!isNaN(d)) totalDebit += d;
        if (!isNaN(c)) totalCredit += c;
      });

      totalDebitEl.textContent = formatNumber(totalDebit);
      totalCreditEl.textContent = formatNumber(totalCredit);

      const diff = Math.abs(totalDebit - totalCredit);
      if (rows.length === 0) {
        balanceHint.textContent = "âš–ï¸ ÙŠØ¬Ø¨ Ø£Ù† ÙŠÙƒÙˆÙ† Ø§Ù„Ù‚ÙŠØ¯ Ù…ØªÙˆØ§Ø²Ù†Ù‹Ø§ (Ù…Ø¬Ù…ÙˆØ¹ Ø§Ù„Ù…Ø¯ÙŠÙ† = Ù…Ø¬Ù…ÙˆØ¹ Ø§Ù„Ø¯Ø§Ø¦Ù†).";
        balanceHint.style.color = "#facc15";
      } else if (diff < 0.005) {
        balanceHint.textContent = "âœ… Ø§Ù„Ù‚ÙŠØ¯ Ù…ØªÙˆØ§Ø²Ù† (Ù…Ø¬Ù…ÙˆØ¹ Ø§Ù„Ù…Ø¯ÙŠÙ† = Ù…Ø¬Ù…ÙˆØ¹ Ø§Ù„Ø¯Ø§Ø¦Ù†).";
        balanceHint.style.color = "#bbf7d0";
      } else {
        balanceHint.textContent = "âš ï¸ Ø§Ù„Ù‚ÙŠØ¯ ØºÙŠØ± Ù…ØªÙˆØ§Ø²Ù†ØŒ Ø±Ø§Ø¬Ø¹ Ù…Ø¨Ø§Ù„Øº Ø§Ù„Ù…Ø¯ÙŠÙ† ÙˆØ§Ù„Ø¯Ø§Ø¦Ù†.";
        balanceHint.style.color = "#fecaca";
      }
    }

    // Ø¥Ù†Ø´Ø§Ø¡ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø­Ø³Ø§Ø¨Ø§Øª
    function createAccountSelect() {
      const select = document.createElement("select");
      select.className = "line-account";
      const defaultOpt = document.createElement("option");
      defaultOpt.value = "";
      defaultOpt.textContent = "Ø§Ø®ØªØ± Ø­Ø³Ø§Ø¨Ø§Ù‹...";
      select.appendChild(defaultOpt);

      accounts.forEach(acc => {
        const opt = document.createElement("option");
        opt.value = acc.id;
        const code = acc.code ? String(acc.code).trim() : "";
        const name = acc.name || "";
        opt.textContent = code ? `${code} â€” ${name}` : name;
        select.appendChild(opt);
      });

      return select;
    }

    // ÙÙ„ØªØ±Ø© Ø­Ø³Ø§Ø¨Ø§Øª Ø­Ø³Ø¨ Ù†Øµ Ø§Ù„Ø¨Ø­Ø«
    function filterAccountOptions(selectElem, term) {
      const t = (term || "").trim().toLowerCase();
      Array.from(selectElem.options).forEach(opt => {
        if (!opt.value) { // "Ø§Ø®ØªØ± Ø­Ø³Ø§Ø¨Ø§Ù‹..."
          opt.hidden = false;
          return;
        }
        const name = (opt.textContent || "").toLowerCase();
        const match = !t || name.includes(t);
        opt.hidden = !match;
      });
    }

    function addLineRow() {
      const tr = document.createElement("tr");

      const tdAccount = document.createElement("td");
      const tdDebit = document.createElement("td");
      const tdCredit = document.createElement("td");
      const tdAction = document.createElement("td");

      // ğŸ” Ø®Ù„ÙŠØ© Ø§Ù„Ø­Ø³Ø§Ø¨ ÙÙŠÙ‡Ø§ input Ø¨Ø­Ø« + select
      const accountWrapper = document.createElement("div");
      accountWrapper.className = "account-cell";

      const searchInput = document.createElement("input");
      searchInput.type = "text";
      searchInput.placeholder = "Ø¨Ø­Ø« Ø¹Ù† Ø­Ø³Ø§Ø¨... (Ø§ÙƒØªØ¨ Ø¬Ø²Ø¡ Ù…Ù† Ø§Ù„Ø§Ø³Ù… Ø£Ùˆ Ø§Ù„ÙƒÙˆØ¯)";
      searchInput.className = "account-search";

      const sel = createAccountSelect();

      // Ø±Ø¨Ø· Ø§Ù„Ø¨Ø­Ø« Ø¨Ø§Ù„Ù€ select
      searchInput.addEventListener("input", () => {
        filterAccountOptions(sel, searchInput.value);
      });

      // Ù„Ùˆ Ø§Ø®ØªØ§Ø± Ø­Ø³Ø§Ø¨ Ù…Ù† Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ù†Ø­Ø· Ø§Ø³Ù…Ù‡ ÙÙŠ Ø®Ø§Ù†Ø© Ø§Ù„Ø¨Ø­Ø«
      sel.addEventListener("change", () => {
        const opt = sel.options[sel.selectedIndex];
        if (opt && opt.value) {
          searchInput.value = opt.textContent || "";
          filterAccountOptions(sel, "");
        }
      });

      accountWrapper.appendChild(searchInput);
      accountWrapper.appendChild(sel);
      tdAccount.appendChild(accountWrapper);

      const debitInput = document.createElement("input");
      debitInput.type = "number";
      debitInput.step = "0.01";
      debitInput.className = "small-input line-debit";
      debitInput.addEventListener("input", () => {
        if (debitInput.value && parseFloat(debitInput.value) !== 0) {
          creditInput.value = "";
        }
        updateTotals();
      });

      const creditInput = document.createElement("input");
      creditInput.type = "number";
      creditInput.step = "0.01";
      creditInput.className = "small-input line-credit";
      creditInput.addEventListener("input", () => {
        if (creditInput.value && parseFloat(creditInput.value) !== 0) {
          debitInput.value = "";
        }
        updateTotals();
      });

      tdDebit.appendChild(debitInput);
      tdCredit.appendChild(creditInput);

      const btnRemove = document.createElement("button");
      btnRemove.type = "button";
      btnRemove.className = "btn-line btn-remove";
      btnRemove.textContent = "ğŸ—‘ï¸ Ø­Ø°Ù";
      btnRemove.addEventListener("click", () => {
        tr.remove();
        updateTotals();
      });
      tdAction.appendChild(btnRemove);

      tr.appendChild(tdAccount);
      tr.appendChild(tdDebit);
      tr.appendChild(tdCredit);
      tr.appendChild(tdAction);

      linesBody.appendChild(tr);
      updateTotals();
    }

    btnAddLine.addEventListener("click", () => {
      if (accounts.length === 0) {
        alert("Ù„Ø§ ØªÙˆØ¬Ø¯ Ø­Ø³Ø§Ø¨Ø§Øª Ù…ØªØ§Ø­Ø©. Ø£Ø¶Ù Ø­Ø³Ø§Ø¨Ø§Øª Ø£ÙˆÙ„Ø§Ù‹ Ù…Ù† ØµÙØ­Ø© Ø¯Ù„ÙŠÙ„ Ø§Ù„Ø­Ø³Ø§Ø¨Ø§Øª.");
        return;
      }
      addLineRow();
    });

    btnResetForm.addEventListener("click", () => {
      jeDescInput.value = "";
      linesBody.innerHTML = "";
      updateTotals();
      clearFormMessage();
      const today = new Date();
      const y = today.getFullYear();
      const m = String(today.getMonth() + 1).padStart(2, "0");
      const d = String(today.getDate()).padStart(2, "0");
      jeDateInput.value = `${y}-${m}-${d}`;
    });
    // ğŸ–¨ï¸ Ø·Ø¨Ø§Ø¹Ø© Ø§Ù„Ù‚ÙŠØ¯
    btnPrintEntry.addEventListener("click", () => {
      window.print();
    });

    journalForm.addEventListener("submit", async (e) => {
      e.preventDefault();
      clearFormMessage();

      const rows = Array.from(linesBody.querySelectorAll("tr"));
      if (rows.length < 1) {
        showFormMessage("ÙŠØ¬Ø¨ Ø¥Ø¶Ø§ÙØ© Ø¨Ù†Ø¯ ÙˆØ§Ø­Ø¯ Ø¹Ù„Ù‰ Ø§Ù„Ø£Ù‚Ù„ ÙÙŠ Ø§Ù„Ù‚ÙŠØ¯.", "error");
        return;
      }

      let totalDebit = 0;
      let totalCredit = 0;
      const linesPayload = [];

      for (const row of rows) {
        const accountSelect = row.querySelector(".line-account");
        const debitInput = row.querySelector(".line-debit");
        const creditInput = row.querySelector(".line-credit");

        const account_id = accountSelect.value;
        if (!account_id) continue;

        const debit = parseFloat(debitInput.value || "0");
        const credit = parseFloat(creditInput.value || "0");

        if ((isNaN(debit) || debit === 0) && (isNaN(credit) || credit === 0)) {
          continue; // Ø³Ø·Ø± ÙØ§Ø¶ÙŠ
        }

        if (!isNaN(debit)) totalDebit += debit;
        if (!isNaN(credit)) totalCredit += credit;

        linesPayload.push({
          account_id: Number(account_id),
          debit: isNaN(debit) ? 0 : debit,
          credit: isNaN(credit) ? 0 : credit
        });
      }

      if (linesPayload.length === 0) {
        showFormMessage("ÙƒÙ„ Ø§Ù„Ø¨Ù†ÙˆØ¯ ÙØ§Ø±ØºØ©ØŒ Ø£Ø¶Ù Ù…Ø¨Ø§Ù„Øº Ù…Ø¯ÙŠÙ† Ø£Ùˆ Ø¯Ø§Ø¦Ù†.", "error");
        return;
      }

      if (Math.abs(totalDebit - totalCredit) > 0.005) {
        showFormMessage("Ø§Ù„Ù‚ÙŠØ¯ ØºÙŠØ± Ù…ØªÙˆØ§Ø²Ù†: Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…Ø¯ÙŠÙ† Ù„Ø§ ÙŠØ³Ø§ÙˆÙŠ Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø¯Ø§Ø¦Ù†.", "error");
        return;
      }

      const dateVal = jeDateInput.value.trim();
      const descVal = jeDescInput.value.trim();

      const payload = {
        date: dateVal || null,
        description: descVal,
        lines: linesPayload
      };

      try {
        const res = await fetch("/api/journal_entries", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(payload)
        });

        let data = {};
        try { data = await res.json(); } catch (_) {}

        if (!res.ok) {
          // Ø±Ø³Ø§Ø¦Ù„ Ø§Ù„Ø®Ø·Ø£ Ù‡Ù†Ø§ Ù†Øµ ÙÙ‚Ø· (Ø¨Ø¯ÙˆÙ† HTML) Ù„Ù„Ø­Ù…Ø§ÙŠØ©
          showFormMessage(data.error || "Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø­ÙØ¸ Ø§Ù„Ù‚ÙŠØ¯.", "error", false);
          return;
        }

        // Ù†Ø­Ø§ÙˆÙ„ Ù†Ø¬ÙŠØ¨ Ø±Ù‚Ù… Ø§Ù„Ù‚ÙŠØ¯ Ø¹Ø´Ø§Ù† Ù†Ø±Ø¨Ø·Ù‡ Ø¨Ø§Ù„Ø¹Ù…Ù„ÙŠØ§Øª
        const entryId = data.id || (data.entry && data.entry.id);

        let msg = "âœ… ØªÙ… Ø­ÙØ¸ Ù‚ÙŠØ¯ Ø§Ù„ÙŠÙˆÙ…ÙŠØ© Ø¨Ù†Ø¬Ø§Ø­.";
        if (entryId) {
          const opsUrl = `/operations?type=journal&journal_id=${entryId}`;
          msg += `
            <br />
            <a href="/journal-list" style="color:#bfdbfe;text-decoration:underline;margin-left:8px;">
              ğŸ“œ Ø¹Ø±Ø¶ ÙÙŠ ØµÙØ­Ø© Ø§Ù„Ù‚ÙŠÙˆØ¯ Ø§Ù„ÙŠØ¯ÙˆÙŠØ©
            </a>
            <a href="${opsUrl}" style="color:#bfdbfe;text-decoration:underline;margin-right:8px;">
              ğŸ§¾ Ø¹Ø±Ø¶ Ù‡Ø°Ø§ Ø§Ù„Ù‚ÙŠØ¯ ÙÙŠ ØµÙØ­Ø© Ø§Ù„Ø¹Ù…Ù„ÙŠØ§Øª
            </a>
          `;
        }

        showFormMessage(msg, "success", true);

        // Ø¥Ø¹Ø§Ø¯Ø© ØªÙ‡ÙŠØ¦Ø© Ø§Ù„Ø¨Ù†ÙˆØ¯
        linesBody.innerHTML = "";
        updateTotals();
        jeDescInput.value = "";

        // Ù†Ø¶ÙŠÙ Ø³Ø·Ø±ÙŠÙ† ÙØ§Ø¶ÙŠÙŠÙ† Ø¬Ø¯ÙŠØ¯ÙŠÙ† Ù„Ù„ØªØ³Ù‡ÙŠÙ„
        if (accounts.length > 0) {
          addLineRow();
          addLineRow();
        }
      } catch (err) {
        showFormMessage("âš ï¸ ØªØ¹Ø°Ø± Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø³ÙŠØ±ÙØ±ØŒ Ø­Ø§ÙˆÙ„ Ù…Ø±Ø© Ø£Ø®Ø±Ù‰.", "error", false);
      }
    });

    // ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø­Ø³Ø§Ø¨Ø§Øª
    async function loadAccounts() {
      try {
        const res = await fetch("/api/accounts");
        if (!res.ok) throw new Error("error");
        const data = await res.json();
        let list = data || [];

        // Ù„Ùˆ ÙÙŠÙ‡ is_group â†’ Ù†Ø³ØªØ®Ø¯Ù… ÙÙ‚Ø· Ø§Ù„Ø­Ø³Ø§Ø¨Ø§Øª Ø§Ù„ÙØ±Ø¹ÙŠØ© (is_group = false)
        if (Array.isArray(list) && list.length > 0 && "is_group" in list[0]) {
          list = list.filter(acc => acc.is_group === false);
        }

        // ØªØ±ØªÙŠØ¨ Ø§Ù„Ø­Ø³Ø§Ø¨Ø§Øª: Ø¨Ø§Ù„ÙƒÙˆØ¯ Ù„Ùˆ Ù…ÙˆØ¬ÙˆØ¯ØŒ ÙˆØ¨Ø¹Ø¯Ù‡Ø§ Ø¨Ø§Ù„Ø§Ø³Ù…
        list.sort((a, b) => {
          const ac = (a.code || "").toString();
          const bc = (b.code || "").toString();
          if (ac && bc && ac !== bc) {
            return ac.localeCompare(bc, "ar");
          }
          const an = (a.name || "").toString();
          const bn = (b.name || "").toString();
          return an.localeCompare(bn, "ar");
        });

        accounts = list;
      } catch (err) {
        console.error("Error loading accounts", err);
        accounts = [];
      }
    }

    async function init() {
      await loadAccounts();
      if (accounts.length > 0) {
        addLineRow();
        addLineRow();
      }
    }

    init();
  </script>
             <script>
            // ğŸ”’ Ù…Ù†Ø¹ ÙƒÙ„ÙŠÙƒ ÙŠÙ…ÙŠÙ†
            document.addEventListener('contextmenu', function (e) {
              e.preventDefault();
            });
          
            // ğŸ”’ Ù…Ù†Ø¹ Ù…ÙØ§ØªÙŠØ­ Ø§Ù„Ø£Ø¯ÙˆØ§Øª Ø§Ù„Ù…Ø´Ù‡ÙˆØ±Ø© Ù„Ù„Ù…Ø·ÙˆØ±ÙŠÙ†
            document.addEventListener('keydown', function (e) {
              // F12
              if (e.key === "F12") {
                e.preventDefault();
              }
          
              // Ctrl + Shift + I Ø£Ùˆ Ctrl + Shift + J Ø£Ùˆ Ctrl + U
              if ((e.ctrlKey && e.shiftKey && (e.key === 'I' || e.key === 'J')) || 
                  (e.ctrlKey && e.key === 'U')) {
                e.preventDefault();
              }
            });
          </script>
</body>
</html>



