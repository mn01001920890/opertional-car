<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <title>ğŸ““ Ø§Ù„ÙŠÙˆÙ…ÙŠØ© Ø§Ù„Ø¹Ø§Ù…Ø©</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <style>
    :root {
      --bg1:#0d6efd;
      --bg2:#6c63ff;
      --card:#111827;
      --ink:#f9fafb;
      --muted:#9ca3af;
      --border:#374151;
      --accent:#2563eb;
      --danger:#dc2626;
      --success:#16a34a;
    }

    * { box-sizing: border-box; }

    body {
      margin: 0;
      min-height: 100vh;
      font-family: "Tajawal", system-ui, -apple-system, "Segoe UI", sans-serif;
      background: linear-gradient(135deg, var(--bg1), var(--bg2));
      color: var(--ink);
    }

    /* ğŸ” Ø´Ø±ÙŠØ· Ø¹Ù„ÙˆÙŠ Ø«Ø§Ø¨Øª */
    .top-bar {
      position: fixed;
      top: 0;
      right: 0;
      left: 0;
      z-index: 1000;
      background: rgba(0,0,0,0.25);
      backdrop-filter: blur(8px);
      padding: 10px 16px;
      display: flex;
      align-items: center;
      gap: 10px;
      flex-wrap: wrap;
    }

    .nav-group {
      display:flex;
      align-items:center;
      gap:8px;
      flex-wrap:wrap;
    }

    .nav-btn {
      border: none;
      border-radius: 999px;
      padding: 8px 14px;
      font-size: 13px;
      font-weight: 600;
      cursor: pointer;
      background: #fff;
      color: #0f172a;
      display: inline-flex;
      align-items: center;
      gap: 6px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.25);
      transition: 0.2s ease;
      white-space: nowrap;
      text-decoration:none;
    }

    .nav-btn:hover {
      background: var(--bg1);
      color: #fff;
      transform: translateY(-1px);
    }

    .page-title {
      margin: 0;
      font-size: 18px;
      font-weight: 700;
      flex: 1;
      text-align: center;
      color: #fff;
    }

    .top-right {
      display:flex;
      align-items:center;
      gap:8px;
      flex-wrap:wrap;
    }

    .top-small-note {
      font-size:11px;
      color:#e5e7eb;
      opacity:0.9;
    }

    /* Ø§Ù„Ø­Ø§ÙˆÙŠØ© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ© */
    .page-wrapper {
      display:flex;
      justify-content:center;
      padding: 80px 16px 16px; /* Ù…Ø³Ø§Ø­Ø© Ù„Ù„Ù‡ÙŠØ¯Ø± Ø§Ù„Ø«Ø§Ø¨Øª */
    }

    .container {
      width: 100%;
      max-width: 1200px;
      background: radial-gradient(circle at top left, rgba(255,255,255,0.22), transparent 55%),
                  radial-gradient(circle at bottom right, rgba(15,23,42,0.6), transparent 55%),
                  #020617;
      border-radius: 18px;
      padding: 20px;
      box-shadow: 0 24px 70px rgba(0,0,0,0.45);
    }

    .header {
      display: flex;
      flex-wrap: wrap;
      align-items: center;
      justify-content: space-between;
      gap: 12px;
      margin-bottom: 18px;
    }

    .title-group h1 {
      margin: 0;
      font-size: 1.5rem;
      display:flex;
      align-items:center;
      gap:8px;
    }

    .title-group p {
      margin: 4px 0 0;
      font-size: 0.9rem;
      color: #e5e7eb;
    }

    .layout {
      display: grid;
      grid-template-columns: minmax(0, 1.15fr) minmax(0, 1.35fr);
      gap: 18px;
    }

    @media (max-width: 960px) {
      .layout {
        grid-template-columns: 1fr;
      }
    }

    .card {
      background: var(--card);
      border-radius: 14px;
      padding: 14px 14px 12px;
      border: 1px solid rgba(148,163,184,0.45);
      box-shadow: 0 14px 40px rgba(0,0,0,0.48);
    }

    .card-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 10px;
      gap: 8px;
    }

    .card-header h2 {
      margin: 0;
      font-size: 1rem;
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .card-header span.badge {
      padding: 3px 9px;
      border-radius: 999px;
      font-size: 0.75rem;
      background: rgba(37,99,235,0.12);
      border: 1px solid rgba(59,130,246,0.4);
      color: #dbeafe;
      white-space:nowrap;
    }

    .card-body {
      font-size: 0.9rem;
    }

    label {
      display: block;
      margin-bottom: 4px;
      font-size: 0.85rem;
      color: #e5e7eb;
    }

    .field {
      margin-bottom: 8px;
    }

    input[type="text"],
    input[type="date"],
    input[type="number"],
    select {
      width: 100%;
      padding: 7px 9px;
      border-radius: 9px;
      border: 1px solid rgba(148,163,184,0.6);
      background: #020617;
      color: var(--ink);
      font-size: 0.9rem;
      outline: none;
      transition: 0.15s ease;
    }

    input[type="text"]:focus,
    input[type="date"]:focus,
    input[type="number"]:focus,
    select:focus {
      border-color: var(--accent);
      box-shadow: 0 0 0 1px rgba(37,99,235,0.45);
    }

    .hint {
      font-size: 0.78rem;
      color: var(--muted);
    }

    .hint-strong {
      font-size: 0.78rem;
      color: #facc15;
      margin-top: 4px;
    }

    .actions {
      margin-top: 8px;
      display: flex;
      justify-content: flex-start;
      gap: 8px;
      flex-wrap: wrap;
    }

    .btn {
      border-radius: 999px;
      padding: 7px 14px;
      font-size: 0.85rem;
      border: none;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      gap: 6px;
      transition: 0.15s ease;
      white-space: nowrap;
    }

    .btn-primary {
      background: linear-gradient(135deg, #2563eb, #4f46e5);
      color: white;
      box-shadow: 0 8px 20px rgba(37,99,235,0.4);
    }

    .btn-primary:hover {
      filter: brightness(1.08);
      transform: translateY(-1px);
    }

    .btn-ghost {
      background: transparent;
      color: #e5e7eb;
      border: 1px solid rgba(148,163,184,0.7);
    }

    .btn-ghost:hover {
      background: rgba(15,23,42,0.9);
    }

    .btn-line {
      padding: 4px 9px;
      font-size: 0.78rem;
      border-radius: 999px;
      border: 1px solid rgba(148,163,184,0.7);
      background: rgba(15,23,42,0.9);
      color: #e5e7eb;
      cursor: pointer;
      transition: 0.15s ease;
      white-space:nowrap;
    }

    .btn-line:hover {
      background: rgba(37,99,235,0.4);
    }

    .btn-remove {
      border-color: rgba(248,113,113,0.9);
      color: #fecaca;
    }

    .message {
      margin-top: 8px;
      font-size: 0.8rem;
      padding: 6px 9px;
      border-radius: 9px;
      display: none;
    }

    .message.error {
      background: rgba(220,38,38,0.08);
      border: 1px solid rgba(220,38,38,0.85);
      color: #fecaca;
    }

    .message.success {
      background: rgba(22,163,74,0.08);
      border: 1px solid rgba(22,163,74,0.9);
      color: #bbf7d0;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      font-size: 0.82rem;
    }

    th, td {
      padding: 6px 6px;
      border-bottom: 1px solid rgba(55,65,81,0.7);
      text-align: right;
    }

    thead {
      background: #020617;
    }

    th {
      font-weight: 600;
      color: #e5e7eb;
      font-size: 0.78rem;
      white-space: nowrap;
    }

    tbody tr:nth-child(odd) {
      background: rgba(15,23,42,0.8);
    }

    tbody tr:nth-child(even) {
      background: rgba(15,23,42,0.6);
    }

    tbody tr:hover {
      background: rgba(37,99,235,0.25);
    }

    .lines-table-wrapper {
      border-radius: 10px;
      border: 1px solid var(--border);
      overflow: auto;
      max-height: 220px;
      background: rgba(15,23,42,0.85);
      margin-top: 4px;
    }

    .small-input {
      max-width: 120px;
    }

    .footer-totals {
      margin-top: 6px;
      display: flex;
      justify-content: flex-start;
      gap: 16px;
      font-size: 0.82rem;
      color: var(--muted);
      flex-wrap: wrap;
    }

    .footer-totals span strong {
      color: #e5e7eb;
    }

    .badge-count {
      font-size: 0.8rem;
      color: var(--muted);
    }

    .entry-card {
      border-radius: 10px;
      border: 1px solid rgba(55,65,81,0.9);
      padding: 8px 9px;
      margin-bottom: 8px;
      background: rgba(15,23,42,0.9);
    }

    .entry-header {
      display: flex;
      justify-content: space-between;
      gap: 6px;
      font-size: 0.8rem;
      margin-bottom: 4px;
      flex-wrap:wrap;
    }

    .entry-header-left {
      display: flex;
      flex-wrap: wrap;
      gap: 6px 10px;
    }

    .entry-id {
      font-weight: 600;
      color: #bfdbfe;
    }

    .entry-date {
      color: var(--muted);
    }

    .entry-desc {
      font-size: 0.8rem;
      color: #e5e7eb;
      margin-bottom: 4px;
    }

    .entry-lines-table {
      width: 100%;
      border-collapse: collapse;
      font-size: 0.78rem;
    }

    .entry-lines-table th,
    .entry-lines-table td {
      padding: 3px 4px;
      border-bottom: 1px solid rgba(55,65,81,0.6);
    }

    .entry-lines-table thead {
      background: rgba(15,23,42,1);
    }

    .badge-total {
      font-size: 0.78rem;
      color: #bbf7d0;
      white-space:nowrap;
    }

    .empty-state {
      text-align: center;
      padding: 12px 5px;
      font-size: 0.85rem;
      color: var(--muted);
    }

    .entries-toolbar {
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:8px;
      margin-bottom:6px;
      flex-wrap:wrap;
    }

    .btn-xs {
      padding:4px 10px;
      font-size:0.78rem;
      border-radius:999px;
      border:1px solid rgba(148,163,184,0.7);
      background:rgba(15,23,42,0.9);
      color:#e5e7eb;
      cursor:pointer;
      display:inline-flex;
      align-items:center;
      gap:4px;
      transition:0.15s ease;
      white-space:nowrap;
    }

    .btn-xs:hover {
      background:rgba(37,99,235,0.4);
    }

    .small-note {
      font-size:0.78rem;
      color:var(--muted);
      margin-top:4px;
    }

    @media print {
      body {
        background:#ffffff;
      }
      .top-bar {
        display:none;
      }
      .page-wrapper {
        padding-top:16px;
      }
    }
  </style>
</head>

<body>

  <!-- ğŸ” Ø§Ù„Ù‡ÙŠØ¯Ø± Ø§Ù„Ø«Ø§Ø¨Øª -->
  <header class="top-bar">
    <div class="nav-group">
      <button class="nav-btn" onclick="location.href='/'">ğŸ  Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</button>
      <button class="nav-btn" onclick="location.href='/operations'">ğŸ§¾ Ø§Ù„Ø¹Ù…Ù„ÙŠØ§Øª</button>
      <button class="nav-btn" onclick="location.href='/receipt'">ğŸ§¾ Ø³Ù†Ø¯ ØªØ­ØµÙŠÙ„ Ø¬Ø¯ÙŠØ¯</button>
      <button class="nav-btn" onclick="location.href='/receipts-list'">ğŸ“‹ Ø³Ù†Ø¯Ø§Øª Ø§Ù„ØªØ­ØµÙŠÙ„</button>
      <button class="nav-btn" onclick="location.href='/accounts'">ğŸ“’ Ø¯Ù„ÙŠÙ„ Ø§Ù„Ø­Ø³Ø§Ø¨Ø§Øª</button>
      <button class="nav-btn" onclick="location.href='/ledger'">ğŸ“‘ Ø¯ÙØªØ± Ø§Ù„Ø£Ø³ØªØ§Ø°</button>
      <button class="nav-btn" onclick="location.href='/general'">ğŸ““ Ø§Ù„ÙŠÙˆÙ…ÙŠØ© Ø§Ù„Ø¹Ø§Ù…Ø©</button>
    </div>

    <h1 class="page-title">ğŸ““ Ø§Ù„ÙŠÙˆÙ…ÙŠØ© Ø§Ù„Ø¹Ø§Ù…Ø©</h1>

    <div class="top-right">
      <span class="top-small-note">
        Ø¥Ù†Ø´Ø§Ø¡ Ù‚ÙŠÙˆØ¯ ÙŠØ¯ÙˆÙŠØ© + Ù…Ø±Ø§Ø¬Ø¹Ø© Ø§Ù„Ù‚ÙŠÙˆØ¯ Ø§Ù„Ù…Ø³Ø¬Ù‘ÙÙ„Ø©
      </span>
    </div>
  </header>

  <div class="page-wrapper">
    <div class="container">
      <!-- Ø¹Ù†ÙˆØ§Ù† Ø§Ù„ØµÙØ­Ø© Ø¯Ø§Ø®Ù„ Ø§Ù„ÙƒØ±Øª -->
      <div class="header">
        <div class="title-group">
          <h1>ğŸ““ Ø§Ù„ÙŠÙˆÙ…ÙŠØ© Ø§Ù„Ø¹Ø§Ù…Ø© (Ù‚ÙŠÙˆØ¯ ÙŠØ¯ÙˆÙŠØ©)</h1>
          <p>
            Ø³Ø¬Ù‘Ù„ Ù‚ÙŠÙˆØ¯ ÙŠÙˆÙ…ÙŠØ© ÙŠØ¯ÙˆÙŠØ© (Ù…Ø¯ÙŠÙ†/Ø¯Ø§Ø¦Ù†)ØŒ
            ÙˆØ§Ù„Ù‚ÙŠÙˆØ¯ Ø§Ù„Ø¢Ù„ÙŠØ© Ø§Ù„Ù†Ø§ØªØ¬Ø© Ù…Ù† Ø§Ù„ØªÙÙˆÙŠØ¶Ø§Øª ÙˆØ³Ù†Ø¯Ø§Øª Ø§Ù„ØªØ­ØµÙŠÙ„ ØªØ¸Ù‡Ø± Ù‡Ù†Ø§ Ø£ÙŠØ¶Ù‹Ø§.
          </p>
        </div>
      </div>

      <div class="layout">
        <!-- âœ… Ø§Ù„ÙÙˆØ±Ù…: Ù‚ÙŠØ¯ Ø¬Ø¯ÙŠØ¯ -->
        <div class="card">
          <div class="card-header">
            <h2>â• Ù‚ÙŠØ¯ ÙŠÙˆÙ…ÙŠØ© Ø¬Ø¯ÙŠØ¯</h2>
            <span class="badge">Ù…Ø¯ÙŠÙ† / Ø¯Ø§Ø¦Ù†</span>
          </div>
          <div class="card-body">
            <form id="journalForm">
              <div class="field">
                <label for="jeDate">ØªØ§Ø±ÙŠØ® Ø§Ù„Ù‚ÙŠØ¯</label>
                <input id="jeDate" type="date" />
                <div class="hint">Ù„Ùˆ ØªØ±ÙƒØªÙ‡ ÙØ§Ø±ØºÙ‹Ø§ØŒ Ø³ÙŠØªÙ… Ø§Ø³ØªØ®Ø¯Ø§Ù… ØªØ§Ø±ÙŠØ® Ø§Ù„ÙŠÙˆÙ… ØªÙ„Ù‚Ø§Ø¦ÙŠÙ‹Ø§.</div>
              </div>

              <div class="field">
                <label for="jeDesc">ÙˆØµÙ Ø§Ù„Ù‚ÙŠØ¯</label>
                <input id="jeDesc" type="text" placeholder="Ù…Ø«Ø§Ù„: Ù‚ÙŠØ¯ ØªØ³ÙˆÙŠØ© / Ù‚ÙŠØ¯ ÙŠØ¯ÙˆÙŠ Ù„Ø¹Ù…ÙŠÙ„ Ù…Ø¹ÙŠÙ†..." />
              </div>

              <div class="field">
                <label>Ø¨Ù†ÙˆØ¯ Ø§Ù„Ù‚ÙŠØ¯ (Ù…Ø¯ÙŠÙ† / Ø¯Ø§Ø¦Ù†)</label>
                <div class="hint">
                  ÙŠØ¬Ø¨ Ø£Ù† ÙŠÙƒÙˆÙ† Ù…Ø¬Ù…ÙˆØ¹ Ø§Ù„Ù…Ø¯ÙŠÙ† = Ù…Ø¬Ù…ÙˆØ¹ Ø§Ù„Ø¯Ø§Ø¦Ù† Ù‚Ø¨Ù„ Ø­ÙØ¸ Ø§Ù„Ù‚ÙŠØ¯.
                </div>

                <div class="lines-table-wrapper">
                  <table>
                    <thead>
                      <tr>
                        <th style="width: 40%;">Ø§Ù„Ø­Ø³Ø§Ø¨</th>
                        <th style="width: 20%;">Ù…Ø¯ÙŠÙ†</th>
                        <th style="width: 20%;">Ø¯Ø§Ø¦Ù†</th>
                        <th style="width: 20%;">Ø¥Ø¬Ø±Ø§Ø¡</th>
                      </tr>
                    </thead>
                    <tbody id="linesBody">
                      <!-- ØµÙÙˆÙ Ø§Ù„Ø¨Ù†ÙˆØ¯ ØªØªØ¶Ø§Ù Ù‡Ù†Ø§ Ø¯ÙŠÙ†Ø§Ù…ÙŠÙƒÙŠØ§Ù‹ -->
                    </tbody>
                  </table>
                </div>

                <div class="footer-totals">
                  <span>Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…Ø¯ÙŠÙ†: <strong id="totalDebit">0.00</strong></span>
                  <span>Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø¯Ø§Ø¦Ù†: <strong id="totalCredit">0.00</strong></span>
                </div>

                <div class="hint-strong" id="balanceHint">
                  âš–ï¸ ÙŠØ¬Ø¨ Ø£Ù† ÙŠÙƒÙˆÙ† Ø§Ù„Ù‚ÙŠØ¯ Ù…ØªÙˆØ§Ø²Ù†Ù‹Ø§ (Ù…Ø¬Ù…ÙˆØ¹ Ø§Ù„Ù…Ø¯ÙŠÙ† = Ù…Ø¬Ù…ÙˆØ¹ Ø§Ù„Ø¯Ø§Ø¦Ù†).
                </div>

                <div style="margin-top:6px;">
                  <button type="button" class="btn-line" id="btnAddLine">
                    â• Ø¥Ø¶Ø§ÙØ© Ø³Ø·Ø±
                  </button>
                </div>
              </div>

              <div class="actions">
                <button type="submit" class="btn btn-primary">
                  ğŸ’¾ Ø­ÙØ¸ Ø§Ù„Ù‚ÙŠØ¯
                </button>
                <button type="button" class="btn btn-ghost" id="btnResetForm">
                  â™»ï¸ Ù…Ø³Ø­ Ø§Ù„Ø­Ù‚ÙˆÙ„
                </button>
              </div>

              <div id="formMessage" class="message"></div>
            </form>
          </div>
        </div>

        <!-- ğŸ“œ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù‚ÙŠÙˆØ¯ -->
        <div class="card">
          <div class="card-header">
            <h2>ğŸ“œ Ø§Ù„Ù‚ÙŠÙˆØ¯ Ø§Ù„Ù…Ø³Ø¬Ù‘ÙÙ„Ø©</h2>
            <span class="badge-count" id="entriesCount">â€”</span>
          </div>
          <div class="card-body" style="max-height: 470px; overflow:auto;">
            <div class="entries-toolbar">
              <button class="btn-xs" type="button" onclick="loadJournalEntries()">
                ğŸ”„ Ø¥Ø¹Ø§Ø¯Ø© ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù‚ÙŠÙˆØ¯
              </button>
              <span class="small-note">
                Ø§Ù„Ù‚ÙŠÙˆØ¯ Ø§Ù„Ø¢Ù„ÙŠØ© Ù…Ù† Ø§Ù„ØªÙÙˆÙŠØ¶Ø§Øª ÙˆØ³Ù†Ø¯Ø§Øª Ø§Ù„ØªØ­ØµÙŠÙ„ ØªØ¸Ù‡Ø± Ù…Ø¹ Ø§Ù„Ø­Ù‚ÙˆÙ„ Ø§Ù„Ù…Ø±Ø¬Ø¹ÙŠØ© (Ù…Ø«Ù„ Ø±Ù‚Ù… Ø§Ù„ØªÙÙˆÙŠØ¶).
              </span>
            </div>

            <div id="entriesContainer">
              <div class="empty-state">
                Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù‚ÙŠÙˆØ¯...
              </div>
            </div>

            <div class="hint" style="margin-top:6px;">
              Ù„Ø§Ø­Ù‚Ù‹Ø§ Ù…Ù…ÙƒÙ† Ù†Ø¹Ù…Ù„ ØµÙØ­Ø© Ù…Ø³ØªÙ‚Ù„Ø© <code>journal-list.html</code> Ù„Ø¹Ø±Ø¶ Ø§Ù„Ù‚ÙŠÙˆØ¯ Ø¨Ø§Ù„ØªÙØµÙŠÙ„ Ù…Ø¹ ÙÙ„Ø§ØªØ± ÙˆØªØµØ¯ÙŠØ±.
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script>
    // Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø­Ø³Ø§Ø¨Ø§Øª
    let accounts = [];
    const accountsMap = new Map();

    // Ø¹Ù†Ø§ØµØ± Ø§Ù„ÙÙˆØ±Ù…
    const jeDateInput = document.getElementById("jeDate");
    const jeDescInput = document.getElementById("jeDesc");
    const linesBody = document.getElementById("linesBody");
    const totalDebitEl = document.getElementById("totalDebit");
    const totalCreditEl = document.getElementById("totalCredit");
    const balanceHint = document.getElementById("balanceHint");
    const formMessage = document.getElementById("formMessage");
    const journalForm = document.getElementById("journalForm");
    const btnAddLine = document.getElementById("btnAddLine");
    const btnResetForm = document.getElementById("btnResetForm");
    const entriesContainer = document.getElementById("entriesContainer");
    const entriesCount = document.getElementById("entriesCount");

    // Ø¶Ø¨Ø· ØªØ§Ø±ÙŠØ® Ø§Ù„ÙŠÙˆÙ… Ù…Ø¨Ø¯Ø¦ÙŠÙ‹Ø§
    (function setToday() {
      const today = new Date();
      const y = today.getFullYear();
      const m = String(today.getMonth() + 1).padStart(2, "0");
      const d = String(today.getDate()).padStart(2, "0");
      jeDateInput.value = `${y}-${m}-${d}`;
    })();

    function showFormMessage(text, type = "success") {
      formMessage.textContent = text;
      formMessage.className = "message " + type;
      formMessage.style.display = "block";
    }

    function clearFormMessage() {
      formMessage.textContent = "";
      formMessage.style.display = "none";
    }

    function formatNumber(val) {
      const num = Number(val || 0);
      return num.toFixed(2);
    }

    function updateTotals() {
      let totalDebit = 0;
      let totalCredit = 0;

      const rows = linesBody.querySelectorAll("tr");
      rows.forEach(row => {
        const debitInput = row.querySelector(".line-debit");
        const creditInput = row.querySelector(".line-credit");
        const d = parseFloat(debitInput.value || "0");
        const c = parseFloat(creditInput.value || "0");
        if (!isNaN(d)) totalDebit += d;
        if (!isNaN(c)) totalCredit += c;
      });

      totalDebitEl.textContent = formatNumber(totalDebit);
      totalCreditEl.textContent = formatNumber(totalCredit);

      const diff = Math.abs(totalDebit - totalCredit);
      if (rows.length === 0) {
        balanceHint.textContent = "âš–ï¸ ÙŠØ¬Ø¨ Ø£Ù† ÙŠÙƒÙˆÙ† Ø§Ù„Ù‚ÙŠØ¯ Ù…ØªÙˆØ§Ø²Ù†Ù‹Ø§ (Ù…Ø¬Ù…ÙˆØ¹ Ø§Ù„Ù…Ø¯ÙŠÙ† = Ù…Ø¬Ù…ÙˆØ¹ Ø§Ù„Ø¯Ø§Ø¦Ù†).";
        balanceHint.style.color = "#facc15";
      } else if (diff < 0.005) {
        balanceHint.textContent = "âœ… Ø§Ù„Ù‚ÙŠØ¯ Ù…ØªÙˆØ§Ø²Ù† (Ù…Ø¬Ù…ÙˆØ¹ Ø§Ù„Ù…Ø¯ÙŠÙ† = Ù…Ø¬Ù…ÙˆØ¹ Ø§Ù„Ø¯Ø§Ø¦Ù†).";
        balanceHint.style.color = "#bbf7d0";
      } else {
        balanceHint.textContent = "âš ï¸ Ø§Ù„Ù‚ÙŠØ¯ ØºÙŠØ± Ù…ØªÙˆØ§Ø²Ù†ØŒ Ø±Ø§Ø¬Ø¹ Ù…Ø¨Ø§Ù„Øº Ø§Ù„Ù…Ø¯ÙŠÙ† ÙˆØ§Ù„Ø¯Ø§Ø¦Ù†.";
        balanceHint.style.color = "#fecaca";
      }
    }

    function createAccountSelect() {
      const select = document.createElement("select");
      select.className = "line-account";
      const defaultOpt = document.createElement("option");
      defaultOpt.value = "";
      defaultOpt.textContent = "Ø§Ø®ØªØ± Ø­Ø³Ø§Ø¨Ø§Ù‹...";
      select.appendChild(defaultOpt);

      accounts.forEach(acc => {
        const opt = document.createElement("option");
        opt.value = acc.id;
        opt.textContent = acc.name;
        select.appendChild(opt);
      });

      return select;
    }

    function addLineRow() {
      const tr = document.createElement("tr");

      const tdAccount = document.createElement("td");
      const tdDebit = document.createElement("td");
      const tdCredit = document.createElement("td");
      const tdAction = document.createElement("td");

      const sel = createAccountSelect();
      tdAccount.appendChild(sel);

      const debitInput = document.createElement("input");
      debitInput.type = "number";
      debitInput.step = "0.01";
      debitInput.className = "small-input line-debit";
      debitInput.addEventListener("input", () => {
        if (debitInput.value && parseFloat(debitInput.value) !== 0) {
          creditInput.value = "";
        }
        updateTotals();
      });

      const creditInput = document.createElement("input");
      creditInput.type = "number";
      creditInput.step = "0.01";
      creditInput.className = "small-input line-credit";
      creditInput.addEventListener("input", () => {
        if (creditInput.value && parseFloat(creditInput.value) !== 0) {
          debitInput.value = "";
        }
        updateTotals();
      });

      tdDebit.appendChild(debitInput);
      tdCredit.appendChild(creditInput);

      const btnRemove = document.createElement("button");
      btnRemove.type = "button";
      btnRemove.className = "btn-line btn-remove";
      btnRemove.textContent = "ğŸ—‘ï¸ Ø­Ø°Ù";
      btnRemove.addEventListener("click", () => {
        tr.remove();
        updateTotals();
      });
      tdAction.appendChild(btnRemove);

      tr.appendChild(tdAccount);
      tr.appendChild(tdDebit);
      tr.appendChild(tdCredit);
      tr.appendChild(tdAction);

      linesBody.appendChild(tr);
      updateTotals();
    }

    btnAddLine.addEventListener("click", () => {
      if (accounts.length === 0) {
        alert("Ù„Ø§ ØªÙˆØ¬Ø¯ Ø­Ø³Ø§Ø¨Ø§Øª Ù…ØªØ§Ø­Ø©. Ø£Ø¶Ù Ø­Ø³Ø§Ø¨Ø§Øª Ø£ÙˆÙ„Ø§Ù‹ Ù…Ù† ØµÙØ­Ø© Ø¯Ù„ÙŠÙ„ Ø§Ù„Ø­Ø³Ø§Ø¨Ø§Øª.");
        return;
      }
      addLineRow();
    });

    btnResetForm.addEventListener("click", () => {
      jeDescInput.value = "";
      linesBody.innerHTML = "";
      updateTotals();
      clearFormMessage();
      const today = new Date();
      const y = today.getFullYear();
      const m = String(today.getMonth() + 1).padStart(2, "0");
      const d = String(today.getDate()).padStart(2, "0");
      jeDateInput.value = `${y}-${m}-${d}`;
    });

    journalForm.addEventListener("submit", async (e) => {
      e.preventDefault();
      clearFormMessage();

      const rows = Array.from(linesBody.querySelectorAll("tr"));
      if (rows.length < 1) {
        showFormMessage("ÙŠØ¬Ø¨ Ø¥Ø¶Ø§ÙØ© Ø¨Ù†Ø¯ ÙˆØ§Ø­Ø¯ Ø¹Ù„Ù‰ Ø§Ù„Ø£Ù‚Ù„ ÙÙŠ Ø§Ù„Ù‚ÙŠØ¯.", "error");
        return;
      }

      let totalDebit = 0;
      let totalCredit = 0;
      const linesPayload = [];

      for (const row of rows) {
        const accountSelect = row.querySelector(".line-account");
        const debitInput = row.querySelector(".line-debit");
        const creditInput = row.querySelector(".line-credit");

        const account_id = accountSelect.value;
        if (!account_id) continue;

        const debit = parseFloat(debitInput.value || "0");
        const credit = parseFloat(creditInput.value || "0");

        if ((isNaN(debit) || debit === 0) && (isNaN(credit) || credit === 0)) {
          continue;
        }

        if (!isNaN(debit)) totalDebit += debit;
        if (!isNaN(credit)) totalCredit += credit;

        linesPayload.push({
          account_id: Number(account_id),
          debit: isNaN(debit) ? 0 : debit,
          credit: isNaN(credit) ? 0 : credit
        });
      }

      if (linesPayload.length === 0) {
        showFormMessage("ÙƒÙ„ Ø§Ù„Ø¨Ù†ÙˆØ¯ ÙØ§Ø±ØºØ©ØŒ Ø£Ø¶Ù Ù…Ø¨Ø§Ù„Øº Ù…Ø¯ÙŠÙ† Ø£Ùˆ Ø¯Ø§Ø¦Ù†.", "error");
        return;
      }

      if (Math.abs(totalDebit - totalCredit) > 0.005) {
        showFormMessage("Ø§Ù„Ù‚ÙŠØ¯ ØºÙŠØ± Ù…ØªÙˆØ§Ø²Ù†: Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…Ø¯ÙŠÙ† Ù„Ø§ ÙŠØ³Ø§ÙˆÙŠ Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø¯Ø§Ø¦Ù†.", "error");
        return;
      }

      const dateVal = jeDateInput.value.trim();
      const descVal = jeDescInput.value.trim();

      const payload = {
        date: dateVal || null,
        description: descVal,
        lines: linesPayload
      };

      try {
        const res = await fetch("/api/journal_entries", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(payload)
        });

        const data = await res.json();
        if (!res.ok) {
          showFormMessage(data.error || "Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø­ÙØ¸ Ø§Ù„Ù‚ÙŠØ¯.", "error");
          return;
        }

        showFormMessage("âœ… ØªÙ… Ø­ÙØ¸ Ù‚ÙŠØ¯ Ø§Ù„ÙŠÙˆÙ…ÙŠØ© Ø¨Ù†Ø¬Ø§Ø­.", "success");
        linesBody.innerHTML = "";
        updateTotals();
        jeDescInput.value = "";
        await loadJournalEntries();
      } catch (err) {
        showFormMessage("âš ï¸ ØªØ¹Ø°Ø± Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø³ÙŠØ±ÙØ±ØŒ Ø­Ø§ÙˆÙ„ Ù…Ø±Ø© Ø£Ø®Ø±Ù‰.", "error");
      }
    });

    // ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø­Ø³Ø§Ø¨Ø§Øª
    async function loadAccounts() {
      try {
        const res = await fetch("/api/accounts");
        if (!res.ok) throw new Error("error");
        const data = await res.json();
        accounts = data || [];
        accountsMap.clear();
        accounts.forEach(acc => {
          accountsMap.set(acc.id, acc.name);
        });
      } catch (err) {
        console.error("Error loading accounts", err);
        accounts = [];
      }
    }

    // ØªØ­Ù…ÙŠÙ„ Ù‚ÙŠÙˆØ¯ Ø§Ù„ÙŠÙˆÙ…ÙŠØ©
    async function loadJournalEntries() {
      try {
        entriesContainer.innerHTML = `
          <div class="empty-state">
            Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù‚ÙŠÙˆØ¯...
          </div>
        `;
        const res = await fetch("/api/journal_entries");
        if (!res.ok) throw new Error("error");
        const data = await res.json();
        renderJournalEntries(data || []);
      } catch (err) {
        console.error("Error loading journal entries", err);
        entriesContainer.innerHTML = `
          <div class="empty-state">
            âš ï¸ Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù‚ÙŠÙˆØ¯ØŒ Ø­Ø§ÙˆÙ„ ØªØ­Ø¯ÙŠØ« Ø§Ù„ØµÙØ­Ø©.
          </div>
        `;
        entriesCount.textContent = "Ø®Ø·Ø£ ÙÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„";
      }
    }

    function renderJournalEntries(entries) {
      if (!entries || entries.length === 0) {
        entriesContainer.innerHTML = `
          <div class="empty-state">
            Ù„Ø§ ØªÙˆØ¬Ø¯ Ù‚ÙŠÙˆØ¯ ÙŠÙˆÙ…ÙŠØ© Ù…Ø³Ø¬Ù‘ÙÙ„Ø© Ø­ØªÙ‰ Ø§Ù„Ø¢Ù†.
          </div>
        `;
        entriesCount.textContent = "0 Ù‚ÙŠØ¯";
        return;
      }

      entriesCount.textContent = `${entries.length} Ù‚ÙŠØ¯/Ù‚ÙŠÙˆØ¯`;
      entriesContainer.innerHTML = "";

      entries.forEach(entry => {
        const card = document.createElement("div");
        card.className = "entry-card";

        let totalDebit = 0;
        let totalCredit = 0;
        (entry.lines || []).forEach(ln => {
          totalDebit += ln.debit || 0;
          totalCredit += ln.credit || 0;
        });

        const header = document.createElement("div");
        header.className = "entry-header";

        const left = document.createElement("div");
        left.className = "entry-header-left";

        const idSpan = document.createElement("span");
        idSpan.className = "entry-id";
        idSpan.textContent = `Ù‚ÙŠØ¯ #${entry.id}`;

        const dateSpan = document.createElement("span");
        dateSpan.className = "entry-date";
        dateSpan.textContent = entry.date || "";

        left.appendChild(idSpan);
        left.appendChild(dateSpan);

        if (entry.ref_authorization_id) {
          const authSpan = document.createElement("span");
          authSpan.style.color = "#fbbf24";
          authSpan.textContent = `ØªÙÙˆÙŠØ¶ Ù…Ø±ØªØ¨Ø·: ${entry.ref_authorization_id}`;
          left.appendChild(authSpan);
        }

        if (entry.ref_receipt_id) {
          const rSpan = document.createElement("span");
          rSpan.style.color = "#38bdf8";
          rSpan.textContent = `Ø³Ù†Ø¯ ØªØ­ØµÙŠÙ„: ${entry.ref_receipt_id}`;
          left.appendChild(rSpan);
        }

        const right = document.createElement("div");
        right.className = "badge-total";
        right.textContent = `Ù…Ø¯ÙŠÙ†: ${formatNumber(totalDebit)} | Ø¯Ø§Ø¦Ù†: ${formatNumber(totalCredit)}`;

        header.appendChild(left);
        header.appendChild(right);

        const desc = document.createElement("div");
        desc.className = "entry-desc";
        desc.textContent = entry.description || "â€”";

        const linesTable = document.createElement("table");
        linesTable.className = "entry-lines-table";
        linesTable.innerHTML = `
          <thead>
            <tr>
              <th style="width:45%;">Ø§Ù„Ø­Ø³Ø§Ø¨</th>
              <th style="width:22%;">Ù…Ø¯ÙŠÙ†</th>
              <th style="width:22%;">Ø¯Ø§Ø¦Ù†</th>
            </tr>
          </thead>
          <tbody></tbody>
        `;

        const tbody = linesTable.querySelector("tbody");
        (entry.lines || []).forEach(ln => {
          const tr = document.createElement("tr");
          const accName = accountsMap.get(ln.account_id) || `Ø­Ø³Ø§Ø¨ #${ln.account_id}`;
          tr.innerHTML = `
            <td>${accName}</td>
            <td>${formatNumber(ln.debit)}</td>
            <td>${formatNumber(ln.credit)}</td>
          `;
          tbody.appendChild(tr);
        });

        card.appendChild(header);
        card.appendChild(desc);
        card.appendChild(linesTable);

        entriesContainer.appendChild(card);
      });
    }

    async function init() {
      await loadAccounts();
      if (accounts.length > 0) {
        addLineRow();
        addLineRow();
      }
      await loadJournalEntries();
    }

    init();
  </script>
</body>
</html>
