<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>ğŸ“ Ø¥ØµØ¯Ø§Ø± ØªÙÙˆÙŠØ¶ Ø¬Ø¯ÙŠØ¯</title>
  <style>
    :root{
      --bg1:#0d6efd; --bg2:#6c63ff; --ok:#0abf53; --err:#e03131; --ink:#111827;
      --card:#ffffff; --muted:#6b7280; --border:#e5e7eb;
    }

    *{box-sizing:border-box}

    body{
      font-family:"Tajawal",system-ui,-apple-system,"Segoe UI",Roboto,Ubuntu,"Helvetica Neue",Arial;
      margin:0;
      min-height:100vh;
      background:linear-gradient(135deg,var(--bg1),var(--bg2));
      color:var(--ink);
    }

    /* ğŸ” Ø´Ø±ÙŠØ· Ø¹Ù„ÙˆÙŠ Ø«Ø§Ø¨Øª + Ø£Ø²Ø±Ø§Ø± ØªÙ†Ù‚Ù‘Ù„ */
    .top-bar{
      position:fixed;
      top:0;
      right:0;
      left:0;
      z-index:1000;
      background:rgba(0,0,0,0.25);
      backdrop-filter:blur(8px);
      padding:10px 16px;
      display:flex;
      align-items:center;
      gap:10px;
      flex-wrap:wrap;
    }

    .nav-group{
      display:flex;
      align-items:center;
      gap:8px;
      flex-wrap:wrap;
    }

    .back-btn{
      border:none;
      border-radius:999px;
      padding:8px 16px;
      font-size:14px;
      font-weight:600;
      cursor:pointer;
      background:#fff;
      color:#0d6efd;
      display:inline-flex;
      align-items:center;
      gap:6px;
      box-shadow:0 2px 6px rgba(0,0,0,0.25);
      transition:0.2s ease;
      white-space:nowrap;
      text-decoration:none;
    }

    .back-btn:hover{
      background:#0d6efd;
      color:#fff;
      transform:translateY(-1px);
    }

    .page-title{
      margin:0;
      font-size:18px;
      font-weight:700;
      flex:1;
      text-align:center;
      color:#fff;
    }

    /* Ù…Ø­ØªÙˆÙ‰ Ø§Ù„ØµÙØ­Ø© */
    .page-content{
      padding:80px 16px 24px; /* Ù…Ø³Ø§Ø­Ø© Ù„Ù„Ù‡ÙŠØ¯Ø± Ø§Ù„Ø«Ø§Ø¨Øª */
      min-height:100vh;
      display:flex;
      justify-content:center;
      align-items:flex-start;
    }

    .card{
      width:100%;
      max-width:620px;
      background:var(--card);
      border-radius:20px;
      box-shadow:0 16px 40px rgba(0,0,0,.22);
      padding:20px 20px 14px;
    }

    h1{
      font-size:22px;
      margin:0 0 4px;
    }

    p.sub{
      margin:0 0 16px;
      color:var(--muted);
      font-size:14px;
    }

    .row{display:flex;gap:10px}
    .row>.col{flex:1}

    label{
      display:block;
      font-size:13px;
      margin:10px 4px 6px;
      font-weight:600;
      color:#111827;
    }

    select,input,textarea{
      width:100%;
      padding:10px 12px;
      border:1px solid var(--border);
      border-radius:12px;
      font-size:14px;
      outline:none;
      transition:border-color .15s ease, box-shadow .15s ease;
      font-family:inherit;
    }

    select:focus,input:focus,textarea:focus{
      border-color:var(--bg1);
      box-shadow:0 0 0 1px rgba(13,110,253,0.1);
    }

    textarea{
      min-height:90px;
      resize:vertical;
    }

    .hint{
      font-size:12px;
      color:var(--muted);
      margin-top:4px;
    }

    .badge{
      display:inline-flex;
      align-items:center;
      gap:6px;
      padding:6px 10px;
      border-radius:999px;
      background:#f3f4f6;
      color:#374151;
      font-size:12px;
      margin:4px 2px 10px;
    }

    .actions{
      display:flex;
      gap:10px;
      justify-content:flex-end;
      margin-top:14px;
    }

    button{
      padding:11px 16px;
      border:none;
      border-radius:12px;
      font-size:14px;
      cursor:pointer;
      background:var(--bg1);
      color:#fff;
      font-weight:600;
      display:inline-flex;
      align-items:center;
      gap:6px;
    }

    button.ghost{
      background:#f3f4f6;
      color:#111827;
    }

    button:hover{
      filter:brightness(0.97);
      transform:translateY(-1px);
    }

    .alert{
      margin:8px 0 4px;
      border-radius:12px;
      padding:10px 12px;
      font-size:13px;
      display:none;
    }

    .alert.ok{
      display:block;
      background:#e9f8f0;
      color:#055e33;
      border:1px solid #b6f0d1;
    }

    .alert.err{
      display:block;
      background:#fdeceb;
      color:#7a1d1b;
      border:1px solid #f5c2c0;
    }

    .fade{
      animation:fade .25s ease;
    }

    @keyframes fade{
      from{opacity:.2;transform:translateY(-3px)}
      to{opacity:1;transform:none}
    }

    .muted{color:var(--muted);font-size:13px;}

    /* Ù…Ù„Ø®Øµ Ø§Ù„ØªÙÙˆÙŠØ¶ Ø§Ù„Ù…Ø­Ø§Ø³Ø¨ÙŠ */
    .calc-panel{
      margin-top:18px;
      padding:12px 12px 10px;
      border-radius:14px;
      background:#f9fafb;
      border:1px dashed #d1d5db;
      font-size:13px;
    }

    .calc-title{
      font-weight:700;
      margin-bottom:6px;
      display:flex;
      align-items:center;
      gap:6px;
      color:#111827;
    }

    .calc-grid{
      display:grid;
      grid-template-columns:repeat(auto-fit,minmax(140px,1fr));
      gap:6px 14px;
      margin-top:4px;
    }

    .calc-item-label{
      color:#6b7280;
      font-size:12px;
    }

    .calc-item-value{
      font-weight:600;
      color:#111827;
      margin-top:1px;
    }

    .calc-item-value.cost{
      color:#0b8a3c;
    }

    @media (max-width:600px){
      .page-title{font-size:16px;}
      .card{padding:16px 14px 12px;}
      .row{flex-direction:column;}
    }
  </style>
</head>
<body>

  <!-- ğŸ” Ø§Ù„Ù‡ÙŠØ¯Ø± Ø§Ù„Ø«Ø§Ø¨Øª -->
  <header class="top-bar">
    <div class="nav-group">
      <button class="back-btn" onclick="location.href='/'">ğŸ  Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</button>
      <button class="back-btn" onclick="location.href='/cars'">ğŸš— Ø§Ù„Ø³ÙŠØ§Ø±Ø§Øª</button>
      <button class="back-btn" onclick="location.href='/drivers'">ğŸ§‘â€âœˆï¸ Ø§Ù„Ø³Ø§Ø¦Ù‚ÙˆÙ†</button>
      <button class="back-btn" onclick="location.href='/authorizations'">ğŸ“„ Ø§Ù„ØªÙÙˆÙŠØ¶Ø§Øª</button>
      <button class="back-btn" onclick="location.href='/operations'">ğŸ§¾ Ø§Ù„Ø¹Ù…Ù„ÙŠØ§Øª</button>
    </div>
    <h2 class="page-title">ğŸ“ Ø¥ØµØ¯Ø§Ø± ØªÙÙˆÙŠØ¶ Ø¬Ø¯ÙŠØ¯</h2>
  </header>

  <main class="page-content">
    <div class="card">
      <h1>ğŸ“ Ø¥ØµØ¯Ø§Ø± ØªÙÙˆÙŠØ¶ Ø¬Ø¯ÙŠØ¯</h1>
      <p class="sub">Ø§Ø®ØªÙØ± Ø§Ù„Ø³Ø§Ø¦Ù‚ ÙˆØ§Ù„Ø³ÙŠØ§Ø±Ø©ØŒ ÙˆØ­Ø¯Ù‘ÙØ¯ Ø¨Ø¯Ø§ÙŠØ© Ø§Ù„ØªÙÙˆÙŠØ¶ØŒ Ø«Ù… Ø§Ø­ÙØ¸.</p>

      <div id="alertBox" class="alert"></div>

      <form id="issueForm">
        <!-- Ø§Ù„Ø³Ø§Ø¦Ù‚ -->
        <label for="driverSearch">Ø§Ù„Ø³Ø§Ø¦Ù‚</label>
        <input id="driverSearch" type="text" placeholder="Ø§ÙƒØªØ¨ Ø§Ø³Ù… Ø§Ù„Ø³Ø§Ø¦Ù‚ Ø£Ùˆ Ø±Ù‚Ù… Ø§Ù„Ø±Ø®ØµØ© Ø£Ùˆ Ø§Ù„Ø¬ÙˆØ§Ù„ Ù„Ù„Ø¨Ø­Ø«..." autocomplete="off" />
        <select id="driverSelect" required style="margin-top:6px;">
          <option value="">Ø§Ø®ØªØ± Ø§Ù„Ø³Ø§Ø¦Ù‚...</option>
        </select>
        <div id="driverInfo" class="hint" style="display:none"></div>

        <!-- Ø§Ù„Ø³ÙŠØ§Ø±Ø© -->
        <label for="carSearch">Ø§Ù„Ø³ÙŠØ§Ø±Ø©</label>
        <input id="carSearch" type="text" placeholder="Ø§ÙƒØªØ¨ Ø±Ù‚Ù… Ø§Ù„Ø³ÙŠØ§Ø±Ø© Ø£Ùˆ Ø§Ù„Ù…ÙˆØ¯ÙŠÙ„ Ø£Ùˆ Ø§Ù„Ù†ÙˆØ¹ Ù„Ù„Ø¨Ø­Ø«..." autocomplete="off" />
        <select id="carSelect" required style="margin-top:6px;">
          <option value="">Ø§Ø®ØªØ± Ø§Ù„Ø³ÙŠØ§Ø±Ø©...</option>
        </select>

        <!-- ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø³ÙŠØ§Ø±Ø© ØªÙÙ…Ù„Ø£ ØªÙ„Ù‚Ø§Ø¦ÙŠÙ‹Ø§ -->
        <div class="row">
          <div class="col">
            <label for="carModel">Ø§Ù„Ù…ÙˆØ¯ÙŠÙ„</label>
            <input id="carModel" type="text" placeholder="ÙŠÙÙ…Ù„Ø£ ØªÙ„Ù‚Ø§Ø¦ÙŠÙ‹Ø§ Ø¹Ù†Ø¯ Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ø³ÙŠØ§Ø±Ø©"/>
          </div>
          <div class="col">
            <label for="carType">Ø§Ù„Ù†ÙˆØ¹</label>
            <input id="carType" type="text" placeholder="ÙŠÙÙ…Ù„Ø£ ØªÙ„Ù‚Ø§Ø¦ÙŠÙ‹Ø§ Ø¹Ù†Ø¯ Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ø³ÙŠØ§Ø±Ø©"/>
          </div>
        </div>

        <div class="row">
          <div class="col">
            <label for="dailyRent">Ø§Ù„Ø¥ÙŠØ¬Ø§Ø± Ø§Ù„ÙŠÙˆÙ…ÙŠ (Ø±ÙŠØ§Ù„)</label>
            <input id="dailyRent" type="number" step="0.01" inputmode="decimal" placeholder="Ù…Ø«Ø§Ù„: 150.00"/>
            <div id="carHint" class="hint" style="display:none"></div>
          </div>
          <div class="col">
            <label for="startDate">ØªØ§Ø±ÙŠØ® Ø¨Ø¯Ø¡ Ø§Ù„ØªÙÙˆÙŠØ¶</label>
            <input id="startDate" type="datetime-local" />
            <div class="hint">ÙŠÙ…ÙƒÙ† ØªØ±ÙƒÙ‡Ø§ ÙƒÙ…Ø§ Ù‡ÙŠ (Ø§Ù„ÙˆÙ‚Øª Ø§Ù„Ø­Ø§Ù„ÙŠ) Ø£Ùˆ Ø§Ø®ØªÙŠØ§Ø± ÙˆÙ‚Øª Ø¢Ø®Ø±.</div>
          </div>
        </div>

        <label for="details">Ù…Ù„Ø§Ø­Ø¸Ø§Øª</label>
        <textarea id="details" placeholder="Ø£ÙŠ ØªÙØ§ØµÙŠÙ„ Ø¥Ø¶Ø§ÙÙŠØ© Ø¹Ù† Ø§Ù„ØªÙÙˆÙŠØ¶ (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)..."></textarea>

        <div class="actions">
          <button type="button" class="ghost" id="resetBtn">ØªÙØ±ÙŠØº</button>
          <button type="submit">ğŸ’¾ Ø­ÙØ¸ Ø§Ù„ØªÙÙˆÙŠØ¶</button>
        </div>
      </form>

      <div style="margin:10px 4px 6px" class="muted">
        ØªÙ„Ù…ÙŠØ­: Ù„Ùˆ Ø³ÙŠØ¨Øª Ø®Ø§Ù†Ø© Ø§Ù„Ø¥ÙŠØ¬Ø§Ø± ÙØ§Ø¶ÙŠØ©ØŒ Ù‡ÙŠØ§Ø®Ø¯ Ù‚ÙŠÙ…Ø© Ø¥ÙŠØ¬Ø§Ø± Ø§Ù„Ø¹Ø±Ø¨ÙŠØ© Ø§Ù„Ù…Ø®Ø²Ù†Ø© ØªÙ„Ù‚Ø§Ø¦ÙŠÙ‹Ø§.
      </div>

      <div class="badge" aria-hidden="true">
        ğŸš— Ø­Ø§Ù„Ø© Ø§Ù„Ø³ÙŠØ§Ø±Ø© ØªØªØ­ÙˆÙ‘Ù„ ØªÙ„Ù‚Ø§Ø¦ÙŠÙ‹Ø§ Ø¥Ù„Ù‰ Â«Ù…Ø¤Ø¬Ø±Ø©Â» Ø¨Ø¹Ø¯ Ø­ÙØ¸ Ø§Ù„ØªÙÙˆÙŠØ¶
      </div>

      <!-- Ù…Ù„Ø®Øµ Ø§Ù„Ø¬Ù…Ø¹Ø© ÙˆØ§Ù„ØªÙƒÙ„ÙØ© Ø¨Ø¹Ø¯ Ø§Ù„Ø­ÙØ¸ -->
      <div id="calcPanel" class="calc-panel" style="display:none">
        <div class="calc-title">
          ğŸ“… Ù…Ù„Ø®Øµ Ø§Ù„ØªÙÙˆÙŠØ¶ Ø§Ù„Ù…Ø­Ø§Ø³Ø¨ÙŠ
        </div>
        <div class="calc-grid">
          <div>
            <div class="calc-item-label">ØªØ§Ø±ÙŠØ® Ø§Ù„Ø¥ØµØ¯Ø§Ø± (issue_date)</div>
            <div id="sumIssueDate" class="calc-item-value">â€”</div>
          </div>
          <div>
            <div class="calc-item-label">Ø¨Ø¯Ø§ÙŠØ© Ø§Ù„ØªÙÙˆÙŠØ¶ (start_date)</div>
            <div id="sumStartDate" class="calc-item-value">â€”</div>
          </div>
          <div>
            <div class="calc-item-label">Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ø¬Ù…Ø¹Ø© Ø§Ù„Ù…Ø­Ø§Ø³Ø¨ÙŠØ© (planned_end)</div>
            <div id="sumPlannedEnd" class="calc-item-value">â€”</div>
          </div>
          <div>
            <div class="calc-item-label">
              Ø¹Ø¯Ø¯ Ø§Ù„Ø£ÙŠØ§Ù… Ø§Ù„Ù…Ø­Ø§Ø³Ø¨ÙŠØ©
              <span class="hint" style="display:block;margin-top:2px;">
                Ù…Ø­Ø³ÙˆØ¨Ø© Ù…Ù† ØªØ§Ø±ÙŠØ® Ø¨Ø¯Ø§ÙŠØ© Ø§Ù„ØªÙÙˆÙŠØ¶ Ø­ØªÙ‰ Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ø¬Ù…Ø¹Ø© (Ø´Ø§Ù…Ù„ ÙŠÙˆÙ… Ø§Ù„Ø¨Ø¯Ø§ÙŠØ©)
              </span>
            </div>
            <div id="sumDays" class="calc-item-value">â€”</div>
          </div>
          <div>
            <div class="calc-item-label">Ø§Ù„Ø¥ÙŠØ¬Ø§Ø± Ø§Ù„ÙŠÙˆÙ…ÙŠ</div>
            <div id="sumDailyRent" class="calc-item-value">â€”</div>
          </div>
          <div>
            <div class="calc-item-label">Ø§Ù„ØªÙƒÙ„ÙØ© Ø§Ù„Ù…ØªÙˆÙ‚Ø¹Ø© (Ø£ÙŠØ§Ù… Ã— Ø¥ÙŠØ¬Ø§Ø±)</div>
            <div id="sumTotal" class="calc-item-value cost">â€”</div>
          </div>
        </div>
      </div>

    </div>
  </main>

  <script>
    // ================== Ø¹Ù†Ø§ØµØ± DOM ==================
    const alertBox     = document.getElementById("alertBox");
    const form         = document.getElementById("issueForm");
    const driverSelect = document.getElementById("driverSelect");
    const driverSearch = document.getElementById("driverSearch");
    const carSelect    = document.getElementById("carSelect");
    const carSearch    = document.getElementById("carSearch");
    const carModel     = document.getElementById("carModel");
    const carType      = document.getElementById("carType");
    const dailyRent    = document.getElementById("dailyRent");
    const startDate    = document.getElementById("startDate");
    const details      = document.getElementById("details");
    const driverInfo   = document.getElementById("driverInfo");
    const carHint      = document.getElementById("carHint");
    const resetBtn     = document.getElementById("resetBtn");

    const calcPanel    = document.getElementById("calcPanel");
    const sumIssueDate = document.getElementById("sumIssueDate");
    const sumStartDate = document.getElementById("sumStartDate");
    const sumPlannedEnd= document.getElementById("sumPlannedEnd");
    const sumDays      = document.getElementById("sumDays");
    const sumDailyRent = document.getElementById("sumDailyRent");
    const sumTotal     = document.getElementById("sumTotal");

    let CARS = [];
    let DRIVERS = [];
    const urlParams = new URLSearchParams(window.location.search);

    // ================== Ø£Ø¯ÙˆØ§Øª ÙˆØ§Ø¬Ù‡Ø© ==================
    function showAlert(msg, kind="err"){
      alertBox.className = "alert fade " + (kind === "ok" ? "ok" : "err");
      alertBox.textContent = msg;
      alertBox.style.display = "block";
    }
    function clearAlert(){ alertBox.style.display="none"; }

    function fmtMoney(n){
      const v = Number(n);
      if (!isFinite(v)) return "";
      return v.toFixed(2);
    }

    function formatDT(value){
      if (!value) return "â€”";
      const d = new Date(value);
      if (isNaN(d)) return value;
      const pad = n => String(n).padStart(2,"0");
      const y=d.getFullYear(), m=pad(d.getMonth()+1), da=pad(d.getDate());
      const h=pad(d.getHours()), mi=pad(d.getMinutes()), s=pad(d.getSeconds());
      return `${y}-${m}-${da} ${h}:${mi}:${s}`;
    }

    // datetime-local default = Ø§Ù„Ø¢Ù†
    function setDefaultStart(){
      const startParam = urlParams.get("start") || urlParams.get("start_date");
      if (startParam) {
        startDate.value = startParam;
        return;
      }
      const now = new Date();
      const local = new Date(now.getTime() - now.getTimezoneOffset()*60000);
      startDate.value = local.toISOString().slice(0,16); // YYYY-MM-DDTHH:MM
    }

    // ================== ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ==================
    async function fetchJSON(url){
      const r = await fetch(url);
      if(!r.ok) throw new Error("HTTP " + r.status);
      return r.json();
    }

    async function loadDrivers(){
      const data = await fetchJSON("/api/drivers");
      DRIVERS = Array.isArray(data) ? data : [];
      driverSelect.innerHTML = '<option value="">Ø§Ø®ØªØ± Ø§Ù„Ø³Ø§Ø¦Ù‚...</option>';
      DRIVERS.forEach(d=>{
        const opt = document.createElement("option");
        opt.value = d.id;                           // Ù†Ø³ØªØ®Ø¯Ù… ID
        opt.textContent = d.name || `Ø³Ø§Ø¦Ù‚ #${d.id}`;
        opt.dataset.name    = d.name || "";
        opt.dataset.phone   = d.phone || "";
        opt.dataset.license = d.license_no || "";
        driverSelect.appendChild(opt);
      });
    }

    async function loadCars(){
      const data = await fetchJSON("/api/cars");
      CARS = Array.isArray(data) ? data : [];
      carSelect.innerHTML = '<option value="">Ø§Ø®ØªØ± Ø§Ù„Ø³ÙŠØ§Ø±Ø©...</option>';
      CARS.forEach(c=>{
        const label = c.model
          ? `${c.plate} â€” ${c.model}`
          : c.plate;
        const opt = document.createElement("option");
        opt.value = c.id; // Ù†Ø³ØªØ®Ø¯Ù… ID
        opt.textContent = label;
        opt.dataset.plate  = c.plate || "";
        opt.dataset.model  = c.model || "";
        opt.dataset.type   = c.car_type || "";
        opt.dataset.status = c.status || "";
        opt.dataset.rent   = (c.daily_rent ?? "");
        carSelect.appendChild(opt);
      });
    }

    // ================== ÙÙ„ØªØ±Ø© Ø§Ù„Ù‚ÙˆØ§Ø¦Ù… Ø¹Ù†Ø¯ Ø§Ù„ÙƒØªØ§Ø¨Ø© (Ø¨Ø¯ÙˆÙ† Ø§Ø®ØªÙŠØ§Ø± Ø£ÙˆØªÙˆÙ…Ø§ØªÙŠÙƒ) ==================
    function filterDriverOptions(term){
      const t = (term || "").trim().toLowerCase();
      Array.from(driverSelect.options).forEach(opt=>{
        if(!opt.value){ opt.hidden=false; return; }
        const name  = opt.dataset.name    || "";
        const lic   = opt.dataset.license || "";
        const phone = opt.dataset.phone   || "";
        const combined = `${name} ${lic} ${phone}`.toLowerCase();
        const match = !t || combined.includes(t);
        opt.hidden = !match;
      });
      // Ù…ÙÙŠØ´ ØªØºÙŠÙŠØ± Ù„Ù‚ÙŠÙ…Ø© Ø§Ù„Ù€ select Ù‡Ù†Ø§
    }

    function filterCarOptions(term){
      const t = (term || "").trim().toLowerCase();
      Array.from(carSelect.options).forEach(opt=>{
        if(!opt.value){ opt.hidden=false; return; }
        const plate = opt.dataset.plate || "";
        const model = opt.dataset.model || "";
        const type  = opt.dataset.type  || "";
        const combined = `${plate} ${model} ${type}`.toLowerCase();
        const match = !t || combined.includes(t);
        opt.hidden = !match;
      });
      // Ù…ÙÙŠØ´ ØªØºÙŠÙŠØ± Ù„Ù‚ÙŠÙ…Ø© Ø§Ù„Ù€ select Ù‡Ù†Ø§
    }

    // Ù„Ù…Ø§ Ø£ÙƒØªØ¨ ÙÙŠ Ø®Ø§Ù†Ø© Ø§Ù„Ø¨Ø­Ø« â†’ ÙÙ„ØªØ±Ø© + Ø¥Ù„ØºØ§Ø¡ Ø§Ù„Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ø­Ø§Ù„ÙŠ
    driverSearch.addEventListener("input", ()=>{
      filterDriverOptions(driverSearch.value);
      driverSelect.value = "";
      driverInfo.style.display = "none";
      driverInfo.textContent = "";
      clearAlert();
    });

    carSearch.addEventListener("input", ()=>{
      filterCarOptions(carSearch.value);
      carSelect.value = "";
      carModel.value = "";
      carType.value  = "";
      dailyRent.value = "";
      carHint.style.display = "none";
      carHint.textContent   = "";
      clearAlert();
    });

    // Ù„Ù…Ø§ Ø£Ø®ØªØ§Ø± Ù…Ù† Ø§Ù„Ù‚Ø§Ø¦Ù…Ø©ØŒ Ø±Ø¬Ù‘Ø¹ Ø§Ø³Ù… Ø§Ù„Ø³Ø§Ø¦Ù‚/Ø±Ù‚Ù… Ø§Ù„Ø³ÙŠØ§Ø±Ø© ÙÙŠ Ø§Ù„Ø®Ø§Ù†Ø©
    driverSelect.addEventListener("change", ()=>{
      const opt = driverSelect.selectedOptions[0];
      if(opt && opt.value){
        const phone = opt.dataset.phone || "Ø¨Ø¯ÙˆÙ† Ø±Ù‚Ù…";
        const lic   = opt.dataset.license || "Ø¨Ø¯ÙˆÙ† Ø±Ù‚Ù… Ø±Ø®ØµØ©";
        driverInfo.style.display = "block";
        driverInfo.textContent = `ğŸ“ ${phone} â€¢ Ø±Ø®ØµØ©: ${lic}`;

        // Ù†Ø¹Ø±Ø¶ Ø§Ù„Ø§Ø³Ù… ÙÙŠ Ø®Ø§Ù†Ø© Ø§Ù„Ø¨Ø­Ø«
        driverSearch.value = opt.dataset.name || opt.textContent || "";
      }else{
        driverInfo.style.display = "none";
        driverInfo.textContent = "";
      }
      clearAlert();
    });

    carSelect.addEventListener("change", ()=>{
      const opt = carSelect.selectedOptions[0];
      if(opt && opt.value){
        carModel.value = opt.dataset.model || "";
        carType.value  = opt.dataset.type  || "";
        const rent   = opt.dataset.rent;
        const status = (opt.dataset.status || "").trim();

        // Ù†Ø¹Ø±Ø¶ Ø±Ù‚Ù… Ø§Ù„Ø³ÙŠØ§Ø±Ø© ÙÙŠ Ø®Ø§Ù†Ø© Ø§Ù„Ø¨Ø­Ø«
        carSearch.value = opt.dataset.plate || "";

        if(status && status !== "Ù…ØªØ§Ø­Ø©"){
          carHint.style.display="block";
          carHint.textContent = `âš ï¸ Ø­Ø§Ù„Ø© Ø§Ù„Ø³ÙŠØ§Ø±Ø© Ø§Ù„Ø¢Ù†: ${status}. ÙŠÙØ¶Ù‘ÙÙ„ Ø§Ø®ØªÙŠØ§Ø± Ø³ÙŠØ§Ø±Ø© Â«Ù…ØªØ§Ø­Ø©Â».`;
        }else{
          carHint.style.display="block";
          const m = fmtMoney(rent);
          carHint.textContent = m
            ? `Ø¥ÙŠØ¬Ø§Ø± Ø§Ù„Ø³ÙŠØ§Ø±Ø© Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠ: ${m} Ø±ÙŠØ§Ù„/ÙŠÙˆÙ…. ÙŠÙ…ÙƒÙ†Ùƒ ØªØºÙŠÙŠØ±Ù‡ ÙŠØ¯ÙˆÙŠÙ‹Ø§.`
            : "Ù„Ø§ ØªÙˆØ¬Ø¯ Ù‚ÙŠÙ…Ø© Ø¥ÙŠØ¬Ø§Ø± Ù…Ø®Ø²Ù†Ø© Ù„Ù‡Ø°Ù‡ Ø§Ù„Ø³ÙŠØ§Ø±Ø©.";
        }

        dailyRent.value = (rent !== null && rent !== undefined && rent !== "") ? rent : "";
      }else{
        carModel.value = "";
        carType.value  = "";
        dailyRent.value = "";
        carHint.style.display="none";
        carHint.textContent="";
      }
      clearAlert();
    });

    resetBtn.addEventListener("click", ()=>{
      form.reset();
      driverInfo.style.display="none";
      carHint.style.display="none";
      carModel.value = "";
      carType.value  = "";
      driverSearch.value = "";
      carSearch.value = "";
      calcPanel.style.display="none";
      clearAlert();
      setDefaultStart();
      // Ø±Ø¬Ù‘Ø¹ ÙƒÙ„ Ø§Ù„Ø§Ø®ØªÙŠØ§Ø±Ø§Øª Ø¸Ø§Ù‡Ø±Ø©
      filterDriverOptions("");
      filterCarOptions("");
    });

    // ================== Ø¹Ø±Ø¶ Ù…Ù„Ø®Øµ Ø§Ù„Ø¬Ù…Ø¹Ø© + Ø§Ù„ØªÙƒÙ„ÙØ© ==================
    function showCalcSummary(auth){
      if (!auth) {
        calcPanel.style.display = "none";
        return;
      }
      const issue   = auth.issue_date;
      const start   = auth.start_date;
      const planned = auth.planned_end_date || auth.end_date;
      const days    = auth.rental_days;
      const total   = auth.planned_amount;
      const rent    = auth.daily_rent;

      sumIssueDate.textContent = formatDT(issue);
      sumStartDate.textContent = formatDT(start);
      sumPlannedEnd.textContent= formatDT(planned);
      sumDays.textContent      = (typeof days === "number") ? `${days} ÙŠÙˆÙ…` : "â€”";
      sumDailyRent.textContent = (rent != null) ? `${rent} Ø±ÙŠØ§Ù„` : "â€”";
      sumTotal.textContent     = (typeof total === "number") ? `${total.toFixed(2)} Ø±ÙŠØ§Ù„` : "â€”";

      calcPanel.style.display = "block";
    }

    // ================== Prefill Ù…Ù† Ø§Ù„Ù€ URL ==================
    function preselectFromURL(){
      // Ø§Ù„Ø³Ø§Ø¦Ù‚
      const driverIdParam   = urlParams.get("driver_id");
      const driverNameParam = urlParams.get("driver_name");
      if (driverIdParam) {
        const opt = Array.from(driverSelect.options).find(
          o => String(o.value) === String(driverIdParam)
        );
        if (opt) {
          driverSelect.value = opt.value;
          driverSelect.dispatchEvent(new Event("change"));
        }
      } else if (driverNameParam) {
        const opt = Array.from(driverSelect.options).find(
          o => (o.dataset.name || "").trim() === driverNameParam.trim()
        );
        if (opt) {
          driverSelect.value = opt.value;
          driverSelect.dispatchEvent(new Event("change"));
        }
      }

      // Ø§Ù„Ø³ÙŠØ§Ø±Ø©
      const carIdParam   = urlParams.get("car_id");
      const carNumParam  = urlParams.get("car_number") || urlParams.get("plate");
      if (carIdParam) {
        const opt = Array.from(carSelect.options).find(
          o => String(o.value) === String(carIdParam)
        );
        if (opt) {
          carSelect.value = opt.value;
          carSelect.dispatchEvent(new Event("change"));
        }
      } else if (carNumParam) {
        const opt = Array.from(carSelect.options).find(
          o => (o.dataset.plate || "").trim() === carNumParam.trim()
        );
        if (opt) {
          carSelect.value = opt.value;
          carSelect.dispatchEvent(new Event("change"));
        }
      }
    }

    // ================== Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ù†Ù…ÙˆØ°Ø¬ ==================
    form.addEventListener("submit", async (e)=>{
      e.preventDefault();
      clearAlert();
      calcPanel.style.display="none";

      if(!driverSelect.value){
        showAlert("Ù…Ù† ÙØ¶Ù„Ùƒ Ø§Ø®ØªØ± Ø§Ù„Ø³Ø§Ø¦Ù‚.");
        return;
      }
      if(!carSelect.value){
        showAlert("Ù…Ù† ÙØ¶Ù„Ùƒ Ø§Ø®ØªØ± Ø§Ù„Ø³ÙŠØ§Ø±Ø©.");
        return;
      }

      const driverOpt = driverSelect.selectedOptions[0];
      const carOpt    = carSelect.selectedOptions[0];

      const payload = {
        driver_id: driverSelect.value ? Number(driverSelect.value) : null,
        car_id:    carSelect.value    ? Number(carSelect.value)    : null,

        driver_name: driverOpt
          ? (driverOpt.dataset.name || driverOpt.textContent || "").trim()
          : null,
        car_number:  carOpt
          ? (carOpt.dataset.plate || carOpt.textContent || "").trim()
          : null,

        start_date:  (startDate.value || "").trim(),
        details:     (details.value || "").trim()
      };

      if (carModel.value) payload.car_model = carModel.value;
      if (carType.value)  payload.car_type  = carType.value;

      const rentVal = (dailyRent.value || "").trim();
      if (rentVal !== "") {
        const n = Number(rentVal);
        if (Number.isNaN(n)) {
          showAlert("Ù‚ÙŠÙ…Ø© Ø§Ù„Ø¥ÙŠØ¬Ø§Ø± Ø§Ù„ÙŠÙˆÙ…ÙŠ ØºÙŠØ± ØµØ­ÙŠØ­Ø©.");
          return;
        }
        payload.daily_rent = n;
      }

      try{
        const res = await fetch("/api/issue", {
          method:"POST",
          headers:{"Content-Type":"application/json"},
          body:JSON.stringify(payload)
        });

        const data = await res.json().catch(()=> ({}));

        if (res.ok) {
          showAlert("âœ… ØªÙ… Ø­ÙØ¸ Ø§Ù„ØªÙÙˆÙŠØ¶ Ø¨Ù†Ø¬Ø§Ø­ØŒ ÙˆØªÙ… Ø§Ø­ØªØ³Ø§Ø¨ Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ø¬Ù…Ø¹Ø© Ø§Ù„Ù…Ø­Ø§Ø³Ø¨ÙŠØ©.", "ok");
          const auth = data.authorization || null;
          showCalcSummary(auth);
        } else {
          showAlert(data.error || "ØªØ¹Ø°Ù‘Ø± Ø­ÙØ¸ Ø§Ù„ØªÙÙˆÙŠØ¶.");
        }
      }catch(err){
        console.error(err);
        showAlert("âš ï¸ Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø®Ø§Ø¯Ù….");
      }
    });

    // ================== Ø¥Ù‚Ù„Ø§Ø¹ Ø§Ù„ØµÙØ­Ø© ==================
    async function bootstrap(){
      try{
        setDefaultStart();
        await Promise.all([loadDrivers(), loadCars()]);
        preselectFromURL();
        // ÙÙ„ØªØ±Ø© Ù…Ø¨Ø¯Ø¦ÙŠØ© (ÙƒÙ„ Ø§Ù„Ø®ÙŠØ§Ø±Ø§Øª Ø¸Ø§Ù‡Ø±Ø©)
        filterDriverOptions("");
        filterCarOptions("");
      }catch(e){
        console.error(e);
        showAlert("âš ï¸ ØªØ¹Ø°Ù‘Ø± ØªØ­Ù…ÙŠÙ„ Ù‚ÙˆØ§Ø¦Ù… Ø§Ù„Ø³Ø§Ø¦Ù‚ÙŠÙ† ÙˆØ§Ù„Ø³ÙŠØ§Ø±Ø§Øª Ù…Ù† Ø§Ù„Ø®Ø§Ø¯Ù….");
      }
    }
    bootstrap();
  </script>
</body>
</html>
