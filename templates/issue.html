<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>ğŸ“ Ø¥ØµØ¯Ø§Ø± ØªÙÙˆÙŠØ¶ Ø¬Ø¯ÙŠØ¯</title>

  <style>
    :root{
      --bg1:#0d6efd; --bg2:#6c63ff; 
      --ok:#0abf53; --err:#e03131; 
      --ink:#111827;
      --card:#ffffff; --muted:#6b7280; 
      --border:#e5e7eb;
    }

    *{box-sizing:border-box}

    body{
      font-family:"Tajawal",system-ui,-apple-system,"Segoe UI",Roboto,Ubuntu,"Helvetica Neue",Arial;
      margin:0;
      min-height:100vh;
      background:linear-gradient(135deg,var(--bg1),var(--bg2));
      color:var(--ink);
    }

    /* Ø´Ø±ÙŠØ· Ø¹Ù„ÙˆÙŠ */
    .top-bar{
      position:fixed;
      top:0;right:0;left:0;
      z-index:1000;
      background:rgba(0,0,0,0.25);
      backdrop-filter:blur(8px);
      padding:10px 16px;
      display:flex;
      align-items:center;
      gap:10px;
      flex-wrap:wrap;
    }

    .nav-group{
      display:flex;
      gap:8px;
    }

    .back-btn{
      border:none;
      border-radius:999px;
      padding:8px 16px;
      font-size:14px;
      font-weight:600;
      cursor:pointer;
      background:#fff;
      color:#0d6efd;
      display:inline-flex;
      gap:6px;
    }

    .back-btn:hover{
      background:#0d6efd;
      color:#fff;
    }

    .page-title{
      margin:0;
      flex:1;
      text-align:center;
      color:#fff;
      font-size:18px;
      font-weight:700;
    }

    /* Ø§Ù„Ù…Ø­ØªÙˆÙ‰ */
    .page-content{
      padding:80px 16px 24px;
      display:flex;
      justify-content:center;
    }

    .card{
      width:100%;
      max-width:620px;
      background:var(--card);
      border-radius:20px;
      box-shadow:0 16px 40px rgba(0,0,0,.22);
      padding:20px;
    }

    h1{margin:0 0 6px;font-size:22px;}
    p.sub{margin:0 0 16px;font-size:14px;color:var(--muted);}

    label{
      display:block;
      margin:10px 4px 6px;
      font-size:13px;
      font-weight:600;
    }

    select,input,textarea{
      width:100%;
      padding:10px 12px;
      border:1px solid var(--border);
      border-radius:12px;
      font-size:14px;
      outline:none;
    }

    select.searchable { padding-right:14px; }

    textarea{
      min-height:90px;
      resize:vertical;
    }

    select:focus,input:focus,textarea:focus{
      border-color:var(--bg1);
      box-shadow:0 0 0 1px rgba(13,110,253,0.2);
    }

    .row{display:flex;gap:10px}
    .col{flex:1}

    .actions{
      margin-top:14px;
      display:flex;
      justify-content:flex-end;
      gap:10px;
    }

    button{
      padding:11px 16px;
      border:none;
      border-radius:12px;
      font-weight:600;
      cursor:pointer;
      background:var(--bg1);
      color:#fff;
    }

    button.ghost{
      background:#f3f4f6;
      color:#111;
    }

    .alert{
      display:none;
      padding:10px 12px;
      border-radius:12px;
      margin:10px 0;
      font-size:13px;
    }

    .alert.ok{
      display:block;
      background:#e8f8f0;
      border:1px solid #a6e8c5;
      color:#0a6640;
    }

    .alert.err{
      display:block;
      background:#fdecec;
      border:1px solid #f5b9b7;
      color:#b81c1c;
    }

    .hint{
      font-size:12px;
      color:var(--muted);
      margin-top:4px;
    }

    .badge{
      padding:6px 10px;
      background:#f3f4f6;
      border-radius:999px;
      font-size:12px;
      margin:6px 0;
      display:inline-block;
    }

    /* Ù…Ù„Ø®Øµ */
    .calc-panel{
      display:none;
      margin-top:16px;
      padding:12px;
      background:#f9fafb;
      border-radius:14px;
      border:1px dashed #d1d5db;
    }

  </style>
</head>

<body>

<header class="top-bar">
  <div class="nav-group">
    <button class="back-btn" onclick="location.href='/'">ğŸ  Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</button>
    <button class="back-btn" onclick="location.href='/cars'">ğŸš— Ø§Ù„Ø³ÙŠØ§Ø±Ø§Øª</button>
    <button class="back-btn" onclick="location.href='/drivers'">ğŸ§‘â€âœˆï¸ Ø§Ù„Ø³Ø§Ø¦Ù‚ÙˆÙ†</button>
    <button class="back-btn" onclick="location.href='/authorizations'">ğŸ“„ Ø§Ù„ØªÙÙˆÙŠØ¶Ø§Øª</button>
    <button class="back-btn" onclick="location.href='/operations'">ğŸ§¾ Ø§Ù„Ø¹Ù…Ù„ÙŠØ§Øª</button>
  </div>
  <h2 class="page-title">ğŸ“ Ø¥ØµØ¯Ø§Ø± ØªÙÙˆÙŠØ¶ Ø¬Ø¯ÙŠØ¯</h2>
</header>

<main class="page-content">
  <div class="card">

    <h1>ğŸ“ Ø¥ØµØ¯Ø§Ø± ØªÙÙˆÙŠØ¶ Ø¬Ø¯ÙŠØ¯</h1>
    <p class="sub">Ø§Ø®ØªØ± Ø§Ù„Ø³Ø§Ø¦Ù‚ ÙˆØ§Ù„Ø³ÙŠØ§Ø±Ø©ØŒ ÙˆØ­Ø¯Ø¯ Ø¨Ø¯Ø§ÙŠØ© Ø§Ù„ØªÙÙˆÙŠØ¶.</p>

    <div id="alertBox" class="alert"></div>

    <form id="issueForm">

      <!-- Ø§Ù„Ø³Ø§Ø¦Ù‚ -->
      <label>Ø§Ù„Ø³Ø§Ø¦Ù‚</label>
      <select id="driverSelect" class="searchable" required>
        <option value="">Ø§Ø®ØªØ± Ø§Ù„Ø³Ø§Ø¦Ù‚...</option>
      </select>
      <div id="driverInfo" class="hint" style="display:none"></div>

      <!-- Ø§Ù„Ø³ÙŠØ§Ø±Ø© -->
      <label>Ø§Ù„Ø³ÙŠØ§Ø±Ø©</label>
      <select id="carSelect" class="searchable" required>
        <option value="">Ø§Ø®ØªØ± Ø§Ù„Ø³ÙŠØ§Ø±Ø©...</option>
      </select>
      <div id="carHint" class="hint" style="display:none"></div>

      <!-- ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø³ÙŠØ§Ø±Ø© -->
      <div class="row">
        <div class="col">
          <label>Ø§Ù„Ù…ÙˆØ¯ÙŠÙ„</label>
          <input id="carModel" type="text" readonly />
        </div>
        <div class="col">
          <label>Ø§Ù„Ù†ÙˆØ¹</label>
          <input id="carType" type="text" readonly />
        </div>
      </div>

      <div class="row">
        <div class="col">
          <label>Ø§Ù„Ø¥ÙŠØ¬Ø§Ø± Ø§Ù„ÙŠÙˆÙ…ÙŠ</label>
          <input id="dailyRent" type="number" step="0.01" placeholder="Ù…Ø«Ø§Ù„: 150"/>
        </div>
        <div class="col">
          <label>ØªØ§Ø±ÙŠØ® Ø¨Ø¯Ø§ÙŠØ© Ø§Ù„ØªÙÙˆÙŠØ¶</label>
          <input id="startDate" type="datetime-local" />
        </div>
      </div>

      <label>Ù…Ù„Ø§Ø­Ø¸Ø§Øª</label>
      <textarea id="details"></textarea>

      <div class="actions">
        <button type="button" class="ghost" id="resetBtn">ØªÙØ±ÙŠØº</button>
        <button type="submit">ğŸ’¾ Ø­ÙØ¸ Ø§Ù„ØªÙÙˆÙŠØ¶</button>
      </div>

    </form>

    <div class="badge">ğŸš— ØªØªØ­ÙˆÙ„ Ø§Ù„Ø³ÙŠØ§Ø±Ø© Ø¥Ù„Ù‰ â€œÙ…Ø¤Ø¬Ø±Ø©â€ ØªÙ„Ù‚Ø§Ø¦ÙŠÙ‹Ø§ Ø¨Ø¹Ø¯ Ø­ÙØ¸ Ø§Ù„ØªÙÙˆÙŠØ¶</div>

    <div id="calcPanel" class="calc-panel"></div>

  </div>
</main>

<script>

let DRIVERS = [];
let CARS = [];

/* =========== Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø¨Ø­Ø« Ø¯Ø§Ø®Ù„ select =========== */
function makeSelectSearchable(selectEl, list, labelFn) {
  let original = [...list];

  selectEl.addEventListener("input", function () {
    const t = selectEl.value.toLowerCase().trim();

    let filtered = t
      ? original.filter(x => labelFn(x).toLowerCase().includes(t))
      : original;

    selectEl.innerHTML = '<option value="">Ø§Ø®ØªØ±...</option>';

    filtered.forEach(item => {
      const opt = document.createElement("option");
      opt.value = item.id;
      opt.textContent = labelFn(item);

      for (const k in item) {
        if (item[k] !== null) opt.dataset[k] = item[k];
      }

      selectEl.appendChild(opt);
    });
  });
}

/* =========== ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø³Ø§Ø¦Ù‚ÙŠÙ† =========== */
async function loadDrivers(){
  const r = await fetch("/api/drivers");
  const data = await r.json();
  DRIVERS = data;

  makeSelectSearchable(
    driverSelect,
    DRIVERS,
    d => `${d.name} - ${d.phone || ""} - ${d.license_no || ""}`
  );
}

/* =========== ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø³ÙŠØ§Ø±Ø§Øª =========== */
async function loadCars(){
  const r = await fetch("/api/cars");
  const data = await r.json();
  CARS = data;

  makeSelectSearchable(
    carSelect,
    CARS,
    c => `${c.plate} - ${c.model || ""} - ${c.car_type || ""}`
  );
}

/* =========== ØªÙØ§Ø¹Ù„ Ø§Ù„Ø§Ø®ØªÙŠØ§Ø± =========== */
driverSelect.addEventListener("change", ()=>{
  const o = driverSelect.selectedOptions[0];
  if (!o.value){ driverInfo.style.display="none"; return; }

  driverInfo.style.display="block";
  driverInfo.textContent = `ğŸ“ ${o.dataset.phone || "â€”"} â€¢ Ø±Ø®ØµØ©: ${o.dataset.license || "â€”"}`;
});

carSelect.addEventListener("change", ()=>{
  const o = carSelect.selectedOptions[0];
  if (!o.value){ 
    carModel.value=""; 
    carType.value="";
    carHint.style.display="none";
    return;
  }

  carModel.value = o.dataset.model || "";
  carType.value  = o.dataset.type || "";

  carHint.style.display="block";
  carHint.textContent = `ğŸš— Ø¥ÙŠØ¬Ø§Ø± ÙŠÙˆÙ…ÙŠ Ù…Ø­ÙÙˆØ¸: ${o.dataset.rent || "â€”"} Ø±ÙŠØ§Ù„`;
});

/* =========== Ø­ÙØ¸ Ø§Ù„ØªÙÙˆÙŠØ¶ =========== */
issueForm.addEventListener("submit", async e=>{
  e.preventDefault();

  if (!driverSelect.value) return showErr("Ø§Ø®ØªØ± Ø§Ù„Ø³Ø§Ø¦Ù‚.");
  if (!carSelect.value) return showErr("Ø§Ø®ØªØ± Ø§Ù„Ø³ÙŠØ§Ø±Ø©.");

  const payload = {
    driver_id: Number(driverSelect.value),
    car_id: Number(carSelect.value),
    start_date: startDate.value,
    details: details.value,
    daily_rent: dailyRent.value ? Number(dailyRent.value) : null
  };

  const r = await fetch("/api/issue", {
    method:"POST",
    headers:{"Content-Type":"application/json"},
    body:JSON.stringify(payload)
  });

  const data = await r.json();

  if (r.ok) showOK("ØªÙ… Ø­ÙØ¸ Ø§Ù„ØªÙÙˆÙŠØ¶ Ø¨Ù†Ø¬Ø§Ø­.");
  else showErr(data.error || "ÙØ´Ù„ Ø­ÙØ¸ Ø§Ù„ØªÙÙˆÙŠØ¶");
});

/* =========== Ø±Ø³Ø§Ø¦Ù„ =========== */
function showErr(t){
  alertBox.className="alert err";
  alertBox.textContent=t;
  alertBox.style.display="block";
}

function showOK(t){
  alertBox.className="alert ok";
  alertBox.textContent=t;
  alertBox.style.display="block";
}

/* =========== Ø¨Ø¯Ø§ÙŠØ© Ø§Ù„ØµÙØ­Ø© =========== */
(async ()=>{
  await loadDrivers();
  await loadCars();
})();
</script>

</body>
</html>
