<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <title>ğŸ“‘ Ø¯ÙØªØ± Ø§Ù„Ø£Ø³ØªØ§Ø° / ÙƒØ´Ù Ø­Ø³Ø§Ø¨</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <style>
    :root {
      --bg1:#0d6efd;
      --bg2:#6c63ff;
      --card:#111827;
      --ink:#f9fafb;
      --muted:#9ca3af;
      --border:#374151;
      --accent:#2563eb;
      --danger:#dc2626;
      --success:#16a34a;
      --print-bg:#ffffff;
      --print-ink:#111827;
    }

    * { box-sizing: border-box; }

    body {
      margin: 0;
      min-height: 100vh;
      font-family: "Tajawal", system-ui, -apple-system, "Segoe UI", sans-serif;
      background: linear-gradient(135deg, var(--bg1), var(--bg2));
      color: var(--ink);
      display: flex;
      justify-content: center;
      padding: 16px;
    }

    .container {
      width: 100%;
      max-width: 1200px;
      background: radial-gradient(circle at top left, rgba(255,255,255,0.25), transparent 55%),
                  radial-gradient(circle at bottom right, rgba(15,23,42,0.55), transparent 55%),
                  #020617;
      border-radius: 18px;
      padding: 20px;
      box-shadow: 0 24px 70px rgba(0,0,0,0.45);
    }

    .header {
      display: flex;
      flex-wrap: wrap;
      align-items: center;
      justify-content: space-between;
      gap: 12px;
      margin-bottom: 18px;
    }

    .title-group h1 {
      margin: 0;
      font-size: 1.6rem;
    }

    .title-group p {
      margin: 4px 0 0;
      font-size: 0.9rem;
      color: #e5e7eb;
    }

    .top-buttons {
      display:flex;
      gap:8px;
      flex-wrap:wrap;
    }

    .btn-back {
      padding: 8px 14px;
      border-radius: 999px;
      border: 1px solid rgba(148,163,184,0.6);
      background: rgba(15,23,42,0.9);
      color: #e5e7eb;
      cursor: pointer;
      font-size: 0.9rem;
      display: inline-flex;
      align-items: center;
      gap: 6px;
      transition: 0.2s ease;
      text-decoration: none;
    }

    .btn-back:hover {
      background: rgba(15,23,42,1);
      transform: translateY(-1px);
    }

    .layout {
      display: grid;
      grid-template-columns: minmax(0, 1.02fr) minmax(0, 1.6fr);
      gap: 18px;
    }

    @media (max-width: 960px) {
      .layout {
        grid-template-columns: 1fr;
      }
    }

    .card {
      background: var(--card);
      border-radius: 14px;
      padding: 14px 14px 12px;
      border: 1px solid rgba(148,163,184,0.45);
      box-shadow: 0 14px 40px rgba(0,0,0,0.48);
    }

    .card-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 10px;
      gap: 8px;
    }

    .card-header h2 {
      margin: 0;
      font-size: 1rem;
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .card-header span.badge {
      padding: 3px 9px;
      border-radius: 999px;
      font-size: 0.75rem;
      background: rgba(37,99,235,0.12);
      border: 1px solid rgba(59,130,246,0.4);
      color: #dbeafe;
    }

    .card-body {
      font-size: 0.9rem;
    }

    label {
      display: block;
      margin-bottom: 4px;
      font-size: 0.85rem;
      color: #e5e7eb;
    }

    .field {
      margin-bottom: 8px;
    }

    input[type="text"],
    input[type="date"],
    select {
      width: 100%;
      padding: 7px 9px;
      border-radius: 9px;
      border: 1px solid rgba(148,163,184,0.6);
      background: #020617;
      color: var(--ink);
      font-size: 0.9rem;
      outline: none;
      transition: 0.15s ease;
    }

    input[type="text"]:focus,
    input[type="date"]:focus,
    select:focus {
      border-color: var(--accent);
      box-shadow: 0 0 0 1px rgba(37,99,235,0.45);
    }

    .hint {
      font-size: 0.78rem;
      color: var(--muted);
    }

    .info-box {
      background: rgba(15,23,42,0.9);
      border-radius: 10px;
      border: 1px solid var(--border);
      padding: 10px 10px 8px;
      margin-top: 6px;
      font-size: 0.83rem;
    }

    .info-row {
      display: flex;
      flex-wrap: wrap;
      gap: 6px 16px;
      margin-bottom: 4px;
    }

    .info-label {
      color: var(--muted);
    }

    .info-value {
      color: #e5e7eb;
      font-weight: 500;
    }

    .badge-type {
      padding: 2px 8px;
      border-radius: 999px;
      font-size: 0.75rem;
      border: 1px solid rgba(148,163,184,0.7);
      color: #e5e7eb;
      white-space: nowrap;
    }

    .badge-type.asset { border-color:#22c55e; color:#bbf7d0; }
    .badge-type.liability { border-color:#f97316; color:#fed7aa; }
    .badge-type.revenue { border-color:#38bdf8; color:#bae6fd; }
    .badge-type.expense { border-color:#f97373; color:#fecaca; }

    .actions {
      margin-top: 10px;
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      justify-content: flex-start;
    }

    .btn {
      border-radius: 999px;
      padding: 7px 14px;
      font-size: 0.85rem;
      border: none;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      gap: 6px;
      transition: 0.15s ease;
      white-space: nowrap;
    }

    .btn-primary {
      background: linear-gradient(135deg, #2563eb, #4f46e5);
      color: white;
      box-shadow: 0 8px 20px rgba(37,99,235,0.4);
    }

    .btn-primary:hover {
      filter: brightness(1.08);
      transform: translateY(-1px);
    }

    .btn-ghost {
      background: transparent;
      color: #e5e7eb;
      border: 1px solid rgba(148,163,184,0.7);
    }

    .btn-ghost:hover {
      background: rgba(15,23,42,0.9);
    }

    .btn-print {
      background: transparent;
      color: #f97316;
      border: 1px solid rgba(248,150,69,0.9);
    }

    .btn-print:hover {
      background: rgba(251,146,60,0.15);
    }

    .message {
      margin-top: 8px;
      font-size: 0.8rem;
      padding: 6px 9px;
      border-radius: 9px;
      display: none;
    }

    .message.error {
      background: rgba(220,38,38,0.08);
      border: 1px solid rgba(220,38,38,0.85);
      color: #fecaca;
    }

    .message.success {
      background: rgba(22,163,74,0.08);
      border: 1px solid rgba(22,163,74,0.9);
      color: #bbf7d0;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      font-size: 0.82rem;
    }

    th, td {
      padding: 6px 6px;
      border-bottom: 1px solid rgba(55,65,81,0.7);
      text-align: right;
      white-space: nowrap;
    }

    thead {
      background: #020617;
    }

    th {
      font-weight: 600;
      color: #e5e7eb;
      font-size: 0.78rem;
    }

    tbody tr:nth-child(odd) {
      background: rgba(15,23,42,0.85);
    }

    tbody tr:nth-child(even) {
      background: rgba(15,23,42,0.65);
    }

    tbody tr:hover {
      background: rgba(37,99,235,0.25);
    }

    .ledger-wrapper {
      border-radius: 10px;
      border: 1px solid var(--border);
      overflow: auto;
      max-height: 440px;
      background: rgba(15,23,42,0.9);
    }

    .badge-count {
      font-size: 0.8rem;
      color: var(--muted);
    }

    .empty-state {
      text-align: center;
      padding: 12px 5px;
      font-size: 0.85rem;
      color: var(--muted);
    }

    .totals-footer {
      margin-top: 6px;
      display: flex;
      flex-wrap: wrap;
      gap: 16px;
      font-size: 0.82rem;
      color: var(--muted);
    }

    .totals-footer span strong {
      color: #e5e7eb;
    }

    .filter-row {
      display: grid;
      grid-template-columns: minmax(0,1.1fr) minmax(0,0.9fr);
      gap: 8px;
      margin-top: 4px;
      margin-bottom: 8px;
    }

    .filter-row-2 {
      display: grid;
      grid-template-columns: repeat(2, minmax(0,1fr));
      gap: 8px;
      margin-bottom: 4px;
    }

    .small-label {
      font-size: 0.8rem;
      color: var(--muted);
    }

    .print-header {
      display:none;
    }

    @media print {
      body {
        background: var(--print-bg);
        color: var(--print-ink);
        padding: 0;
      }
      .container {
        background: var(--print-bg);
        color: var(--print-ink);
        box-shadow: none;
        border-radius: 0;
        max-width: 100%;
        padding: 10mm 12mm;
      }
      .header,
      .top-buttons,
      .btn,
      .actions,
      .hint,
      .message {
        display: none !important;
      }
      .card {
        box-shadow: none;
        border-radius: 0;
        border: none;
        padding: 0;
      }
      .layout {
        grid-template-columns: 1fr;
      }
      .ledger-wrapper {
        max-height: none;
      }
      .print-header {
        display:block;
        margin-bottom: 8px;
        font-size: 0.9rem;
      }
      table, th, td {
        border-color:#e5e7eb !important;
        color:#111827 !important;
      }
    }
  </style>
</head>

<body>
  <div class="container">
    <!-- Header -->
    <div class="header">
      <div class="title-group">
        <h1>ğŸ“‘ Ø¯ÙØªØ± Ø§Ù„Ø£Ø³ØªØ§Ø° / ÙƒØ´Ù Ø­Ø³Ø§Ø¨</h1>
        <p>
          Ù‡Ø°Ù‡ Ø§Ù„ØµÙØ­Ø© Ø¬Ø²Ø¡ Ù…Ù† Ù…ÙˆØ¯ÙŠÙˆÙ„ Ø§Ù„Ù…Ø­Ø§Ø³Ø¨Ø©ØŒ ÙˆÙŠÙ…ÙƒÙ† ÙØªØ­Ù‡Ø§ Ù…Ù† <strong>ØµÙØ­Ø© Ø§Ù„Ø¹Ù…Ù„ÙŠØ§Øª</strong> Ù„Ø¹Ø±Ø¶ ÙƒØ´Ù Ø­Ø³Ø§Ø¨ Ù„Ø£ÙŠ Ø­Ø³Ø§Ø¨ ÙÙŠ Ø´Ø¬Ø±Ø© Ø§Ù„Ø­Ø³Ø§Ø¨Ø§Øª.
        </p>
      </div>
      <div class="top-buttons">
        <a href="/" class="btn-back">
          <span>ğŸ </span>
          <span>Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</span>
        </a>
        <a href="/operations" class="btn-back">
          <span>ğŸ§¾</span>
          <span>ØµÙØ­Ø© Ø§Ù„Ø¹Ù…Ù„ÙŠØ§Øª</span>
        </a>
        <a href="/accounts" class="btn-back">
          <span>ğŸ“’</span>
          <span>Ø¯Ù„ÙŠÙ„ Ø§Ù„Ø­Ø³Ø§Ø¨Ø§Øª</span>
        </a>
        <a href="/general" class="btn-back">
          <span>ğŸ““</span>
          <span>Ø§Ù„ÙŠÙˆÙ…ÙŠØ© Ø§Ù„Ø¹Ø§Ù…Ø©</span>
        </a>
      </div>
    </div>

    <!-- Print header (ÙŠØ¸Ù‡Ø± ÙÙ‚Ø· ÙÙŠ Ø§Ù„Ø·Ø¨Ø§Ø¹Ø©) -->
    <div class="print-header">
      <h2 style="margin:0 0 4px;">ÙƒØ´Ù Ø­Ø³Ø§Ø¨</h2>
      <div id="printAccountName" style="font-size:0.9rem; margin-bottom:2px;"></div>
      <div id="printDateRange" style="font-size:0.8rem; color:#4b5563;"></div>
    </div>

    <div class="layout">
      <!-- left: filters & account info -->
      <div class="card">
        <div class="card-header">
          <h2>âš™ï¸ Ø¥Ø¹Ø¯Ø§Ø¯ ÙƒØ´Ù Ø§Ù„Ø­Ø³Ø§Ø¨</h2>
          <span class="badge">Ù…Ø±ØªØ¨Ø· Ø¨Ø­Ø±ÙƒØ§Øª ØµÙØ­Ø© Ø§Ù„Ø¹Ù…Ù„ÙŠØ§Øª</span>
        </div>
        <div class="card-body">

          <div class="field">
            <label for="accountSelect">Ø§Ù„Ø­Ø³Ø§Ø¨</label>
            <select id="accountSelect">
              <option value="">Ø§Ø®ØªØ± Ø­Ø³Ø§Ø¨Ø§Ù‹ Ù…Ù† Ø¯Ù„ÙŠÙ„ Ø§Ù„Ø­Ø³Ø§Ø¨Ø§Øª...</option>
            </select>
            <div class="hint">
              Ù„Ùˆ Ù…Ø´ Ù„Ø§Ù‚ÙŠ Ø§Ù„Ø­Ø³Ø§Ø¨ØŒ ØªØ£ÙƒØ¯ Ø¥Ù†Ù‡ Ù…Ø¶Ø§Ù Ù…Ù† ØµÙØ­Ø© <strong>Ø¯Ù„ÙŠÙ„ Ø§Ù„Ø­Ø³Ø§Ø¨Ø§Øª</strong> ÙˆØ£Ù† Ø§Ù„Ø¹Ù…Ù„ÙŠØ§Øª Ù…Ø³Ø¬Ù„Ø© Ø¹Ù„ÙŠÙ‡ Ù…Ù† ØµÙØ­Ø© Ø§Ù„Ø¹Ù…Ù„ÙŠØ§Øª / Ø§Ù„ÙŠÙˆÙ…ÙŠØ©.
            </div>
          </div>

          <div class="filter-row">
            <div class="field">
              <label for="accountSearch">Ø¨Ø­Ø« Ø¹Ù† Ø­Ø³Ø§Ø¨ Ø¨Ø§Ù„Ø§Ø³Ù… Ø£Ùˆ Ø§Ù„ÙƒÙˆØ¯</label>
              <input id="accountSearch" type="text" placeholder="Ø§ÙƒØªØ¨ Ø¬Ø²Ø¡ Ù…Ù† Ø§Ø³Ù… Ø§Ù„Ø­Ø³Ø§Ø¨ Ø£Ùˆ Ø§Ù„ÙƒÙˆØ¯..." />
              <div class="hint">Ù…Ø«Ø§Ù„: "1101" Ø£Ùˆ "Ø³Ø§Ø¦Ù‚ÙŠÙ†" Ø£Ùˆ "Ø¥ÙŠØ±Ø§Ø¯".</div>
            </div>
            <div class="field">
              <label class="small-label">Ø­Ø³Ø§Ø¨Ø§Øª Ù…ØªØ§Ø­Ø©</label>
              <div class="hint" id="accountsCountHint">â€”</div>
            </div>
          </div>

          <div class="field">
            <label>ÙÙ„ØªØ±Ø© Ø¹Ù„Ù‰ Ù…Ø³ØªÙˆÙ‰ Ø§Ù„Ø­Ø±ÙƒØ©</label>
            <div class="filter-row-2">
              <div>
                <label for="fromDate" class="small-label">Ù…Ù† ØªØ§Ø±ÙŠØ®</label>
                <input id="fromDate" type="date" />
              </div>
              <div>
                <label for="toDate" class="small-label">Ø¥Ù„Ù‰ ØªØ§Ø±ÙŠØ®</label>
                <input id="toDate" type="date" />
              </div>
            </div>
            <div class="field">
              <label for="textFilter">Ø¨Ø­Ø« Ù†ØµÙ‘ÙŠ Ø¯Ø§Ø®Ù„ Ø§Ù„Ø­Ø±ÙƒØ©</label>
              <input id="textFilter" type="text" placeholder="Ø¨Ø­Ø« ÙÙŠ Ø§Ù„ÙˆØµÙ / Ù…Ù„Ø§Ø­Ø¸Ø§Øª / Ø±Ù‚Ù… Ø§Ù„Ø±Ø®ØµØ© Ø¥Ù† ÙˆÙØ¬Ø¯..." />
            </div>
            <div class="hint">
              Ø§Ù„ÙÙ„ØªØ±Ø© Ø¯ÙŠ Ø¨ØªØ´ØªØºÙ„ Ø¹Ù„Ù‰ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø¹Ø±ÙˆØ¶Ø© ÙÙ‚Ø· (client-side)ØŒ Ø¨Ø¯ÙˆÙ† Ø§Ø³ØªØ¹Ù„Ø§Ù… Ø¥Ø¶Ø§ÙÙŠ Ù…Ù† Ø§Ù„Ø³ÙŠØ±ÙØ±.
            </div>
          </div>

          <div class="info-box" id="accountInfoBox">
            <div class="info-row">
              <span class="info-label">Ø§Ù„Ø­Ø³Ø§Ø¨ Ø§Ù„Ù…Ø­Ø¯Ø¯:</span>
              <span class="info-value" id="infoAccountName">â€”</span>
            </div>
            <div class="info-row">
              <span class="info-label">Ø§Ù„Ù†ÙˆØ¹:</span>
              <span id="infoAccountType" class="badge-type">â€”</span>
            </div>
            <div class="info-row">
              <span class="info-label">ID Ø¯Ø§Ø®Ù„ÙŠ:</span>
              <span class="info-value" id="infoAccountId">â€”</span>
            </div>
          </div>

          <div class="actions">
            <button type="button" class="btn btn-primary" id="btnLoadLedger">
              ğŸ“¥ ØªØ­Ù…ÙŠÙ„ ÙƒØ´Ù Ø§Ù„Ø­Ø³Ø§Ø¨
            </button>
            <button type="button" class="btn btn-print" id="btnPrint">
              ğŸ–¨ï¸ Ø·Ø¨Ø§Ø¹Ø© / Ø­ÙØ¸ PDF
            </button>
            <button type="button" class="btn btn-ghost" id="btnResetFilters">
              â™»ï¸ Ù…Ø³Ø­ Ø§Ù„ÙÙ„Ø§ØªØ±
            </button>
          </div>

          <div id="formMessage" class="message"></div>
        </div>
      </div>

      <!-- right: ledger table -->
      <div class="card">
        <div class="card-header">
          <h2>ğŸ“Š ÙƒØ´Ù Ø§Ù„Ø­Ø±ÙƒØ© Ù„Ù„Ø­Ø³Ø§Ø¨</h2>
          <span class="badge-count" id="ledgerCount">â€”</span>
        </div>
        <div class="card-body">
          <div class="ledger-wrapper">
            <table>
              <thead>
                <tr>
                  <th>Ø§Ù„ØªØ§Ø±ÙŠØ®</th>
                  <th>Ø§Ù„ÙˆØµÙ / Ø§Ù„Ø¨ÙŠØ§Ù†</th>
                  <th>Ù…Ø¯ÙŠÙ†</th>
                  <th>Ø¯Ø§Ø¦Ù†</th>
                  <th>Ø§Ù„Ø±ØµÙŠØ¯</th>
                </tr>
              </thead>
              <tbody id="ledgerBody">
                <tr>
                  <td colspan="5" class="empty-state">
                    Ù„Ù… ÙŠØªÙ… Ø§Ø®ØªÙŠØ§Ø± Ø£ÙŠ Ø­Ø³Ø§Ø¨ Ø¨Ø¹Ø¯.
                  </td>
                </tr>
              </tbody>
            </table>
          </div>
          <div class="totals-footer">
            <span>Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…Ø¯ÙŠÙ†: <strong id="totalDebit">0.00</strong></span>
            <span>Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø¯Ø§Ø¦Ù†: <strong id="totalCredit">0.00</strong></span>
            <span>Ø§Ù„Ø±ØµÙŠØ¯ Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠ: <strong id="finalBalance">0.00</strong></span>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script>
    // âœ… Ø¯Ø¹Ù… Ø§Ù„Ø±Ø¨Ø· Ù…Ù† ØµÙØ­Ø© Ø§Ù„Ø¹Ù…Ù„ÙŠØ§Øª Ø¹Ù† Ø·Ø±ÙŠÙ‚ Ø¨Ø§Ø±Ø§Ù…ÙŠØªØ±Ø§Øª URL
    // Ù…Ø«Ø§Ù„: /ledger?account_id=5&from=2025-01-01&to=2025-12-31
    const urlParams = new URLSearchParams(window.location.search);

    let allAccounts = [];
    let currentLedgerRaw = [];      // ÙƒÙ„ Ø§Ù„ØµÙÙˆÙ Ø§Ù„Ø±Ø§Ø¬Ø¹Ø© Ù…Ù† Ø§Ù„ API
    let currentLedgerFiltered = []; // Ø¨Ø¹Ø¯ Ø§Ù„ÙÙ„Ø§ØªØ±
    let currentAccount = null;

    const accountSelect = document.getElementById("accountSelect");
    const accountSearch = document.getElementById("accountSearch");
    const accountsCountHint = document.getElementById("accountsCountHint");

    const fromDateInput = document.getElementById("fromDate");
    const toDateInput = document.getElementById("toDate");
    const textFilterInput = document.getElementById("textFilter");

    const infoAccountName = document.getElementById("infoAccountName");
    const infoAccountType = document.getElementById("infoAccountType");
    const infoAccountId = document.getElementById("infoAccountId");

    const ledgerBody = document.getElementById("ledgerBody");
    const ledgerCount = document.getElementById("ledgerCount");
    const totalDebitEl = document.getElementById("totalDebit");
    const totalCreditEl = document.getElementById("totalCredit");
    const finalBalanceEl = document.getElementById("finalBalance");

    const btnLoadLedger = document.getElementById("btnLoadLedger");
    const btnPrint = document.getElementById("btnPrint");
    const btnResetFilters = document.getElementById("btnResetFilters");
    const formMessage = document.getElementById("formMessage");

    const printAccountName = document.getElementById("printAccountName");
    const printDateRange = document.getElementById("printDateRange");

    function showMessage(text, type = "success") {
      formMessage.textContent = text;
      formMessage.className = "message " + type;
      formMessage.style.display = "block";
    }

    function clearMessage() {
      formMessage.textContent = "";
      formMessage.style.display = "none";
    }

    function formatNumber(val) {
      const num = Number(val || 0);
      return num.toFixed(2);
    }

    function typeLabel(type) {
      switch (type) {
        case "asset": return "Ø£ØµÙ„ (Asset)";
        case "liability": return "Ø§Ù„ØªØ²Ø§Ù… (Liability)";
        case "revenue": return "Ø¥ÙŠØ±Ø§Ø¯ (Revenue)";
        case "expense": return "Ù…ØµØ±ÙˆÙ (Expense)";
        default: return type || "ØºÙŠØ± Ù…Ø­Ø¯Ø¯";
      }
    }

    function typeBadgeClass(type) {
      if (!type) return "badge-type";
      return "badge-type " + type;
    }

    async function loadAccounts() {
      try {
        const res = await fetch("/api/accounts");
        if (!res.ok) throw new Error("error");
        const data = await res.json();
        let list = Array.isArray(data) ? data : [];

        // Ù„Ùˆ ÙÙŠÙ‡ is_group â†’ Ù†Ø³ØªØ®Ø¯Ù… ÙÙ‚Ø· Ø§Ù„Ø­Ø³Ø§Ø¨Ø§Øª Ø§Ù„ÙØ±Ø¹ÙŠØ© (is_group = false)
        if (Array.isArray(list) && list.length > 0 && "is_group" in list[0]) {
          list = list.filter(acc => acc.is_group === false);
        }

        // ØªØ±ØªÙŠØ¨ Ø§Ù„Ø­Ø³Ø§Ø¨Ø§Øª Ø¨Ø§Ù„ÙƒÙˆØ¯ Ù„Ùˆ Ù…ÙˆØ¬ÙˆØ¯ØŒ Ø«Ù… Ø§Ù„Ø§Ø³Ù…
        list.sort((a, b) => {
          const ac = (a.code || "").toString();
          const bc = (b.code || "").toString();
          if (ac && bc && ac !== bc) {
            return ac.localeCompare(bc, "ar");
          }
          const an = (a.name || "").toString();
          const bn = (b.name || "").toString();
          return an.localeCompare(bn, "ar");
        });

        allAccounts = list;
        accountsCountHint.textContent = `${allAccounts.length} Ø­Ø³Ø§Ø¨/Ø­Ø³Ø§Ø¨Ø§Øª Ù…ØªØ§Ø­Ø©`;
        populateAccountsSelect();
      } catch (err) {
        accountsCountHint.textContent = "Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø­Ø³Ø§Ø¨Ø§Øª";
        console.error("Error loading accounts", err);
      }
    }

    function populateAccountsSelect(filteredList) {
      const list = filteredList || allAccounts;
      const currentValue = accountSelect.value;

      accountSelect.innerHTML = "";
      const defaultOpt = document.createElement("option");
      defaultOpt.value = "";
      defaultOpt.textContent = "Ø§Ø®ØªØ± Ø­Ø³Ø§Ø¨Ø§Ù‹ Ù…Ù† Ø¯Ù„ÙŠÙ„ Ø§Ù„Ø­Ø³Ø§Ø¨Ø§Øª...";
      accountSelect.appendChild(defaultOpt);

      list.forEach(acc => {
        const opt = document.createElement("option");
        opt.value = acc.id;
        const code = acc.code ? String(acc.code).trim() : "";
        const name = acc.name || "";
        opt.textContent = code ? `${code} â€” ${name}` : name;
        accountSelect.appendChild(opt);
      });

      const exists = list.some(acc => String(acc.id) === String(currentValue));
      if (exists) {
        accountSelect.value = currentValue;
      } else {
        accountSelect.value = "";
      }
    }

    accountSearch.addEventListener("input", () => {
      const term = accountSearch.value.trim().toLowerCase();
      if (!term) {
        populateAccountsSelect();
        return;
      }
      const filtered = allAccounts.filter(acc => {
        const name = (acc.name || "").toLowerCase();
        const code = (acc.code || "").toString().toLowerCase();
        return name.includes(term) || code.includes(term);
      });
      populateAccountsSelect(filtered);
    });

    accountSelect.addEventListener("change", () => {
      const id = Number(accountSelect.value || 0);
      currentAccount = allAccounts.find(acc => acc.id === id) || null;
      updateAccountInfoBox();
      currentLedgerRaw = [];
      currentLedgerFiltered = [];
      renderLedger();
    });

    function updateAccountInfoBox() {
      if (!currentAccount) {
        infoAccountName.textContent = "â€”";
        infoAccountType.textContent = "â€”";
        infoAccountType.className = "badge-type";
        infoAccountId.textContent = "â€”";
        printAccountName.textContent = "";
        return;
      }

      infoAccountName.textContent = currentAccount.name || "â€”";
      infoAccountType.textContent = typeLabel(currentAccount.type);
      infoAccountType.className = typeBadgeClass(currentAccount.type);
      infoAccountId.textContent = currentAccount.id || "â€”";

      printAccountName.textContent = `Ø§Ù„Ø­Ø³Ø§Ø¨: ${currentAccount.name} (ID: ${currentAccount.id})`;
    }

    function parseDateStringToDateObj(dateString) {
      if (!dateString) return null;
      const parts = dateString.split(" ");
      const datePart = parts[0];
      const [y, m, d] = datePart.split("-").map(Number);
      if (!y || !m || !d) return null;
      return new Date(y, m - 1, d);
    }

    function applyFilters() {
      if (!currentLedgerRaw || currentLedgerRaw.length === 0) {
        currentLedgerFiltered = [];
        renderLedger();
        return;
      }

      const fromDateVal = fromDateInput.value.trim();
      const toDateVal = toDateInput.value.trim();
      const textFilterVal = textFilterInput.value.trim().toLowerCase();

      let fromDateObj = null;
      let toDateObj = null;

      if (fromDateVal) {
        const [y, m, d] = fromDateVal.split("-").map(Number);
        fromDateObj = new Date(y, m - 1, d, 0, 0, 0);
      }
      if (toDateVal) {
        const [y, m, d] = toDateVal.split("-").map(Number);
        toDateObj = new Date(y, m - 1, d, 23, 59, 59);
      }

      currentLedgerFiltered = currentLedgerRaw.filter(row => {
        const rowDate = parseDateStringToDateObj(row.date);
        if (fromDateObj && rowDate && rowDate < fromDateObj) return false;
        if (toDateObj && rowDate && rowDate > toDateObj) return false;

        if (textFilterVal) {
          const haystack = (row.description || "").toLowerCase();
          if (!haystack.includes(textFilterVal)) return false;
        }

        return true;
      });

      renderLedger();
      updatePrintDateRange(fromDateVal, toDateVal);
    }

    function updatePrintDateRange(fromDateVal, toDateVal) {
      const fromVal = fromDateVal || fromDateInput.value.trim();
      const toVal = toDateVal || toDateInput.value.trim();

      if (!fromVal && !toVal) {
        printDateRange.textContent = "";
        return;
      }

      let text = "Ø§Ù„ÙØªØ±Ø©: ";
      if (fromVal) text += `Ù…Ù† ${fromVal} `;
      if (toVal) text += `Ø¥Ù„Ù‰ ${toVal}`;
      printDateRange.textContent = text;
    }

    function renderLedger() {
      const rows = currentLedgerFiltered && currentLedgerFiltered.length
        ? currentLedgerFiltered
        : [];

      if (!currentAccount) {
        ledgerBody.innerHTML = `
          <tr>
            <td colspan="5" class="empty-state">
              Ù„Ù… ÙŠØªÙ… Ø§Ø®ØªÙŠØ§Ø± Ø£ÙŠ Ø­Ø³Ø§Ø¨ Ø¨Ø¹Ø¯.
            </td>
          </tr>
        `;
        ledgerCount.textContent = "â€”";
        totalDebitEl.textContent = "0.00";
        totalCreditEl.textContent = "0.00";
        finalBalanceEl.textContent = "0.00";
        return;
      }

      if (rows.length === 0) {
        ledgerBody.innerHTML = `
          <tr>
            <td colspan="5" class="empty-state">
              Ù„Ø§ ØªÙˆØ¬Ø¯ Ø­Ø±ÙƒØ§Øª Ù„Ù‡Ø°Ø§ Ø§Ù„Ø­Ø³Ø§Ø¨ Ø·Ø¨Ù‚Ù‹Ø§ Ù„Ù„ÙÙ„Ø§ØªØ± Ø§Ù„Ø­Ø§Ù„ÙŠØ©.
            </td>
          </tr>
        `;
        ledgerCount.textContent = "0 Ø­Ø±ÙƒØ©";
        totalDebitEl.textContent = "0.00";
        totalCreditEl.textContent = "0.00";
        finalBalanceEl.textContent = "0.00";
        return;
      }

      ledgerBody.innerHTML = "";
      let totalDebit = 0;
      let totalCredit = 0;
      let endingBalance = 0;

      rows.forEach(row => {
        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td>${row.date || ""}</td>
          <td>${row.description || ""}</td>
          <td>${formatNumber(row.debit)}</td>
          <td>${formatNumber(row.credit)}</td>
          <td>${formatNumber(row.balance)}</td>
        `;
        ledgerBody.appendChild(tr);

        totalDebit += row.debit || 0;
        totalCredit += row.credit || 0;
        endingBalance = row.balance || endingBalance;
      });

      ledgerCount.textContent = `${rows.length} Ø­Ø±ÙƒØ©`;
      totalDebitEl.textContent = formatNumber(totalDebit);
      totalCreditEl.textContent = formatNumber(totalCredit);
      finalBalanceEl.textContent = formatNumber(endingBalance);
    }

    async function loadLedgerForSelectedAccount(autoFromURL = false) {
      clearMessage();
      const accId = Number(accountSelect.value || 0);
      if (!accId) {
        if (!autoFromURL) {
          showMessage("Ù…Ù† ÙØ¶Ù„Ùƒ Ø§Ø®ØªØ± Ø­Ø³Ø§Ø¨Ù‹Ø§ Ø£ÙˆÙ„Ø§Ù‹.", "error");
        }
        return;
      }

      currentAccount = allAccounts.find(a => a.id === accId) || null;
      updateAccountInfoBox();

      try {
        ledgerBody.innerHTML = `
          <tr>
            <td colspan="5" class="empty-state">
              Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ ÙƒØ´Ù Ø§Ù„Ø­Ø³Ø§Ø¨...
            </td>
          </tr>
        `;
        ledgerCount.textContent = "â€”";
        totalDebitEl.textContent = "0.00";
        totalCreditEl.textContent = "0.00";
        finalBalanceEl.textContent = "0.00";

        const res = await fetch(`/api/accounts/${accId}/ledger`);
        const data = await res.json();

        if (!res.ok) {
          showMessage(data.error || "Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ ØªØ­Ù…ÙŠÙ„ ÙƒØ´Ù Ø§Ù„Ø­Ø³Ø§Ø¨.", "error");
          ledgerBody.innerHTML = `
            <tr>
              <td colspan="5" class="empty-state">
                âš ï¸ ØªØ¹Ø°Ø± ØªØ­Ù…ÙŠÙ„ ÙƒØ´Ù Ø§Ù„Ø­Ø³Ø§Ø¨.
              </td>
            </tr>
          `;
          return;
        }

        // Ù„Ùˆ Ø§Ù„Ù€ backend Ø±Ø¬Ø¹ account Ù…Ø¹ lines Ù†Ø­Ø¯Ù‘Ø« Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø­Ø³Ø§Ø¨ Ù…Ù† Ù‡Ù†Ø§Ùƒ
        if (data.account) {
          const fromAll = allAccounts.find(a => a.id === data.account.id);
          currentAccount = fromAll || data.account;
          updateAccountInfoBox();
        }

        currentLedgerRaw = data.lines || [];
        applyFilters();

        if (!currentLedgerRaw.length) {
          showMessage("Ù„Ø§ ØªÙˆØ¬Ø¯ Ø­Ø±ÙƒØ§Øª Ù…Ø³Ø¬Ù‘ÙÙ„Ø© Ù„Ù‡Ø°Ø§ Ø§Ù„Ø­Ø³Ø§Ø¨ Ø­ØªÙ‰ Ø§Ù„Ø¢Ù†.", "success");
        } else if (!autoFromURL) {
          showMessage("âœ… ØªÙ… ØªØ­Ù…ÙŠÙ„ ÙƒØ´Ù Ø§Ù„Ø­Ø³Ø§Ø¨ Ø¨Ù†Ø¬Ø§Ø­.", "success");
        }
      } catch (err) {
        console.error(err);
        showMessage("âš ï¸ ØªØ¹Ø°Ø± Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø³ÙŠØ±ÙØ±ØŒ Ø­Ø§ÙˆÙ„ Ù…Ø±Ø© Ø£Ø®Ø±Ù‰.", "error");
      }
    }

    btnLoadLedger.addEventListener("click", () => loadLedgerForSelectedAccount(false));

    [fromDateInput, toDateInput, textFilterInput].forEach(input => {
      input.addEventListener("input", () => {
        applyFilters();
      });
    });

    btnResetFilters.addEventListener("click", () => {
      fromDateInput.value = "";
      toDateInput.value = "";
      textFilterInput.value = "";
      applyFilters();
      clearMessage();
    });

    btnPrint.addEventListener("click", () => {
      if (!currentAccount) {
        alert("Ø§Ø®ØªØ± Ø­Ø³Ø§Ø¨Ù‹Ø§ Ø£ÙˆÙ„Ø§Ù‹ Ù‚Ø¨Ù„ Ø§Ù„Ø·Ø¨Ø§Ø¹Ø©.");
        return;
      }
      window.print();
    });

    // âœ… ØªÙ‡ÙŠØ¦Ø© Ø§Ù„ÙÙ„Ø§ØªØ± Ø¨Ù†Ø§Ø¡Ù‹ Ø¹Ù„Ù‰ Ø¨Ø§Ø±Ø§Ù…ÙŠØªØ±Ø§Øª URL Ø§Ù„Ù‚Ø§Ø¯Ù…Ø© Ù…Ù† ØµÙØ­Ø© Ø§Ù„Ø¹Ù…Ù„ÙŠØ§Øª
    function applyInitialURLFilters() {
      const accIdParam = urlParams.get("account_id") || urlParams.get("acc_id");
      if (accIdParam) {
        accountSelect.value = String(accIdParam);
        const idNum = Number(accIdParam);
        currentAccount = allAccounts.find(a => a.id === idNum) || null;
        updateAccountInfoBox();
      }

      const fromParam = urlParams.get("from");
      const toParam = urlParams.get("to");
      if (fromParam) fromDateInput.value = fromParam;
      if (toParam) toDateInput.value = toParam;
      updatePrintDateRange(fromParam || "", toParam || "");

      if (accIdParam) {
        loadLedgerForSelectedAccount(true);
      }
    }

    async function init() {
      await loadAccounts();
      updateAccountInfoBox();
      applyInitialURLFilters();
    }

    init();
  </script>
</body>
</html>
