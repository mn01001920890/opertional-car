<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <title>ğŸ§¾ ØµÙØ­Ø© Ø§Ù„Ø¹Ù…Ù„ÙŠØ§Øª</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <style>
    :root {
      --bg1:#0d6efd;
      --bg2:#6c63ff;
      --card:#ffffff;
      --ink:#111827;
      --muted:#6b7280;
      --border:#e5e7eb;
      --accent:#0d6efd;
      --danger:#dc2626;
      --success:#16a34a;
      --info:#0ea5e9;
    }

    * { box-sizing: border-box; }

    body {
      margin: 0;
      min-height: 100vh;
      font-family: "Tajawal", system-ui, -apple-system, "Segoe UI", sans-serif;
      background: linear-gradient(135deg, var(--bg1), var(--bg2));
      color: var(--ink);
      display: flex;
      justify-content: center;
      padding: 16px;
    }

    .container {
      width: 100%;
      max-width: 1200px;
      background:
        radial-gradient(circle at top left, rgba(255,255,255,0.35), transparent 55%),
        radial-gradient(circle at bottom right, rgba(15,23,42,0.35), transparent 55%),
        #0b1120;
      border-radius: 18px;
      padding: 20px;
      box-shadow: 0 20px 60px rgba(0,0,0,0.35);
      color: #f9fafb;
    }

    .header {
      display: flex;
      flex-wrap: wrap;
      align-items: center;
      justify-content: space-between;
      gap: 12px;
      margin-bottom: 18px;
    }

    .title-group h1 {
      margin: 0;
      font-size: 1.6rem;
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .title-group p {
      margin: 4px 0 0;
      font-size: 0.9rem;
      color: #e5e7eb;
    }

    .top-buttons {
      display:flex;
      flex-wrap:wrap;
      gap:8px;
    }

    .btn-back,
    .btn-nav {
      padding: 8px 14px;
      border-radius: 999px;
      border: 1px solid rgba(148,163,184,0.6);
      background: rgba(15,23,42,0.85);
      color: #e5e7eb;
      cursor: pointer;
      font-size: 0.9rem;
      display: inline-flex;
      align-items: center;
      gap: 6px;
      transition: 0.2s ease;
      text-decoration: none;
      white-space: nowrap;
    }

    .btn-back:hover,
    .btn-nav:hover {
      background: rgba(15,23,42,1);
      transform: translateY(-1px);
    }

    .layout {
      display: grid;
      grid-template-columns: minmax(0, 1fr);
      gap: 16px;
    }

    .card {
      background: rgba(15,23,42,0.92);
      border-radius: 14px;
      padding: 14px 16px;
      border: 1px solid rgba(148,163,184,0.4);
      box-shadow: 0 10px 30px rgba(0,0,0,0.4);
    }

    .card-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 10px;
      gap: 10px;
    }

    .card-header h2 {
      margin: 0;
      font-size: 1rem;
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .card-header span.badge {
      padding: 3px 9px;
      border-radius: 999px;
      font-size: 0.75rem;
      background: rgba(37,99,235,0.12);
      border: 1px solid rgba(59,130,246,0.4);
      color: #dbeafe;
    }

    .filters {
      display: grid;
      grid-template-columns: repeat(4, minmax(0, 1fr));
      gap: 10px;
      margin-bottom: 10px;
    }

    @media (max-width: 900px) {
      .filters {
        grid-template-columns: repeat(2, minmax(0, 1fr));
      }
    }

    @media (max-width: 600px) {
      .filters {
        grid-template-columns: 1fr;
      }
    }

    label {
      display: block;
      margin-bottom: 4px;
      font-size: 0.78rem;
      color: #e5e7eb;
    }

    input[type="text"],
    input[type="date"],
    select {
      width: 100%;
      padding: 6px 9px;
      border-radius: 9px;
      border: 1px solid rgba(148,163,184,0.6);
      background: rgba(15,23,42,0.9);
      color: #f9fafb;
      font-size: 0.85rem;
      outline: none;
      transition: 0.15s ease;
    }

    input[type="text"]:focus,
    input[type="date"]:focus,
    select:focus {
      border-color: var(--accent);
      box-shadow: 0 0 0 1px rgba(37,99,235,0.4);
    }

    .hint {
      font-size: 0.78rem;
      color: #9ca3af;
      margin-top: 4px;
    }

    .badge-count {
      font-size: 0.8rem;
      color: #9ca3af;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      font-size: 0.85rem;
    }

    thead {
      background: rgba(15,23,42,0.95);
    }

    th, td {
      padding: 6px 8px;
      border-bottom: 1px solid rgba(55,65,81,0.7);
      text-align: right;
      white-space: nowrap;
    }

    th {
      font-weight: 600;
      color: #e5e7eb;
      font-size: 0.8rem;
    }

    tbody tr:nth-child(odd) {
      background: rgba(15,23,42,0.75);
    }

    tbody tr:nth-child(even) {
      background: rgba(15,23,42,0.55);
    }

    tbody tr:hover {
      background: rgba(37,99,235,0.22);
    }

    .empty-state {
      text-align: center;
      padding: 12px 4px;
      font-size: 0.85rem;
      color: #9ca3af;
    }

    .pill-op {
      padding: 2px 8px;
      border-radius: 999px;
      font-size: 0.75rem;
      border: 1px solid rgba(148,163,184,0.7);
      color: #e5e7eb;
      display: inline-flex;
      align-items: center;
      gap: 4px;
    }

    .pill-op.auth {
      border-color:#22c55e;
      color:#bbf7d0;
    }

    .pill-op.receipt {
      border-color:#0ea5e9;
      color:#bae6fd;
    }

    .pill-op.journal {
      border-color:#a855f7;
      color:#e9d5ff;
    }

    .amount-cell {
      font-family: "SF Mono","Cascadia Code",monospace;
    }

    .ref {
      font-family: "SF Mono","Cascadia Code",monospace;
      font-size: 0.8rem;
      color:#e5e7eb;
    }

    .subtext {
      font-size: 0.78rem;
      color:#9ca3af;
    }

    /* ØªØ¸Ù„ÙŠÙ„ ØµÙ Ø¹Ù†Ø¯ Ø§Ù„ÙÙˆÙƒØ³ Ù…Ù† URL */
    .row-highlight {
      outline: 2px solid #facc15;
      box-shadow: 0 0 0 2px rgba(250,204,21,0.5);
    }
  </style>
</head>

<body>
  <div class="container">
    <!-- Header -->
    <div class="header">
      <div class="title-group">
        <h1>ğŸ§¾ ØµÙØ­Ø© Ø§Ù„Ø¹Ù…Ù„ÙŠØ§Øª</h1>
        <p>
          Ø¹Ø±Ø¶ ÙƒÙ„ Ø§Ù„Ø¹Ù…Ù„ÙŠØ§Øª Ø§Ù„Ù…Ø­Ø§Ø³Ø¨ÙŠØ© ØªØ­Øª Ø¨Ø¹Ø¶Ù‡Ø§ Ø³ÙˆØ§Ø¡ ÙƒØ§Ù†Øª Ù†Ø§ØªØ¬Ø© Ø¹Ù† Ø¥Ù‚ÙØ§Ù„ ØªÙÙˆÙŠØ¶ØŒ Ø³Ù†Ø¯ ØªØ­ØµÙŠÙ„ Ù†Ù‚Ø¯ÙŠØŒ Ø£Ùˆ Ù‚ÙŠØ¯ ÙŠÙˆÙ…ÙŠØ©.
        </p>
      </div>
      <div class="top-buttons">
        <a href="/" class="btn-back">
          <span>ğŸ </span>
          <span>Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</span>
        </a>
        <a href="/accounts" class="btn-nav">
          <span>ğŸ“’</span>
          <span>Ø¯Ù„ÙŠÙ„ Ø§Ù„Ø­Ø³Ø§Ø¨Ø§Øª</span>
        </a>
        <a href="/ledger" class="btn-nav">
          <span>ğŸ“‘</span>
          <span>Ø¯ÙØªØ± Ø§Ù„Ø£Ø³ØªØ§Ø°</span>
        </a>
        <a href="/general" class="btn-nav">
          <span>ğŸ““</span>
          <span>Ø§Ù„ÙŠÙˆÙ…ÙŠØ© Ø§Ù„Ø¹Ø§Ù…Ø©</span>
        </a>
        <a href="/receipt" class="btn-nav">
          <span>ğŸ§¾</span>
          <span>Ø³Ù†Ø¯ ØªØ­ØµÙŠÙ„</span>
        </a>
      </div>
    </div>

    <div class="layout">
      <div class="card">
        <div class="card-header">
          <h2>ğŸ” ÙÙ„Ø§ØªØ± Ø§Ù„Ø¹Ù…Ù„ÙŠØ§Øª</h2>
          <span class="badge-count" id="operationsCount">â€”</span>
        </div>
        <div class="card-body">
          <div class="filters">
            <div>
              <label for="filterType">Ù†ÙˆØ¹ Ø§Ù„Ø¹Ù…Ù„ÙŠØ©</label>
              <select id="filterType">
                <option value="all">Ø§Ù„ÙƒÙ„</option>
                <option value="auth_close">Ø¥Ù‚ÙØ§Ù„ ØªÙÙˆÙŠØ¶</option>
                <option value="receipt">Ø³Ù†Ø¯ ØªØ­ØµÙŠÙ„ Ù†Ù‚Ø¯ÙŠ</option>
                <option value="journal">Ù‚ÙŠØ¯ ÙŠÙˆÙ…ÙŠØ©</option>
              </select>
            </div>

            <div>
              <label for="filterFromDate">Ù…Ù† ØªØ§Ø±ÙŠØ®</label>
              <input type="date" id="filterFromDate" />
            </div>

            <div>
              <label for="filterToDate">Ø¥Ù„Ù‰ ØªØ§Ø±ÙŠØ®</label>
              <input type="date" id="filterToDate" />
            </div>

            <div>
              <label for="filterSearch">Ø¨Ø­Ø« (Ø³Ø§Ø¦Ù‚ / Ø³ÙŠØ§Ø±Ø© / ÙˆØµÙ)</label>
              <input type="text" id="filterSearch" placeholder="Ø§ÙƒØªØ¨ Ø¬Ø²Ø¡ Ù…Ù† Ø§Ù„Ø§Ø³Ù… Ø£Ùˆ Ø±Ù‚Ù… Ø§Ù„Ø³ÙŠØ§Ø±Ø© Ø£Ùˆ ÙƒÙ„Ù…Ø© Ù…Ù† Ø§Ù„Ø¨ÙŠØ§Ù†" />
            </div>
          </div>

          <div class="hint">
            â€¢ ÙŠØªÙ… ØªØ¬Ù…ÙŠØ¹ Ø§Ù„Ø¹Ù…Ù„ÙŠØ§Øª Ù…Ù†: Ø¥Ù‚ÙØ§Ù„ Ø§Ù„ØªÙÙˆÙŠØ¶Ø§ØªØŒ Ø³Ù†Ø¯Ø§Øª Ø§Ù„ØªØ­ØµÙŠÙ„ Ø§Ù„Ù†Ù‚Ø¯ÙŠØŒ ÙˆÙ‚ÙŠÙˆØ¯ Ø§Ù„ÙŠÙˆÙ…ÙŠØ© Ø§Ù„ÙŠØ¯ÙˆÙŠØ©.<br/>
            â€¢ ÙŠÙ…ÙƒÙ†Ùƒ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø¹Ù„Ù‰ Ø§Ù„ØµÙØ­Ø© Ù…Ù† Ø±ÙˆØ§Ø¨Ø· Ø£Ø®Ø±Ù‰ Ù…Ø¹ ÙÙ„Ø§ØªØ± Ø¬Ø§Ù‡Ø²Ø© Ø¨Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø¨Ø§Ø±Ø§Ù…ÙŠØªØ±Ø§Øª URL (type / from / to / q / auth_id / receipt_id / journal_id).
          </div>
        </div>
      </div>

      <div class="card">
        <div class="card-header">
          <h2>ğŸ“‹ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø¹Ù…Ù„ÙŠØ§Øª</h2>
          <span class="badge">Operations Log</span>
        </div>
        <div class="card-body">
          <div style="max-height: 420px; overflow: auto; border-radius: 10px; border: 1px solid rgba(55,65,81,0.7);">
            <table>
              <thead>
                <tr>
                  <th>#</th>
                  <th>Ø§Ù„ØªØ§Ø±ÙŠØ®</th>
                  <th>Ù†ÙˆØ¹ Ø§Ù„Ø¹Ù…Ù„ÙŠØ©</th>
                  <th>Ø§Ù„Ù…Ø±Ø¬Ø¹</th>
                  <th>Ø§Ù„ÙˆØµÙ</th>
                  <th>Ø§Ù„Ø³Ø§Ø¦Ù‚</th>
                  <th>Ø§Ù„Ø³ÙŠØ§Ø±Ø©</th>
                  <th>Ø§Ù„Ù…Ø¨Ù„Øº</th>
                </tr>
              </thead>
              <tbody id="operationsTableBody">
                <tr>
                  <td colspan="8" class="empty-state">
                    Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¹Ù…Ù„ÙŠØ§Øª...
                  </td>
                </tr>
              </tbody>
            </table>
          </div>
          <div class="hint" style="margin-top:8px;">
            Ø§Ù„ØªØ±ØªÙŠØ¨ Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠ Ù…Ù† Ø§Ù„Ø£Ø­Ø¯Ø« Ø¥Ù„Ù‰ Ø§Ù„Ø£Ù‚Ø¯Ù…. ÙŠÙ…ÙƒÙ†Ùƒ ØªØ¶ÙŠÙŠÙ‚ Ø§Ù„Ù†ØªØ§Ø¦Ø¬ Ø¨Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„ÙÙ„Ø§ØªØ± Ø¨Ø§Ù„Ø£Ø¹Ù„Ù‰.
          </div>
        </div>
      </div>
    </div>
  </div>

  <script>
    const urlParams = new URLSearchParams(window.location.search);

    const filterType = document.getElementById("filterType");
    const filterFromDate = document.getElementById("filterFromDate");
    const filterToDate = document.getElementById("filterToDate");
    const filterSearch = document.getElementById("filterSearch");
    const operationsTableBody = document.getElementById("operationsTableBody");
    const operationsCount = document.getElementById("operationsCount");

    let operations = [];      // ÙƒÙ„ Ø§Ù„Ø¹Ù…Ù„ÙŠØ§Øª Ø§Ù„Ù…ÙˆØ­Ù‘Ø¯Ø©
    let filteredOperations = [];

    function parseDateStr(dateStr) {
      if (!dateStr) return null;
      try {
        // Ø§Ù„Ø´ÙƒÙ„ Ù…Ù† Ø§Ù„Ù€ API: "YYYY-MM-DD HH:MM:SS"
        return new Date(dateStr.replace(" ", "T"));
      } catch {
        return null;
      }
    }

    function formatDateForDisplay(dateStr) {
      if (!dateStr) return "â€”";
      const d = parseDateStr(dateStr);
      if (!d || isNaN(d.getTime())) return dateStr;
      const yyyy = d.getFullYear();
      const mm = String(d.getMonth() + 1).padStart(2, "0");
      const dd = String(d.getDate()).padStart(2, "0");
      const hh = String(d.getHours()).padStart(2, "0");
      const mi = String(d.getMinutes()).padStart(2, "0");
      return `${yyyy}-${mm}-${dd} ${hh}:${mi}`;
    }

    function formatAmount(amount) {
      if (amount === null || amount === undefined) return "â€”";
      const num = Number(amount);
      if (isNaN(num)) return "â€”";
      return num.toLocaleString("ar-EG", { minimumFractionDigits: 2, maximumFractionDigits: 2 });
    }

    function typePill(opType) {
      let cls = "pill-op";
      let label = "";
      let icon = "";

      if (opType === "auth_close") {
        cls += " auth";
        label = "Ø¥Ù‚ÙØ§Ù„ ØªÙÙˆÙŠØ¶";
        icon = "ğŸš—";
      } else if (opType === "receipt") {
        cls += " receipt";
        label = "Ø³Ù†Ø¯ ØªØ­ØµÙŠÙ„ Ù†Ù‚Ø¯ÙŠ";
        icon = "ğŸ’µ";
      } else if (opType === "journal") {
        cls += " journal";
        label = "Ù‚ÙŠØ¯ ÙŠÙˆÙ…ÙŠØ©";
        icon = "ğŸ“˜";
      } else {
        label = "Ø¹Ù…Ù„ÙŠØ©";
        icon = "ğŸ“";
      }

      return `<span class="${cls}"><span>${icon}</span><span>${label}</span></span>`;
    }

    function buildOperationsRow(op, index) {
      const dateStr = formatDateForDisplay(op.date);
      const amountStr = formatAmount(op.amount);
      const driver = op.driver_name || "â€”";
      const car = op.car_number || "â€”";
      const desc = op.description || "â€”";

      // id ÙØ±ÙŠØ¯ Ù„Ù„ØµÙ Ø¹Ù„Ø´Ø§Ù† Ù„Ù…Ø§ Ù†ÙŠØ¬ÙŠ Ù†Ø¹Ù…Ù„ highlight Ù…Ù† URL
      const rowId = `op-row-${op.source}-${op.id}`;

      return `
        <tr id="${rowId}">
          <td>${index + 1}</td>
          <td>${dateStr}</td>
          <td>${typePill(op.type)}</td>
          <td><span class="ref">${op.ref || "â€”"}</span></td>
          <td>
            ${desc}
            ${
              op.extra
                ? `<div class="subtext">${op.extra}</div>`
                : ""
            }
          </td>
          <td>${driver}</td>
          <td>${car}</td>
          <td class="amount-cell">${amountStr}</td>
        </tr>
      `;
    }

    function applyFilters() {
      const typeVal = filterType.value;
      const fromVal = filterFromDate.value; // "YYYY-MM-DD"
      const toVal = filterToDate.value;
      const searchVal = (filterSearch.value || "").trim().toLowerCase();

      let fromDate = null;
      let toDate = null;

      if (fromVal) {
        fromDate = new Date(fromVal + "T00:00:00");
      }
      if (toVal) {
        toDate = new Date(toVal + "T23:59:59");
      }

      filteredOperations = operations.filter(op => {
        if (typeVal !== "all" && op.type !== typeVal) return false;

        const opDate = parseDateStr(op.date);
        if (fromDate && opDate && opDate < fromDate) return false;
        if (toDate && opDate && opDate > toDate) return false;

        if (searchVal) {
          const haystack = (
            (op.description || "") +
            " " +
            (op.driver_name || "") +
            " " +
            (op.car_number || "") +
            " " +
            (op.ref || "")
          ).toLowerCase();
          if (!haystack.includes(searchVal)) return false;
        }

        return true;
      });

      renderOperationsTable();
    }

    function renderOperationsTable() {
      if (!filteredOperations || filteredOperations.length === 0) {
        operationsTableBody.innerHTML = `
          <tr>
            <td colspan="8" class="empty-state">
              Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¹Ù…Ù„ÙŠØ§Øª Ù…Ø·Ø§Ø¨Ù‚Ø© Ù„Ù„ÙÙ„Ø§ØªØ± Ø§Ù„Ø­Ø§Ù„ÙŠØ©.
            </td>
          </tr>
        `;
        operationsCount.textContent = "0 Ø¹Ù…Ù„ÙŠØ©";
        return;
      }

      operationsTableBody.innerHTML = "";
      filteredOperations.forEach((op, idx) => {
        operationsTableBody.insertAdjacentHTML("beforeend", buildOperationsRow(op, idx));
      });

      operationsCount.textContent = `${filteredOperations.length} Ø¹Ù…Ù„ÙŠØ©`;

      // Ø¨Ø¹Ø¯ Ù…Ø§ Ù†Ø±Ø³Ù… Ø§Ù„Ø¬Ø¯ÙˆÙ„ Ù†Ø´ÙˆÙ Ù„Ùˆ ÙÙŠ focus Ù…Ù† URL
      focusRowFromURL();
    }

    async function loadOperations() {
      try {
        const [authRes, receiptsRes, journalRes] = await Promise.all([
          fetch("/api/authorizations/closed"),
          fetch("/api/receipts"),
          fetch("/api/journal_entries"),
        ]);

        if (!authRes.ok || !receiptsRes.ok || !journalRes.ok) {
          throw new Error("Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¹Ù…Ù„ÙŠØ§Øª");
        }

        const [auths, receipts, journalEntries] = await Promise.all([
          authRes.json(),
          receiptsRes.json(),
          journalRes.json(),
        ]);

        const ops = [];

        // 1) Ø¹Ù…Ù„ÙŠØ§Øª Ø¥Ù‚ÙØ§Ù„ Ø§Ù„ØªÙÙˆÙŠØ¶Ø§Øª
        (auths || []).forEach(a => {
          const opDate = a.close_date || a.end_date || a.issue_date;
          const amount = a.closed_amount != null && a.closed_amount !== undefined
            ? a.closed_amount
            : a.planned_amount;

          ops.push({
            id: a.id,
            source: "auth",
            type: "auth_close",
            date: opDate,
            ref: `AUTH-${a.id}`,
            description: a.details || `Ø¥Ù‚ÙØ§Ù„ ØªÙÙˆÙŠØ¶ Ù„Ù„Ø³ÙŠØ§Ø±Ø© ${a.car_number || ""}`.trim(),
            extra: `Ø³Ø§Ø¦Ù‚: ${a.driver_name || "ØºÙŠØ± Ù…Ø­Ø¯Ø¯"}`,
            driver_name: a.driver_name,
            car_number: a.car_number,
            amount: amount
          });
        });

        // 2) Ø³Ù†Ø¯Ø§Øª Ø§Ù„ØªØ­ØµÙŠÙ„ Ø§Ù„Ù†Ù‚Ø¯ÙŠ
        (receipts || []).forEach(r => {
          ops.push({
            id: r.id,
            source: "receipt",
            type: "receipt",
            date: r.date,
            ref: `RCPT-${r.id}`,
            description: r.description || "Ø³Ù†Ø¯ ØªØ­ØµÙŠÙ„ Ù†Ù‚Ø¯ÙŠ",
            extra: r.ref_authorization_id ? `Ø¹Ù† ØªÙÙˆÙŠØ¶ Ø±Ù‚Ù… ${r.ref_authorization_id}` : "",
            driver_name: r.driver_name,
            car_number: "",
            amount: r.amount
          });
        });

        // 3) Ù‚ÙŠÙˆØ¯ Ø§Ù„ÙŠÙˆÙ…ÙŠØ© (ÙŠØ¯ÙˆÙŠ + Ø£ÙˆØªÙˆÙ…Ø§ØªÙŠÙƒ)
        (journalEntries || []).forEach(je => {
          let totalDebit = 0;
          if (Array.isArray(je.lines)) {
            je.lines.forEach(ln => {
              if (ln.debit) totalDebit += Number(ln.debit) || 0;
            });
          }

          let desc = je.description || "Ù‚ÙŠØ¯ ÙŠÙˆÙ…ÙŠØ©";
          let extra = "";
          if (je.ref_authorization_id) {
            extra = `Ù…Ø±ØªØ¨Ø· Ø¨ØªÙÙˆÙŠØ¶ Ø±Ù‚Ù… ${je.ref_authorization_id}`;
          } else if (je.ref_receipt_id) {
            extra = `Ù…Ø±ØªØ¨Ø· Ø¨Ø³Ù†Ø¯ ØªØ­ØµÙŠÙ„ Ø±Ù‚Ù… ${je.ref_receipt_id}`;
          }

          ops.push({
            id: je.id,
            source: "journal",
            type: "journal",
            date: je.date,
            ref: `JE-${je.id}`,
            description: desc,
            extra: extra,
            driver_name: "",
            car_number: "",
            amount: totalDebit || null
          });
        });

        // ØªØ±ØªÙŠØ¨ Ù…Ù† Ø§Ù„Ø£Ø­Ø¯Ø« Ù„Ù„Ø£Ù‚Ø¯Ù…
        ops.sort((a, b) => {
          const da = parseDateStr(a.date);
          const db = parseDateStr(b.date);
          const na = da ? da.getTime() : 0;
          const nb = db ? db.getTime() : 0;
          return nb - na;
        });

        operations = ops;
        // Ù†Ø·Ø¨Ù‘Ù‚ ÙÙ„Ø§ØªØ± Ø£ÙˆÙ„ÙŠØ© Ù…Ù† URL Ù‚Ø¨Ù„ Ø£ÙˆÙ„ render
        applyInitialURLFilters();
        applyFilters();
      } catch (err) {
        console.error(err);
        operationsTableBody.innerHTML = `
          <tr>
            <td colspan="8" class="empty-state">
              âš ï¸ Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¹Ù…Ù„ÙŠØ§ØªØŒ Ø­Ø§ÙˆÙ„ ØªØ­Ø¯ÙŠØ« Ø§Ù„ØµÙØ­Ø©.
            </td>
          </tr>
        `;
        operationsCount.textContent = "Ø®Ø·Ø£ ÙÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„";
      }
    }

    function applyInitialURLFilters() {
      const typeParam = urlParams.get("type");
      const fromParam = urlParams.get("from");
      const toParam = urlParams.get("to");
      const qParam = urlParams.get("q");

      if (typeParam && ["auth_close","receipt","journal","all"].includes(typeParam)) {
        filterType.value = typeParam;
      }

      if (fromParam) {
        filterFromDate.value = fromParam;
      }
      if (toParam) {
        filterToDate.value = toParam;
      }
      if (qParam) {
        filterSearch.value = qParam;
      }
    }

    function focusRowFromURL() {
      // Ù†Ø­Ø§ÙˆÙ„ Ù†Ø­Ø¯Ø¯ ØµÙ Ù…Ø¹ÙŠÙ‘Ù† Ù…Ù† Ø®Ù„Ø§Ù„ auth_id Ø£Ùˆ receipt_id Ø£Ùˆ journal_id
      const authId = urlParams.get("auth_id");
      const receiptId = urlParams.get("receipt_id");
      const journalId = urlParams.get("journal_id");

      let targetSource = null;
      let targetId = null;

      if (authId) {
        targetSource = "auth";
        targetId = authId;
      } else if (receiptId) {
        targetSource = "receipt";
        targetId = receiptId;
      } else if (journalId) {
        targetSource = "journal";
        targetId = journalId;
      }

      if (!targetSource || !targetId) return;

      const rowDomId = `op-row-${targetSource}-${targetId}`;
      const rowEl = document.getElementById(rowDomId);
      if (rowEl) {
        rowEl.classList.add("row-highlight");
        rowEl.scrollIntoView({ behavior:"smooth", block:"center" });
        setTimeout(() => {
          rowEl.classList.remove("row-highlight");
        }, 3500);
      }
    }

    // Ø±Ø¨Ø· Ø§Ù„ÙÙ„Ø§ØªØ± Ù…Ø¹ Ø§Ù„Ø¯Ø§Ù„Ø©
    filterType.addEventListener("change", applyFilters);
    filterFromDate.addEventListener("change", applyFilters);
    filterToDate.addEventListener("change", applyFilters);
    filterSearch.addEventListener("input", () => {
      applyFilters();
    });

    // Ø£ÙˆÙ„ Ù…Ø§ Ø§Ù„ØµÙØ­Ø© ØªÙØªØ­
    loadOperations();
  </script>
</body>
</html>
