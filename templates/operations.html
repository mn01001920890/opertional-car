<!DOCTYPE html> 
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <title>ğŸ§¾ ØµÙØ­Ø© Ø§Ù„Ø¹Ù…Ù„ÙŠØ§Øª (Ø¯ÙØªØ± Ø§Ù„Ù‚ÙŠÙˆØ¯)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <style>
    :root {
      --bg1:#0d6efd;
      --bg2:#6c63ff;
      --card:#ffffff;
      --ink:#111827;
      --muted:#6b7280;
      --border:#e5e7eb;
      --accent:#0d6efd;
      --danger:#dc2626;
      --success:#16a34a;
      --info:#0ea5e9;
    }

    * { box-sizing: border-box; }

    body {
      margin: 0;
      min-height: 100vh;
      font-family: "Tajawal", system-ui, -apple-system, "Segoe UI", sans-serif;
      background: linear-gradient(135deg, var(--bg1), var(--bg2));
      color: var(--ink);
      display: flex;
      justify-content: center;
      padding: 16px;
    }

    .container {
      width: 100%;
      max-width: 1200px;
      background:
        radial-gradient(circle at top left, rgba(255,255,255,0.35), transparent 55%),
        radial-gradient(circle at bottom right, rgba(15,23,42,0.35), transparent 55%),
        #0b1120;
      border-radius: 18px;
      padding: 20px;
      box-shadow: 0 20px 60px rgba(0,0,0,0.35);
      color: #f9fafb;
    }

    .header {
      display: flex;
      flex-wrap: wrap;
      align-items: center;
      justify-content: space-between;
      gap: 12px;
      margin-bottom: 18px;
    }

    .title-group h1 {
      margin: 0;
      font-size: 1.6rem;
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .title-group p {
      margin: 4px 0 0;
      font-size: 0.9rem;
      color: #e5e7eb;
    }

    .top-buttons {
      display:flex;
      flex-wrap:wrap;
      gap:8px;
    }

    .btn-back,
    .btn-nav {
      padding: 8px 14px;
      border-radius: 999px;
      border: 1px solid rgba(148,163,184,0.6);
      background: rgba(15,23,42,0.85);
      color: #e5e7eb;
      cursor: pointer;
      font-size: 0.9rem;
      display: inline-flex;
      align-items: center;
      gap: 6px;
      transition: 0.2s ease;
      text-decoration: none;
      white-space: nowrap;
    }

    .btn-back:hover,
    .btn-nav:hover {
      background: rgba(15,23,42,1);
      transform: translateY(-1px);
    }

    .layout {
      display: grid;
      grid-template-columns: minmax(0, 1fr);
      gap: 16px;
    }

    .card {
      background: rgba(15,23,42,0.92);
      border-radius: 14px;
      padding: 14px 16px;
      border: 1px solid rgba(148,163,184,0.4);
      box-shadow: 0 10px 30px rgba(0,0,0,0.4);
    }

    .card-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 10px;
      gap: 10px;
    }

    .card-header h2 {
      margin: 0;
      font-size: 1rem;
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .card-header span.badge {
      padding: 3px 9px;
      border-radius: 999px;
      font-size: 0.75rem;
      background: rgba(37,99,235,0.12);
      border: 1px solid rgba(59,130,246,0.4);
      color: #dbeafe;
    }

    .filters {
      display: grid;
      grid-template-columns: repeat(4, minmax(0, 1fr));
      gap: 10px;
      margin-bottom: 10px;
    }

    @media (max-width: 900px) {
      .filters {
        grid-template-columns: repeat(2, minmax(0, 1fr));
      }
    }

    @media (max-width: 600px) {
      .filters {
        grid-template-columns: 1fr;
      }
    }

    label {
      display: block;
      margin-bottom: 4px;
      font-size: 0.78rem;
      color: #e5e7eb;
    }

    input[type="text"],
    input[type="date"],
    select {
      width: 100%;
      padding: 6px 9px;
      border-radius: 9px;
      border: 1px solid rgba(148,163,184,0.6);
      background: rgba(15,23,42,0.9);
      color: #f9fafb;
      font-size: 0.85rem;
      outline: none;
      transition: 0.15s ease;
    }

    input[type="text"]:focus,
    input[type="date"]:focus,
    select:focus {
      border-color: var(--accent);
      box-shadow: 0 0 0 1px rgba(37,99,235,0.4);
    }

    .hint {
      font-size: 0.78rem;
      color: #9ca3af;
      margin-top: 4px;
    }

    .badge-count {
      font-size: 0.8rem;
      color: #9ca3af;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      font-size: 0.85rem;
    }

    thead {
      background: rgba(15,23,42,0.95);
    }

    th, td {
      padding: 6px 8px;
      border-bottom: 1px solid rgba(55,65,81,0.7);
      text-align: right;
      white-space: nowrap;
      vertical-align: top;
    }

    th {
      font-weight: 600;
      color: #e5e7eb;
      font-size: 0.8rem;
    }

    tbody tr:nth-child(odd) {
      background: rgba(15,23,42,0.75);
    }

    tbody tr:nth-child(even) {
      background: rgba(15,23,42,0.55);
    }

    tbody tr:hover {
      background: rgba(37,99,235,0.22);
    }

    .empty-state {
      text-align: center;
      padding: 12px 4px;
      font-size: 0.85rem;
      color: #9ca3af;
    }

    .pill-op {
      padding: 2px 8px;
      border-radius: 999px;
      font-size: 0.75rem;
      border: 1px solid rgba(148,163,184,0.7);
      color: #e5e7eb;
      display: inline-flex;
      align-items: center;
      gap: 4px;
    }

    .pill-op.auth {
      border-color:#22c55e;
      color:#bbf7d0;
    }

    .pill-op.receipt {
      border-color:#0ea5e9;
      color:#bae6fd;
    }

    .pill-op.manual {
      border-color:#a855f7;
      color:#e9d5ff;
    }

    .amount-cell {
      font-family: "SF Mono","Cascadia Code",monospace;
    }

    .ref-main {
      font-family: "SF Mono","Cascadia Code",monospace;
      font-size: 0.8rem;
      color:#e5e7eb;
    }

    .subtext {
      font-size: 0.78rem;
      color:#9ca3af;
    }

    .acc-name {
      font-size: 0.8rem;
      font-weight: 600;
      color:#e5e7eb;
    }

    .acc-code {
      font-size: 0.75rem;
      color:#9ca3af;
    }

    /* ØªØ¸Ù„ÙŠÙ„ ØµÙ Ø¹Ù†Ø¯ Ø§Ù„ÙÙˆÙƒØ³ Ù…Ù† URL */
    .row-highlight {
      outline: 2px solid #facc15;
      box-shadow: 0 0 0 2px rgba(250,204,21,0.5);
    }
  </style>
</head>

<body>
  <div class="container">
    <!-- Header -->
    <div class="header">
      <div class="title-group">
        <h1>ğŸ§¾ ØµÙØ­Ø© Ø§Ù„Ø¹Ù…Ù„ÙŠØ§Øª (Ù‚ÙŠÙˆØ¯ Ø§Ù„ÙŠÙˆÙ…ÙŠØ©)</h1>
        <p>
          Ù‡Ù†Ø§ ÙŠØ¸Ù‡Ø± ÙƒÙ„ <strong>Ø§Ù„Ù‚ÙŠÙˆØ¯ Ø§Ù„Ù…Ø­Ø§Ø³Ø¨ÙŠØ©</strong> (Ù…Ø¯ÙŠÙ†/Ø¯Ø§Ø¦Ù†) Ø§Ù„Ù†Ø§ØªØ¬Ø© Ø¹Ù†: Ø¥Ù‚ÙØ§Ù„ Ø§Ù„ØªÙÙˆÙŠØ¶ØŒ Ø³Ù†Ø¯ Ø§Ù„ØªØ­ØµÙŠÙ„ Ø§Ù„Ù†Ù‚Ø¯ÙŠØŒ Ø£Ùˆ Ø§Ù„Ù‚ÙŠÙˆØ¯ Ø§Ù„ÙŠØ¯ÙˆÙŠØ© Ù…Ù† Ø§Ù„ÙŠÙˆÙ…ÙŠØ© Ø§Ù„Ø¹Ø§Ù…Ø©.
        </p>
      </div>
      <div class="top-buttons">
        <a href="/" class="btn-back">
          <span>ğŸ </span>
          <span>Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</span>
        </a>
        <a href="/accounts" class="btn-nav">
          <span>ğŸ“’</span>
          <span>Ø¯Ù„ÙŠÙ„ Ø§Ù„Ø­Ø³Ø§Ø¨Ø§Øª</span>
        </a>
        <a href="/ledger" class="btn-nav">
          <span>ğŸ“‘</span>
          <span>Ø¯ÙØªØ± Ø§Ù„Ø£Ø³ØªØ§Ø°</span>
        </a>
        <a href="/general" class="btn-nav">
          <span>ğŸ““</span>
          <span>Ø§Ù„ÙŠÙˆÙ…ÙŠØ© Ø§Ù„Ø¹Ø§Ù…Ø©</span>
        </a>
        <a href="/receipt" class="btn-nav">
          <span>ğŸ§¾</span>
          <span>Ø³Ù†Ø¯ ØªØ­ØµÙŠÙ„</span>
        </a>
      </div>
    </div>

    <div class="layout">
      <!-- ÙÙ„Ø§ØªØ± -->
      <div class="card">
        <div class="card-header">
          <h2>ğŸ” ÙÙ„Ø§ØªØ± Ø§Ù„Ù‚ÙŠÙˆØ¯</h2>
          <span class="badge-count" id="operationsCount">â€”</span>
        </div>
        <div class="card-body">
          <div class="filters">
            <div>
              <label for="filterType">Ù…ØµØ¯Ø± Ø§Ù„Ø¹Ù…Ù„ÙŠØ©</label>
              <select id="filterType">
                <option value="all">Ø§Ù„ÙƒÙ„</option>
                <option value="auth_close">Ø¥Ù‚ÙØ§Ù„ ØªÙÙˆÙŠØ¶</option>
                <option value="receipt">Ø³Ù†Ø¯ ØªØ­ØµÙŠÙ„ Ù†Ù‚Ø¯ÙŠ</option>
                <option value="manual">Ù‚ÙŠØ¯ ÙŠØ¯ÙˆÙŠ Ù…Ù† Ø§Ù„ÙŠÙˆÙ…ÙŠØ©</option>
              </select>
            </div>

            <div>
              <label for="filterFromDate">Ù…Ù† ØªØ§Ø±ÙŠØ®</label>
              <input type="date" id="filterFromDate" />
            </div>

            <div>
              <label for="filterToDate">Ø¥Ù„Ù‰ ØªØ§Ø±ÙŠØ®</label>
              <input type="date" id="filterToDate" />
            </div>

            <div>
              <label for="filterSearch">Ø¨Ø­Ø« (Ø­Ø³Ø§Ø¨ / Ø³Ø§Ø¦Ù‚ / ÙˆØµÙ / Ù…Ø±Ø¬Ø¹)</label>
              <input type="text" id="filterSearch" placeholder="Ø§ÙƒØªØ¨ Ø¬Ø²Ø¡ Ù…Ù† Ø§Ø³Ù… Ø§Ù„Ø­Ø³Ø§Ø¨ Ø£Ùˆ Ø§Ù„Ø³Ø§Ø¦Ù‚ Ø£Ùˆ ÙƒÙ„Ù…Ø© Ù…Ù† Ø§Ù„Ø¨ÙŠØ§Ù† Ø£Ùˆ Ø±Ù‚Ù… Ø§Ù„Ù…Ø±Ø¬Ø¹" />
            </div>
          </div>

          <div class="hint">
            â€¢ ÙƒÙ„ Ø³Ø·Ø± Ù‡Ù†Ø§ ÙŠÙ…Ø«Ù„ <strong>Ù‚ÙŠØ¯ ÙŠÙˆÙ…ÙŠØ© ÙƒØ§Ù…Ù„ (Ù…Ø¯ÙŠÙ† + Ø¯Ø§Ø¦Ù†)</strong> Ù‚Ø§Ø¯Ù… Ù…Ù† Ø¥Ù‚ÙØ§Ù„ Ø§Ù„ØªÙÙˆÙŠØ¶ Ø£Ùˆ Ø³Ù†Ø¯ Ø§Ù„ØªØ­ØµÙŠÙ„ Ø£Ùˆ Ù‚ÙŠØ¯ ÙŠØ¯ÙˆÙŠ.<br/>
            â€¢ ÙŠÙ…ÙƒÙ†Ùƒ ÙØªØ­ Ø§Ù„ØµÙØ­Ø© Ù…Ù† Ø±ÙˆØ§Ø¨Ø· Ø£Ø®Ø±Ù‰ Ù…Ø¹ ÙÙ„Ø§ØªØ± Ø¬Ø§Ù‡Ø²Ø© Ø¨Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø¨Ø§Ø±Ø§Ù…ÙŠØªØ±Ø§Øª URL Ù…Ø«Ù„:
            <code>?type=receipt&amp;journal_id=15</code> Ø£Ùˆ <code>?auth_id=10</code> Ø£Ùˆ <code>?receipt_id=3</code>.
          </div>
        </div>
      </div>

      <!-- Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ø¹Ù…Ù„ÙŠØ§Øª -->
      <div class="card">
        <div class="card-header">
          <h2>ğŸ“‹ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù‚ÙŠÙˆØ¯ Ø§Ù„Ù…Ø­Ø§Ø³Ø¨ÙŠØ©</h2>
          <span class="badge">Journal Operations Log</span>
        </div>
        <div class="card-body">
          <div style="max-height: 420px; overflow: auto; border-radius: 10px; border: 1px solid rgba(55,65,81,0.7);">
            <table>
              <thead>
                <tr>
                  <th>#</th>
                  <th>Ø§Ù„ØªØ§Ø±ÙŠØ®</th>
                  <th>Ù†ÙˆØ¹ Ø§Ù„Ø¹Ù…Ù„ÙŠØ©</th>
                  <th>Ø§Ù„Ø£Ø±Ù‚Ø§Ù… (Ø¹Ù…Ù„ÙŠØ© / Ù…Ø±Ø¬Ø¹)</th>
                  <th>Ø§Ù„Ø­Ø³Ø§Ø¨ Ø§Ù„Ù…Ø¯ÙŠÙ†</th>
                  <th>Ø§Ù„Ø­Ø³Ø§Ø¨ Ø§Ù„Ø¯Ø§Ø¦Ù†</th>
                  <th>Ø§Ù„Ù…Ø¨Ù„Øº</th>
                  <th>ÙˆØµÙ Ù…Ø®ØªØµØ±</th>
                </tr>
              </thead>
              <tbody id="operationsTableBody">
                <tr>
                  <td colspan="8" class="empty-state">
                    Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù‚ÙŠÙˆØ¯...
                  </td>
                </tr>
              </tbody>
            </table>
          </div>
          <div class="hint" style="margin-top:8px;">
            Ø§Ù„ØªØ±ØªÙŠØ¨ Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠ Ù…Ù† Ø§Ù„Ø£Ø­Ø¯Ø« Ø¥Ù„Ù‰ Ø§Ù„Ø£Ù‚Ø¯Ù…. Ø§Ù„ÙÙ„Ø§ØªØ± Ø¨Ø§Ù„Ø£Ø¹Ù„Ù‰ ØªØ¶ÙŠÙ‚ Ø§Ù„Ù†ØªØ§Ø¦Ø¬ Ø­Ø³Ø¨ Ø§Ù„Ù…ØµØ¯Ø± Ø£Ùˆ Ø§Ù„ØªØ§Ø±ÙŠØ® Ø£Ùˆ Ø§Ù„Ø¨Ø­Ø«.
          </div>
        </div>
      </div>
    </div>
  </div>

  <script>
    const urlParams = new URLSearchParams(window.location.search);

    const filterType      = document.getElementById("filterType");
    const filterFromDate  = document.getElementById("filterFromDate");
    const filterToDate    = document.getElementById("filterToDate");
    const filterSearch    = document.getElementById("filterSearch");
    const operationsTableBody = document.getElementById("operationsTableBody");
    const operationsCount = document.getElementById("operationsCount");

    let operations = [];      // ÙƒÙ„ Ø§Ù„Ù‚ÙŠÙˆØ¯ Ø¨Ø¹Ø¯ Ø§Ù„Ù…Ø§Ø¨
    let filteredOperations = [];

    function parseDateStr(dateStr) {
      if (!dateStr) return null;
      try {
        // Ù†ÙØªØ±Ø¶ Ø§Ù„Ø´ÙƒÙ„: "YYYY-MM-DD HH:MM:SS"
        return new Date(dateStr.replace(" ", "T"));
      } catch {
        return null;
      }
    }

    function formatDateForDisplay(dateStr) {
      if (!dateStr) return "â€”";
      const d = parseDateStr(dateStr);
      if (!d || isNaN(d.getTime())) return dateStr;
      const yyyy = d.getFullYear();
      const mm = String(d.getMonth() + 1).padStart(2, "0");
      const dd = String(d.getDate()).padStart(2, "0");
      const hh = String(d.getHours()).padStart(2, "0");
      const mi = String(d.getMinutes()).padStart(2, "0");
      return `${yyyy}-${mm}-${dd} ${hh}:${mi}`;
    }

    function formatAmount(amount) {
      if (amount === null || amount === undefined) return "â€”";
      const num = Number(amount);
      if (isNaN(num)) return "â€”";
      return num.toLocaleString("ar-EG", { minimumFractionDigits: 2, maximumFractionDigits: 2 });
    }

    function typePill(sourceType) {
      let cls = "pill-op";
      let label = "";
      let icon = "";

      if (sourceType === "auth_close") {
        cls += " auth";
        label = "Ø¥Ù‚ÙØ§Ù„ ØªÙÙˆÙŠØ¶";
        icon = "ğŸš—";
      } else if (sourceType === "receipt") {
        cls += " receipt";
        label = "Ø³Ù†Ø¯ ØªØ­ØµÙŠÙ„ Ù†Ù‚Ø¯ÙŠ";
        icon = "ğŸ’µ";
      } else { // manual / ØºÙŠØ±Ù‡
        cls += " manual";
        label = "Ù‚ÙŠØ¯ ÙŠØ¯ÙˆÙŠ";
        icon = "ğŸ“˜";
      }

      return `<span class="${cls}"><span>${icon}</span><span>${label}</span></span>`;
    }

    function buildOperationsRow(op, index) {
      const dateStr   = formatDateForDisplay(op.date);
      const amountStr = formatAmount(op.amount);

      const rowId = `op-row-${op.id}`;

      const debitHtml = op.debit
        ? `
          <div class="acc-name">${op.debit.account_name || "â€”"}</div>
          <div class="acc-code">${op.debit.account_code || ""}</div>
          <div class="subtext">Ù…Ø¯ÙŠÙ†: ${formatAmount(op.debit.amount)}</div>
        `
        : "â€”";

      const creditHtml = op.credit
        ? `
          <div class="acc-name">${op.credit.account_name || "â€”"}</div>
          <div class="acc-code">${op.credit.account_code || ""}</div>
          <div class="subtext">Ø¯Ø§Ø¦Ù†: ${formatAmount(op.credit.amount)}</div>
        `
        : "â€”";

      let refSub = "";
      if (op.source_type === "auth_close" && op.ref_authorization_id) {
        refSub = `ØªÙÙˆÙŠØ¶ #${op.ref_authorization_id}`;
      } else if (op.source_type === "receipt" && op.ref_receipt_id) {
        refSub = `Ø³Ù†Ø¯ ØªØ­ØµÙŠÙ„ #${op.ref_receipt_id}`;
      } else if (op.source_type === "manual" && op.manual_ref) {
        refSub = `Ù…Ø±Ø¬Ø¹ ÙŠØ¯ÙˆÙŠ #${op.manual_ref}`;
      }

      const refHtml = `
        <div class="ref-main">OP-${op.id}</div>
        ${refSub ? `<div class="subtext">${refSub}</div>` : ""}
      `;

      const descShort = op.description || "â€”";

      return `
        <tr id="${rowId}">
          <td>${index + 1}</td>
          <td>${dateStr}</td>
          <td>${typePill(op.source_type)}</td>
          <td>${refHtml}</td>
          <td>${debitHtml}</td>
          <td>${creditHtml}</td>
          <td class="amount-cell">${amountStr}</td>
          <td>
            ${descShort}
            ${
              op.driver_name || op.car_number
                ? `<div class="subtext">${
                    op.driver_name ? "Ø³Ø§Ø¦Ù‚: " + op.driver_name : ""
                  } ${op.car_number ? " | Ø³ÙŠØ§Ø±Ø©: " + op.car_number : ""}</div>`
                : ""
            }
          </td>
        </tr>
      `;
    }

    function applyFilters() {
      const typeVal    = filterType.value;
      const fromVal    = filterFromDate.value;
      const toVal      = filterToDate.value;
      const searchVal  = (filterSearch.value || "").trim().toLowerCase();

      let fromDate = null;
      let toDate   = null;

      if (fromVal) {
        fromDate = new Date(fromVal + "T00:00:00");
      }
      if (toVal) {
        toDate = new Date(toVal + "T23:59:59");
      }

      filteredOperations = operations.filter(op => {
        if (typeVal !== "all" && op.source_type !== typeVal) return false;

        const opDate = parseDateStr(op.date);
        if (fromDate && opDate && opDate < fromDate) return false;
        if (toDate && opDate && opDate > toDate) return false;

        if (searchVal) {
          const haystack = (
            (op.description || "") + " " +
            (op.driver_name || "") + " " +
            (op.car_number || "") + " " +
            (op.ref_text || "") + " " +
            (op.debit ? (op.debit.account_name || "") + " " + (op.debit.account_code || "") : "") + " " +
            (op.credit ? (op.credit.account_name || "") + " " + (op.credit.account_code || "") : "")
          ).toLowerCase();
          if (!haystack.includes(searchVal)) return false;
        }

        return true;
      });

      renderOperationsTable();
    }

    function renderOperationsTable() {
      if (!filteredOperations || filteredOperations.length === 0) {
        operationsTableBody.innerHTML = `
          <tr>
            <td colspan="8" class="empty-state">
              Ù„Ø§ ØªÙˆØ¬Ø¯ Ù‚ÙŠÙˆØ¯ Ù…Ø·Ø§Ø¨Ù‚Ø© Ù„Ù„ÙÙ„Ø§ØªØ± Ø§Ù„Ø­Ø§Ù„ÙŠØ©.
            </td>
          </tr>
        `;
        operationsCount.textContent = "0 Ù‚ÙŠØ¯";
        return;
      }

      operationsTableBody.innerHTML = "";
      filteredOperations.forEach((op, idx) => {
        operationsTableBody.insertAdjacentHTML("beforeend", buildOperationsRow(op, idx));
      });

      operationsCount.textContent = `${filteredOperations.length} Ù‚ÙŠØ¯`;

      // Ø¨Ø¹Ø¯ Ø§Ù„Ø±Ø³Ù… Ù†Ø­Ø§ÙˆÙ„ Ù†Ø­Ø¯Ø¯ ØµÙ Ù…Ø¹ÙŠÙ‘Ù† Ù…Ù† URL
      focusRowFromURL();
    }

    function mapJournalEntriesToOps(journalEntries) {
      const ops = [];

      (journalEntries || []).forEach(je => {
        const source_type_raw = je.source_type || je.source || "manual";
        let source_type = "manual";
        if (source_type_raw === "auth_close" || source_type_raw === "authorization") {
          source_type = "auth_close";
        } else if (source_type_raw === "receipt") {
          source_type = "receipt";
        }

        let debitLine  = null;
        let creditLine = null;
        if (Array.isArray(je.lines)) {
          je.lines.forEach(ln => {
            const d = Number(ln.debit || 0);
            const c = Number(ln.credit || 0);
            if (d > 0 && !debitLine)  debitLine  = { 
              account_code: ln.account_code || ln.code || "", 
              account_name: ln.account_name || ln.name || "", 
              amount: d 
            };
            if (c > 0 && !creditLine) creditLine = { 
              account_code: ln.account_code || ln.code || "", 
              account_name: ln.account_name || ln.name || "", 
              amount: c 
            };
          });
        }

        const amount =
          debitLine ? debitLine.amount :
          (creditLine ? creditLine.amount : null);

        let refText = `OP-${je.id}`;
        if (source_type === "auth_close" && je.ref_authorization_id) {
          refText += ` | AUTH-${je.ref_authorization_id}`;
        } else if (source_type === "receipt" && je.ref_receipt_id) {
          refText += ` | RCPT-${je.ref_receipt_id}`;
        }

        ops.push({
          id: je.id,
          date: je.date,
          description: je.description || "",
          source_type,
          ref_authorization_id: je.ref_authorization_id || null,
          ref_receipt_id: je.ref_receipt_id || null,
          manual_ref: je.manual_ref || null,
          driver_name: je.driver_name || "",
          car_number: je.car_number || "",
          debit: debitLine,
          credit: creditLine,
          amount,
          ref_text: refText
        });
      });

      // ØªØ±ØªÙŠØ¨ Ù…Ù† Ø§Ù„Ø£Ø­Ø¯Ø« Ù„Ù„Ø£Ù‚Ø¯Ù…
      ops.sort((a, b) => {
        const da = parseDateStr(a.date);
        const db = parseDateStr(b.date);
        const na = da ? da.getTime() : 0;
        const nb = db ? db.getTime() : 0;
        return nb - na;
      });

      return ops;
    }

    async function loadOperations() {
      try {
        // Ø§Ù„Ø¢Ù† Ù†Ø¹ØªÙ…Ø¯ ÙÙ‚Ø· Ø¹Ù„Ù‰ Ù‚ÙŠÙˆØ¯ Ø§Ù„ÙŠÙˆÙ…ÙŠØ© Ù…Ù† Ø§Ù„Ù€ API
        const res = await fetch("/api/journal_entries");
        if (!res.ok) throw new Error("HTTP " + res.status);
        const journalEntries = await res.json();

        operations = mapJournalEntriesToOps(journalEntries);

        // Ù†Ø·Ø¨Ù‘Ù‚ ÙÙ„Ø§ØªØ± Ø£ÙˆÙ„ÙŠØ© Ù…Ù† URL Ù‚Ø¨Ù„ Ø£ÙˆÙ„ render
        applyInitialURLFilters();
        applyFilters();
      } catch (err) {
        console.error(err);
        operationsTableBody.innerHTML = `
          <tr>
            <td colspan="8" class="empty-state">
              âš ï¸ Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù‚ÙŠÙˆØ¯ØŒ Ø­Ø§ÙˆÙ„ ØªØ­Ø¯ÙŠØ« Ø§Ù„ØµÙØ­Ø©.
            </td>
          </tr>
        `;
        operationsCount.textContent = "Ø®Ø·Ø£ ÙÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„";
      }
    }

    function applyInitialURLFilters() {
      const typeParam = urlParams.get("type");
      const fromParam = urlParams.get("from");
      const toParam   = urlParams.get("to");
      const qParam    = urlParams.get("q");

      if (typeParam && ["auth_close","receipt","manual","all"].includes(typeParam)) {
        filterType.value = typeParam;
      }

      if (fromParam) filterFromDate.value = fromParam;
      if (toParam)   filterToDate.value   = toParam;
      if (qParam)    filterSearch.value   = qParam;
    }

    function focusRowFromURL() {
      const authId    = urlParams.get("auth_id");
      const receiptId = urlParams.get("receipt_id");
      const journalId = urlParams.get("journal_id");

      let targetOp = null;

      if (journalId) {
        targetOp = filteredOperations.find(
          op => String(op.id) === String(journalId)
        );
      } else if (authId) {
        targetOp = filteredOperations.find(
          op => op.source_type === "auth_close" &&
                String(op.ref_authorization_id) === String(authId)
        );
      } else if (receiptId) {
        targetOp = filteredOperations.find(
          op => op.source_type === "receipt" &&
                String(op.ref_receipt_id) === String(receiptId)
        );
      }

      if (!targetOp) return;

      const rowDomId = `op-row-${targetOp.id}`;
      const rowEl = document.getElementById(rowDomId);
      if (rowEl) {
        rowEl.classList.add("row-highlight");
        rowEl.scrollIntoView({ behavior:"smooth", block:"center" });
        setTimeout(() => {
          rowEl.classList.remove("row-highlight");
        }, 3500);
      }
    }

    // Ø±Ø¨Ø· Ø§Ù„ÙÙ„Ø§ØªØ±
    filterType.addEventListener("change", applyFilters);
    filterFromDate.addEventListener("change", applyFilters);
    filterToDate.addEventListener("change", applyFilters);
    filterSearch.addEventListener("input", applyFilters);

    // Ø£ÙˆÙ„ Ù…Ø§ Ø§Ù„ØµÙØ­Ø© ØªÙØªØ­
    loadOperations();
  </script>
</body>
</html>
