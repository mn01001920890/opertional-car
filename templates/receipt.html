<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>ğŸ§¾ Ø³Ù†Ø¯ ØªØ­ØµÙŠÙ„ Ù†Ù‚Ø¯ÙŠ</title>

  <style>
    :root {
      --main-blue: #0d6efd;
      --main-purple: #6c63ff;
      --card-radius: 14px;
      --shadow: 0 4px 12px rgba(0,0,0,0.25);
      --muted: #6b7280;
    }

    * {
      box-sizing: border-box;
    }

    body {
      font-family: "Tajawal", system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      margin: 0;
      background: linear-gradient(135deg, var(--main-blue), var(--main-purple));
      color: #fff;
      min-height: 100vh;
    }

    /* ğŸ” Ø´Ø±ÙŠØ· Ø¹Ù„ÙˆÙŠ Ø«Ø§Ø¨Øª */
    .top-bar {
      position: fixed;
      top: 0;
      right: 0;
      left: 0;
      z-index: 1000;
      background: rgba(0, 0, 0, 0.25);
      backdrop-filter: blur(8px);
      padding: 10px 16px;
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .back-btn {
      border: none;
      border-radius: 999px;
      padding: 8px 16px;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      background: #fff;
      color: var(--main-blue);
      display: inline-flex;
      align-items: center;
      gap: 6px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.25);
      transition: 0.2s ease;
      white-space: nowrap;
    }

    .back-btn:hover {
      background: var(--main-blue);
      color: #fff;
      transform: translateY(-1px);
    }

    .page-title {
      margin: 0;
      font-size: 18px;
      font-weight: 700;
      flex: 1;
      text-align: center;
      color: #fff;
    }

    /* Ù…Ø­ØªÙˆÙ‰ Ø§Ù„ØµÙØ­Ø© */
    .page-content {
      max-width: 1100px;
      margin: 0 auto;
      padding: 80px 16px 24px; /* Ù…Ø³Ø§Ø­Ø© Ù„Ù„Ù‡ÙŠØ¯Ø± Ø§Ù„Ø«Ø§Ø¨Øª */
    }

    h2 {
      text-align: center;
      font-size: 24px;
      margin-bottom: 6px;
    }

    .subtitle {
      text-align: center;
      font-size: 14px;
      opacity: 0.9;
      margin-bottom: 20px;
    }

    .layout {
      display: grid;
      grid-template-columns: 2.2fr 1.3fr;
      gap: 16px;
    }

    @media (max-width: 900px) {
      .layout {
        grid-template-columns: 1fr;
      }
    }

    .card {
      background: #ffffff;
      color: #111827;
      border-radius: var(--card-radius);
      box-shadow: var(--shadow);
      padding: 16px 16px 18px;
    }

    .card-header {
      display: flex;
      align-items: center;
      gap: 10px;
      margin-bottom: 10px;
    }

    .card-header-title {
      font-size: 18px;
      font-weight: 700;
      margin: 0;
      color: #111827;
    }

    .card-header-note {
      font-size: 12px;
      color: var(--muted);
    }

    .form-grid {
      display: grid;
      grid-template-columns: repeat(2, minmax(0, 1fr));
      gap: 10px 12px;
    }

    @media (max-width: 640px) {
      .form-grid {
        grid-template-columns: 1fr;
      }
    }

    .form-group {
      display: flex;
      flex-direction: column;
      gap: 4px;
    }

    label {
      font-size: 13px;
      font-weight: 600;
      color: #111827;
    }

    .hint {
      font-size: 11px;
      color: var(--muted);
    }

    input[type="text"],
    input[type="number"],
    input[type="datetime-local"],
    select,
    textarea {
      border-radius: 10px;
      border: 1px solid #e5e7eb;
      padding: 8px 10px;
      font-size: 13px;
      outline: none;
      transition: 0.15s ease;
      font-family: inherit;
    }

    input[type="text"]:focus,
    input[type="number"]:focus,
    input[type="datetime-local"]:focus,
    select:focus,
    textarea:focus {
      border-color: var(--main-blue);
      box-shadow: 0 0 0 2px rgba(13,110,253,0.18);
    }

    textarea {
      min-height: 70px;
      resize: vertical;
    }

    .readonly {
      background: #f9fafb;
    }

    .btn-primary {
      margin-top: 8px;
      width: 100%;
      border: none;
      border-radius: 999px;
      padding: 10px 16px;
      font-size: 15px;
      font-weight: 700;
      cursor: pointer;
      background: linear-gradient(135deg, var(--main-blue), var(--main-purple));
      color: #fff;
      box-shadow: 0 4px 10px rgba(0,0,0,0.25);
      transition: 0.2s ease;
    }

    .btn-primary:hover {
      transform: translateY(-1px);
      opacity: 0.95;
    }

    .btn-secondary {
      margin-top: 6px;
      width: 100%;
      border: none;
      border-radius: 999px;
      padding: 8px 14px;
      font-size: 13px;
      font-weight: 600;
      cursor: pointer;
      background: #f3f4f6;
      color: #111827;
      transition: 0.15s ease;
    }

    .btn-secondary:hover {
      background: #e5e7eb;
    }

    .status-bar {
      margin-top: 8px;
      font-size: 13px;
      padding: 6px 10px;
      border-radius: 999px;
      display: none;
    }

    .status-bar.ok {
      display: block;
      background: #ecfdf3;
      color: #166534;
      border: 1px solid #bbf7d0;
    }

    .status-bar.err {
      display: block;
      background: #fef2f2;
      color: #b91c1c;
      border: 1px solid #fecaca;
    }

    /* ÙƒØ§Ø±Øª Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø³Ø§Ø¦Ù‚ ÙˆØ§Ù„ØªÙÙˆÙŠØ¶ */
    .info-row {
      display: flex;
      justify-content: space-between;
      gap: 6px;
      font-size: 13px;
      margin-bottom: 4px;
    }

    .info-label {
      color: var(--muted);
    }

    .info-value {
      font-weight: 600;
      color: #111827;
    }

    .pill {
      display: inline-flex;
      align-items: center;
      gap: 4px;
      padding: 3px 8px;
      border-radius: 999px;
      font-size: 11px;
      background: #eff6ff;
      color: #1d4ed8;
      margin-left: 4px;
    }

    .small-title {
      font-size: 13px;
      font-weight: 700;
      margin: 4px 0 6px;
      color: #111827;
    }

    .divider {
      height: 1px;
      background: #e5e7eb;
      margin: 8px 0;
    }

    .auth-select-row {
      display: flex;
      flex-direction: column;
      gap: 4px;
      margin-top: 6px;
    }

    .tag-warning {
      display: inline-block;
      margin-top: 4px;
      font-size: 11px;
      color: #b45309;
      background: #fffbeb;
      border-radius: 999px;
      padding: 3px 8px;
      border: 1px solid #fbbf24;
    }

    .mini-note {
      font-size: 11px;
      color: var(--muted);
      margin-top: 4px;
    }

    .amount-highlight {
      font-size: 16px;
      font-weight: 800;
      color: #16a34a;
    }
  </style>
</head>

<body>

  <!-- ğŸ” Ø§Ù„Ù‡ÙŠØ¯Ø± Ø§Ù„Ø«Ø§Ø¨Øª -->
  <header class="top-bar">
    <button class="back-btn" onclick="location.href='/'">
      ğŸ  Ø±Ø¬ÙˆØ¹
    </button>
    <h1 class="page-title">ğŸ§¾ Ø³Ù†Ø¯ ØªØ­ØµÙŠÙ„ Ù†Ù‚Ø¯ÙŠ Ù…Ù† Ø§Ù„Ø³Ø§Ø¦Ù‚</h1>
  </header>

  <main class="page-content">
    <h2>Ø³Ù†Ø¯ ØªØ­ØµÙŠÙ„ Ù†Ù‚Ø¯ÙŠ</h2>
    <p class="subtitle">
      Ø§Ø³ØªØ®Ø¯Ù… Ù‡Ø°Ù‡ Ø§Ù„Ø´Ø§Ø´Ø© Ù„ØªØ³Ø¬ÙŠÙ„ Ø³Ø¯Ø§Ø¯ Ù†Ù‚Ø¯ÙŠ Ù…Ù† Ø§Ù„Ø³Ø§Ø¦Ù‚ Ø¹Ù† ØªÙÙˆÙŠØ¶ ÙˆØ§Ø­Ø¯ Ø£Ùˆ Ø£ÙƒØ«Ø±ØŒ ÙˆØ³ÙŠØªÙ… Ø¥Ù†Ø´Ø§Ø¡
      <strong>Ù‚ÙŠØ¯ ÙŠÙˆÙ…ÙŠØ© ØªÙ„Ù‚Ø§Ø¦ÙŠÙ‹Ø§</strong> Ù…Ù† Ø­Ù€/ Ø§Ù„ØµÙ†Ø¯ÙˆÙ‚ Ø¥Ù„Ù‰ Ø­Ù€/ Ø­Ø³Ø§Ø¨ Ø§Ù„Ø³Ø§Ø¦Ù‚ÙŠÙ†.
    </p>

    <div class="layout">
      <!-- â¤ Ø§Ù„Ø¬Ø²Ø¡ Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠ: Ù†Ù…ÙˆØ°Ø¬ Ø§Ù„Ø³Ù†Ø¯ -->
      <section class="card">
        <div class="card-header">
          <div>
            <p class="card-header-title">Ø¨ÙŠØ§Ù†Ø§Øª Ø³Ù†Ø¯ Ø§Ù„ØªØ­ØµÙŠÙ„</p>
            <p class="card-header-note">
              Ø§Ø®ØªØ± Ø§Ù„Ø³Ø§Ø¦Ù‚ ÙˆØ§Ù„ØªÙÙˆÙŠØ¶ (Ø¥Ù† ÙˆØ¬Ø¯)ØŒ Ø«Ù… Ø£Ø¯Ø®Ù„ Ù‚ÙŠÙ…Ø© Ø§Ù„Ù…Ø¨Ù„Øº ÙˆØ§Ù„Ø¨ÙŠØ§Ù†ØŒ ÙˆØ§Ø¶ØºØ· "Ø­ÙØ¸ Ø³Ù†Ø¯ Ø§Ù„ØªØ­ØµÙŠÙ„".
            </p>
          </div>
        </div>

        <form id="receiptForm" onsubmit="submitReceipt(event)">
          <div class="form-grid">
            <!-- Ø§Ù„ØªØ§Ø±ÙŠØ® -->
            <div class="form-group">
              <label for="receiptDate">ØªØ§Ø±ÙŠØ® Ø§Ù„Ø³Ù†Ø¯</label>
              <input id="receiptDate" type="datetime-local" />
              <div class="hint">ÙŠØªÙ… Ø¶Ø¨Ø·Ù‡ ØªÙ„Ù‚Ø§Ø¦ÙŠÙ‹Ø§ Ø¹Ù„Ù‰ ØªØ§Ø±ÙŠØ® ÙˆÙˆÙ‚Øª Ø§Ù„Ø¬Ù‡Ø§Ø²ØŒ ÙˆÙŠÙ…ÙƒÙ†Ùƒ ØªØ¹Ø¯ÙŠÙ„Ù‡ ÙŠØ¯ÙˆÙŠÙ‹Ø§.</div>
            </div>

            <!-- Ø§Ù„Ø³Ø§Ø¦Ù‚ -->
            <div class="form-group">
              <label for="driverSelect">Ø§Ù„Ø³Ø§Ø¦Ù‚</label>
              <select id="driverSelect" onchange="onDriverChange()">
                <option value="">Ø§Ø®ØªØ± Ø§Ù„Ø³Ø§Ø¦Ù‚ Ù…Ù† Ø§Ù„Ù‚Ø§Ø¦Ù…Ø©</option>
              </select>
              <div class="hint">ÙŠØªÙ… ØªØ­Ù…ÙŠÙ„ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø³Ø§Ø¦Ù‚ÙŠÙ† ØªÙ„Ù‚Ø§Ø¦ÙŠÙ‹Ø§ Ù…Ù† Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª.</div>
            </div>

            <!-- Ø§Ø³Ù… Ø§Ù„Ø³Ø§Ø¦Ù‚ (Ø­ÙØ±) -->
            <div class="form-group">
              <label for="driverName">Ø§Ø³Ù… Ø§Ù„Ø³Ø§Ø¦Ù‚ (Ù„Ù„ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„ÙŠØ¯ÙˆÙŠ Ø¥Ù† Ù„Ø²Ù…)</label>
              <input type="text" id="driverName" placeholder="ÙŠØªÙ… ØªØ¹Ø¨Ø¦ØªÙ‡ ØªÙ„Ù‚Ø§Ø¦ÙŠÙ‹Ø§ Ø¨Ø¹Ø¯ Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ø³Ø§Ø¦Ù‚ØŒ ÙˆÙŠÙ…ÙƒÙ† ØªØ¹Ø¯ÙŠÙ„Ù‡" />
            </div>

            <!-- Ø§Ø®ØªÙŠØ§Ø± ØªÙÙˆÙŠØ¶ -->
            <div class="form-group">
              <label for="authSelect">Ø§Ù„ØªÙÙˆÙŠØ¶ (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)</label>
              <select id="authSelect" onchange="onAuthChange()">
                <option value="">Ø¨Ø¯ÙˆÙ† Ø±Ø¨Ø· Ø¨ØªÙÙˆÙŠØ¶ Ù…Ø­Ø¯Ø¯</option>
              </select>
              <div class="hint">
                Ù„Ùˆ ÙØªØ­Øª Ø§Ù„Ø´Ø§Ø´Ø© Ù…Ù† Ø±Ø§Ø¨Ø· Ù…Ø«Ù„: <code>?authorization_id=123</code> Ø³ÙŠØªÙ… Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„ØªÙÙˆÙŠØ¶ ØªÙ„Ù‚Ø§Ø¦ÙŠÙ‹Ø§.
              </div>
            </div>

            <!-- Ø§Ù„Ù…Ø¨Ù„Øº -->
            <div class="form-group">
              <label for="amount">Ù‚ÙŠÙ…Ø© Ø§Ù„Ù…Ø¨Ù„Øº (Ø±ÙŠØ§Ù„)</label>
              <input id="amount" type="number" step="0.01" min="0" placeholder="Ù…Ø«Ø§Ù„: 1500.00" />
              <div class="hint">ÙŠÙ…Ø«Ù„ Ù‚ÙŠÙ…Ø© Ø§Ù„Ø³Ø¯Ø§Ø¯ Ø§Ù„Ù†Ù‚Ø¯ÙŠ Ø§Ù„Ø°ÙŠ ØªÙ… Ø§Ø³ØªÙ„Ø§Ù…Ù‡ Ù…Ù† Ø§Ù„Ø³Ø§Ø¦Ù‚.</div>
            </div>

            <!-- Ø¨ÙŠØ§Ù† Ø§Ù„Ø³Ù†Ø¯ -->
            <div class="form-group">
              <label for="description">Ø§Ù„Ø¨ÙŠØ§Ù†</label>
              <textarea id="description" placeholder="Ù…Ø«Ø§Ù„: Ø³Ø¯Ø§Ø¯ Ø¹Ù† ØªÙÙˆÙŠØ¶ Ø±Ù‚Ù… 10 Ø¹Ù† Ø§Ù„ÙØªØ±Ø© Ù…Ù† ... Ø¥Ù„Ù‰ ..."></textarea>
              <div class="hint">ÙŠØªÙ… Ø§Ù‚ØªØ±Ø§Ø­ Ø¨ÙŠØ§Ù† ØªÙ„Ù‚Ø§Ø¦ÙŠ Ø¹Ù†Ø¯ Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„ØªÙÙˆÙŠØ¶ ÙˆÙŠÙ…ÙƒÙ†Ùƒ ØªØ¹Ø¯ÙŠÙ„Ù‡ Ø¨Ø­Ø±Ù‘ÙŠØ©.</div>
            </div>
          </div>

          <button type="submit" class="btn-primary">
            âœ… Ø­ÙØ¸ Ø³Ù†Ø¯ Ø§Ù„ØªØ­ØµÙŠÙ„ ÙˆØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ù‚ÙŠØ¯
          </button>

          <button type="button" class="btn-secondary" onclick="window.print()">
            ğŸ–¨ï¸ Ø·Ø¨Ø§Ø¹Ø© Ø§Ù„Ø³Ù†Ø¯
          </button>

          <div id="statusBar" class="status-bar"></div>
        </form>
      </section>

      <!-- â¤ Ø§Ù„Ø¬Ø²Ø¡ Ø§Ù„Ø¬Ø§Ù†Ø¨ÙŠ: Ù…Ù„Ø®Øµ Ø§Ù„Ø³Ø§Ø¦Ù‚ ÙˆØ§Ù„ØªÙÙˆÙŠØ¶ -->
      <aside class="card">
        <div class="card-header">
          <div>
            <p class="card-header-title">Ù…Ù„Ø®Øµ Ø§Ù„Ø³Ø§Ø¦Ù‚ ÙˆØ§Ù„ØªÙÙˆÙŠØ¶</p>
            <p class="card-header-note">
              ÙŠØ³Ø§Ø¹Ø¯Ùƒ Ø¹Ù„Ù‰ Ù…Ø±Ø§Ø¬Ø¹Ø© Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„ØªÙÙˆÙŠØ¶ Ø§Ù„Ù…Ø®ØªØ§Ø± Ù‚Ø¨Ù„ ØªØ³Ø¬ÙŠÙ„ Ø³Ù†Ø¯ Ø§Ù„ØªØ­ØµÙŠÙ„.
            </p>
          </div>
        </div>

        <div id="summaryEmpty" class="mini-note">
          Ù„Ù… ÙŠØªÙ… Ø§Ø®ØªÙŠØ§Ø± Ø³Ø§Ø¦Ù‚ Ø£Ùˆ ØªÙÙˆÙŠØ¶ Ø¨Ø¹Ø¯. Ø§Ø®ØªØ± Ø§Ù„Ø³Ø§Ø¦Ù‚ Ø«Ù… Ø§Ù„ØªÙÙˆÙŠØ¶ Ù„Ø¹Ø±Ø¶ Ø§Ù„ØªÙØ§ØµÙŠÙ„ Ù‡Ù†Ø§.
        </div>

        <div id="summaryContent" style="display:none;">
          <div class="small-title">ğŸ§‘â€âœˆï¸ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø³Ø§Ø¦Ù‚</div>
          <div class="info-row">
            <span class="info-label">Ø§Ù„Ø§Ø³Ù…:</span>
            <span class="info-value" id="sumDriverName">â€”</span>
          </div>
          <div class="info-row">
            <span class="info-label">Ø±Ù‚Ù… Ø§Ù„Ø±Ø®ØµØ©:</span>
            <span class="info-value" id="sumDriverLicense">â€”</span>
          </div>
          <div class="info-row">
            <span class="info-label">Ø±Ù‚Ù… Ø§Ù„Ø¬ÙˆØ§Ù„:</span>
            <span class="info-value" id="sumDriverPhone">â€”</span>
          </div>

          <div class="divider"></div>

          <div class="small-title">
            ğŸš— Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„ØªÙÙˆÙŠØ¶
            <span class="pill" id="sumAuthStatusPill" style="display:none;"></span>
          </div>

          <div class="info-row">
            <span class="info-label">Ø±Ù‚Ù… Ø§Ù„ØªÙÙˆÙŠØ¶:</span>
            <span class="info-value" id="sumAuthId">â€”</span>
          </div>
          <div class="info-row">
            <span class="info-label">Ø§Ù„Ø³ÙŠØ§Ø±Ø©:</span>
            <span class="info-value" id="sumAuthCar">â€”</span>
          </div>
          <div class="info-row">
            <span class="info-label">Ø§Ù„ÙØªØ±Ø©:</span>
            <span class="info-value" id="sumAuthPeriod">â€”</span>
          </div>
          <div class="info-row">
            <span class="info-label">Ø§Ù„Ø¥ÙŠØ¬Ø§Ø± Ø§Ù„ÙŠÙˆÙ…ÙŠ:</span>
            <span class="info-value" id="sumAuthDailyRent">â€”</span>
          </div>
          <div class="info-row">
            <span class="info-label">Ø¹Ø¯Ø¯ Ø§Ù„Ø£ÙŠØ§Ù… Ø§Ù„Ù…Ø®Ø·Ø·Ø©:</span>
            <span class="info-value" id="sumAuthDays">â€”</span>
          </div>
          <div class="info-row">
            <span class="info-label">Ù‚ÙŠÙ…Ø© Ø§Ù„Ø¥ÙŠØ¬Ø§Ø± Ø§Ù„Ù…Ø®Ø·Ø·Ø©:</span>
            <span class="info-value amount-highlight" id="sumAuthPlannedAmount">â€”</span>
          </div>

          <p class="mini-note">
            Ù‡Ø°Ù‡ Ø§Ù„Ù‚ÙŠÙ…Ø© <strong>Ø¥Ø±Ø´Ø§Ø¯ÙŠØ©</strong> Ù„Ù…Ø³Ø§Ø¹Ø¯ØªÙƒ Ø¹Ù„Ù‰ ØªØ­Ø¯ÙŠØ¯ Ù…Ø¨Ù„Øº Ø§Ù„Ø³Ø¯Ø§Ø¯ØŒ ÙˆÙŠÙ…ÙƒÙ†Ùƒ Ø¥Ø¯Ø®Ø§Ù„ Ø£ÙŠ Ù…Ø¨Ù„Øº ÙŠÙ†Ø§Ø³Ø¨ Ø­Ø§Ù„Ø© Ø§Ù„Ø¹Ù…ÙŠÙ„.
          </p>

          <div class="divider"></div>

          <div class="small-title">ğŸ’¡ ØªÙ„Ù…ÙŠØ­Ø§Øª</div>
          <p class="mini-note">
            Ø¨Ø¹Ø¯ Ø­ÙØ¸ Ø§Ù„Ø³Ù†Ø¯ØŒ ÙŠØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ù‚ÙŠØ¯ ÙÙŠ Ø§Ù„ÙŠÙˆÙ…ÙŠØ© Ø§Ù„Ø¹Ø§Ù…Ø©:
            <br />
            Ù…Ù† Ø­Ù€/ <strong>Ø§Ù„ØµÙ†Ø¯ÙˆÙ‚</strong> (Ù…Ø¯ÙŠÙ†) &nbsp;&nbsp; Ø¥Ù„Ù‰ Ø­Ù€/ <strong>Ø­Ø³Ø§Ø¨ Ø§Ù„Ø³Ø§Ø¦Ù‚ÙŠÙ†</strong> (Ø¯Ø§Ø¦Ù†)
          </p>
        </div>
      </aside>
    </div>
  </main>

  <script>
    let allDrivers = [];
    let allAuthorizations = [];

    // ğŸ”¹ ØªÙ‡ÙŠØ¦Ø© Ø§Ù„ØµÙØ­Ø©
    document.addEventListener("DOMContentLoaded", () => {
      setDefaultDateTime();
      loadDrivers();
      loadAuthorizations();
    });

    // Ø¶Ø¨Ø· Ø§Ù„ØªØ§Ø±ÙŠØ® Ø§Ù„Ø­Ø§Ù„ÙŠ ÙÙŠ input datetime-local
    function setDefaultDateTime() {
      const input = document.getElementById("receiptDate");
      const now = new Date();
      const pad = (n) => String(n).padStart(2, "0");
      const local = new Date(now.getTime() - now.getTimezoneOffset() * 60000);
      const iso = local.toISOString().slice(0, 16); // YYYY-MM-DDTHH:MM
      input.value = iso;
    }

    // ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø³Ø§Ø¦Ù‚ÙŠÙ† Ù…Ù† /api/drivers
    async function loadDrivers() {
      try {
        const res = await fetch("/api/drivers");
        if (!res.ok) throw new Error("HTTP " + res.status);
        const data = await res.json();
        allDrivers = Array.isArray(data) ? data : [];

        const select = document.getElementById("driverSelect");
        select.innerHTML = '<option value="">Ø§Ø®ØªØ± Ø§Ù„Ø³Ø§Ø¦Ù‚ Ù…Ù† Ø§Ù„Ù‚Ø§Ø¦Ù…Ø©</option>';

        allDrivers.forEach(d => {
          const opt = document.createElement("option");
          opt.value = d.id;
          opt.textContent = d.name || ("Ø³Ø§Ø¦Ù‚ #" + d.id);
          select.appendChild(opt);
        });
      } catch (err) {
        console.error(err);
        showStatus("ØªØ¹Ø°Ø± ØªØ­Ù…ÙŠÙ„ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø³Ø§Ø¦Ù‚ÙŠÙ† Ù…Ù† Ø§Ù„Ø®Ø§Ø¯Ù….", true);
      }
    }

    // ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØªÙÙˆÙŠØ¶Ø§Øª Ù…Ù† /api/authorizations
    async function loadAuthorizations() {
      try {
        const res = await fetch("/api/authorizations");
        if (!res.ok) throw new Error("HTTP " + res.status);
        const data = await res.json();
        allAuthorizations = Array.isArray(data) ? data : [];

        populateAuthSelect();
        // Ø¯Ø¹Ù… ÙØªØ­ Ø§Ù„ØµÙØ­Ø© Ø¨Ù€ ?authorization_id=123
        preselectAuthorizationFromURL();
      } catch (err) {
        console.error(err);
        showStatus("ØªØ¹Ø°Ø± ØªØ­Ù…ÙŠÙ„ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„ØªÙÙˆÙŠØ¶Ø§Øª Ù…Ù† Ø§Ù„Ø®Ø§Ø¯Ù….", true);
      }
    }

    function populateAuthSelect() {
      const select = document.getElementById("authSelect");
      const driverSelect = document.getElementById("driverSelect");
      const chosenDriverId = driverSelect.value;

      // Ù†Ø­Ø¯Ø¯ Ø§Ù„ØªÙÙˆÙŠØ¶Ø§Øª Ø§Ù„Ù„ÙŠ ØªØ®Øµ Ø§Ù„Ø³Ø§Ø¦Ù‚ Ø§Ù„Ù…Ø®ØªØ§Ø±ØŒ Ù„Ùˆ Ù…ÙˆØ¬ÙˆØ¯
      let filtered = allAuthorizations;
      if (chosenDriverId) {
        const driver = allDrivers.find(d => String(d.id) === String(chosenDriverId));
        if (driver) {
          filtered = allAuthorizations.filter(a => (a.driver_name || "").trim() === (driver.name || "").trim());
        }
      }

      select.innerHTML = '<option value="">Ø¨Ø¯ÙˆÙ† Ø±Ø¨Ø· Ø¨ØªÙÙˆÙŠØ¶ Ù…Ø­Ø¯Ø¯</option>';

      filtered.forEach(a => {
        const issue = a.issue_date || "";
        const car = a.car_number || "";
        const status = (a.status || "").trim() || "ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ";
        const text =
          `ØªÙÙˆÙŠØ¶ #${a.id} - Ø³ÙŠØ§Ø±Ø© ${car} - Ù…Ù† ${issue} - Ø­Ø§Ù„Ø©: ${status}`;
        const opt = document.createElement("option");
        opt.value = a.id;
        opt.textContent = text;
        select.appendChild(opt);
      });
    }

    function onDriverChange() {
      const driverSelect = document.getElementById("driverSelect");
      const id = driverSelect.value;
      const driverNameInput = document.getElementById("driverName");

      const driver = allDrivers.find(d => String(d.id) === String(id));
      if (driver) {
        driverNameInput.value = driver.name || "";
      }

      populateAuthSelect();
      updateSummary();
    }

    function onAuthChange() {
      // Ø§Ù‚ØªØ±Ø­ Ø¨ÙŠØ§Ù† ØªÙ„Ù‚Ø§Ø¦ÙŠ Ø¨Ù†Ø§Ø¡Ù‹ Ø¹Ù„Ù‰ Ø§Ù„ØªÙÙˆÙŠØ¶
      const authSelect = document.getElementById("authSelect");
      const authId = authSelect.value;
      const descInput = document.getElementById("description");

      const auth = allAuthorizations.find(a => String(a.id) === String(authId));
      if (auth) {
        const from = auth.issue_date || "";
        const to = auth.end_date || auth.planned_end_date || "";
        const car = auth.car_number || "";
        const baseText = `Ø³Ø¯Ø§Ø¯ Ø¹Ù† ØªÙÙˆÙŠØ¶ Ø±Ù‚Ù… ${auth.id} Ø¹Ù† Ø³ÙŠØ§Ø±Ø© ${car} Ø¹Ù† Ø§Ù„ÙØªØ±Ø© Ù…Ù† ${from} Ø­ØªÙ‰ ${to}`;
        // Ù„Ùˆ Ø§Ù„Ø¨ÙŠØ§Ù† ÙØ§Ø¶ÙŠ Ø£Ùˆ ÙƒØ§Ù† Ù†Øµ Ø§ÙØªØ±Ø§Ø¶ÙŠ Ù‚Ø¯ÙŠÙ… Ù†Ø¨Ø¯Ù„Ù‡
        if (!descInput.value.trim() || descInput.value.startsWith("Ø³Ø¯Ø§Ø¯ Ø¹Ù† ØªÙÙˆÙŠØ¶ Ø±Ù‚Ù…")) {
          descInput.value = baseText;
        }
      }

      updateSummary();
    }

    // Ù‚Ø±Ø§Ø¡Ø© authorization_id Ù…Ù† URL Ø¥Ù† ÙˆØ¬Ø¯
    function preselectAuthorizationFromURL() {
      const params = new URLSearchParams(window.location.search);
      const authId = params.get("authorization_id");
      if (!authId) return;

      const authSelect = document.getElementById("authSelect");
      const option = Array.from(authSelect.options).find(
        opt => String(opt.value) === String(authId)
      );
      if (option) {
        authSelect.value = authId;
        onAuthChange();

        // Ù†Ø­Ø§ÙˆÙ„ Ù†Ø¶Ø¨Ø· Ø§Ù„Ø³Ø§Ø¦Ù‚ ØªÙ„Ù‚Ø§Ø¦ÙŠÙ‹Ø§ Ù…Ù† Ø§Ù„ØªÙÙˆÙŠØ¶
        const auth = allAuthorizations.find(a => String(a.id) === String(authId));
        if (auth && auth.driver_name) {
          const driver = allDrivers.find(d => (d.name || "").trim() === (auth.driver_name || "").trim());
          if (driver) {
            const driverSelect = document.getElementById("driverSelect");
            driverSelect.value = driver.id;
            document.getElementById("driverName").value = driver.name || "";
          }
        }
      }
    }

    // ØªØ­Ø¯ÙŠØ« Ù…Ù„Ø®Øµ Ø§Ù„Ø³Ø§Ø¦Ù‚/Ø§Ù„ØªÙÙˆÙŠØ¶ ÙÙŠ Ø§Ù„ÙƒØ§Ø±Øª Ø§Ù„Ø¬Ø§Ù†Ø¨ÙŠ
    function updateSummary() {
      const driverSelect = document.getElementById("driverSelect");
      const driverId = driverSelect.value;
      const authSelect = document.getElementById("authSelect");
      const authId = authSelect.value;

      const summaryEmpty = document.getElementById("summaryEmpty");
      const summaryContent = document.getElementById("summaryContent");

      const d = allDrivers.find(dr => String(dr.id) === String(driverId));
      const a = allAuthorizations.find(au => String(au.id) === String(authId));

      if (!d && !a) {
        summaryEmpty.style.display = "block";
        summaryContent.style.display = "none";
        return;
      }

      summaryEmpty.style.display = "none";
      summaryContent.style.display = "block";

      // Ø³Ø§Ø¦Ù‚
      document.getElementById("sumDriverName").textContent = d ? (d.name || "â€”") : "â€”";
      document.getElementById("sumDriverLicense").textContent = d ? (d.license_no || "â€”") : "â€”";
      document.getElementById("sumDriverPhone").textContent = d ? (d.phone || "â€”") : "â€”";

      // ØªÙÙˆÙŠØ¶
      const pill = document.getElementById("sumAuthStatusPill");
      if (!a) {
        document.getElementById("sumAuthId").textContent = "â€”";
        document.getElementById("sumAuthCar").textContent = "â€”";
        document.getElementById("sumAuthPeriod").textContent = "â€”";
        document.getElementById("sumAuthDailyRent").textContent = "â€”";
        document.getElementById("sumAuthDays").textContent = "â€”";
        document.getElementById("sumAuthPlannedAmount").textContent = "â€”";
        pill.style.display = "none";
      } else {
        document.getElementById("sumAuthId").textContent = a.id || "â€”";
        document.getElementById("sumAuthCar").textContent =
          (a.car_number || "â€”") + " / " + (a.car_model || "") + " " + (a.car_type || "");

        const from = a.issue_date || "";
        const to = a.end_date || a.planned_end_date || "";
        document.getElementById("sumAuthPeriod").textContent = `Ù…Ù† ${from} Ø­ØªÙ‰ ${to}`;

        const daily = a.daily_rent != null ? `${a.daily_rent} Ø±ÙŠØ§Ù„/ÙŠÙˆÙ…` : "â€”";
        document.getElementById("sumAuthDailyRent").textContent = daily;

        const days = a.rental_days != null ? a.rental_days : null;
        document.getElementById("sumAuthDays").textContent = days != null ? `${days} ÙŠÙˆÙ…` : "â€”";

        const plannedAmount =
          a.planned_amount != null ? `${a.planned_amount.toFixed ? a.planned_amount.toFixed(2) : a.planned_amount} Ø±ÙŠØ§Ù„` : "â€”";
        document.getElementById("sumAuthPlannedAmount").textContent = plannedAmount;

        const status = (a.status || "").trim() || "ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ";
        pill.style.display = "inline-flex";
        pill.textContent = `Ø­Ø§Ù„Ø© Ø§Ù„ØªÙÙˆÙŠØ¶: ${status}`;
      }
    }

    // Ø¹Ø±Ø¶ Ø±Ø³Ø§Ù„Ø© Ø­Ø§Ù„Ø© (Ù†Ø¬Ø§Ø­ / Ø®Ø·Ø£)
    function showStatus(message, isError = false) {
      const bar = document.getElementById("statusBar");
      bar.textContent = message || "";
      bar.className = "status-bar " + (isError ? "err" : "ok");
    }

    // Ø¥Ø±Ø³Ø§Ù„ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø³Ù†Ø¯ Ø¥Ù„Ù‰ /api/receipts
    async function submitReceipt(e) {
      e.preventDefault();
      showStatus("");

      const driverSelect = document.getElementById("driverSelect");
      const driverId = driverSelect.value || null;
      const driverName = (document.getElementById("driverName").value || "").trim();
      const authSelect = document.getElementById("authSelect");
      const authId = authSelect.value || null;
      const amountStr = (document.getElementById("amount").value || "").trim();
      const desc = (document.getElementById("description").value || "").trim();
      const dateVal = (document.getElementById("receiptDate").value || "").trim();

      if (!amountStr) {
        showStatus("Ù‚ÙŠÙ…Ø© Ø§Ù„Ù…Ø¨Ù„Øº Ù…Ø·Ù„ÙˆØ¨Ø© Ù„ØªØ³Ø¬ÙŠÙ„ Ø³Ù†Ø¯ Ø§Ù„ØªØ­ØµÙŠÙ„.", true);
        return;
      }

      const payload = {
        amount: amountStr,
        driver_id: driverId ? Number(driverId) : null,
        driver_name: driverName || null,
        authorization_id: authId ? Number(authId) : null,
        description: desc || null,
        date: dateVal || null,
      };

      try {
        const res = await fetch("/api/receipts", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(payload),
        });

        let data = {};
        try {
          data = await res.json();
        } catch (_) {}

        if (!res.ok) {
          const msg = data.error || `Ù„Ù… ÙŠØªÙ… Ø­ÙØ¸ Ø§Ù„Ø³Ù†Ø¯ (HTTP ${res.status})`;
          showStatus(msg, true);
          return;
        }

        showStatus("âœ… ØªÙ… Ø­ÙØ¸ Ø³Ù†Ø¯ Ø§Ù„ØªØ­ØµÙŠÙ„ ÙˆØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ù‚ÙŠØ¯ ÙÙŠ Ø§Ù„ÙŠÙˆÙ…ÙŠØ© Ø§Ù„Ø¹Ø§Ù…Ø© Ø¨Ù†Ø¬Ø§Ø­.");

        // Ù…Ù…ÙƒÙ† Ø¨Ø¹Ø¯ Ø§Ù„Ù†Ø¬Ø§Ø­ ØªÙØ±Ù‘Øº Ø§Ù„Ù…Ø¨Ù„Øº ÙÙ‚Ø· ÙˆØªØ¨Ù‚ÙŠ Ø¨Ø§Ù‚ÙŠ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù„ØªØ³Ø¬ÙŠÙ„ Ø³Ù†Ø¯ Ø¢Ø®Ø± Ù„Ù†ÙØ³ Ø§Ù„Ø³Ø§Ø¦Ù‚
        // document.getElementById("amount").value = "";
        // document.getElementById("description").value = data.receipt ? (data.receipt.description || "") : desc;
      } catch (err) {
        console.error(err);
        showStatus("âš ï¸ ØªØ¹Ø°Ø± Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø®Ø§Ø¯Ù…. ØªØ£ÙƒØ¯ Ø£Ù† Ø§Ù„Ø¨Ø§Ùƒ Ø¥Ù†Ø¯ ÙŠØ¹Ù…Ù„ Ø«Ù… Ø£Ø¹Ø¯ Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø©.", true);
      }
    }
  </script>
</body>
</html>
