<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>ğŸ§¾ Ø³Ù†Ø¯ ØªØ­ØµÙŠÙ„ Ù†Ù‚Ø¯ÙŠ</title>

  <style>
    :root {
      --main-blue: #0d6efd;
      --main-purple: #6c63ff;
      --card-radius: 14px;
      --shadow: 0 4px 12px rgba(0,0,0,0.25);
      --muted: #6b7280;
    }

    * {
      box-sizing: border-box;
    }

    body {
      font-family: "Tajawal", system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      margin: 0;
      background: linear-gradient(135deg, var(--main-blue), var(--main-purple));
      color: #fff;
      min-height: 100vh;
    }

    /* ğŸ” Ø´Ø±ÙŠØ· Ø¹Ù„ÙˆÙŠ Ø«Ø§Ø¨Øª */
    .top-bar {
      position: fixed;
      top: 0;
      right: 0;
      left: 0;
      z-index: 1000;
      background: rgba(0, 0, 0, 0.25);
      backdrop-filter: blur(8px);
      padding: 10px 16px;
      display: flex;
      align-items: center;
      gap: 10px;
      flex-wrap: wrap;
    }

    .top-left {
      display:flex;
      align-items:center;
      gap:8px;
      flex-wrap:wrap;
    }

    .nav-btn {
      border: none;
      border-radius: 999px;
      padding: 8px 14px;
      font-size: 13px;
      font-weight: 600;
      cursor: pointer;
      background: #fff;
      color: var(--main-blue);
      display: inline-flex;
      align-items: center;
      gap: 6px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.25);
      transition: 0.2s ease;
      white-space: nowrap;
      text-decoration:none;
    }

    .nav-btn:hover {
      background: var(--main-blue);
      color: #fff;
      transform: translateY(-1px);
    }

    .page-title {
      margin: 0;
      font-size: 18px;
      font-weight: 700;
      flex: 1;
      text-align: center;
      color: #fff;
    }

    /* Ù…Ø­ØªÙˆÙ‰ Ø§Ù„ØµÙØ­Ø© */
    .page-content {
      max-width: 1100px;
      margin: 0 auto;
      padding: 80px 16px 24px; /* Ù…Ø³Ø§Ø­Ø© Ù„Ù„Ù‡ÙŠØ¯Ø± Ø§Ù„Ø«Ø§Ø¨Øª */
    }

    h2 {
      text-align: center;
      font-size: 24px;
      margin-bottom: 6px;
    }

    .subtitle {
      text-align: center;
      font-size: 14px;
      opacity: 0.9;
      margin-bottom: 20px;
    }

    .layout {
      display: grid;
      grid-template-columns: 2.2fr 1.3fr;
      gap: 16px;
    }

    @media (max-width: 900px) {
      .layout {
        grid-template-columns: 1fr;
      }
    }

    .card {
      background: #ffffff;
      color: #111827;
      border-radius: var(--card-radius);
      box-shadow: var(--shadow);
      padding: 16px 16px 18px;
    }

    .card-header {
      display: flex;
      align-items: center;
      gap: 10px;
      margin-bottom: 10px;
    }

    .card-header-title {
      font-size: 18px;
      font-weight: 700;
      margin: 0;
      color: #111827;
    }

    .card-header-note {
      font-size: 12px;
      color: var(--muted);
    }

    .form-grid {
      display: grid;
      grid-template-columns: repeat(2, minmax(0, 1fr));
      gap: 10px 12px;
    }

    @media (max-width: 640px) {
      .form-grid {
        grid-template-columns: 1fr;
      }
    }

    .form-group {
      display: flex;
      flex-direction: column;
      gap: 4px;
    }

    label {
      font-size: 13px;
      font-weight: 600;
      color: #111827;
    }

    .hint {
      font-size: 11px;
      color: var(--muted);
    }

    input[type="text"],
    input[type="number"],
    input[type="datetime-local"],
    select,
    textarea {
      border-radius: 10px;
      border: 1px solid #e5e7eb;
      padding: 8px 10px;
      font-size: 13px;
      outline: none;
      transition: 0.15s ease;
      font-family: inherit;
    }

    input[type="text"]:focus,
    input[type="number"]:focus,
    input[type="datetime-local"]:focus,
    select:focus,
    textarea:focus {
      border-color: var(--main-blue);
      box-shadow: 0 0 0 2px rgba(13,110,253,0.18);
    }

    textarea {
      min-height: 70px;
      resize: vertical;
    }

    .readonly {
      background: #f9fafb;
    }

    .btn-primary {
      margin-top: 8px;
      width: 100%;
      border: none;
      border-radius: 999px;
      padding: 10px 16px;
      font-size: 15px;
      font-weight: 700;
      cursor: pointer;
      background: linear-gradient(135deg, var(--main-blue), var(--main-purple));
      color: #fff;
      box-shadow: 0 4px 10px rgba(0,0,0,0.25);
      transition: 0.2s ease;
    }

    .btn-primary:hover {
      transform: translateY(-1px);
      opacity: 0.95;
    }

    .btn-secondary {
      margin-top: 6px;
      width: 100%;
      border: none;
      border-radius: 999px;
      padding: 8px 14px;
      font-size: 13px;
      font-weight: 600;
      cursor: pointer;
      background: #f3f4f6;
      color: #111827;
      transition: 0.15s ease;
    }

    .btn-secondary:hover {
      background: #e5e7eb;
    }

    .status-bar {
      margin-top: 8px;
      font-size: 13px;
      padding: 6px 10px;
      border-radius: 999px;
      display: none;
    }

    .status-bar.ok {
      display: block;
      background: #ecfdf3;
      color: #166534;
      border: 1px solid #bbf7d0;
    }

    .status-bar.err {
      display: block;
      background: #fef2f2;
      color: #b91c1c;
      border: 1px solid #fecaca;
    }

    /* ÙƒØ§Ø±Øª Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø³Ø§Ø¦Ù‚ ÙˆØ§Ù„ØªÙÙˆÙŠØ¶ */
    .info-row {
      display: flex;
      justify-content: space-between;
      gap: 6px;
      font-size: 13px;
      margin-bottom: 4px;
    }

    .info-label {
      color: var(--muted);
    }

    .info-value {
      font-weight: 600;
      color: #111827;
    }

    .pill {
      display: inline-flex;
      align-items: center;
      gap: 4px;
      padding: 3px 8px;
      border-radius: 999px;
      font-size: 11px;
      background: #eff6ff;
      color: #1d4ed8;
      margin-left: 4px;
    }

    .small-title {
      font-size: 13px;
      font-weight: 700;
      margin: 4px 0 6px;
      color: #111827;
    }

    .divider {
      height: 1px;
      background: #e5e7eb;
      margin: 8px 0;
    }

    .mini-note {
      font-size: 11px;
      color: var(--muted);
      margin-top: 4px;
    }

    .amount-highlight {
      font-size: 16px;
      font-weight: 800;
      color: #16a34a;
    }

    /* ğŸ–¨ï¸ ØªÙ†Ø³ÙŠÙ‚ Ù„Ù„Ø·Ø¨Ø§Ø¹Ø© */
    @media print {
      body {
        background: #ffffff;
      }

      .top-bar {
        display: none;
      }

      .page-content {
        padding-top: 16px;
      }

      .btn-primary,
      .btn-secondary,
      #statusBar {
        display: none !important;
      }
    }
  </style>
</head>

<body>

  <!-- ğŸ” Ø§Ù„Ù‡ÙŠØ¯Ø± Ø§Ù„Ø«Ø§Ø¨Øª -->
  <header class="top-bar">
    <div class="top-left">
      <a class="nav-btn" href="/dashboard">ğŸ  Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</a>
      <a class="nav-btn" href="/operations">ğŸ“‹ Ø§Ù„Ø¹Ù…Ù„ÙŠØ§Øª</a>
      <a class="nav-btn" href="/accounts">ğŸ“’ Ø¯Ù„ÙŠÙ„ Ø§Ù„Ø­Ø³Ø§Ø¨Ø§Øª</a>
      <a class="nav-btn" href="/ledger">ğŸ“‘ Ø¯ÙØªØ± Ø§Ù„Ø£Ø³ØªØ§Ø°</a>
      <a class="nav-btn" href="/general">ğŸ““ Ø§Ù„ÙŠÙˆÙ…ÙŠØ© Ø§Ù„Ø¹Ø§Ù…Ø©</a>
    </div>
    <h1 class="page-title">ğŸ§¾ Ø³Ù†Ø¯ ØªØ­ØµÙŠÙ„ Ù†Ù‚Ø¯ÙŠ Ù…Ù† Ø§Ù„Ø³Ø§Ø¦Ù‚</h1>
  </header>

  <main class="page-content">
    <h2>Ø³Ù†Ø¯ ØªØ­ØµÙŠÙ„ Ù†Ù‚Ø¯ÙŠ</h2>
    <p class="subtitle">
      Ø§Ø³ØªØ®Ø¯Ù… Ù‡Ø°Ù‡ Ø§Ù„Ø´Ø§Ø´Ø© Ù„ØªØ³Ø¬ÙŠÙ„ Ø³Ø¯Ø§Ø¯ Ù†Ù‚Ø¯ÙŠ Ù…Ù† Ø§Ù„Ø³Ø§Ø¦Ù‚ Ø¹Ù† ØªÙÙˆÙŠØ¶ ÙˆØ§Ø­Ø¯ Ø£Ùˆ Ø£ÙƒØ«Ø±ØŒ ÙˆØ³ÙŠØªÙ… Ø¥Ù†Ø´Ø§Ø¡
      <strong>Ù‚ÙŠØ¯ ÙŠÙˆÙ…ÙŠØ© ØªÙ„Ù‚Ø§Ø¦ÙŠÙ‹Ø§</strong> ÙˆÙÙ‚ Ø´Ø¬Ø±Ø© Ø§Ù„Ø­Ø³Ø§Ø¨Ø§Øª Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©:
      <br>
      Ù…Ù† Ø­Ù€/ <strong>Ø§Ù„ØµÙ†Ø¯ÙˆÙ‚</strong> (Ø£ØµÙ„) &nbsp;&nbsp; Ø¥Ù„Ù‰ Ø­Ù€/ <strong>Ø§Ù„Ø³Ø§Ø¦Ù‚ÙŠÙ† / Ø§Ø³Ù… Ø§Ù„Ø³Ø§Ø¦Ù‚</strong> (Ø£ØµÙ„ â€“ Ø­Ø³Ø§Ø¨ ØªÙØµÙŠÙ„ÙŠ).
      <br>
      Ù„Ùˆ ÙØªØ­Øª Ø§Ù„Ø´Ø§Ø´Ø© Ù…Ù† Ø§Ù„Ø³ÙŠØ§Ø±Ø§Øª Ø§Ù„Ù…Ø¤Ø¬Ø±Ø© Ø¨Ø¹Ø¯ Ø§Ù„Ø¥Ù‚ÙØ§Ù„ØŒ Ø³ÙŠØªÙ… ØªØ¹Ø¨Ø¦Ø© <strong>Ø§Ù„ØªÙÙˆÙŠØ¶</strong> Ùˆ
      <strong>Ø§Ù„Ù…Ø¨Ù„Øº</strong> ØªÙ„Ù‚Ø§Ø¦ÙŠÙ‹Ø§ Ù…Ù† Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¥Ù‚ÙØ§Ù„.
    </p>

    <div class="layout">
      <!-- â¤ Ø§Ù„Ø¬Ø²Ø¡ Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠ: Ù†Ù…ÙˆØ°Ø¬ Ø§Ù„Ø³Ù†Ø¯ -->
      <section class="card">
        <div class="card-header">
          <div>
            <p class="card-header-title">Ø¨ÙŠØ§Ù†Ø§Øª Ø³Ù†Ø¯ Ø§Ù„ØªØ­ØµÙŠÙ„</p>
            <p class="card-header-note">
              Ø§Ø®ØªØ± Ø§Ù„Ø³Ø§Ø¦Ù‚ ÙˆØ§Ù„ØªÙÙˆÙŠØ¶ (Ø¥Ù† ÙˆØ¬Ø¯)ØŒ Ø«Ù… Ø£Ø¯Ø®Ù„ Ù‚ÙŠÙ…Ø© Ø§Ù„Ù…Ø¨Ù„Øº ÙˆØ§Ù„Ø¨ÙŠØ§Ù†ØŒ ÙˆØ§Ø¶ØºØ· "Ø­ÙØ¸ Ø³Ù†Ø¯ Ø§Ù„ØªØ­ØµÙŠÙ„".
            </p>
          </div>
        </div>

        <form id="receiptForm" onsubmit="submitReceipt(event)">
          <div class="form-grid">
            <!-- Ø§Ù„ØªØ§Ø±ÙŠØ® -->
            <div class="form-group">
              <label for="receiptDate">ØªØ§Ø±ÙŠØ® Ø§Ù„Ø³Ù†Ø¯</label>
              <input id="receiptDate" type="datetime-local" />
              <div class="hint">ÙŠØªÙ… Ø¶Ø¨Ø·Ù‡ ØªÙ„Ù‚Ø§Ø¦ÙŠÙ‹Ø§ Ø¹Ù„Ù‰ ØªØ§Ø±ÙŠØ® ÙˆÙˆÙ‚Øª Ø§Ù„Ø¬Ù‡Ø§Ø²ØŒ ÙˆÙŠÙ…ÙƒÙ†Ùƒ ØªØ¹Ø¯ÙŠÙ„Ù‡ ÙŠØ¯ÙˆÙŠÙ‹Ø§.</div>
            </div>

            <!-- Ø§Ù„Ø³Ø§Ø¦Ù‚ -->
            <div class="form-group">
              <label for="driverSearch">Ø§Ù„Ø³Ø§Ø¦Ù‚</label>
              <input id="driverSearch" type="text" placeholder="Ø§ÙƒØªØ¨ Ø§Ø³Ù… Ø§Ù„Ø³Ø§Ø¦Ù‚ Ø£Ùˆ Ø±Ù‚Ù… Ø§Ù„Ø±Ø®ØµØ© Ø£Ùˆ Ø§Ù„Ø¬ÙˆØ§Ù„ Ù„Ù„Ø¨Ø­Ø«..." autocomplete="off" />
              <select id="driverSelect" onchange="onDriverChange()" style="margin-top:6px;">
                <option value="">Ø§Ø®ØªØ± Ø§Ù„Ø³Ø§Ø¦Ù‚ Ù…Ù† Ø§Ù„Ù‚Ø§Ø¦Ù…Ø©</option>
              </select>
              <div class="hint">
                Ø³ÙŠØªÙ… Ù„Ø§Ø­Ù‚Ù‹Ø§ Ø±Ø¨Ø· ÙƒÙ„ Ø³Ø§Ø¦Ù‚ Ø¨Ø­Ø³Ø§Ø¨ ØªÙØµÙŠÙ„ÙŠ ÙÙŠ Ø´Ø¬Ø±Ø© Ø§Ù„Ø­Ø³Ø§Ø¨Ø§Øª:
                <strong>Ø£ØµÙ„ / Ø§Ù„Ø³Ø§Ø¦Ù‚ÙŠÙ† / Ø§Ø³Ù… Ø§Ù„Ø³Ø§Ø¦Ù‚</strong>.
              </div>
            </div>

            <!-- Ø§Ø³Ù… Ø§Ù„Ø³Ø§Ø¦Ù‚ (Ø­ÙØ±) -->
            <div class="form-group">
              <label for="driverName">Ø§Ø³Ù… Ø§Ù„Ø³Ø§Ø¦Ù‚ (Ù„Ù„ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„ÙŠØ¯ÙˆÙŠ Ø¥Ù† Ù„Ø²Ù…)</label>
              <input type="text" id="driverName" placeholder="ÙŠØªÙ… ØªØ¹Ø¨Ø¦ØªÙ‡ ØªÙ„Ù‚Ø§Ø¦ÙŠÙ‹Ø§ Ø¨Ø¹Ø¯ Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ø³Ø§Ø¦Ù‚ØŒ ÙˆÙŠÙ…ÙƒÙ† ØªØ¹Ø¯ÙŠÙ„Ù‡" />
            </div>

            <!-- Ø§Ø®ØªÙŠØ§Ø± ØªÙÙˆÙŠØ¶ -->
            <div class="form-group">
              <label for="authSearch">Ø§Ù„ØªÙÙˆÙŠØ¶ (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)</label>
              <input id="authSearch" type="text" placeholder="Ø§ÙƒØªØ¨ Ø±Ù‚Ù… Ø§Ù„ØªÙÙˆÙŠØ¶ Ø£Ùˆ Ø±Ù‚Ù… Ø§Ù„Ø³ÙŠØ§Ø±Ø© Ù„Ù„Ø¨Ø­Ø«..." autocomplete="off" />
              <select id="authSelect" onchange="onAuthChange()" style="margin-top:6px;">
                <option value="">Ø¨Ø¯ÙˆÙ† Ø±Ø¨Ø· Ø¨ØªÙÙˆÙŠØ¶ Ù…Ø­Ø¯Ø¯</option>
              </select>
              <div class="hint">
                Ù„Ùˆ ÙØªØ­Øª Ø§Ù„Ø´Ø§Ø´Ø© Ù…Ù† Ø±Ø§Ø¨Ø· Ù…Ø«Ù„:
                <code>?authorization_id=123&amp;amount=1450</code> Ø³ÙŠØªÙ… Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„ØªÙÙˆÙŠØ¶
                ÙˆÙ…Ù„Ø¡ Ø§Ù„Ù…Ø¨Ù„Øº ØªÙ„Ù‚Ø§Ø¦ÙŠÙ‹Ø§.
              </div>
            </div>

            <!-- Ø§Ù„Ù…Ø¨Ù„Øº -->
            <div class="form-group">
              <label for="amount">Ù‚ÙŠÙ…Ø© Ø§Ù„Ù…Ø¨Ù„Øº (Ø±ÙŠØ§Ù„)</label>
              <input id="amount" type="number" step="0.01" min="0" placeholder="Ù…Ø«Ø§Ù„: 1500.00" />
              <div class="hint">
                Ù‡Ø°Ø§ Ø§Ù„Ù…Ø¨Ù„Øº Ø³ÙŠÙØ³ØªØ®Ø¯Ù… ÙÙŠ Ø§Ù„Ù‚ÙŠØ¯:
                Ù…Ù† Ø­Ù€/ Ø§Ù„ØµÙ†Ø¯ÙˆÙ‚ (Ù…Ø¯ÙŠÙ†) Ø¥Ù„Ù‰ Ø­Ù€/ Ø§Ù„Ø³Ø§Ø¦Ù‚ÙŠÙ† / Ø§Ø³Ù… Ø§Ù„Ø³Ø§Ø¦Ù‚ (Ø¯Ø§Ø¦Ù†).
              </div>
            </div>

            <!-- Ø¨ÙŠØ§Ù† Ø§Ù„Ø³Ù†Ø¯ -->
            <div class="form-group">
              <label for="description">Ø§Ù„Ø¨ÙŠØ§Ù†</label>
              <textarea id="description" placeholder="Ù…Ø«Ø§Ù„: Ø³Ø¯Ø§Ø¯ Ø¹Ù† ØªÙÙˆÙŠØ¶ Ø±Ù‚Ù… 10 Ø¹Ù† Ø§Ù„ÙØªØ±Ø© Ù…Ù† ... Ø¥Ù„Ù‰ ..."></textarea>
              <div class="hint">ÙŠØªÙ… Ø§Ù‚ØªØ±Ø§Ø­ Ø¨ÙŠØ§Ù† ØªÙ„Ù‚Ø§Ø¦ÙŠ Ø¹Ù†Ø¯ Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„ØªÙÙˆÙŠØ¶ ÙˆÙŠÙ…ÙƒÙ†Ùƒ ØªØ¹Ø¯ÙŠÙ„Ù‡ Ø¨Ø­Ø±Ù‘ÙŠØ©.</div>
            </div>
          </div>

          <button type="submit" class="btn-primary">
            âœ… Ø­ÙØ¸ Ø³Ù†Ø¯ Ø§Ù„ØªØ­ØµÙŠÙ„ ÙˆØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ù‚ÙŠØ¯
          </button>

          <button type="button" class="btn-secondary" onclick="window.print()">
            ğŸ–¨ï¸ Ø·Ø¨Ø§Ø¹Ø© Ø§Ù„Ø³Ù†Ø¯
          </button>

          <div id="statusBar" class="status-bar"></div>
        </form>
      </section>

      <!-- â¤ Ø§Ù„Ø¬Ø²Ø¡ Ø§Ù„Ø¬Ø§Ù†Ø¨ÙŠ: Ù…Ù„Ø®Øµ Ø§Ù„Ø³Ø§Ø¦Ù‚ ÙˆØ§Ù„ØªÙÙˆÙŠØ¶ -->
      <aside class="card">
        <div class="card-header">
          <div>
            <p class="card-header-title">Ù…Ù„Ø®Øµ Ø§Ù„Ø³Ø§Ø¦Ù‚ ÙˆØ§Ù„ØªÙÙˆÙŠØ¶</p>
            <p class="card-header-note">
              ÙŠØ³Ø§Ø¹Ø¯Ùƒ Ø¹Ù„Ù‰ Ù…Ø±Ø§Ø¬Ø¹Ø© Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„ØªÙÙˆÙŠØ¶ Ø§Ù„Ù…Ø®ØªØ§Ø± Ù‚Ø¨Ù„ ØªØ³Ø¬ÙŠÙ„ Ø³Ù†Ø¯ Ø§Ù„ØªØ­ØµÙŠÙ„ ÙˆØ§Ù„ØªØ£ÙƒØ¯ Ù…Ù† ØªÙˆØ§ÙÙ‚Ù‡ Ù…Ø¹ Ø§Ù„Ù‚ÙŠØ¯ Ø§Ù„Ù…Ø­Ø§Ø³Ø¨ÙŠ.
            </p>
          </div>
        </div>

        <div id="summaryEmpty" class="mini-note">
          Ù„Ù… ÙŠØªÙ… Ø§Ø®ØªÙŠØ§Ø± Ø³Ø§Ø¦Ù‚ Ø£Ùˆ ØªÙÙˆÙŠØ¶ Ø¨Ø¹Ø¯. Ø§Ø®ØªØ± Ø§Ù„Ø³Ø§Ø¦Ù‚ Ø«Ù… Ø§Ù„ØªÙÙˆÙŠØ¶ Ù„Ø¹Ø±Ø¶ Ø§Ù„ØªÙØ§ØµÙŠÙ„ Ù‡Ù†Ø§.
        </div>

        <div id="summaryContent" style="display:none;">
          <div class="small-title">ğŸ§‘â€âœˆï¸ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø³Ø§Ø¦Ù‚</div>
          <div class="info-row">
            <span class="info-label">Ø§Ù„Ø§Ø³Ù…:</span>
            <span class="info-value" id="sumDriverName">â€”</span>
          </div>
          <div class="info-row">
            <span class="info-label">Ø±Ù‚Ù… Ø§Ù„Ø±Ø®ØµØ©:</span>
            <span class="info-value" id="sumDriverLicense">â€”</span>
          </div>
          <div class="info-row">
            <span class="info-label">Ø±Ù‚Ù… Ø§Ù„Ø¬ÙˆØ§Ù„:</span>
            <span class="info-value" id="sumDriverPhone">â€”</span>
          </div>

          <div class="divider"></div>

          <div class="small-title">
            ğŸš— Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„ØªÙÙˆÙŠØ¶
            <span class="pill" id="sumAuthStatusPill" style="display:none;"></span>
          </div>

          <div class="info-row">
            <span class="info-label">Ø±Ù‚Ù… Ø§Ù„ØªÙÙˆÙŠØ¶:</span>
            <span class="info-value" id="sumAuthId">â€”</span>
          </div>
          <div class="info-row">
            <span class="info-label">Ø§Ù„Ø³ÙŠØ§Ø±Ø©:</span>
            <span class="info-value" id="sumAuthCar">â€”</span>
          </div>
          <div class="info-row">
            <span class="info-label">Ø§Ù„ÙØªØ±Ø©:</span>
            <span class="info-value" id="sumAuthPeriod">â€”</span>
          </div>
          <div class="info-row">
            <span class="info-label">Ø§Ù„Ø¥ÙŠØ¬Ø§Ø± Ø§Ù„ÙŠÙˆÙ…ÙŠ:</span>
            <span class="info-value" id="sumAuthDailyRent">â€”</span>
          </div>
          <div class="info-row">
            <span class="info-label">Ø¹Ø¯Ø¯ Ø§Ù„Ø£ÙŠØ§Ù… Ø§Ù„Ù…Ø®Ø·Ø·Ø©:</span>
            <span class="info-value" id="sumAuthDays">â€”</span>
          </div>
          <div class="info-row">
            <span class="info-label">Ù‚ÙŠÙ…Ø© Ø§Ù„Ø¥ÙŠØ¬Ø§Ø± Ø§Ù„Ù…Ø®Ø·Ø·Ø©:</span>
            <span class="info-value amount-highlight" id="sumAuthPlannedAmount">â€”</span>
          </div>

          <p class="mini-note">
            Ù‡Ø°Ù‡ Ø§Ù„Ù‚ÙŠÙ…Ø© <strong>Ø¥Ø±Ø´Ø§Ø¯ÙŠØ©</strong> Ù„Ù…Ø³Ø§Ø¹Ø¯ØªÙƒ Ø¹Ù„Ù‰ ØªØ­Ø¯ÙŠØ¯ Ù…Ø¨Ù„Øº Ø§Ù„Ø³Ø¯Ø§Ø¯ØŒ ÙˆÙŠÙ…ÙƒÙ†Ùƒ Ø¥Ø¯Ø®Ø§Ù„ Ø£ÙŠ Ù…Ø¨Ù„Øº ÙŠÙ†Ø§Ø³Ø¨ Ø­Ø§Ù„Ø© Ø§Ù„Ø³Ø§Ø¦Ù‚.
          </p>

          <div class="divider"></div>

          <div class="small-title">ğŸ’¡ ØªÙ„Ù…ÙŠØ­Ø§Øª Ù…Ø­Ø§Ø³Ø¨ÙŠØ©</div>
          <p class="mini-note">
            Ø¨Ø¹Ø¯ Ø­ÙØ¸ Ø§Ù„Ø³Ù†Ø¯ØŒ ÙŠØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ù‚ÙŠØ¯ ÙÙŠ Ø§Ù„ÙŠÙˆÙ…ÙŠØ© Ø§Ù„Ø¹Ø§Ù…Ø© Ø¨Ù†Ø§Ø¡Ù‹ Ø¹Ù„Ù‰ Ø´Ø¬Ø±Ø© Ø§Ù„Ø­Ø³Ø§Ø¨Ø§Øª:
            <br />
            Ù…Ù† Ø­Ù€/ <strong>Ø§Ù„ØµÙ†Ø¯ÙˆÙ‚</strong> (Ø£ØµÙ„ â€“ Ù…Ø¯ÙŠÙ†)
            &nbsp;&nbsp; Ø¥Ù„Ù‰ Ø­Ù€/ <strong>Ø§Ù„Ø³Ø§Ø¦Ù‚ÙŠÙ† / Ø§Ø³Ù… Ø§Ù„Ø³Ø§Ø¦Ù‚</strong> (Ø£ØµÙ„ â€“ Ø­Ø³Ø§Ø¨ ØªÙØµÙŠÙ„ÙŠ Ø¯Ø§Ø¦Ù†).
            <br />
            Ø­Ø³Ø§Ø¨ Ø§Ù„Ø³Ø§Ø¦Ù‚ Ø§Ù„ØªÙØµÙŠÙ„ÙŠ ÙŠÙƒÙˆÙ† ØªØ­Øª Ø§Ù„Ø­Ø³Ø§Ø¨ Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠ:
            <strong>Ø£ØµÙ„ / Ø§Ù„Ø³Ø§Ø¦Ù‚ÙŠÙ† / Ø§Ø³Ù… Ø§Ù„Ø³Ø§Ø¦Ù‚</strong>.
          </p>
        </div>
      </aside>
    </div>
  </main>

  <script>
    let allDrivers = [];
    let allAuthorizations = [];
    const urlParams = new URLSearchParams(window.location.search);

    // ğŸ§© Ù…Ø±Ø§Ø¬Ø¹ Ù„Ø¹Ù†Ø§ØµØ± Ø§Ù„Ø¨Ø­Ø« ÙˆØ§Ù„Ù‚ÙˆØ§Ø¦Ù…
    const driverSearch = document.getElementById("driverSearch");
    const driverSelect = document.getElementById("driverSelect");
    const authSearch   = document.getElementById("authSearch");
    const authSelect   = document.getElementById("authSelect");

    // ğŸ”¹ ØªÙ‡ÙŠØ¦Ø© Ø§Ù„ØµÙØ­Ø©
    document.addEventListener("DOMContentLoaded", () => {
      setDefaultDateTime();
      loadDrivers();
      loadAuthorizations();
      prefillAmountFromURL();

      // Ø±Ø¨Ø· Ø£Ø­Ø¯Ø§Ø« Ø§Ù„Ø¨Ø­Ø«
      driverSearch.addEventListener("input", () => {
        filterDriverOptions(driverSearch.value);
        driverSelect.value = "";
        updateSummary();
      });

      authSearch.addEventListener("input", () => {
        filterAuthOptions(authSearch.value);
        authSelect.value = "";
        updateSummary();
      });
    });

    // Ø¶Ø¨Ø· Ø§Ù„ØªØ§Ø±ÙŠØ® Ø§Ù„Ø­Ø§Ù„ÙŠ
    function setDefaultDateTime() {
      const input = document.getElementById("receiptDate");
      const now = new Date();
      const local = new Date(now.getTime() - now.getTimezoneOffset() * 60000);
      const iso = local.toISOString().slice(0, 16);
      input.value = iso;
    }

    // ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø³Ø§Ø¦Ù‚ÙŠÙ†
    async function loadDrivers() {
      try {
        const res = await fetch("/api/drivers");
        if (!res.ok) throw new Error("HTTP " + res.status);
        const data = await res.json();
        allDrivers = Array.isArray(data) ? data : [];

        driverSelect.innerHTML = '<option value="">Ø§Ø®ØªØ± Ø§Ù„Ø³Ø§Ø¦Ù‚ Ù…Ù† Ø§Ù„Ù‚Ø§Ø¦Ù…Ø©</option>';

        allDrivers.forEach(d => {
          const opt = document.createElement("option");
          opt.value = d.id;
          opt.textContent = d.name || ("Ø³Ø§Ø¦Ù‚ #" + d.id);
          opt.dataset.name    = d.name || "";
          opt.dataset.license = d.license_no || "";
          opt.dataset.phone   = d.phone || "";
          driverSelect.appendChild(opt);
        });

        preselectDriverFromURL();
        filterDriverOptions(driverSearch.value || "");
      } catch (err) {
        console.error(err);
        showStatus("ØªØ¹Ø°Ø± ØªØ­Ù…ÙŠÙ„ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø³Ø§Ø¦Ù‚ÙŠÙ† Ù…Ù† Ø§Ù„Ø®Ø§Ø¯Ù….", true);
      }
    }

    // ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØªÙÙˆÙŠØ¶Ø§Øª
    async function loadAuthorizations() {
      try {
        const res = await fetch("/api/authorizations");
        if (!res.ok) throw new Error("HTTP " + res.status);
        const data = await res.json();
        allAuthorizations = Array.isArray(data) ? data : [];

        populateAuthSelect();
        preselectAuthorizationFromURL();
        updateSummary();
      } catch (err) {
        console.error(err);
        showStatus("ØªØ¹Ø°Ø± ØªØ­Ù…ÙŠÙ„ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„ØªÙÙˆÙŠØ¶Ø§Øª Ù…Ù† Ø§Ù„Ø®Ø§Ø¯Ù….", true);
      }
    }

    function populateAuthSelect() {
      const chosenDriverId = driverSelect.value;

      let filtered = allAuthorizations;
      if (chosenDriverId) {
        const driver = allDrivers.find(d => String(d.id) === String(chosenDriverId));
        if (driver) {
          filtered = allAuthorizations.filter(
            a => (a.driver_name || "").trim() === (driver.name || "").trim()
          );
        }
      }

      authSelect.innerHTML = '<option value="">Ø¨Ø¯ÙˆÙ† Ø±Ø¨Ø· Ø¨ØªÙÙˆÙŠØ¶ Ù…Ø­Ø¯Ø¯</option>';

      filtered.forEach(a => {
        const issue = a.issue_date || "";
        const car   = a.car_number || "";
        const status = (a.status || "").trim() || "ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ";
        const text =
          `ØªÙÙˆÙŠØ¶ #${a.id} - Ø³ÙŠØ§Ø±Ø© ${car} - Ù…Ù† ${issue} - Ø­Ø§Ù„Ø©: ${status}`;
        const opt = document.createElement("option");
        opt.value = a.id;
        opt.textContent = text;
        opt.dataset.authId = a.id;
        opt.dataset.car    = car;
        opt.dataset.status = status;
        authSelect.appendChild(opt);
      });

      filterAuthOptions(authSearch.value || "");
    }

    // ğŸ” ÙÙ„ØªØ±Ø© Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø³Ø§Ø¦Ù‚ÙŠÙ† Ø¨Ù†Ø§Ø¡Ù‹ Ø¹Ù„Ù‰ Ù…Ø§ ÙŠÙÙƒØªØ¨ ÙÙŠ Ø®Ø§Ù†Ø© Ø§Ù„Ø¨Ø­Ø«
    function filterDriverOptions(term) {
      const t = (term || "").trim().toLowerCase();

      Array.from(driverSelect.options).forEach(opt => {
        if (!opt.value) {
          opt.hidden = false;
          return;
        }
        const name  = opt.dataset.name    || "";
        const lic   = opt.dataset.license || "";
        const phone = opt.dataset.phone   || "";
        const combined = `${name} ${lic} ${phone}`.toLowerCase();
        const match = !t || combined.includes(t);
        opt.hidden = !match;
      });
    }

    // ğŸ” ÙÙ„ØªØ±Ø© Ø§Ù„ØªÙÙˆÙŠØ¶Ø§Øª
    function filterAuthOptions(term) {
      const t = (term || "").trim().toLowerCase();

      Array.from(authSelect.options).forEach(opt => {
        if (!opt.value) {
          opt.hidden = false;
          return;
        }
        const id     = (opt.dataset.authId || opt.value || "").toString();
        const car    = opt.dataset.car    || "";
        const status = opt.dataset.status || "";
        const text   = opt.textContent    || "";
        const combined = `${id} ${car} ${status} ${text}`.toLowerCase();
        const match = !t || combined.includes(t);
        opt.hidden = !match;
      });
    }

    // ØªØºÙŠÙŠØ± Ø§Ù„Ø³Ø§Ø¦Ù‚
    function onDriverChange() {
      const id = driverSelect.value;
      const driverNameInput = document.getElementById("driverName");

      const driver = allDrivers.find(d => String(d.id) === String(id));
      if (driver) {
        driverNameInput.value = driver.name || "";
      }

      populateAuthSelect();
      updateSummary();
    }

    // ØªØºÙŠÙŠØ± Ø§Ù„ØªÙÙˆÙŠØ¶
    function onAuthChange() {
      const authId = authSelect.value;
      const descInput = document.getElementById("description");
      const amountInput = document.getElementById("amount");

      const auth = allAuthorizations.find(a => String(a.id) === String(authId));
      if (auth) {
        const from = auth.issue_date || "";
        const to = auth.end_date || auth.planned_end_date || "";
        const car = auth.car_number || "";
        const baseText =
          `Ø³Ø¯Ø§Ø¯ Ø¹Ù† ØªÙÙˆÙŠØ¶ Ø±Ù‚Ù… ${auth.id} Ø¹Ù† Ø³ÙŠØ§Ø±Ø© ${car} Ø¹Ù† Ø§Ù„ÙØªØ±Ø© Ù…Ù† ${from} Ø­ØªÙ‰ ${to}`;

        if (!descInput.value.trim() || descInput.value.startsWith("Ø³Ø¯Ø§Ø¯ Ø¹Ù† ØªÙÙˆÙŠØ¶ Ø±Ù‚Ù…")) {
          descInput.value = baseText;
        }

        if (!amountInput.value.trim()) {
          let suggested = null;

          if (auth.closed_amount != null && !Number.isNaN(Number(auth.closed_amount))) {
            suggested = Number(auth.closed_amount);
          } else if (auth.planned_amount != null && !Number.isNaN(Number(auth.planned_amount))) {
            suggested = Number(auth.planned_amount);
          }

          if (suggested != null) {
            amountInput.value = suggested.toFixed(2);
          }
        }
      }

      updateSummary();
    }

    // Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„ØªÙÙˆÙŠØ¶ Ù…Ù† URL
    function preselectAuthorizationFromURL() {
      const authId = urlParams.get("authorization_id");
      if (!authId) return;

      const option = Array.from(authSelect.options).find(
        opt => String(opt.value) === String(authId)
      );
      if (option) {
        authSelect.value = authId;
        onAuthChange();

        const auth = allAuthorizations.find(a => String(a.id) === String(authId));
        if (auth && auth.driver_name) {
          const driver = allDrivers.find(
            d => (d.name || "").trim() === (auth.driver_name || "").trim()
          );
          if (driver) {
            driverSelect.value = driver.id;
            document.getElementById("driverName").value = driver.name || "";
            driverSearch.value = driver.name || "";
            filterDriverOptions(driverSearch.value);
          }
        }
      }
    }

    function preselectDriverFromURL() {
      const driverId = urlParams.get("driver_id");
      if (!driverId) return;

      const opt = Array.from(driverSelect.options).find(
        o => String(o.value) === String(driverId)
      );
      if (opt) {
        driverSelect.value = driverId;
        const driver = allDrivers.find(d => String(d.id) === String(driverId));
        if (driver) {
          document.getElementById("driverName").value = driver.name || "";
          driverSearch.value = driver.name || "";
          filterDriverOptions(driverSearch.value);
        }
      }
    }

    // ØªØ¹Ø¨Ø¦Ø© Ø§Ù„Ù…Ø¨Ù„Øº Ù…Ù† URL
    function prefillAmountFromURL() {
      const amountParam = urlParams.get("amount");
      if (!amountParam) return;

      const amountInput = document.getElementById("amount");
      const num = Number(amountParam);
      if (!Number.isNaN(num)) {
        amountInput.value = num.toFixed(2);
      }
    }

    // Ù…Ù„Ø®Øµ Ø§Ù„Ø³Ø§Ø¦Ù‚/Ø§Ù„ØªÙÙˆÙŠØ¶
    function updateSummary() {
      const driverId = driverSelect.value;
      const authId = authSelect.value;

      const summaryEmpty = document.getElementById("summaryEmpty");
      const summaryContent = document.getElementById("summaryContent");

      const d = allDrivers.find(dr => String(dr.id) === String(driverId));
      const a = allAuthorizations.find(au => String(au.id) === String(authId));

      if (!d && !a) {
        summaryEmpty.style.display = "block";
        summaryContent.style.display = "none";
        return;
      }

      summaryEmpty.style.display = "none";
      summaryContent.style.display = "block";

      document.getElementById("sumDriverName").textContent = d ? (d.name || "â€”") : "â€”";
      document.getElementById("sumDriverLicense").textContent = d ? (d.license_no || "â€”") : "â€”";
      document.getElementById("sumDriverPhone").textContent = d ? (d.phone || "â€”") : "â€”";

      const pill = document.getElementById("sumAuthStatusPill");
      if (!a) {
        document.getElementById("sumAuthId").textContent = "â€”";
        document.getElementById("sumAuthCar").textContent = "â€”";
        document.getElementById("sumAuthPeriod").textContent = "â€”";
        document.getElementById("sumAuthDailyRent").textContent = "â€”";
        document.getElementById("sumAuthDays").textContent = "â€”";
        document.getElementById("sumAuthPlannedAmount").textContent = "â€”";
        pill.style.display = "none";
      } else {
        document.getElementById("sumAuthId").textContent = a.id || "â€”";
        document.getElementById("sumAuthCar").textContent =
          (a.car_number || "â€”") + " / " + (a.car_model || "") + " " + (a.car_type || "");

        const from = a.issue_date || "";
        const to = a.end_date || a.planned_end_date || "";
        document.getElementById("sumAuthPeriod").textContent = `Ù…Ù† ${from} Ø­ØªÙ‰ ${to}`;

        const daily = a.daily_rent != null ? `${a.daily_rent} Ø±ÙŠØ§Ù„/ÙŠÙˆÙ…` : "â€”";
        document.getElementById("sumAuthDailyRent").textContent = daily;

        const days = a.rental_days != null ? a.rental_days : null;
        document.getElementById("sumAuthDays").textContent = days != null ? `${days} ÙŠÙˆÙ…` : "â€”";

        let plannedAmount = "â€”";
        if (a.planned_amount != null) {
          const val = a.planned_amount.toFixed
            ? a.planned_amount.toFixed(2)
            : a.planned_amount;
          plannedAmount = `${val} Ø±ÙŠØ§Ù„`;
        } else if (a.closed_amount != null) {
          const val = a.closed_amount.toFixed
            ? a.closed_amount.toFixed(2)
            : a.closed_amount;
          plannedAmount = `${val} Ø±ÙŠØ§Ù„`;
        }
        document.getElementById("sumAuthPlannedAmount").textContent = plannedAmount;

        const status = (a.status || "").trim() || "ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ";
        pill.style.display = "inline-flex";
        pill.textContent = `Ø­Ø§Ù„Ø© Ø§Ù„ØªÙÙˆÙŠØ¶: ${status}`;
      }
    }

    // Ø±Ø³Ø§Ù„Ø© Ø­Ø§Ù„Ø© (Ù†Ø¬Ø§Ø­/Ø®Ø·Ø£)
    function showStatus(message, isError = false) {
      const bar = document.getElementById("statusBar");
      if (!message) {
        bar.innerHTML = "";
        bar.style.display = "none";
        return;
      }
      bar.innerHTML = message;
      bar.className = "status-bar " + (isError ? "err" : "ok");
      bar.style.display = "block";
    }

    // Ø¥Ø±Ø³Ø§Ù„ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø³Ù†Ø¯
    async function submitReceipt(e) {
      e.preventDefault();
      showStatus("");

      const driverId   = driverSelect.value || null;
      const driverName = (document.getElementById("driverName").value || "").trim();
      const authId     = authSelect.value || null;
      const amountStr  = (document.getElementById("amount").value || "").trim();
      const desc       = (document.getElementById("description").value || "").trim();
      const dateVal    = (document.getElementById("receiptDate").value || "").trim();

      if (!amountStr) {
        showStatus("Ù‚ÙŠÙ…Ø© Ø§Ù„Ù…Ø¨Ù„Øº Ù…Ø·Ù„ÙˆØ¨Ø© Ù„ØªØ³Ø¬ÙŠÙ„ Ø³Ù†Ø¯ Ø§Ù„ØªØ­ØµÙŠÙ„.", true);
        return;
      }

      const amountNum = Number(amountStr);
      if (Number.isNaN(amountNum) || amountNum <= 0) {
        showStatus("Ù‚ÙŠÙ…Ø© Ø§Ù„Ù…Ø¨Ù„Øº ØºÙŠØ± ØµØ­ÙŠØ­Ø©ØŒ ÙŠØ¬Ø¨ Ø£Ù† ØªÙƒÙˆÙ† Ø±Ù‚Ù…Ù‹Ø§ Ø£ÙƒØ¨Ø± Ù…Ù† ØµÙØ±.", true);
        return;
      }

      if (!driverId && !driverName) {
        showStatus("ÙŠØ¬Ø¨ Ø§Ø®ØªÙŠØ§Ø± Ø³Ø§Ø¦Ù‚ Ø£Ùˆ ÙƒØªØ§Ø¨Ø© Ø§Ø³Ù… Ø§Ù„Ø³Ø§Ø¦Ù‚ Ù‚Ø¨Ù„ Ø­ÙØ¸ Ø§Ù„Ø³Ù†Ø¯.", true);
        return;
      }

      const payload = {
        amount: amountNum,
        driver_id: driverId ? Number(driverId) : null,
        driver_name: driverName || null,
        authorization_id: authId ? Number(authId) : null,
        description: desc || null,
        date: dateVal || null
        // Ù…Ù† Ù†Ø§Ø­ÙŠØ© Ø§Ù„Ø¨Ø§Ùƒ Ø¥Ù†Ø¯ Ù‡Ù†Ø³ØªØ®Ø¯Ù… Ù‡Ø°Ù‡ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù„Ø¥Ù†Ø´Ø§Ø¡ Ù‚ÙŠØ¯:
        // Ù…Ù† Ø§Ù„ØµÙ†Ø¯ÙˆÙ‚ Ø¥Ù„Ù‰ Ø­Ø³Ø§Ø¨ Ø§Ù„Ø³Ø§Ø¦Ù‚ Ø§Ù„ØªÙØµÙŠÙ„ÙŠ ØªØ­Øª "Ø§Ù„Ø³Ø§Ø¦Ù‚ÙŠÙ†".
      };

      try {
        const res = await fetch("/api/receipts", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(payload),
        });

        let data = {};
        try {
          data = await res.json();
        } catch (_) {}

        if (!res.ok) {
          const msg = data.error || `Ù„Ù… ÙŠØªÙ… Ø­ÙØ¸ Ø§Ù„Ø³Ù†Ø¯ (HTTP ${res.status})`;
          showStatus(msg, true);
          return;
        }

        let extraLink = "";
        if (data.receipt && data.receipt.id) {
          const opsUrl = `/operations?type=receipt&receipt_id=${data.receipt.id}`;
          extraLink =
            ` <a href="${opsUrl}" style="color:#1d4ed8; text-decoration:underline; margin-right:6px;">ÙØªØ­ Ø§Ù„Ø¹Ù…Ù„ÙŠØ© ÙÙŠ ØµÙØ­Ø© Ø§Ù„Ø¹Ù…Ù„ÙŠØ§Øª</a>`;
        }

        showStatus(
          "âœ… ØªÙ… Ø­ÙØ¸ Ø³Ù†Ø¯ Ø§Ù„ØªØ­ØµÙŠÙ„ ÙˆØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ù‚ÙŠØ¯ ÙÙŠ Ø§Ù„ÙŠÙˆÙ…ÙŠØ© Ø§Ù„Ø¹Ø§Ù…Ø© Ø¨Ù†Ø¬Ø§Ø­." + extraLink,
          false
        );

      } catch (err) {
        console.error(err);
        showStatus("âš ï¸ ØªØ¹Ø°Ø± Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø®Ø§Ø¯Ù…. ØªØ£ÙƒØ¯ Ø£Ù† Ø§Ù„Ø¨Ø§Ùƒ Ø¥Ù†Ø¯ ÙŠØ¹Ù…Ù„ Ø«Ù… Ø£Ø¹Ø¯ Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø©.", true);
      }
    }
  </script>
</body>
</html>

