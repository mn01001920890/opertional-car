<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>ğŸ§¾ Ø³Ù†Ø¯ ØªØ­ØµÙŠÙ„ Ù†Ù‚Ø¯ÙŠ</title>

  <style>
    :root {
      --main-blue: #0d6efd;
      --main-purple: #6c63ff;
      --card-radius: 14px;
      --shadow: 0 4px 12px rgba(0,0,0,0.25);
      --muted: #6b7280;
    }

    * { box-sizing: border-box; }

    body {
      font-family: "Tajawal", system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      margin: 0;
      background: linear-gradient(135deg, var(--main-blue), var(--main-purple));
      color: #fff;
      min-height: 100vh;
    }

    /* ğŸ” Ø´Ø±ÙŠØ· Ø¹Ù„ÙˆÙŠ Ø«Ø§Ø¨Øª */
    .top-bar {
      position: fixed;
      top: 0;
      right: 0;
      left: 0;
      z-index: 1000;
      background: rgba(0, 0, 0, 0.25);
      backdrop-filter: blur(8px);
      padding: 10px 16px;
      display: flex;
      align-items: center;
      gap: 10px;
      flex-wrap: wrap;
    }

    .top-left {
      display:flex;
      align-items:center;
      gap:8px;
      flex-wrap:wrap;
    }

    .nav-btn {
      border: none;
      border-radius: 999px;
      padding: 8px 14px;
      font-size: 13px;
      font-weight: 600;
      cursor: pointer;
      background: #fff;
      color: var(--main-blue);
      display: inline-flex;
      align-items: center;
      gap: 6px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.25);
      transition: 0.2s ease;
      white-space: nowrap;
      text-decoration:none;
    }

    .nav-btn:hover {
      background: var(--main-blue);
      color: #fff;
      transform: translateY(-1px);
    }

    .nav-btn.active {
      background: var(--main-blue);
      color:#fff;
      box-shadow: 0 0 0 1px rgba(191,219,254,0.8);
    }

    .page-title {
      margin: 0;
      font-size: 18px;
      font-weight: 700;
      flex: 1;
      text-align: center;
      color: #fff;
    }

    /* Ù…Ø­ØªÙˆÙ‰ Ø§Ù„ØµÙØ­Ø© */
    .page-content {
      max-width: 1100px;
      margin: 0 auto;
      padding: 80px 16px 24px; /* Ù…Ø³Ø§Ø­Ø© Ù„Ù„Ù‡ÙŠØ¯Ø± Ø§Ù„Ø«Ø§Ø¨Øª */
    }

    h2 {
      text-align: center;
      font-size: 24px;
      margin-bottom: 6px;
    }

    .subtitle {
      text-align: center;
      font-size: 14px;
      opacity: 0.9;
      margin-bottom: 20px;
      line-height: 1.7;
    }

    .layout {
      display: grid;
      grid-template-columns: 2.2fr 1.3fr;
      gap: 16px;
    }

    @media (max-width: 900px) {
      .layout { grid-template-columns: 1fr; }
    }

    .card {
      background: #ffffff;
      color: #111827;
      border-radius: var(--card-radius);
      box-shadow: var(--shadow);
      padding: 16px 16px 18px;
    }

    .card-header {
      display: flex;
      align-items: center;
      gap: 10px;
      margin-bottom: 10px;
    }

    .card-header-title {
      font-size: 18px;
      font-weight: 700;
      margin: 0;
      color: #111827;
    }

    .card-header-note {
      font-size: 12px;
      color: var(--muted);
      line-height: 1.6;
    }

    .form-grid {
      display: grid;
      grid-template-columns: repeat(2, minmax(0, 1fr));
      gap: 10px 12px;
    }

    @media (max-width: 640px) {
      .form-grid { grid-template-columns: 1fr; }
    }

    .form-group {
      display: flex;
      flex-direction: column;
      gap: 4px;
    }

    label {
      font-size: 13px;
      font-weight: 600;
      color: #111827;
    }

    .hint {
      font-size: 11px;
      color: var(--muted);
      line-height: 1.6;
    }

    input[type="text"],
    input[type="number"],
    input[type="datetime-local"],
    select,
    textarea {
      border-radius: 10px;
      border: 1px solid #e5e7eb;
      padding: 8px 10px;
      font-size: 13px;
      outline: none;
      transition: 0.15s ease;
      font-family: inherit;
    }

    input[type="text"]:focus,
    input[type="number"]:focus,
    input[type="datetime-local"]:focus,
    select:focus,
    textarea:focus {
      border-color: var(--main-blue);
      box-shadow: 0 0 0 2px rgba(13,110,253,0.18);
    }

    textarea {
      min-height: 70px;
      resize: vertical;
    }

    .btn-primary {
      margin-top: 8px;
      width: 100%;
      border: none;
      border-radius: 999px;
      padding: 10px 16px;
      font-size: 15px;
      font-weight: 700;
      cursor: pointer;
      background: linear-gradient(135deg, var(--main-blue), var(--main-purple));
      color: #fff;
      box-shadow: 0 4px 10px rgba(0,0,0,0.25);
      transition: 0.2s ease;
    }

    .btn-primary:hover {
      transform: translateY(-1px);
      opacity: 0.95;
    }

    .btn-secondary {
      margin-top: 6px;
      width: 100%;
      border: none;
      border-radius: 999px;
      padding: 8px 14px;
      font-size: 13px;
      font-weight: 600;
      cursor: pointer;
      background: #f3f4f6;
      color: #111827;
      transition: 0.15s ease;
    }

    .btn-secondary:hover { background: #e5e7eb; }

    .status-bar {
      margin-top: 8px;
      font-size: 13px;
      padding: 8px 12px;
      border-radius: 12px;
      display: none;
      line-height: 1.6;
    }

    .status-bar.ok {
      display: block;
      background: #ecfdf3;
      color: #166534;
      border: 1px solid #bbf7d0;
    }

    .status-bar.err {
      display: block;
      background: #fef2f2;
      color: #b91c1c;
      border: 1px solid #fecaca;
    }

    /* ÙƒØ§Ø±Øª Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø³Ø§Ø¦Ù‚ ÙˆØ§Ù„ØªÙÙˆÙŠØ¶ */
    .info-row {
      display: flex;
      justify-content: space-between;
      gap: 6px;
      font-size: 13px;
      margin-bottom: 4px;
    }

    .info-label { color: var(--muted); }
    .info-value { font-weight: 600; color: #111827; }

    .pill {
      display: inline-flex;
      align-items: center;
      gap: 4px;
      padding: 3px 8px;
      border-radius: 999px;
      font-size: 11px;
      background: #eff6ff;
      color: #1d4ed8;
      margin-left: 4px;
      border: 1px solid rgba(29,78,216,0.18);
    }

    .small-title {
      font-size: 13px;
      font-weight: 700;
      margin: 4px 0 6px;
      color: #111827;
    }

    .divider {
      height: 1px;
      background: #e5e7eb;
      margin: 8px 0;
    }

    .mini-note {
      font-size: 11px;
      color: var(--muted);
      margin-top: 4px;
      line-height: 1.6;
    }

    .amount-highlight {
      font-size: 16px;
      font-weight: 800;
      color: #16a34a;
    }

    /* ===========================
       ğŸ–¨ï¸ Ø·Ø¨Ø§Ø¹Ø© Ø¥ÙŠØµØ§Ù„ Ø³Ù†Ø¯ Ø§Ù„ØªØ­ØµÙŠÙ„
       =========================== */
    #printArea { display: none; }

    @media print {
      @page { size: A4; margin: 12mm; }

      body { background:#fff !important; color:#000 !important; }
      body * { visibility: hidden !important; }

      #printArea, #printArea * { visibility: visible !important; }
      #printArea{
        display:block !important;
        position: static !important;
        direction: rtl;
        font-family: "Tajawal", system-ui, -apple-system, "Segoe UI", sans-serif;
        color:#000;
      }

      .top-bar, .page-content { display:none !important; }
      * { -webkit-print-color-adjust: exact; print-color-adjust: exact; }
    }

    .print-sheet{
      background:#fff;
    }

    .print-head{
      border-bottom: 2px solid #111;
      padding-bottom: 10px;
      margin-bottom: 10px;
      display:flex;
      align-items:flex-end;
      justify-content: space-between;
      gap: 10px;
      flex-wrap: wrap;
    }

    .print-head h1{
      margin:0;
      font-size: 18px;
      font-weight: 900;
    }

    .print-pill{
      border:1px solid #111;
      border-radius: 999px;
      padding: 4px 10px;
      font-size: 12px;
      white-space: nowrap;
    }

    .print-meta{
      margin-top: 10px;
      display:grid;
      grid-template-columns: repeat(3, minmax(0, 1fr));
      gap: 8px 10px;
      font-size: 12px;
    }

    .print-meta .item{
      border: 1px solid #ddd;
      border-radius: 10px;
      padding: 7px 9px;
    }

    .print-meta .k{ font-weight: 900; margin-left: 6px; }
    .print-meta .v{ font-weight: 700; }

    .print-box{
      margin-top: 10px;
      border: 1px solid #ddd;
      border-radius: 12px;
      padding: 10px 12px;
      font-size: 12px;
      line-height: 1.8;
    }

    .print-amount{
      font-size: 16px;
      font-weight: 900;
      direction: ltr;
      text-align: left;
      font-variant-numeric: tabular-nums;
    }

    .print-table{
      width:100%;
      border-collapse: collapse;
      margin-top: 10px;
      font-size: 12px;
      table-layout: fixed;
    }

    .print-table th, .print-table td{
      border: 1px solid #ddd;
      padding: 8px 8px;
      vertical-align: top;
      word-wrap: break-word;
      overflow-wrap: anywhere;
    }

    .print-table th{
      background:#f3f4f6;
      font-weight: 900;
    }

    .print-sig{
      margin-top: 18px;
      display:flex;
      justify-content: space-between;
      gap: 12px;
      flex-wrap: wrap;
    }

    .sig-line{
      width: 46%;
      min-width: 220px;
      border-top: 1px solid #999;
      padding-top: 6px;
      text-align:center;
      font-size: 12px;
    }

    @media (max-width: 768px){
      .print-meta{ grid-template-columns: 1fr; }
    }
  </style>
</head>

<body>

  <!-- ğŸ” Ø§Ù„Ù‡ÙŠØ¯Ø± Ø§Ù„Ø«Ø§Ø¨Øª -->
  <header class="top-bar">
    <div class="top-left">
      <a class="nav-btn" href="/dashboard">ğŸ  Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</a>
      <a class="nav-btn" href="/operations">ğŸ§¾ Ø§Ù„Ø¹Ù…Ù„ÙŠØ§Øª</a>
      <a class="nav-btn active" href="/receipt">ğŸ§¾ Ø³Ù†Ø¯ ØªØ­ØµÙŠÙ„ Ø¬Ø¯ÙŠØ¯</a>
      <a class="nav-btn" href="/receipts-list">ğŸ“‹ Ø³Ù†Ø¯Ø§Øª Ø§Ù„ØªØ­ØµÙŠÙ„</a>
      <a class="nav-btn" href="/accounts">ğŸ“’ Ø¯Ù„ÙŠÙ„ Ø§Ù„Ø­Ø³Ø§Ø¨Ø§Øª</a>
      <a class="nav-btn" href="/ledger">ğŸ“‘ Ø¯ÙØªØ± Ø§Ù„Ø£Ø³ØªØ§Ø°</a>
      <a class="nav-btn" href="/general">ğŸ““ Ø§Ù„ÙŠÙˆÙ…ÙŠØ© Ø§Ù„Ø¹Ø§Ù…Ø©</a>
      <a class="nav-btn" href="/journal-list">ğŸ“œ Ø§Ù„Ù‚ÙŠÙˆØ¯ Ø§Ù„ÙŠØ¯ÙˆÙŠØ©</a>
    </div>
    <h1 class="page-title">ğŸ§¾ Ø³Ù†Ø¯ ØªØ­ØµÙŠÙ„ Ù†Ù‚Ø¯ÙŠ Ù…Ù† Ø§Ù„Ø³Ø§Ø¦Ù‚</h1>
  </header>

  <main class="page-content">
    <h2>Ø³Ù†Ø¯ ØªØ­ØµÙŠÙ„ Ù†Ù‚Ø¯ÙŠ</h2>
    <p class="subtitle">
      Ø§Ø³ØªØ®Ø¯Ù… Ù‡Ø°Ù‡ Ø§Ù„Ø´Ø§Ø´Ø© Ù„ØªØ³Ø¬ÙŠÙ„ Ø³Ø¯Ø§Ø¯ Ù†Ù‚Ø¯ÙŠ Ù…Ù† Ø§Ù„Ø³Ø§Ø¦Ù‚ Ø¹Ù† ØªÙÙˆÙŠØ¶ ÙˆØ§Ø­Ø¯ Ø£Ùˆ Ø£ÙƒØ«Ø±ØŒ ÙˆØ³ÙŠØªÙ… Ø¥Ù†Ø´Ø§Ø¡
      <strong>Ù‚ÙŠØ¯ ÙŠÙˆÙ…ÙŠØ© ØªÙ„Ù‚Ø§Ø¦ÙŠÙ‹Ø§</strong> ÙˆÙÙ‚ Ø´Ø¬Ø±Ø© Ø§Ù„Ø­Ø³Ø§Ø¨Ø§Øª:
      <br>
      Ù…Ù† Ø­Ù€/ <strong>Ø§Ù„ØµÙ†Ø¯ÙˆÙ‚</strong> (Ù…Ø¯ÙŠÙ†) &nbsp;&nbsp; Ø¥Ù„Ù‰ Ø­Ù€/ <strong>Ø§Ù„Ø³Ø§Ø¦Ù‚ÙŠÙ† / Ø§Ø³Ù… Ø§Ù„Ø³Ø§Ø¦Ù‚</strong> (Ø¯Ø§Ø¦Ù†).
      <br>
      Ù„Ùˆ ÙØªØ­Øª Ø§Ù„Ø´Ø§Ø´Ø© Ù…Ù† Ø±Ø§Ø¨Ø· Ù…Ø«Ù„:
      <code style="background:rgba(255,255,255,0.18); padding:2px 6px; border-radius:8px;">
        ?authorization_id=123&amount=1450
      </code>
      Ù‡ÙŠÙ…Ù„Ø§ Ø§Ù„ØªÙÙˆÙŠØ¶ ÙˆØ§Ù„Ù…Ø¨Ù„Øº ØªÙ„Ù‚Ø§Ø¦ÙŠÙ‹Ø§.
    </p>

    <div class="layout">
      <!-- â¤ Ø§Ù„Ø¬Ø²Ø¡ Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠ: Ù†Ù…ÙˆØ°Ø¬ Ø§Ù„Ø³Ù†Ø¯ -->
      <section class="card">
        <div class="card-header">
          <div>
            <p class="card-header-title">Ø¨ÙŠØ§Ù†Ø§Øª Ø³Ù†Ø¯ Ø§Ù„ØªØ­ØµÙŠÙ„</p>
            <p class="card-header-note">
              Ø§Ø®ØªØ§Ø± Ø§Ù„Ø³Ø§Ø¦Ù‚ ÙˆØ§Ù„ØªÙÙˆÙŠØ¶ (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)ØŒ Ø§ÙƒØªØ¨ Ø§Ù„Ù…Ø¨Ù„Øº ÙˆØ§Ù„Ø¨ÙŠØ§Ù†ØŒ ÙˆØ¨Ø¹Ø¯ÙŠÙ† Ø§Ø¶ØºØ· Ø­ÙØ¸.
              Ø¨Ø¹Ø¯ Ø§Ù„Ø­ÙØ¸ ØªÙ‚Ø¯Ø± ØªØ·Ø¨Ø¹ Ø¥ÙŠØµØ§Ù„ Ù…Ù†Ø³Ù‚.
            </p>
          </div>
        </div>

        <form id="receiptForm">
          <div class="form-grid">
            <!-- Ø§Ù„ØªØ§Ø±ÙŠØ® -->
            <div class="form-group">
              <label for="receiptDate">ØªØ§Ø±ÙŠØ® Ø§Ù„Ø³Ù†Ø¯</label>
              <input id="receiptDate" type="datetime-local" />
              <div class="hint">Ø¨ÙŠØªØ¸Ø¨Ø· ØªÙ„Ù‚Ø§Ø¦ÙŠÙ‹Ø§ Ø­Ø³Ø¨ ÙˆÙ‚Øª Ø§Ù„Ø¬Ù‡Ø§Ø²ØŒ ÙˆØªÙ‚Ø¯Ø± ØªØ¹Ø¯Ù„Ù‡.</div>
            </div>

            <!-- Ø§Ù„Ø³Ø§Ø¦Ù‚ -->
            <div class="form-group">
              <label for="driverSearch">Ø§Ù„Ø³Ø§Ø¦Ù‚</label>
              <input id="driverSearch" type="text" placeholder="Ø§Ø¨Ø­Ø« Ø¨Ø§Ù„Ø§Ø³Ù…/Ø§Ù„Ø±Ø®ØµØ©/Ø§Ù„Ø¬ÙˆØ§Ù„..." autocomplete="off" />
              <select id="driverSelect" style="margin-top:6px;">
                <option value="">Ø§Ø®ØªØ± Ø§Ù„Ø³Ø§Ø¦Ù‚ Ù…Ù† Ø§Ù„Ù‚Ø§Ø¦Ù…Ø©</option>
              </select>
              <div class="hint">
                Ø§Ù„Ù‚ÙŠØ¯ Ø§Ù„Ù†Ø§ØªØ¬: Ù…Ù† Ø§Ù„ØµÙ†Ø¯ÙˆÙ‚ (Ù…Ø¯ÙŠÙ†) Ø¥Ù„Ù‰ Ø­Ø³Ø§Ø¨ Ø§Ù„Ø³Ø§Ø¦Ù‚ Ø§Ù„ØªÙØµÙŠÙ„ÙŠ (Ø¯Ø§Ø¦Ù†).
              </div>
            </div>

            <!-- Ø§Ø³Ù… Ø§Ù„Ø³Ø§Ø¦Ù‚ (Ø­ÙØ±) -->
            <div class="form-group">
              <label for="driverName">Ø§Ø³Ù… Ø§Ù„Ø³Ø§Ø¦Ù‚ (Ù„Ù„ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„ÙŠØ¯ÙˆÙŠ Ø¥Ù† Ù„Ø²Ù…)</label>
              <input type="text" id="driverName" placeholder="Ø¨ÙŠØªØ¹Ø¨Ù‘Ù‰ ØªÙ„Ù‚Ø§Ø¦ÙŠÙ‹Ø§ Ø¨Ø¹Ø¯ Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ø³Ø§Ø¦Ù‚" />
            </div>

            <!-- Ø§Ø®ØªÙŠØ§Ø± ØªÙÙˆÙŠØ¶ -->
            <div class="form-group">
              <label for="authSearch">Ø§Ù„ØªÙÙˆÙŠØ¶ (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)</label>
              <input id="authSearch" type="text" placeholder="Ø§Ø¨Ø­Ø« Ø¨Ø±Ù‚Ù… Ø§Ù„ØªÙÙˆÙŠØ¶/Ø§Ù„Ø³ÙŠØ§Ø±Ø©..." autocomplete="off" />
              <select id="authSelect" style="margin-top:6px;">
                <option value="">Ø¨Ø¯ÙˆÙ† Ø±Ø¨Ø· Ø¨ØªÙÙˆÙŠØ¶ Ù…Ø­Ø¯Ø¯</option>
              </select>
              <div class="hint">
                Ù„Ùˆ Ø¬Ø§Ù„Ùƒ Ù…Ù† Ø±Ø§Ø¨Ø· ÙÙŠÙ‡ authorization_id Ù‡ÙŠØ®ØªØ§Ø±Ù‡ ØªÙ„Ù‚Ø§Ø¦ÙŠÙ‹Ø§.
              </div>
            </div>

            <!-- Ø§Ù„Ù…Ø¨Ù„Øº -->
            <div class="form-group">
              <label for="amount">Ù‚ÙŠÙ…Ø© Ø§Ù„Ù…Ø¨Ù„Øº (Ø±ÙŠØ§Ù„)</label>
              <input id="amount" type="number" step="0.01" min="0" placeholder="Ù…Ø«Ø§Ù„: 1500.00" />
              <div class="hint">Ù†ØµÙŠØ­Ø©: Ø®Ù„ÙŠ Ø§Ù„Ù…Ø¨Ù„Øº Ø£ÙƒØ¨Ø± Ù…Ù† ØµÙØ±.</div>
            </div>

            <!-- Ø¨ÙŠØ§Ù† Ø§Ù„Ø³Ù†Ø¯ -->
            <div class="form-group">
              <label for="description">Ø§Ù„Ø¨ÙŠØ§Ù†</label>
              <textarea id="description" placeholder="Ù…Ø«Ø§Ù„: Ø³Ø¯Ø§Ø¯ Ø¹Ù† ØªÙÙˆÙŠØ¶ Ø±Ù‚Ù… ..."></textarea>
              <div class="hint">Ø¨ÙŠØªÙ‚ØªØ±Ø­ ØªÙ„Ù‚Ø§Ø¦ÙŠÙ‹Ø§ Ø¹Ù†Ø¯ Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„ØªÙÙˆÙŠØ¶ ÙˆØªÙ‚Ø¯Ø± ØªØ¹Ø¯Ù„.</div>
            </div>
          </div>

          <button type="submit" class="btn-primary">
            âœ… Ø­ÙØ¸ Ø³Ù†Ø¯ Ø§Ù„ØªØ­ØµÙŠÙ„ ÙˆØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ù‚ÙŠØ¯
          </button>

          <button type="button" class="btn-secondary" id="btnPrintReceipt">
            ğŸ–¨ï¸ Ø·Ø¨Ø§Ø¹Ø© Ø¥ÙŠØµØ§Ù„ Ø§Ù„Ø³Ù†Ø¯ (Ù…Ù†Ø³Ù‚)
          </button>

          <div id="statusBar" class="status-bar"></div>
        </form>
      </section>

      <!-- â¤ Ø§Ù„Ø¬Ø²Ø¡ Ø§Ù„Ø¬Ø§Ù†Ø¨ÙŠ: Ù…Ù„Ø®Øµ Ø§Ù„Ø³Ø§Ø¦Ù‚ ÙˆØ§Ù„ØªÙÙˆÙŠØ¶ -->
      <aside class="card">
        <div class="card-header">
          <div>
            <p class="card-header-title">Ù…Ù„Ø®Øµ Ø§Ù„Ø³Ø§Ø¦Ù‚ ÙˆØ§Ù„ØªÙÙˆÙŠØ¶</p>
            <p class="card-header-note">
              Ø±Ø§Ø¬Ø¹ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù‚Ø¨Ù„ Ø§Ù„Ø­ÙØ¸ ÙˆØ§Ù„ØªØ£ÙƒØ¯ Ù…Ù† Ø§Ù„Ø±Ù‚Ù…/Ø§Ù„Ø³ÙŠØ§Ø±Ø©/Ø§Ù„ÙØªØ±Ø©.
            </p>
          </div>
        </div>

        <div id="summaryEmpty" class="mini-note">
          Ù„Ø³Ù‡ Ù…ÙÙŠØ´ Ø³Ø§Ø¦Ù‚/ØªÙÙˆÙŠØ¶ Ù…Ø®ØªØ§Ø±. Ø§Ø®ØªØ§Ø± Ø§Ù„Ø³Ø§Ø¦Ù‚ Ø«Ù… Ø§Ù„ØªÙÙˆÙŠØ¶ Ù„Ø¹Ø±Ø¶ Ø§Ù„ØªÙØ§ØµÙŠÙ„.
        </div>

        <div id="summaryContent" style="display:none;">
          <div class="small-title">ğŸ§‘â€âœˆï¸ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø³Ø§Ø¦Ù‚</div>
          <div class="info-row">
            <span class="info-label">Ø§Ù„Ø§Ø³Ù…:</span>
            <span class="info-value" id="sumDriverName">â€”</span>
          </div>
          <div class="info-row">
            <span class="info-label">Ø±Ù‚Ù… Ø§Ù„Ø±Ø®ØµØ©:</span>
            <span class="info-value" id="sumDriverLicense">â€”</span>
          </div>
          <div class="info-row">
            <span class="info-label">Ø±Ù‚Ù… Ø§Ù„Ø¬ÙˆØ§Ù„:</span>
            <span class="info-value" id="sumDriverPhone">â€”</span>
          </div>

          <div class="divider"></div>

          <div class="small-title">
            ğŸš— Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„ØªÙÙˆÙŠØ¶
            <span class="pill" id="sumAuthStatusPill" style="display:none;"></span>
          </div>

          <div class="info-row">
            <span class="info-label">Ø±Ù‚Ù… Ø§Ù„ØªÙÙˆÙŠØ¶:</span>
            <span class="info-value" id="sumAuthId">â€”</span>
          </div>
          <div class="info-row">
            <span class="info-label">Ø§Ù„Ø³ÙŠØ§Ø±Ø©:</span>
            <span class="info-value" id="sumAuthCar">â€”</span>
          </div>
          <div class="info-row">
            <span class="info-label">Ø§Ù„ÙØªØ±Ø©:</span>
            <span class="info-value" id="sumAuthPeriod">â€”</span>
          </div>
          <div class="info-row">
            <span class="info-label">Ø§Ù„Ø¥ÙŠØ¬Ø§Ø± Ø§Ù„ÙŠÙˆÙ…ÙŠ:</span>
            <span class="info-value" id="sumAuthDailyRent">â€”</span>
          </div>
          <div class="info-row">
            <span class="info-label">Ø¹Ø¯Ø¯ Ø§Ù„Ø£ÙŠØ§Ù… Ø§Ù„Ù…Ø®Ø·Ø·Ø©:</span>
            <span class="info-value" id="sumAuthDays">â€”</span>
          </div>
          <div class="info-row">
            <span class="info-label">Ù‚ÙŠÙ…Ø© Ø¥Ø±Ø´Ø§Ø¯ÙŠØ©:</span>
            <span class="info-value amount-highlight" id="sumAuthPlannedAmount">â€”</span>
          </div>

          <p class="mini-note">
            Ø§Ù„Ù‚ÙŠÙ…Ø© Ø¯ÙŠ Ø¥Ø±Ø´Ø§Ø¯ÙŠØ© ÙÙ‚Ø· Ù„Ù…Ø³Ø§Ø¹Ø¯ØªÙƒ ÙÙŠ ØªØ­Ø¯ÙŠØ¯ Ù…Ø¨Ù„Øº Ø§Ù„Ø³Ø¯Ø§Ø¯.
          </p>

          <div class="divider"></div>

          <div class="small-title">ğŸ’¡ ØªÙ„Ù…ÙŠØ­ Ù…Ø­Ø§Ø³Ø¨ÙŠ</div>
          <p class="mini-note">
            Ø§Ù„Ù‚ÙŠØ¯ Ø§Ù„Ù†Ø§ØªØ¬ Ø¨Ø¹Ø¯ Ø§Ù„Ø­ÙØ¸:
            <br />
            Ù…Ù† Ø­Ù€/ <strong>Ø§Ù„ØµÙ†Ø¯ÙˆÙ‚</strong> (Ù…Ø¯ÙŠÙ†)
            &nbsp;&nbsp; Ø¥Ù„Ù‰ Ø­Ù€/ <strong>Ø§Ù„Ø³Ø§Ø¦Ù‚ÙŠÙ† / Ø§Ø³Ù… Ø§Ù„Ø³Ø§Ø¦Ù‚</strong> (Ø¯Ø§Ø¦Ù†).
          </p>
        </div>
      </aside>
    </div>
  </main>

  <!-- âœ… Ù…Ù†Ø·Ù‚Ø© Ø·Ø¨Ø§Ø¹Ø© Ø§Ù„Ø¥ÙŠØµØ§Ù„ ÙÙ‚Ø· -->
  <div id="printArea" aria-hidden="true"></div>

  <script>
    let allDrivers = [];
    let allAuthorizations = [];
    const urlParams = new URLSearchParams(window.location.search);

    // Ø¢Ø®Ø± Ø³Ù†Ø¯ Ù…Ø­ÙÙˆØ¸ (Ø¹Ù„Ø´Ø§Ù† Ø²Ø± Ø§Ù„Ø·Ø¨Ø§Ø¹Ø© ÙŠØ·Ø¨Ø¹ Ù†ÙØ³ Ø§Ù„Ø³Ù†Ø¯)
    let lastSavedReceipt = null;

    // Ø¹Ù†Ø§ØµØ±
    const driverSearch = document.getElementById("driverSearch");
    const driverSelect = document.getElementById("driverSelect");
    const authSearch   = document.getElementById("authSearch");
    const authSelect   = document.getElementById("authSelect");
    const btnPrintReceipt = document.getElementById("btnPrintReceipt");

    document.addEventListener("DOMContentLoaded", () => init());

    async function init(){
      setDefaultDateTime();

      // âœ… ØªØ±ØªÙŠØ¨ ØªØ­Ù…ÙŠÙ„ Ù…Ù‡Ù… Ø¹Ø´Ø§Ù† URL prefill ÙŠØ´ØªØºÙ„ ØµØ­
      await loadDrivers();
      await loadAuthorizations();

      // Ø±Ø¨Ø· Ø£Ø­Ø¯Ø§Ø« Ø§Ù„Ø¨Ø­Ø«
      driverSearch.addEventListener("input", () => {
        filterDriverOptions(driverSearch.value);
        driverSelect.value = "";
        document.getElementById("driverName").value = "";
        populateAuthSelect(); // ÙŠØ¹ÙŠØ¯ Ø¨Ù†Ø§Ø¡ Ø§Ù„ØªÙÙˆÙŠØ¶Ø§Øª Ø¨Ø¯ÙˆÙ† Ø³Ø§Ø¦Ù‚ Ù…Ø­Ø¯Ø¯
        authSelect.value = "";
        updateSummary();
      });

      authSearch.addEventListener("input", () => {
        filterAuthOptions(authSearch.value);
        authSelect.value = "";
        updateSummary();
      });

      driverSelect.addEventListener("change", onDriverChange);
      authSelect.addEventListener("change", onAuthChange);

      // âœ… Ø·Ø¨Ù‘Ù‚ Ø£ÙŠ Ù‚ÙŠÙ… Ø¬Ø§ÙŠØ© Ù…Ù† Ø§Ù„Ù€ URL Ø¨Ø¹Ø¯ Ù…Ø§ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§ØªØ­Ù…Ù„Øª
      applyUrlPrefills();

      // Ø²Ø± Ø·Ø¨Ø§Ø¹Ø© Ø§Ù„Ø¥ÙŠØµØ§Ù„ (Ù…Ù†Ø³Ù‚)
      btnPrintReceipt.addEventListener("click", () => {
        const data = lastSavedReceipt || buildReceiptDataFromForm(null);
        printReceipt(data);
      });

      // Ø¥Ø±Ø³Ø§Ù„ ÙÙˆØ±Ù…
      document.getElementById("receiptForm").addEventListener("submit", submitReceipt);
    }

    function setDefaultDateTime() {
      const input = document.getElementById("receiptDate");
      const now = new Date();
      const local = new Date(now.getTime() - now.getTimezoneOffset() * 60000);
      input.value = local.toISOString().slice(0, 16);
    }

    function fmtMoney(n){
      const num = Number(n || 0);
      return num.toFixed(2);
    }

    function escapeHtml(str){
      const s = (str == null ? "" : String(str));
      return s
        .replaceAll("&","&amp;")
        .replaceAll("<","&lt;")
        .replaceAll(">","&gt;")
        .replaceAll('"',"&quot;")
        .replaceAll("'","&#39;");
    }

    function nowStamp(){
      const d = new Date();
      const pad = n => String(n).padStart(2,"0");
      return `${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())} ${pad(d.getHours())}:${pad(d.getMinutes())}:${pad(d.getSeconds())}`;
    }

    // ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø³Ø§Ø¦Ù‚ÙŠÙ†
    async function loadDrivers() {
      try {
        const res = await fetch("/api/drivers");
        if (!res.ok) throw new Error("HTTP " + res.status);
        const data = await res.json();
        allDrivers = Array.isArray(data) ? data : [];

        driverSelect.innerHTML = '<option value="">Ø§Ø®ØªØ± Ø§Ù„Ø³Ø§Ø¦Ù‚ Ù…Ù† Ø§Ù„Ù‚Ø§Ø¦Ù…Ø©</option>';

        allDrivers.forEach(d => {
          const opt = document.createElement("option");
          opt.value = d.id;
          opt.textContent = d.name || ("Ø³Ø§Ø¦Ù‚ #" + d.id);
          opt.dataset.name    = d.name || "";
          opt.dataset.license = d.license_no || "";
          opt.dataset.phone   = d.phone || "";
          driverSelect.appendChild(opt);
        });

        filterDriverOptions(driverSearch.value || "");
      } catch (err) {
        console.error(err);
        showStatus("ØªØ¹Ø°Ø± ØªØ­Ù…ÙŠÙ„ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø³Ø§Ø¦Ù‚ÙŠÙ† Ù…Ù† Ø§Ù„Ø®Ø§Ø¯Ù….", true);
      }
    }

    // ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØªÙÙˆÙŠØ¶Ø§Øª
    async function loadAuthorizations() {
      try {
        const res = await fetch("/api/authorizations");
        if (!res.ok) throw new Error("HTTP " + res.status);
        const data = await res.json();
        allAuthorizations = Array.isArray(data) ? data : [];

        populateAuthSelect();
        updateSummary();
      } catch (err) {
        console.error(err);
        showStatus("ØªØ¹Ø°Ø± ØªØ­Ù…ÙŠÙ„ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„ØªÙÙˆÙŠØ¶Ø§Øª Ù…Ù† Ø§Ù„Ø®Ø§Ø¯Ù….", true);
      }
    }

    function populateAuthSelect() {
      const chosenDriverId = driverSelect.value;

      let filtered = allAuthorizations;

      if (chosenDriverId) {
        const driver = allDrivers.find(d => String(d.id) === String(chosenDriverId));
        filtered = allAuthorizations.filter(a => {
          // Ø§Ù„Ø£ÙØ¶Ù„: Ù„Ùˆ ÙÙŠ driver_id ÙÙŠ Ø§Ù„ØªÙÙˆÙŠØ¶
          if (a.driver_id != null) return String(a.driver_id) === String(chosenDriverId);
          // fallback: Ù…Ù‚Ø§Ø±Ù†Ø© Ø¨Ø§Ù„Ø§Ø³Ù…
          if (driver) return (a.driver_name || "").trim() === (driver.name || "").trim();
          return false;
        });
      }

      authSelect.innerHTML = '<option value="">Ø¨Ø¯ÙˆÙ† Ø±Ø¨Ø· Ø¨ØªÙÙˆÙŠØ¶ Ù…Ø­Ø¯Ø¯</option>';

      filtered.forEach(a => {
        const issue = a.issue_date || "";
        const car   = a.car_number || "";
        const status = (a.status || "").trim() || "ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ";
        const text = `ØªÙÙˆÙŠØ¶ #${a.id} - Ø³ÙŠØ§Ø±Ø© ${car} - Ù…Ù† ${issue} - Ø­Ø§Ù„Ø©: ${status}`;

        const opt = document.createElement("option");
        opt.value = a.id;
        opt.textContent = text;
        opt.dataset.authId = a.id;
        opt.dataset.car    = car;
        opt.dataset.status = status;
        authSelect.appendChild(opt);
      });

      filterAuthOptions(authSearch.value || "");
    }

    function filterDriverOptions(term) {
      const t = (term || "").trim().toLowerCase();

      Array.from(driverSelect.options).forEach(opt => {
        if (!opt.value) { opt.hidden = false; return; }
        const name  = opt.dataset.name    || "";
        const lic   = opt.dataset.license || "";
        const phone = opt.dataset.phone   || "";
        const combined = `${name} ${lic} ${phone}`.toLowerCase();
        opt.hidden = !!t && !combined.includes(t);
      });
    }

    function filterAuthOptions(term) {
      const t = (term || "").trim().toLowerCase();

      Array.from(authSelect.options).forEach(opt => {
        if (!opt.value) { opt.hidden = false; return; }
        const id     = (opt.dataset.authId || opt.value || "").toString();
        const car    = opt.dataset.car    || "";
        const status = opt.dataset.status || "";
        const text   = opt.textContent    || "";
        const combined = `${id} ${car} ${status} ${text}`.toLowerCase();
        opt.hidden = !!t && !combined.includes(t);
      });
    }

    function onDriverChange() {
      const id = driverSelect.value;
      const driverNameInput = document.getElementById("driverName");

      const driver = allDrivers.find(d => String(d.id) === String(id));
      if (driver) {
        driverNameInput.value = driver.name || "";
        driverSearch.value = driver.name || "";
        filterDriverOptions(driverSearch.value);
      } else {
        driverNameInput.value = "";
      }

      // Ø¥Ø¹Ø§Ø¯Ø© Ø¨Ù†Ø§Ø¡ Ø§Ù„ØªÙÙˆÙŠØ¶Ø§Øª Ø§Ù„Ø®Ø§ØµØ© Ø¨Ø§Ù„Ø³Ø§Ø¦Ù‚
      authSelect.value = "";
      authSearch.value = "";
      populateAuthSelect();
      updateSummary();
    }

    function onAuthChange() {
      const authId = authSelect.value;
      const descInput = document.getElementById("description");
      const amountInput = document.getElementById("amount");

      const auth = allAuthorizations.find(a => String(a.id) === String(authId));
      if (auth) {
        const from = auth.issue_date || "";
        const to = auth.end_date || auth.planned_end_date || "";
        const car = auth.car_number || "";
        const baseText = `Ø³Ø¯Ø§Ø¯ Ø¹Ù† ØªÙÙˆÙŠØ¶ Ø±Ù‚Ù… ${auth.id} Ø¹Ù† Ø³ÙŠØ§Ø±Ø© ${car} Ø¹Ù† Ø§Ù„ÙØªØ±Ø© Ù…Ù† ${from} Ø­ØªÙ‰ ${to}`;

        if (!descInput.value.trim() || descInput.value.startsWith("Ø³Ø¯Ø§Ø¯ Ø¹Ù† ØªÙÙˆÙŠØ¶ Ø±Ù‚Ù…")) {
          descInput.value = baseText;
        }

        if (!amountInput.value.trim()) {
          let suggested = null;

          if (auth.closed_amount != null && !Number.isNaN(Number(auth.closed_amount))) {
            suggested = Number(auth.closed_amount);
          } else if (auth.planned_amount != null && !Number.isNaN(Number(auth.planned_amount))) {
            suggested = Number(auth.planned_amount);
          }

          if (suggested != null) amountInput.value = suggested.toFixed(2);
        }

        // Ù„Ùˆ Ø§Ù„ØªÙÙˆÙŠØ¶ ÙÙŠÙ‡ driver_id Ø£Ùˆ driver_name .. Ø­Ø§ÙˆÙ„ Ø¸Ø¨Ø· Ø§Ù„Ø³Ø§Ø¦Ù‚ ØªÙ„Ù‚Ø§Ø¦ÙŠÙ‹Ø§
        if (auth.driver_id != null) {
          const d = allDrivers.find(x => String(x.id) === String(auth.driver_id));
          if (d) {
            driverSelect.value = d.id;
            document.getElementById("driverName").value = d.name || "";
            driverSearch.value = d.name || "";
            filterDriverOptions(driverSearch.value);
            populateAuthSelect();
            authSelect.value = auth.id;
          }
        } else if (auth.driver_name) {
          const d = allDrivers.find(x => (x.name || "").trim() === (auth.driver_name || "").trim());
          if (d) {
            driverSelect.value = d.id;
            document.getElementById("driverName").value = d.name || "";
            driverSearch.value = d.name || "";
            filterDriverOptions(driverSearch.value);
            populateAuthSelect();
            authSelect.value = auth.id;
          }
        }
      }

      updateSummary();
    }

    function applyUrlPrefills(){
      const driverId = urlParams.get("driver_id");
      const authId = urlParams.get("authorization_id");
      const amountParam = urlParams.get("amount");

      // 1) Ù„Ùˆ ÙÙŠ authorization_id: Ù†Ø«Ø¨Øª Ø§Ù„ØªÙÙˆÙŠØ¶ØŒ ÙˆÙ†Ø·Ù„Ø¹ Ø§Ù„Ø³Ø§Ø¦Ù‚ Ù…Ù†Ù‡ (Ù„Ùˆ Ù…ÙˆØ¬ÙˆØ¯)
      if (authId) {
        const auth = allAuthorizations.find(a => String(a.id) === String(authId));
        if (auth) {
          if (auth.driver_id != null) {
            const d = allDrivers.find(x => String(x.id) === String(auth.driver_id));
            if (d) {
              driverSelect.value = d.id;
              document.getElementById("driverName").value = d.name || "";
              driverSearch.value = d.name || "";
              filterDriverOptions(driverSearch.value);
            }
          } else if (auth.driver_name) {
            const d = allDrivers.find(x => (x.name || "").trim() === (auth.driver_name || "").trim());
            if (d) {
              driverSelect.value = d.id;
              document.getElementById("driverName").value = d.name || "";
              driverSearch.value = d.name || "";
              filterDriverOptions(driverSearch.value);
            }
          }
          populateAuthSelect();
          authSelect.value = authId;
          onAuthChange();
        }
      } else if (driverId) {
        // 2) Ù„Ùˆ ÙÙŠ driver_id Ø¨Ø³
        const d = allDrivers.find(x => String(x.id) === String(driverId));
        if (d) {
          driverSelect.value = d.id;
          document.getElementById("driverName").value = d.name || "";
          driverSearch.value = d.name || "";
          filterDriverOptions(driverSearch.value);
          populateAuthSelect();
        }
      }

      // 3) Ù…Ø¨Ù„Øº Ù…Ù† URL
      if (amountParam) {
        const n = Number(amountParam);
        if (!Number.isNaN(n)) document.getElementById("amount").value = n.toFixed(2);
      }

      updateSummary();
    }

    function updateSummary() {
      const driverId = driverSelect.value;
      const authId = authSelect.value;

      const summaryEmpty = document.getElementById("summaryEmpty");
      const summaryContent = document.getElementById("summaryContent");

      const d = allDrivers.find(dr => String(dr.id) === String(driverId));
      const a = allAuthorizations.find(au => String(au.id) === String(authId));

      if (!d && !a) {
        summaryEmpty.style.display = "block";
        summaryContent.style.display = "none";
        return;
      }

      summaryEmpty.style.display = "none";
      summaryContent.style.display = "block";

      document.getElementById("sumDriverName").textContent = d ? (d.name || "â€”") : "â€”";
      document.getElementById("sumDriverLicense").textContent = d ? (d.license_no || "â€”") : "â€”";
      document.getElementById("sumDriverPhone").textContent = d ? (d.phone || "â€”") : "â€”";

      const pill = document.getElementById("sumAuthStatusPill");
      if (!a) {
        document.getElementById("sumAuthId").textContent = "â€”";
        document.getElementById("sumAuthCar").textContent = "â€”";
        document.getElementById("sumAuthPeriod").textContent = "â€”";
        document.getElementById("sumAuthDailyRent").textContent = "â€”";
        document.getElementById("sumAuthDays").textContent = "â€”";
        document.getElementById("sumAuthPlannedAmount").textContent = "â€”";
        pill.style.display = "none";
      } else {
        document.getElementById("sumAuthId").textContent = a.id || "â€”";
        document.getElementById("sumAuthCar").textContent =
          (a.car_number || "â€”") + (a.car_model ? (" / " + a.car_model) : "") + (a.car_type ? (" " + a.car_type) : "");

        const from = a.issue_date || "";
        const to = a.end_date || a.planned_end_date || "";
        document.getElementById("sumAuthPeriod").textContent = `Ù…Ù† ${from} Ø­ØªÙ‰ ${to}`;

        document.getElementById("sumAuthDailyRent").textContent =
          (a.daily_rent != null ? `${a.daily_rent} Ø±ÙŠØ§Ù„/ÙŠÙˆÙ…` : "â€”");

        document.getElementById("sumAuthDays").textContent =
          (a.rental_days != null ? `${a.rental_days} ÙŠÙˆÙ…` : "â€”");

        let plannedAmount = "â€”";
        if (a.planned_amount != null) plannedAmount = `${fmtMoney(a.planned_amount)} Ø±ÙŠØ§Ù„`;
        else if (a.closed_amount != null) plannedAmount = `${fmtMoney(a.closed_amount)} Ø±ÙŠØ§Ù„`;

        document.getElementById("sumAuthPlannedAmount").textContent = plannedAmount;

        const status = (a.status || "").trim() || "ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ";
        pill.style.display = "inline-flex";
        pill.textContent = `Ø­Ø§Ù„Ø© Ø§Ù„ØªÙÙˆÙŠØ¶: ${status}`;
      }
    }

    function showStatus(message, isError = false) {
      const bar = document.getElementById("statusBar");
      if (!message) {
        bar.innerHTML = "";
        bar.style.display = "none";
        return;
      }
      bar.innerHTML = message;
      bar.className = "status-bar " + (isError ? "err" : "ok");
      bar.style.display = "block";
    }

    function buildReceiptDataFromForm(receiptId){
      const driverId   = driverSelect.value || null;
      const driverName = (document.getElementById("driverName").value || "").trim() || null;
      const authId     = authSelect.value || null;
      const amountStr  = (document.getElementById("amount").value || "").trim();
      const desc       = (document.getElementById("description").value || "").trim() || null;
      const dateVal    = (document.getElementById("receiptDate").value || "").trim() || null;

      const amountNum = Number(amountStr || 0);

      const d = allDrivers.find(x => driverId && String(x.id) === String(driverId));
      const a = allAuthorizations.find(x => authId && String(x.id) === String(authId));

      const carText = a
        ? ((a.car_number || "â€”") + (a.car_model ? (" / " + a.car_model) : "") + (a.car_type ? (" " + a.car_type) : ""))
        : "â€”";

      const periodText = a
        ? (`Ù…Ù† ${(a.issue_date || "â€”")} Ø­ØªÙ‰ ${(a.end_date || a.planned_end_date || "â€”")}`)
        : "â€”";

      return {
        id: receiptId,
        date: dateVal,
        amount: amountNum,
        description: desc,
        driver: {
          id: driverId ? Number(driverId) : null,
          name: driverName || (d ? (d.name || null) : null),
          license_no: d ? (d.license_no || null) : null,
          phone: d ? (d.phone || null) : null
        },
        authorization: a ? {
          id: a.id,
          status: a.status || null,
          car: carText,
          period: periodText
        } : null
      };
    }

    function buildPrintReceiptHtml(data){
      const idText = data && data.id ? ("#" + data.id) : "â€”";
      const dateText = data && data.date ? data.date.replace("T"," ") : "â€”";
      const driverName = (data && data.driver && data.driver.name) ? data.driver.name : "â€”";
      const driverLic  = (data && data.driver && data.driver.license_no) ? data.driver.license_no : "â€”";
      const driverPhone= (data && data.driver && data.driver.phone) ? data.driver.phone : "â€”";

      const authId = (data && data.authorization && data.authorization.id) ? ("#" + data.authorization.id) : "â€”";
      const authStatus = (data && data.authorization && data.authorization.status) ? data.authorization.status : "â€”";
      const authCar = (data && data.authorization && data.authorization.car) ? data.authorization.car : "â€”";
      const authPeriod = (data && data.authorization && data.authorization.period) ? data.authorization.period : "â€”";

      const amount = (data && typeof data.amount === "number" && !Number.isNaN(data.amount)) ? data.amount : 0;

      const desc = (data && data.description) ? data.description : "â€”";

      return `
        <div class="print-sheet">
          <div class="print-head">
            <h1>Ø³Ù†Ø¯ ØªØ­ØµÙŠÙ„ Ù†Ù‚Ø¯ÙŠ</h1>
            <div class="print-pill">Ø±Ù‚Ù… Ø§Ù„Ø³Ù†Ø¯: ${escapeHtml(idText)}</div>
          </div>

          <div class="print-meta">
            <div class="item"><span class="k">ØªØ§Ø±ÙŠØ® Ø§Ù„Ø³Ù†Ø¯:</span><span class="v">${escapeHtml(dateText)}</span></div>
            <div class="item"><span class="k">ØªØ§Ø±ÙŠØ® Ø§Ù„Ø·Ø¨Ø§Ø¹Ø©:</span><span class="v">${escapeHtml(nowStamp())}</span></div>
            <div class="item"><span class="k">Ø§Ù„Ø­Ø§Ù„Ø©:</span><span class="v">ØªÙ… Ø§Ù„Ø§Ø³ØªÙ„Ø§Ù… Ù†Ù‚Ø¯Ù‹Ø§</span></div>
          </div>

          <div class="print-box">
            <div><strong>Ø§Ù„Ø³Ø§Ø¦Ù‚:</strong> ${escapeHtml(driverName)}</div>
            <div><strong>Ø§Ù„Ø±Ø®ØµØ©:</strong> ${escapeHtml(driverLic)}</div>
            <div><strong>Ø§Ù„Ø¬ÙˆØ§Ù„:</strong> ${escapeHtml(driverPhone)}</div>
          </div>

          <table class="print-table">
            <thead>
              <tr>
                <th style="width:32%;">Ø¨ÙŠØ§Ù†</th>
                <th>ØªÙØ§ØµÙŠÙ„</th>
              </tr>
            </thead>
            <tbody>
              <tr>
                <td>Ø§Ù„ØªÙÙˆÙŠØ¶</td>
                <td>
                  <div><strong>Ø±Ù‚Ù…:</strong> ${escapeHtml(authId)} &nbsp;&nbsp; <strong>Ø­Ø§Ù„Ø©:</strong> ${escapeHtml(authStatus)}</div>
                  <div><strong>Ø§Ù„Ø³ÙŠØ§Ø±Ø©:</strong> ${escapeHtml(authCar)}</div>
                  <div><strong>Ø§Ù„ÙØªØ±Ø©:</strong> ${escapeHtml(authPeriod)}</div>
                </td>
              </tr>
              <tr>
                <td>Ø§Ù„Ù…Ø¨Ù„Øº</td>
                <td class="print-amount">${escapeHtml(fmtMoney(amount))} SAR</td>
              </tr>
              <tr>
                <td>Ø§Ù„Ø¨ÙŠØ§Ù†</td>
                <td>${escapeHtml(desc)}</td>
              </tr>
              <tr>
                <td>Ø§Ù„Ø£Ø«Ø± Ø§Ù„Ù…Ø­Ø§Ø³Ø¨ÙŠ</td>
                <td>
                  Ù…Ù† Ø­Ù€/ <strong>Ø§Ù„ØµÙ†Ø¯ÙˆÙ‚</strong> (Ù…Ø¯ÙŠÙ†) Ø¥Ù„Ù‰ Ø­Ù€/ <strong>Ø§Ù„Ø³Ø§Ø¦Ù‚ÙŠÙ† / Ø§Ø³Ù… Ø§Ù„Ø³Ø§Ø¦Ù‚</strong> (Ø¯Ø§Ø¦Ù†)
                </td>
              </tr>
            </tbody>
          </table>

          <div class="print-sig">
            <div class="sig-line">Ø§Ù„Ù…ÙØ³ØªÙ„Ù…</div>
            <div class="sig-line">Ø§Ù„Ù…ÙØ­Ø§Ø³Ø¨</div>
          </div>
        </div>
      `;
    }

    function printReceipt(data){
      const printArea = document.getElementById("printArea");
      printArea.innerHTML = buildPrintReceiptHtml(data || buildReceiptDataFromForm(null));

      requestAnimationFrame(() => {
        setTimeout(() => window.print(), 60);
      });
    }

    window.addEventListener("afterprint", () => {
      document.getElementById("printArea").innerHTML = "";
    });

    async function submitReceipt(e) {
      e.preventDefault();
      showStatus("");

      const driverId   = driverSelect.value || null;
      const driverName = (document.getElementById("driverName").value || "").trim();
      const authId     = authSelect.value || null;
      const amountStr  = (document.getElementById("amount").value || "").trim();
      const desc       = (document.getElementById("description").value || "").trim();
      const dateVal    = (document.getElementById("receiptDate").value || "").trim();

      if (!amountStr) {
        showStatus("Ù‚ÙŠÙ…Ø© Ø§Ù„Ù…Ø¨Ù„Øº Ù…Ø·Ù„ÙˆØ¨Ø© Ù„ØªØ³Ø¬ÙŠÙ„ Ø³Ù†Ø¯ Ø§Ù„ØªØ­ØµÙŠÙ„.", true);
        return;
      }

      const amountNum = Number(amountStr);
      if (Number.isNaN(amountNum) || amountNum <= 0) {
        showStatus("Ù‚ÙŠÙ…Ø© Ø§Ù„Ù…Ø¨Ù„Øº ØºÙŠØ± ØµØ­ÙŠØ­Ø©ØŒ Ù„Ø§Ø²Ù… ØªÙƒÙˆÙ† Ø±Ù‚Ù… Ø£ÙƒØ¨Ø± Ù…Ù† ØµÙØ±.", true);
        return;
      }

      if (!driverId && !driverName) {
        showStatus("Ù„Ø§Ø²Ù… ØªØ®ØªØ§Ø± Ø³Ø§Ø¦Ù‚ Ø£Ùˆ ØªÙƒØªØ¨ Ø§Ø³Ù… Ø§Ù„Ø³Ø§Ø¦Ù‚ Ù‚Ø¨Ù„ Ø§Ù„Ø­ÙØ¸.", true);
        return;
      }

      const payload = {
        amount: amountNum,
        driver_id: driverId ? Number(driverId) : null,
        driver_name: driverName || null,
        authorization_id: authId ? Number(authId) : null,
        description: desc || null,
        date: dateVal || null
      };

      try {
        const res = await fetch("/api/receipts", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(payload),
        });

        let data = {};
        try { data = await res.json(); } catch (_) {}

        if (!res.ok) {
          const msg = data.error || `Ù„Ù… ÙŠØªÙ… Ø­ÙØ¸ Ø§Ù„Ø³Ù†Ø¯ (HTTP ${res.status})`;
          showStatus(msg, true);
          return;
        }

        // âœ… Ù…Ø±Ù† ÙÙŠ Ù‚Ø±Ø§Ø¡Ø© id Ø­Ø³Ø¨ Ø§Ø³ØªØ¬Ø§Ø¨Ø© Ø§Ù„Ø³ÙŠØ±ÙØ±
        const receiptId =
          (data && data.receipt && data.receipt.id) ||
          data.id ||
          (data && data.receipt_id) ||
          null;

        const opsUrl = receiptId ? `/operations?type=receipt&receipt_id=${receiptId}` : null;
        const listUrl = `/receipts-list`;

        showStatus(
          `âœ… ØªÙ… Ø­ÙØ¸ Ø³Ù†Ø¯ Ø§Ù„ØªØ­ØµÙŠÙ„ ÙˆØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ù‚ÙŠØ¯ Ø¨Ù†Ø¬Ø§Ø­.` +
          (opsUrl ? ` <a href="${opsUrl}" style="color:#1d4ed8;text-decoration:underline;">Ø¹Ø±Ø¶ Ø§Ù„Ø¹Ù…Ù„ÙŠØ©</a>` : "") +
          ` <a href="${listUrl}" style="color:#1d4ed8;text-decoration:underline; margin-right:6px;">Ø¹Ø±Ø¶ Ø³Ù†Ø¯Ø§Øª Ø§Ù„ØªØ­ØµÙŠÙ„</a>`,
          false
        );

        // Ø®Ø²Ù‘Ù† Ø§Ù„Ø³Ù†Ø¯ Ù„Ù„Ø·Ø¨Ø§Ø¹Ø©
        lastSavedReceipt = buildReceiptDataFromForm(receiptId);

        // ğŸ–¨ï¸ (Ø§Ø®ØªÙŠØ§Ø±ÙŠ) Ø§Ø·Ø¨Ø¹ ØªÙ„Ù‚Ø§Ø¦ÙŠ Ø¨Ø¹Ø¯ Ø§Ù„Ø­ÙØ¸
        printReceipt(lastSavedReceipt);

      } catch (err) {
        console.error(err);
        showStatus("âš ï¸ ØªØ¹Ø°Ø± Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø®Ø§Ø¯Ù…. ØªØ£ÙƒØ¯ Ø¥Ù† Ø§Ù„Ø¨Ø§Ùƒ Ø¥Ù†Ø¯ Ø´ØºØ§Ù„ Ø«Ù… Ø¬Ø±Ù‘Ø¨ ØªØ§Ù†ÙŠ.", true);
      }
    }
  </script>

  <script>
    // ğŸ”’ Ù…Ù†Ø¹ ÙƒÙ„ÙŠÙƒ ÙŠÙ…ÙŠÙ†
    document.addEventListener('contextmenu', function (e) {
      e.preventDefault();
    });

    // ğŸ”’ Ù…Ù†Ø¹ Ù…ÙØ§ØªÙŠØ­ Ø§Ù„Ø£Ø¯ÙˆØ§Øª Ø§Ù„Ù…Ø´Ù‡ÙˆØ±Ø© Ù„Ù„Ù…Ø·ÙˆØ±ÙŠÙ†
    document.addEventListener('keydown', function (e) {
      if (e.key === "F12") e.preventDefault();

      if ((e.ctrlKey && e.shiftKey && (e.key === 'I' || e.key === 'J')) ||
          (e.ctrlKey && e.key === 'U')) {
        e.preventDefault();
      }
    });
  </script>

</body>
</html>
