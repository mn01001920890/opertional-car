<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>ğŸ“‹ Ø³Ù†Ø¯Ø§Øª Ø§Ù„ØªØ­ØµÙŠÙ„ Ø§Ù„Ù†Ù‚Ø¯ÙŠØ©</title>

  <style>
    :root {
      --main-blue: #0d6efd;
      --main-purple: #6c63ff;
      --card-radius: 14px;
      --shadow: 0 4px 12px rgba(0,0,0,0.25);
      --muted: #6b7280;
      --danger: #dc2626;
      --success: #16a34a;
    }

    * {
      box-sizing: border-box;
    }

    body {
      font-family: "Tajawal", system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      margin: 0;
      background: linear-gradient(135deg, var(--main-blue), var(--main-purple));
      color: #fff;
      min-height: 100vh;
    }

    /* ğŸ” Ø´Ø±ÙŠØ· Ø¹Ù„ÙˆÙŠ Ø«Ø§Ø¨Øª */
    .top-bar {
      position: fixed;
      top: 0;
      right: 0;
      left: 0;
      z-index: 1000;
      background: rgba(0, 0, 0, 0.25);
      backdrop-filter: blur(8px);
      padding: 10px 16px;
      display: flex;
      align-items: center;
      gap: 10px;
      flex-wrap: wrap;
    }

    .nav-group {
      display:flex;
      align-items:center;
      gap:8px;
      flex-wrap:wrap;
    }

    .nav-btn {
      border: none;
      border-radius: 999px;
      padding: 8px 14px;
      font-size: 13px;
      font-weight: 600;
      cursor: pointer;
      background: #fff;
      color: var(--main-blue);
      display: inline-flex;
      align-items: center;
      gap: 6px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.25);
      transition: 0.2s ease;
      white-space: nowrap;
      text-decoration:none;
    }

    .nav-btn:hover {
      background: var(--main-blue);
      color: #fff;
      transform: translateY(-1px);
    }

    .page-title {
      margin: 0;
      font-size: 18px;
      font-weight: 700;
      flex: 1;
      text-align: center;
      color: #fff;
    }

    .top-right-actions {
      display:flex;
      align-items:center;
      gap:8px;
      flex-wrap:wrap;
    }

    .small-link-btn {
      border: none;
      border-radius: 999px;
      padding: 7px 12px;
      font-size: 12px;
      font-weight: 600;
      cursor: pointer;
      background: rgba(255,255,255,0.12);
      color: #e5e7eb;
      transition: 0.2s ease;
      white-space: nowrap;
    }

    .small-link-btn:hover {
      background: rgba(255,255,255,0.22);
    }

    /* Ù…Ø­ØªÙˆÙ‰ Ø§Ù„ØµÙØ­Ø© */
    .page-content {
      max-width: 1200px;
      margin: 0 auto;
      padding: 80px 16px 24px; /* Ù…Ø³Ø§Ø­Ø© Ù„Ù„Ù‡ÙŠØ¯Ø± Ø§Ù„Ø«Ø§Ø¨Øª */
    }

    h2 {
      text-align: center;
      font-size: 24px;
      margin-bottom: 6px;
    }

    .subtitle {
      text-align: center;
      font-size: 14px;
      opacity: 0.9;
      margin-bottom: 18px;
    }

    /* Ø´Ø±ÙŠØ· Ø§Ù„ÙÙ„ØªØ±Ø© ÙˆØ§Ù„Ø¹Ø¯Ø§Ø¯ */
    .toolbar {
      display: flex;
      flex-wrap: wrap;
      align-items: center;
      gap: 10px;
      margin-bottom: 12px;
    }

    .toolbar-card {
      background: rgba(255,255,255,0.97);
      color: #111827;
      border-radius: var(--card-radius);
      box-shadow: var(--shadow);
      padding: 10px 12px;
      display: flex;
      flex-wrap: wrap;
      align-items: center;
      gap: 10px;
      width: 100%;
    }

    .counter-pill {
      border-radius: 999px;
      padding: 6px 12px;
      background: #ecfdf3;
      color: #166534;
      font-size: 13px;
      font-weight: 700;
      display: inline-flex;
      align-items: center;
      gap: 6px;
      white-space: nowrap;
    }

    .total-pill {
      border-radius: 999px;
      padding: 6px 12px;
      background: #eff6ff;
      color: #1d4ed8;
      font-size: 13px;
      font-weight: 700;
      display: inline-flex;
      align-items: center;
      gap: 6px;
      white-space: nowrap;
    }

    .filters-group {
      display:flex;
      flex-wrap:wrap;
      align-items:center;
      gap:8px;
      flex:1;
      min-width:220px;
    }

    .filter-item {
      display:flex;
      flex-direction:column;
      gap:3px;
    }

    .filter-label {
      font-size:11px;
      color: var(--muted);
    }

    .filter-input,
    .filter-date {
      border-radius: 999px;
      border: 1px solid #e5e7eb;
      padding: 6px 10px;
      font-size: 12px;
      outline: none;
      font-family: inherit;
      min-width: 130px;
    }

    .filter-input:focus,
    .filter-date:focus {
      border-color: var(--main-blue);
      box-shadow: 0 0 0 2px rgba(13,110,253,0.18);
    }

    .badge {
      font-size: 11px;
      border-radius: 999px;
      padding: 4px 8px;
      background: #f3f4f6;
      color: #4b5563;
      white-space: nowrap;
    }

    /* Ø´Ø±ÙŠØ· Ø§Ù„Ø­Ø§Ù„Ø© */
    .status-bar {
      margin-top: 10px;
      font-size: 13px;
      padding: 6px 10px;
      border-radius: 999px;
      display: none;
    }

    .status-bar.ok {
      display: block;
      background: #ecfdf3;
      color: #166534;
      border: 1px solid #bbf7d0;
    }

    .status-bar.err {
      display: block;
      background: #fef2f2;
      color: #b91c1c;
      border: 1px solid #fecaca;
    }

    /* ÙƒØ±ÙˆØª (Ù…ÙˆØ¨Ø§ÙŠÙ„) */
    .cards-grid {
      display: grid;
      grid-template-columns: repeat(3, minmax(0, 1fr));
      gap: 12px;
    }

    @media (max-width: 1024px) {
      .cards-grid {
        grid-template-columns: repeat(2, minmax(0, 1fr));
      }
    }

    @media (max-width: 700px) {
      .cards-grid {
        grid-template-columns: 1fr;
      }
    }

    .card {
      background: #ffffff;
      color: #111827;
      border-radius: var(--card-radius);
      box-shadow: var(--shadow);
      padding: 10px 12px;
      display: flex;
      flex-direction: column;
      gap: 6px;
      border: 1px solid #e5e7eb;
      font-size: 13px;
    }

    .card-header-line {
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:6px;
    }

    .card-title {
      margin:0;
      font-size:14px;
      font-weight:700;
      display:flex;
      align-items:center;
      gap:6px;
      flex-wrap:wrap;
    }

    .pill-id {
      border-radius: 999px;
      background: #eef2ff;
      color: #3730a3;
      padding: 3px 8px;
      font-size: 11px;
      font-weight: 700;
    }

    .pill-date {
      font-size:11px;
      color: #4b5563;
    }

    .row {
      display:flex;
      justify-content:space-between;
      gap:6px;
      font-size:13px;
    }

    .row span {
      display:inline-flex;
      align-items:center;
      gap:4px;
    }

    .label {
      color: var(--muted);
      font-size:12px;
    }

    .value {
      font-weight:600;
    }

    .amount-strong {
      font-weight:800;
      color: #16a34a;
    }

    .desc-text {
      font-size:12px;
      color:#111827;
    }

    .divider {
      height:1px;
      background:#e5e7eb;
      margin:4px 0;
    }

    .actions-row {
      display:flex;
      flex-wrap:wrap;
      gap:6px;
      margin-top:4px;
    }

    .btn-sm-outline {
      border-radius: 999px;
      border: 1px solid #e5e7eb;
      padding: 5px 9px;
      font-size: 11px;
      font-weight: 600;
      cursor: pointer;
      background: #f9fafb;
      color: #111827;
      display:inline-flex;
      align-items:center;
      gap:4px;
      transition:0.15s ease;
      white-space:nowrap;
    }

    .btn-sm-outline:hover {
      background:#e5e7eb;
    }

    /* Ø¬Ø¯ÙˆÙ„ (Ø´Ø§Ø´Ø§Øª ÙƒØ¨ÙŠØ±Ø©) */
    .table-wrapper {
      display:none;
      margin-top:14px;
    }

    .table-card {
      background: rgba(255,255,255,0.98);
      color:#111827;
      border-radius:var(--card-radius);
      box-shadow:var(--shadow);
      padding:10px 12px;
      overflow-x:auto;
    }

    table {
      width:100%;
      border-collapse:collapse;
      font-size:12.5px;
      direction:rtl;
    }

    thead {
      background:#f3f4f6;
    }

    th, td {
      padding:6px 8px;
      border-bottom:1px solid #e5e7eb;
      text-align:right;
      white-space:nowrap;
    }

    th {
      font-weight:700;
      font-size:12px;
      color:#374151;
    }

    tbody tr:nth-child(even) {
      background:#f9fafb;
    }

    .td-amount {
      font-weight:700;
      color:#16a34a;
    }

    .td-ref {
      font-size:12px;
      color:#4b5563;
    }

    .td-actions {
      display:flex;
      flex-wrap:wrap;
      gap:4px;
    }

    @media (min-width: 900px) {
      .cards-grid {
        display:none;
      }
      .table-wrapper {
        display:block;
      }
    }

    @media (max-width: 899px) {
      .cards-grid {
        display:grid;
      }
      .table-wrapper {
        display:none;
      }
    }

    .empty-state {
      margin-top: 18px;
      background: rgba(255,255,255,0.96);
      color: #111827;
      padding: 14px 16px;
      border-radius: var(--card-radius);
      box-shadow: var(--shadow);
      font-size: 14px;
      display: none;
      flex-direction: column;
      gap: 4px;
    }

    .empty-state strong {
      font-weight:700;
    }

    .small-note {
      font-size:11px;
      color:#6b7280;
      margin-top:4px;
    }

    /* Ø·Ø¨Ø§Ø¹Ø© (Ù…Ù…ÙƒÙ† ØªØ·Ø¨Ø¹ Ø§Ù„Ø¬Ø¯ÙˆÙ„) */
    @media print {
      body {
        background:#ffffff;
      }
      .top-bar {
        display:none;
      }
      .page-content {
        padding-top:16px;
      }
      .status-bar,
      .small-link-btn {
        display:none !important;
      }
    }
  </style>
</head>

<body>
  <!-- ğŸ” Ø§Ù„Ù‡ÙŠØ¯Ø± -->
  <header class="top-bar">
    <div class="nav-group">
      <button class="nav-btn" onclick="location.href='/dashboard'">ğŸ  Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</button>
      <button class="nav-btn" onclick="location.href='/operations'">ğŸ§¾ Ø§Ù„Ø¹Ù…Ù„ÙŠØ§Øª</button>
      <button class="nav-btn" onclick="location.href='/receipt'">ğŸ§¾ Ø³Ù†Ø¯ ØªØ­ØµÙŠÙ„ Ø¬Ø¯ÙŠØ¯</button>
      <button class="nav-btn" onclick="location.href='/accounts'">ğŸ“’ Ø¯Ù„ÙŠÙ„ Ø§Ù„Ø­Ø³Ø§Ø¨Ø§Øª</button>
      <button class="nav-btn" onclick="location.href='/ledger'">ğŸ“‘ Ø¯ÙØªØ± Ø§Ù„Ø£Ø³ØªØ§Ø°</button>
      <button class="nav-btn" onclick="location.href='/general'">ğŸ““ Ø§Ù„ÙŠÙˆÙ…ÙŠØ© Ø§Ù„Ø¹Ø§Ù…Ø©</button>
    </div>

    <h1 class="page-title">ğŸ“‹ Ø³Ù†Ø¯Ø§Øª Ø§Ù„ØªØ­ØµÙŠÙ„ Ø§Ù„Ù†Ù‚Ø¯ÙŠØ©</h1>

    <div class="top-right-actions">
      <button class="small-link-btn" onclick="exportReceiptsCSV()">â¬‡ï¸ ØªØµØ¯ÙŠØ± Excel (CSV)</button>
      <button class="small-link-btn" onclick="window.print()">ğŸ–¨ï¸ Ø·Ø¨Ø§Ø¹Ø©</button>
    </div>
  </header>

  <main class="page-content">
    <h2>Ù‚Ø§Ø¦Ù…Ø© Ø³Ù†Ø¯Ø§Øª Ø§Ù„ØªØ­ØµÙŠÙ„ Ø§Ù„Ù†Ù‚Ø¯ÙŠØ©</h2>
    <p class="subtitle">
      Ù‡Ø°Ù‡ Ø§Ù„Ø´Ø§Ø´Ø© ØªØ¹Ø±Ø¶ ÙƒÙ„ <strong>Ø³Ù†Ø¯Ø§Øª Ø§Ù„ØªØ­ØµÙŠÙ„ Ø§Ù„Ù†Ù‚Ø¯ÙŠØ©</strong> Ø§Ù„Ù…Ø³Ø¬Ù„Ø© Ù…Ù† Ø§Ù„Ø³Ø§Ø¦Ù‚ÙŠÙ†ØŒ Ù…Ø¹ Ø¥Ù…ÙƒØ§Ù†ÙŠØ©
      Ø§Ù„ÙÙ„ØªØ±Ø© Ø¨Ø§Ù„ØªØ§Ø±ÙŠØ® ÙˆØ§Ù„Ø¨Ø­Ø« Ø¨Ø§Ø³Ù… Ø§Ù„Ø³Ø§Ø¦Ù‚ Ø£Ùˆ Ø±Ù‚Ù… Ø§Ù„ØªÙÙˆÙŠØ¶ Ø£Ùˆ Ø¬Ø²Ø¡ Ù…Ù† Ø§Ù„Ø¨ÙŠØ§Ù†.
    </p>

    <!-- Ø´Ø±ÙŠØ· Ø§Ù„ÙÙ„ØªØ±Ø© -->
    <section class="toolbar">
      <div class="toolbar-card">
        <div class="counter-pill">
          <span>Ø¹Ø¯Ø¯ Ø§Ù„Ø³Ù†Ø¯Ø§Øª:</span>
          <span id="receiptsCount">0</span>
        </div>

        <div class="total-pill">
          <span>Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…Ø¨Ø§Ù„Øº Ø§Ù„Ù…Ø¹Ø±ÙˆØ¶Ø©:</span>
          <span id="receiptsTotal">0.00 Ø±.Ø³</span>
        </div>

        <div class="filters-group">
          <div class="filter-item">
            <span class="filter-label">Ù…Ù† ØªØ§Ø±ÙŠØ®:</span>
            <input id="dateFrom" type="date" class="filter-date" oninput="applyFilters()" />
          </div>
          <div class="filter-item">
            <span class="filter-label">Ø¥Ù„Ù‰ ØªØ§Ø±ÙŠØ®:</span>
            <input id="dateTo" type="date" class="filter-date" oninput="applyFilters()" />
          </div>
          <div class="filter-item" style="flex:1; min-width:180px;">
            <span class="filter-label">Ø¨Ø­Ø« Ø¨Ø§Ø³Ù… Ø§Ù„Ø³Ø§Ø¦Ù‚ / Ø±Ù‚Ù… Ø§Ù„ØªÙÙˆÙŠØ¶ / Ø¬Ø²Ø¡ Ù…Ù† Ø§Ù„Ø¨ÙŠØ§Ù†:</span>
            <input
              id="searchInput"
              type="text"
              class="filter-input"
              placeholder="Ù…Ø«Ø§Ù„: Ø£Ø­Ù…Ø¯ØŒ ØªÙÙˆÙŠØ¶ 10ØŒ Ø³Ø¯Ø§Ø¯ Ø¹Ù†..."
              oninput="applyFilters()"
            />
          </div>
        </div>

        <span class="badge">
          Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ø­Ù…Ù„Ø© Ù…Ù† /api/receipts (Cash Receipt Journal)
        </span>
      </div>
    </section>

    <!-- Ø´Ø±ÙŠØ· Ø§Ù„Ø­Ø§Ù„Ø© -->
    <div id="statusBar" class="status-bar"></div>

    <!-- ÙƒØ±ÙˆØª (Ù…ÙˆØ¨Ø§ÙŠÙ„) -->
    <section id="cardsContainer" class="cards-grid">
      <!-- Ù…Ù† JavaScript -->
    </section>

    <!-- Ø¬Ø¯ÙˆÙ„ (Ø¯ÙŠØ³ÙƒØªÙˆØ¨) -->
    <section class="table-wrapper">
      <div class="table-card">
        <table>
          <thead>
            <tr>
              <th># Ø±Ù‚Ù… Ø§Ù„Ø³Ù†Ø¯</th>
              <th>Ø§Ù„ØªØ§Ø±ÙŠØ®</th>
              <th>Ø§Ø³Ù… Ø§Ù„Ø³Ø§Ø¦Ù‚</th>
              <th>Ø§Ù„Ù…Ø¨Ù„Øº</th>
              <th>Ø±Ù‚Ù… Ø§Ù„ØªÙÙˆÙŠØ¶ Ø§Ù„Ù…Ø±ØªØ¨Ø·</th>
              <th>Ø§Ù„Ø¨ÙŠØ§Ù†</th>
              <th>Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª</th>
            </tr>
          </thead>
          <tbody id="tableBody">
            <!-- Ù…Ù† JavaScript -->
          </tbody>
        </table>
      </div>
    </section>

    <!-- Ø­Ø§Ù„Ø© Ø¹Ø¯Ù… ÙˆØ¬ÙˆØ¯ Ø³Ù†Ø¯Ø§Øª -->
    <div id="emptyState" class="empty-state">
      <strong>Ù„Ø§ ØªÙˆØ¬Ø¯ Ø³Ù†Ø¯Ø§Øª ØªØ­ØµÙŠÙ„ Ù…Ø·Ø§Ø¨Ù‚Ø© Ù„Ù„ÙÙ„Ø§ØªØ± Ø§Ù„Ø­Ø§Ù„ÙŠØ©.</strong>
      <span>ÙŠÙ…ÙƒÙ†Ùƒ ØªØºÙŠÙŠØ± ÙØªØ±Ø© Ø§Ù„ØªØ§Ø±ÙŠØ® Ø£Ùˆ Ù…Ø³Ø­ Ù…Ø±Ø¨Ø¹ Ø§Ù„Ø¨Ø­Ø« Ù„Ø¹Ø±Ø¶ ÙƒÙ„ Ø§Ù„Ø³Ù†Ø¯Ø§Øª.</span>
      <span class="small-note">
        Ø¥Ø°Ø§ Ù„Ù… ØªÙØ³Ø¬Ù„ Ø£ÙŠ Ø³Ù†Ø¯Ø§Øª Ù…Ù† Ù‚Ø¨Ù„ØŒ ÙŠÙ…ÙƒÙ†Ùƒ Ø¥Ù†Ø´Ø§Ø¡ Ø£ÙˆÙ„ Ø³Ù†Ø¯ Ù…Ù† ØµÙØ­Ø© "ğŸ§¾ Ø³Ù†Ø¯ ØªØ­ØµÙŠÙ„ Ø¬Ø¯ÙŠØ¯".
      </span>
    </div>
  </main>

  <script>
    let allReceipts = [];
    let filteredReceipts = [];

    document.addEventListener("DOMContentLoaded", () => {
      loadReceipts();
    });

    function showStatus(message, isError = false) {
      const bar = document.getElementById("statusBar");
      if (!message) {
        bar.style.display = "none";
        bar.textContent = "";
        return;
      }
      bar.textContent = message;
      bar.className = "status-bar " + (isError ? "err" : "ok");
      bar.style.display = "block";
    }

    // Ù…Ø­Ø§ÙˆÙ„Ø© Ø°ÙƒÙŠØ© Ù„Ù‚Ø±Ø§Ø¡Ø© Ø§Ù„ØªØ§Ø±ÙŠØ® Ù…Ù† Ø§Ù„Ø­Ù‚ÙˆÙ„ Ø§Ù„Ù…Ø®ØªÙ„ÙØ©
    function getReceiptDateString(r) {
      return (
        r.date ||
        r.receipt_date ||
        r.created_at ||
        ""
      );
    }

    function parseDateTime(str) {
      if (!str) return null;
      try {
        // Ù„Ùˆ ISO Ù…Ù† Ø§Ù„Ø¨Ø§Ùƒ Ø¥Ù†Ø¯
        if (str.includes("T")) return new Date(str);
        // Ù„Ùˆ Ø¨ØµÙŠØºØ© "YYYY-MM-DD HH:MM:SS"
        return new Date(str.replace(" ", "T"));
      } catch {
        return null;
      }
    }

    function formatDateTimeShort(str) {
      if (!str) return "â€”";
      const d = parseDateTime(str);
      if (!d || isNaN(d.getTime())) return str;
      const yyyy = d.getFullYear();
      const mm = String(d.getMonth() + 1).padStart(2, "0");
      const dd = String(d.getDate()).padStart(2, "0");
      const hh = String(d.getHours()).padStart(2, "0");
      const mi = String(d.getMinutes()).padStart(2, "0");
      return `${yyyy}-${mm}-${dd} ${hh}:${mi}`;
    }

    // âœ… Ù‡Ù†Ø§ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ù…Ù‡Ù…: async + await
    async function loadReceipts() {
      showStatus("Ø¬Ø§Ø±Ù ØªØ­Ù…ÙŠÙ„ Ø³Ù†Ø¯Ø§Øª Ø§Ù„ØªØ­ØµÙŠÙ„ Ù…Ù† Ø§Ù„Ø®Ø§Ø¯Ù…...", false);
      document.getElementById("cardsContainer").innerHTML = "";
      document.getElementById("tableBody").innerHTML = "";

      try {
        const res = await fetch("/api/receipts");
        if (!res.ok) throw new Error("HTTP " + res.status);
        let data = await res.json();

        // Ø¯Ø¹Ù… Ø´ÙƒÙ„ÙŠÙ†: [..] Ø£Ùˆ {receipts:[..]}
        if (Array.isArray(data)) {
          allReceipts = data;
        } else if (Array.isArray(data.receipts)) {
          allReceipts = data.receipts;
        } else {
          allReceipts = [];
        }

        // ØªØ±ØªÙŠØ¨ Ù…Ø¨Ø¯Ø¦ÙŠ: Ø§Ù„Ø£Ø­Ø¯Ø« Ø£ÙˆÙ„Ø§Ù‹ Ø­Ø³Ø¨ Ø§Ù„ØªØ§Ø±ÙŠØ®/Ø§Ù„Ù€ id
        allReceipts.sort((a, b) => {
          const da = parseDateTime(getReceiptDateString(a));
          const db = parseDateTime(getReceiptDateString(b));
          if (da && db) return db - da;
          // fallback Ø¹Ù„Ù‰ id
          return (b.id || 0) - (a.id || 0);
        });

        applyFilters();

        if (!allReceipts.length) {
          showStatus("Ù„Ø§ ØªÙˆØ¬Ø¯ Ø³Ù†Ø¯Ø§Øª ØªØ­ØµÙŠÙ„ Ù…Ø³Ø¬Ù„Ø© Ø­ØªÙ‰ Ø§Ù„Ø¢Ù†.", false);
        } else {
          showStatus(`ØªÙ… ØªØ­Ù…ÙŠÙ„ ${allReceipts.length} Ø³Ù†Ø¯ ØªØ­ØµÙŠÙ„ Ø¨Ù†Ø¬Ø§Ø­.`, false);
        }
      } catch (err) {
        console.error(err);
        showStatus("ØªØ¹Ø°Ø± ØªØ­Ù…ÙŠÙ„ Ø³Ù†Ø¯Ø§Øª Ø§Ù„ØªØ­ØµÙŠÙ„. ØªØ£ÙƒØ¯ Ø£Ù† Ø§Ù„Ø®Ø§Ø¯Ù… ÙŠØ¹Ù…Ù„ Ø¨Ø´ÙƒÙ„ ØµØ­ÙŠØ­.", true);
        document.getElementById("emptyState").style.display = "flex";
      }
    }

    function applyFilters() {
      const dateFromVal = document.getElementById("dateFrom").value;
      const dateToVal   = document.getElementById("dateTo").value;
      const searchTerm  = (document.getElementById("searchInput").value || "")
        .trim()
        .toLowerCase();

      let fromDate = null;
      let toDate   = null;

      if (dateFromVal) {
        fromDate = new Date(dateFromVal + "T00:00:00");
      }
      if (dateToVal) {
        toDate = new Date(dateToVal + "T23:59:59");
      }

      filteredReceipts = allReceipts.filter(r => {
        const dateStr = getReceiptDateString(r);
        const d = parseDateTime(dateStr);

        if (fromDate && d && d < fromDate) return false;
        if (toDate && d && d > toDate) return false;

        if (searchTerm) {
          const driver = (r.driver_name || "").toLowerCase();
          const desc   = (r.description || "").toLowerCase();
          const authId =
            (r.authorization_id != null ? String(r.authorization_id) : "") ||
            (r.auth_id != null ? String(r.auth_id) : "") ||
            (r.ref_authorization_id != null ? String(r.ref_authorization_id) : "");
          const authStr = authId.toLowerCase();
          const idStr = r.id != null ? String(r.id).toLowerCase() : "";

          const combined = `${driver} ${desc} ${authStr} ${idStr}`;
          if (!combined.includes(searchTerm)) return false;
        }

        return true;
      });

      refreshViews();
    }

    function refreshViews() {
      const count = filteredReceipts.length;
      document.getElementById("receiptsCount").textContent = count;

      let total = 0;
      filteredReceipts.forEach(r => {
        const num = Number(r.amount);
        if (!Number.isNaN(num)) total += num;
      });
      document.getElementById("receiptsTotal").textContent = total.toFixed(2) + " Ø±.Ø³";

      if (!count) {
        document.getElementById("emptyState").style.display = "flex";
      } else {
        document.getElementById("emptyState").style.display = "none";
      }

      renderCards();
      renderTable();
    }

    function renderCards() {
      const container = document.getElementById("cardsContainer");
      container.innerHTML = "";

      if (!filteredReceipts.length) return;

      filteredReceipts.forEach(r => {
        const dateStr = formatDateTimeShort(getReceiptDateString(r));
        const driverName = r.driver_name || "â€”";
        const amount = r.amount != null && !Number.isNaN(Number(r.amount))
          ? Number(r.amount).toFixed(2)
          : "â€”";

        const authId =
          (r.authorization_id != null ? String(r.authorization_id) : "") ||
          (r.auth_id != null ? String(r.auth_id) : "") ||
          (r.ref_authorization_id != null ? String(r.ref_authorization_id) : "");
        const hasAuth = !!authId;

        const desc = r.description || "Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù† Ù…Ø³Ø¬Ù„.";

        const card = document.createElement("article");
        card.className = "card";
        card.innerHTML = `
          <div class="card-header-line">
            <h3 class="card-title">
              <span class="pill-id">#${r.id}</span>
              <span>Ø³Ù†Ø¯ ØªØ­ØµÙŠÙ„ Ù†Ù‚Ø¯ÙŠ</span>
            </h3>
            <span class="pill-date">${dateStr}</span>
          </div>

          <div class="row">
            <span>
              <span class="label">Ø§Ù„Ø³Ø§Ø¦Ù‚:</span>
              <span class="value">${driverName}</span>
            </span>
          </div>

          <div class="row">
            <span>
              <span class="label">Ø§Ù„Ù…Ø¨Ù„Øº:</span>
              <span class="amount-strong">${amount} Ø±.Ø³</span>
            </span>
            <span>
              <span class="label">ØªÙÙˆÙŠØ¶ Ù…Ø±ØªØ¨Ø·:</span>
              <span class="value">${hasAuth ? authId : "â€”"}</span>
            </span>
          </div>

          <div class="divider"></div>

          <div class="row">
            <span class="label">Ø§Ù„Ø¨ÙŠØ§Ù†:</span>
          </div>
          <div class="row">
            <span class="desc-text">${desc}</span>
          </div>

          <div class="divider"></div>

          <div class="actions-row">
            <button class="btn-sm-outline" onclick="openInOperations(${r.id})">
              ğŸ” ÙØªØ­ ÙÙŠ ØµÙØ­Ø© Ø§Ù„Ø¹Ù…Ù„ÙŠØ§Øª
            </button>
          </div>
        `;

        container.appendChild(card);
      });
    }

    function renderTable() {
      const tbody = document.getElementById("tableBody");
      tbody.innerHTML = "";

      if (!filteredReceipts.length) return;

      filteredReceipts.forEach(r => {
        const tr = document.createElement("tr");

        const dateStr = formatDateTimeShort(getReceiptDateString(r));
        const driverName = r.driver_name || "â€”";
        const amount = r.amount != null && !Number.isNaN(Number(r.amount))
          ? Number(r.amount).toFixed(2)
          : "â€”";

        const authId =
          (r.authorization_id != null ? String(r.authorization_id) : "") ||
          (r.auth_id != null ? String(r.auth_id) : "") ||
          (r.ref_authorization_id != null ? String(r.ref_authorization_id) : "");
        const hasAuth = !!authId;

        const desc = r.description || "";

        tr.innerHTML = `
          <td>${r.id != null ? r.id : "â€”"}</td>
          <td>${dateStr}</td>
          <td>${driverName}</td>
          <td class="td-amount">${amount !== "â€”" ? amount + " Ø±.Ø³" : "â€”"}</td>
          <td class="td-ref">${hasAuth ? authId : "â€”"}</td>
          <td>${desc}</td>
          <td>
            <div class="td-actions">
              <button class="btn-sm-outline" onclick="openInOperations(${r.id})">
                ğŸ” ÙÙŠ Ø§Ù„Ø¹Ù…Ù„ÙŠØ§Øª
              </button>
            </div>
          </td>
        `;

        tbody.appendChild(tr);
      });
    }

    // ÙØªØ­ Ø§Ù„Ù‚ÙŠØ¯ Ø§Ù„Ù…Ø±ØªØ¨Ø· Ø¨Ù‡Ø°Ø§ Ø§Ù„Ø³Ù†Ø¯ ÙÙŠ ØµÙØ­Ø© Ø§Ù„Ø¹Ù…Ù„ÙŠØ§Øª
    function openInOperations(receiptId) {
      if (!receiptId && receiptId !== 0) return;
      const url = `/operations?type=receipt&receipt_id=${receiptId}`;
      window.location.href = url;
    }

    // â¬‡ï¸ ØªØµØ¯ÙŠØ± Ø§Ù„Ø³Ù†Ø¯Ø§Øª Ø§Ù„Ù…Ø¹Ø±ÙˆØ¶Ø© Ø­Ø§Ù„ÙŠÙ‹Ø§ (Ø¨Ø¹Ø¯ Ø§Ù„ÙÙ„ØªØ±Ø©) Ø¥Ù„Ù‰ CSV (Excel)
    function exportReceiptsCSV() {
      if (!filteredReceipts.length) {
        showStatus("Ù„Ø§ ØªÙˆØ¬Ø¯ Ø³Ù†Ø¯Ø§Øª ÙÙŠ Ø§Ù„Ù†ØªØ§Ø¦Ø¬ Ø§Ù„Ø­Ø§Ù„ÙŠØ© Ù„ØªØµØ¯ÙŠØ±Ù‡Ø§.", true);
        return;
      }

      // ØªØ±ÙˆÙŠØ³Ø© Ø§Ù„Ø£Ø¹Ù…Ø¯Ø©
      const header = [
        "receipt_id",
        "date",
        "driver_name",
        "amount",
        "authorization_id",
        "description"
      ];

      const lines = [];
      lines.push(header.join(","));

      filteredReceipts.forEach(r => {
        const dateStr = formatDateTimeShort(getReceiptDateString(r));
        const driverName = r.driver_name || "";
        const amount = r.amount != null && !Number.isNaN(Number(r.amount))
          ? Number(r.amount).toFixed(2)
          : "";

        const authId =
          (r.authorization_id != null ? String(r.authorization_id) : "") ||
          (r.auth_id != null ? String(r.auth_id) : "") ||
          (r.ref_authorization_id != null ? String(r.ref_authorization_id) : "");

        const desc = r.description || "";

        // Ø¯Ø§Ù„Ø© ØµØºÙŠØ±Ø© Ù„Ù„Ù‡Ø±ÙˆØ¨ Ù…Ù† Ø§Ù„ÙÙˆØ§ØµÙ„ ÙˆØ¹Ù„Ø§Ù…Ø§Øª Ø§Ù„Ø§Ù‚ØªØ¨Ø§Ø³
        function escapeCSV(value) {
          if (value == null) return "";
          let v = String(value);
          // Ø§Ø³ØªØ¨Ø¯Ø§Ù„ " Ø¨Ù€ ""
          v = v.replace(/"/g, '""');
          // Ù„Ùˆ ÙÙŠÙ‡Ø§ ÙÙˆØ§ØµÙ„ Ø£Ùˆ Ø³Ø·ÙˆØ± Ø¬Ø¯ÙŠØ¯Ø© â†’ Ù†Ø­ÙˆØ·Ù‡Ø§ Ø¨ÙŠÙ† ""
          if (/[",\n]/.test(v)) {
            v = `"${v}"`;
          }
          return v;
        }

        const row = [
          escapeCSV(r.id != null ? r.id : ""),
          escapeCSV(dateStr),
          escapeCSV(driverName),
          escapeCSV(amount),
          escapeCSV(authId),
          escapeCSV(desc)
        ];

        lines.push(row.join(","));
      });

      const csvContent = "\uFEFF" + lines.join("\n"); // BOM Ø¹Ø´Ø§Ù† Ø§Ù„Ø¹Ø±Ø¨ÙŠ ÙŠØ¸Ù‡Ø± ØµØ­
      const blob = new Blob([csvContent], { type: "text/csv;charset=utf-8;" });
      const url = URL.createObjectURL(blob);

      const a = document.createElement("a");
      a.href = url;

      const now = new Date();
      const yyyy = now.getFullYear();
      const mm = String(now.getMonth() + 1).padStart(2, "0");
      const dd = String(now.getDate()).padStart(2, "0");
      a.download = `receipts_export_${yyyy}${mm}${dd}.csv`;

      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);

      setTimeout(() => URL.revokeObjectURL(url), 1000);

      showStatus("âœ… ØªÙ… ØªØµØ¯ÙŠØ± Ø§Ù„Ø³Ù†Ø¯Ø§Øª Ø§Ù„Ù…Ø¹Ø±ÙˆØ¶Ø© Ø¥Ù„Ù‰ Ù…Ù„Ù CSV ÙŠÙ…ÙƒÙ†Ùƒ ÙØªØ­Ù‡ ÙÙŠ Excel.", false);
    }
  </script>
</body>
</html>

