<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>ğŸš— Ø§Ù„Ø³ÙŠØ§Ø±Ø§Øª Ø§Ù„Ù…Ø¤Ø¬Ø±Ø© (Ø§Ù„ØªÙÙˆÙŠØ¶Ø§Øª Ø§Ù„Ù†Ø´Ø·Ø©)</title>

  <style>
    :root {
      --main-blue: #0d6efd;
      --main-purple: #6c63ff;
      --card-radius: 14px;
      --shadow: 0 4px 12px rgba(0,0,0,0.25);
      --muted: #6b7280;
      --danger: #dc2626;
      --success: #16a34a;
    }

    * {
      box-sizing: border-box;
    }

    body {
      font-family: "Tajawal", system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      margin: 0;
      background: linear-gradient(135deg, var(--main-blue), var(--main-purple));
      color: #fff;
      min-height: 100vh;
    }

    /* ğŸ” Ø´Ø±ÙŠØ· Ø¹Ù„ÙˆÙŠ Ø«Ø§Ø¨Øª */
    .top-bar {
      position: fixed;
      top: 0;
      right: 0;
      left: 0;
      z-index: 1000;
      background: rgba(0, 0, 0, 0.25);
      backdrop-filter: blur(8px);
      padding: 10px 16px;
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .back-btn {
      border: none;
      border-radius: 999px;
      padding: 8px 16px;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      background: #fff;
      color: var(--main-blue);
      display: inline-flex;
      align-items: center;
      gap: 6px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.25);
      transition: 0.2s ease;
      white-space: nowrap;
    }

    .back-btn:hover {
      background: var(--main-blue);
      color: #fff;
      transform: translateY(-1px);
    }

    .page-title {
      margin: 0;
      font-size: 18px;
      font-weight: 700;
      flex: 1;
      text-align: center;
      color: #fff;
    }

    .top-right-actions {
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .small-link-btn {
      border: none;
      border-radius: 999px;
      padding: 7px 12px;
      font-size: 12px;
      font-weight: 600;
      cursor: pointer;
      background: rgba(255,255,255,0.12);
      color: #e5e7eb;
      transition: 0.2s ease;
      white-space: nowrap;
    }

    .small-link-btn:hover {
      background: rgba(255,255,255,0.22);
    }

    /* Ù…Ø­ØªÙˆÙ‰ Ø§Ù„ØµÙØ­Ø© */
    .page-content {
      max-width: 1200px;
      margin: 0 auto;
      padding: 80px 16px 24px; /* Ù…Ø³Ø§Ø­Ø© Ù„Ù„Ù‡ÙŠØ¯Ø± Ø§Ù„Ø«Ø§Ø¨Øª */
    }

    h2 {
      text-align: center;
      font-size: 24px;
      margin-bottom: 6px;
    }

    .subtitle {
      text-align: center;
      font-size: 14px;
      opacity: 0.9;
      margin-bottom: 18px;
    }

    /* Ø´Ø±ÙŠØ· Ø§Ù„ÙÙ„ØªØ±Ø© ÙˆØ§Ù„Ø¹Ø¯Ø§Ø¯ */
    .toolbar {
      display: flex;
      flex-wrap: wrap;
      align-items: center;
      gap: 10px;
      margin-bottom: 12px;
    }

    .toolbar-card {
      background: rgba(255,255,255,0.95);
      color: #111827;
      border-radius: var(--card-radius);
      box-shadow: var(--shadow);
      padding: 10px 12px;
      display: flex;
      flex-wrap: wrap;
      align-items: center;
      gap: 10px;
      width: 100%;
    }

    .counter-pill {
      border-radius: 999px;
      padding: 6px 12px;
      background: #ecfdf3;
      color: #166534;
      font-size: 13px;
      font-weight: 700;
      display: inline-flex;
      align-items: center;
      gap: 6px;
      white-space: nowrap;
    }

    .search-group {
      display: flex;
      align-items: center;
      gap: 6px;
      flex: 1;
      min-width: 200px;
    }

    .search-input {
      width: 100%;
      border-radius: 999px;
      border: 1px solid #e5e7eb;
      padding: 7px 12px;
      font-size: 13px;
      outline: none;
      font-family: inherit;
    }

    .search-input:focus {
      border-color: var(--main-blue);
      box-shadow: 0 0 0 2px rgba(13,110,253,0.18);
    }

    .search-label {
      font-size: 12px;
      color: var(--muted);
      white-space: nowrap;
    }

    .badge {
      font-size: 11px;
      border-radius: 999px;
      padding: 4px 8px;
      background: #eff6ff;
      color: #1d4ed8;
      white-space: nowrap;
    }

    /* ÙƒØ±ÙˆØª Ø§Ù„ØªÙÙˆÙŠØ¶Ø§Øª (Ù…ÙˆØ¨Ø§ÙŠÙ„ / Ø´Ø§Ø´Ø§Øª ØµØºÙŠØ±Ø©) */
    .cards-grid {
      display: grid;
      grid-template-columns: repeat(3, minmax(0, 1fr));
      gap: 12px;
    }

    @media (max-width: 1024px) {
      .cards-grid {
        grid-template-columns: repeat(2, minmax(0, 1fr));
      }
    }

    @media (max-width: 700px) {
      .cards-grid {
        grid-template-columns: 1fr;
      }
    }

    .card {
      background: #ffffff;
      color: #111827;
      border-radius: var(--card-radius);
      box-shadow: var(--shadow);
      padding: 12px 12px 10px;
      display: flex;
      flex-direction: column;
      gap: 6px;
      border: 1px solid #e5e7eb;
    }

    /* âœ… ÙƒØ§Ø±Øª Ù…ØªØ£Ø®Ø± (Ø¨Ø¹Ø¯ Ø§Ù„Ø¬Ù…Ø¹Ø©) */
    .card-overdue {
      border: 2px solid var(--danger);
      box-shadow:
        0 0 0 1px rgba(220,38,38,0.18),
        var(--shadow);
    }

    .card-header-line {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 6px;
      margin-bottom: 2px;
    }

    .card-title {
      margin: 0;
      font-size: 15px;
      font-weight: 700;
      color: #111827;
      display: flex;
      align-items: center;
      gap: 6px;
      flex-wrap: wrap;
    }

    .pill-id {
      border-radius: 999px;
      background: #eef2ff;
      color: #3730a3;
      padding: 3px 8px;
      font-size: 11px;
      font-weight: 700;
    }

    .status-pill {
      border-radius: 999px;
      padding: 3px 8px;
      font-size: 11px;
      font-weight: 600;
      background: #f97316;
      color: #fff;
      white-space: nowrap;
    }

    .status-pill.green {
      background: #22c55e;
    }

    .status-pill.overdue {
      background: var(--danger);
    }

    .row {
      display: flex;
      justify-content: space-between;
      gap: 6px;
      font-size: 13px;
    }

    .row span {
      display: inline-flex;
      align-items: center;
      gap: 4px;
    }

    .label {
      color: var(--muted);
      font-size: 12px;
    }

    .value {
      font-weight: 600;
    }

    .value-strong {
      font-weight: 800;
      color: #16a34a;
    }

    /* ğŸ”´ ØªÙ…ÙŠÙŠØ² Ø§Ù„Ù…Ø¯Ø¯ Ø§Ù„Ù…ØªØ£Ø®Ø±Ø© */
    .value-overdue {
      color: var(--danger);
      font-weight: 800;
    }

    .overdue-text {
      font-size: 11px;
      color: var(--danger);
      font-weight: 700;
      margin-top: 2px;
    }

    .divider {
      height: 1px;
      background: #e5e7eb;
      margin: 6px 0;
    }

    .actions-row {
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
      margin-top: 4px;
    }

    .btn-sm-primary,
    .btn-sm-danger,
    .btn-sm-outline {
      border-radius: 999px;
      border: none;
      padding: 6px 10px;
      font-size: 12px;
      font-weight: 600;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      gap: 4px;
      transition: 0.18s ease;
      white-space: nowrap;
    }

    .btn-sm-primary {
      background: linear-gradient(135deg, var(--main-blue), var(--main-purple));
      color: #fff;
      box-shadow: 0 2px 6px rgba(0,0,0,0.25);
    }

    .btn-sm-primary:hover {
      transform: translateY(-1px);
      opacity: 0.95;
    }

    .btn-sm-danger {
      background: #fee2e2;
      color: var(--danger);
    }

    .btn-sm-danger:hover {
      background: #fecaca;
    }

    .btn-sm-outline {
      background: #f9fafb;
      color: #111827;
      border: 1px solid #e5e7eb;
    }

    .btn-sm-outline:hover {
      background: #e5e7eb;
    }

    .empty-state {
      margin-top: 18px;
      background: rgba(255,255,255,0.95);
      color: #111827;
      padding: 14px 16px;
      border-radius: var(--card-radius);
      box-shadow: var(--shadow);
      font-size: 14px;
      display: flex;
      flex-direction: column;
      gap: 4px;
    }

    .empty-state strong {
      font-weight: 700;
    }

    .status-bar {
      margin-top: 10px;
      font-size: 13px;
      padding: 6px 10px;
      border-radius: 999px;
      display: none;
    }

    .status-bar.ok {
      display: block;
      background: #ecfdf3;
      color: #166534;
      border: 1px solid #bbf7d0;
    }

    .status-bar.err {
      display: block;
      background: #fef2f2;
      color: #b91c1c;
      border: 1px solid #fecaca;
    }

    .small-note {
      font-size: 11px;
      color: #6b7280;
      margin-top: 4px;
    }

    /* ğŸ‘‡ğŸ‘‡ Ø¬Ø¯ÙˆÙ„ Ø¹Ù„Ù‰ Ø´Ø§Ø´Ø§Øª Ø§Ù„Ù„Ø§Ø¨ / Ø§Ù„ÙƒØ¨ÙŠØ±Ø© ÙÙ‚Ø· */
    .table-wrapper {
      display: none;
      margin-top: 14px;
    }

    .table-card {
      background: rgba(255,255,255,0.98);
      color: #111827;
      border-radius: var(--card-radius);
      box-shadow: var(--shadow);
      padding: 10px 12px;
      overflow-x: auto;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      font-size: 12.5px;
      direction: rtl;
    }

    thead {
      background: #f3f4f6;
    }

    th, td {
      padding: 6px 8px;
      border-bottom: 1px solid #e5e7eb;
      text-align: right;
      white-space: nowrap;
    }

    th {
      font-weight: 700;
      font-size: 12px;
      color: #374151;
    }

    tbody tr:nth-child(even) {
      background: #f9fafb;
    }

    tbody tr.row-overdue {
      background: #fef2f2;
    }

    tbody tr.row-overdue td {
      border-bottom-color: #fecaca;
    }

    .td-overdue {
      color: var(--danger);
      font-weight: 700;
    }

    .td-amount {
      font-weight: 700;
      color: #16a34a;
    }

    .td-actions {
      display: flex;
      flex-wrap: wrap;
      gap: 4px;
    }

    /* âœ… Ø§Ù„ØªØ­ÙƒÙ… ÙÙŠ Ø§Ù„Ø¹Ø±Ø¶ Ø­Ø³Ø¨ Ø­Ø¬Ù… Ø§Ù„Ø´Ø§Ø´Ø© */
    @media (min-width: 900px) {
      .cards-grid {
        display: none;
      }
      .table-wrapper {
        display: block;
      }
    }

    @media (max-width: 899px) {
      .cards-grid {
        display: grid;
      }
      .table-wrapper {
        display: none;
      }
    }
  </style>
</head>

<body>
  <!-- ğŸ” Ø§Ù„Ù‡ÙŠØ¯Ø± Ø§Ù„Ø«Ø§Ø¨Øª -->
  <header class="top-bar">
    <button class="back-btn" onclick="location.href='/'">
      â¬…ï¸ Ø±Ø¬ÙˆØ¹
    </button>

    <h1 class="page-title">ğŸš— Ø§Ù„Ø³ÙŠØ§Ø±Ø§Øª Ø§Ù„Ù…Ø¤Ø¬Ø±Ø© (Ø§Ù„ØªÙÙˆÙŠØ¶Ø§Øª Ø§Ù„Ù†Ø´Ø·Ø©)</h1>

    <div class="top-right-actions">
      <button class="small-link-btn" onclick="location.href='/issue'">
        â• Ø¥ØµØ¯Ø§Ø± ØªÙÙˆÙŠØ¶ Ø¬Ø¯ÙŠØ¯
      </button>
      <button class="small-link-btn" onclick="location.href='/receipt'">
        ğŸ§¾ Ø³Ù†Ø¯ ØªØ­ØµÙŠÙ„ Ø¬Ø¯ÙŠØ¯
      </button>
    </div>
  </header>

  <main class="page-content">
    <h2>Ø§Ù„Ø³ÙŠØ§Ø±Ø§Øª Ø§Ù„Ù…Ø¤Ø¬Ø±Ø© Ø­Ø§Ù„ÙŠÙ‹Ø§</h2>
    <p class="subtitle">
      Ù‡Ø°Ù‡ Ø§Ù„Ø´Ø§Ø´Ø© ØªØ¹Ø±Ø¶ <strong>ÙƒÙ„ Ø§Ù„ØªÙÙˆÙŠØ¶Ø§Øª Ø§Ù„Ù†Ø´Ø·Ø©</strong> (Ù„Ù… ÙŠØªÙ… Ø¥Ù†Ù‡Ø§Ø¤Ù‡Ø§ Ø¨Ø¹Ø¯)ØŒ Ù…Ø¹ ØªÙ…ÙŠÙŠØ²
      <strong>Ø§Ù„ØªÙÙˆÙŠØ¶Ø§Øª Ø§Ù„ØªÙŠ ØªØ¬Ø§ÙˆØ²Øª Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ø£Ø³Ø¨ÙˆØ¹ (Ø§Ù„Ø¬Ù…Ø¹Ø©)</strong> Ø¨Ø§Ù„Ù„ÙˆÙ† Ø§Ù„Ø£Ø­Ù…Ø± ÙˆØªØ±ØªÙŠØ¨Ù‡Ø§ ÙÙŠ Ø¨Ø¯Ø§ÙŠØ© Ø§Ù„ØµÙØ­Ø©.
      <br/>
      Ø¹Ø¯Ø¯ Ø§Ù„Ø£ÙŠØ§Ù… Ø§Ù„Ù…Ø­Ø§Ø³Ø¨ÙŠØ© Ù…Ø­Ø³ÙˆØ¨ Ù…Ù† <strong>ØªØ§Ø±ÙŠØ® Ø¨Ø¯Ø§ÙŠØ© Ø§Ù„ØªÙÙˆÙŠØ¶ (start_date)</strong> Ø­ØªÙ‰
      <strong>Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ø¬Ù…Ø¹Ø© Ø§Ù„Ù…Ø­Ø§Ø³Ø¨ÙŠØ© (planned_end)</strong> Ø´Ø§Ù…Ù„ ÙŠÙˆÙ… Ø§Ù„Ø¨Ø¯Ø§ÙŠØ©.
    </p>

    <!-- Ø´Ø±ÙŠØ· Ø§Ù„ÙÙ„ØªØ±Ø© ÙˆØ§Ù„Ø¹Ø¯Ø§Ø¯ -->
    <section class="toolbar">
      <div class="toolbar-card">
        <div class="counter-pill">
          <span>Ø§Ù„ØªÙÙˆÙŠØ¶Ø§Øª Ø§Ù„Ù†Ø´Ø·Ø©:</span>
          <span id="activeCount">0</span>
        </div>

        <div class="search-group">
          <span class="search-label">Ø¨Ø­Ø« Ø¨Ø§Ø³Ù… Ø§Ù„Ø³Ø§Ø¦Ù‚ Ø£Ùˆ Ø±Ù‚Ù… Ø§Ù„Ø³ÙŠØ§Ø±Ø© Ø£Ùˆ Ø±Ù‚Ù… Ø§Ù„Ø±Ø®ØµØ©:</span>
          <input
            id="searchInput"
            type="text"
            class="search-input"
            placeholder="Ø§ÙƒØªØ¨ Ø¬Ø²Ø¡ Ù…Ù† Ø§Ø³Ù… Ø§Ù„Ø³Ø§Ø¦Ù‚ Ø£Ùˆ Ø±Ù‚Ù… Ø§Ù„Ø³ÙŠØ§Ø±Ø© Ø£Ùˆ Ø±Ù‚Ù… Ø§Ù„Ø±Ø®ØµØ©..."
            oninput="applyFilter()"
          />
        </div>

        <span class="badge">
          ğŸ” ÙŠØªÙ… ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ø¨Ø§Ø´Ø±Ø© Ù…Ù† Ø§Ù„Ø®Ø§Ø¯Ù…
        </span>
      </div>
    </section>

    <!-- Ø´Ø±ÙŠØ· Ø§Ù„Ø­Ø§Ù„Ø© (Ù†Ø¬Ø§Ø­ / Ø®Ø·Ø£) -->
    <div id="statusBar" class="status-bar"></div>

    <!-- âœ… Ø¹Ø±Ø¶ ÙƒØ±ÙˆØª Ø¹Ù„Ù‰ Ø§Ù„Ù…ÙˆØ¨Ø§ÙŠÙ„ / Ø§Ù„Ø´Ø§Ø´Ø§Øª Ø§Ù„ØµØºÙŠØ±Ø© -->
    <section id="cardsContainer" class="cards-grid">
      <!-- ÙŠØªÙ… Ù…Ù„Ø¤Ù‡Ø§ Ø¨Ø§Ù„Ù€ JS -->
    </section>

    <!-- âœ… Ø¬Ø¯ÙˆÙ„ Ø¹Ù„Ù‰ Ø§Ù„Ù„Ø§Ø¨ØªÙˆØ¨ / Ø§Ù„Ø´Ø§Ø´Ø§Øª Ø§Ù„ÙƒØ¨ÙŠØ±Ø© -->
    <section class="table-wrapper">
      <div class="table-card">
        <table>
          <thead>
            <tr>
              <th>#</th>
              <th>Ø§Ù„Ø³ÙŠØ§Ø±Ø©</th>
              <th>Ø§Ù„Ø³Ø§Ø¦Ù‚</th>
              <th>Ø±Ù‚Ù… Ø§Ù„Ø±Ø®ØµØ©</th>
              <th>ØªØ§Ø±ÙŠØ® Ø§Ù„Ø¥ØµØ¯Ø§Ø±</th>
              <th>Ø¨Ø¯Ø§ÙŠØ© Ø§Ù„ØªÙÙˆÙŠØ¶</th>
              <th>Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ø¬Ù…Ø¹Ø© Ø§Ù„Ù…Ø­Ø§Ø³Ø¨ÙŠØ©</th>
              <th>Ø£ÙŠØ§Ù… Ø§Ù„ØªÙÙˆÙŠØ¶</th>
              <th>Ø£ÙŠØ§Ù… Ø§Ù„ØªØ£Ø®ÙŠØ±</th>
              <th>Ø§Ù„Ø¥ÙŠØ¬Ø§Ø± Ø§Ù„ÙŠÙˆÙ…ÙŠ</th>
              <th>Ù‚ÙŠÙ…Ø© Ø§Ù„Ø£Ø³Ø¨ÙˆØ¹ ØªÙ‚Ø±ÙŠØ¨Ù‹Ø§</th>
              <th>Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª</th>
            </tr>
          </thead>
          <tbody id="tableBody">
            <!-- Ø§Ù„ØµÙÙˆÙ Ù…Ù† JS -->
          </tbody>
        </table>
      </div>
    </section>

    <!-- Ø­Ø§Ù„Ø© Ø¹Ø¯Ù… ÙˆØ¬ÙˆØ¯ Ø¨ÙŠØ§Ù†Ø§Øª -->
    <div id="emptyState" class="empty-state" style="display:none;">
      <strong>Ù„Ø§ ØªÙˆØ¬Ø¯ Ø³ÙŠØ§Ø±Ø§Øª Ù…Ø¤Ø¬Ø±Ø© Ø­Ø§Ù„ÙŠÙ‹Ø§.</strong>
      <span>ÙŠÙ…ÙƒÙ†Ùƒ Ø¥ØµØ¯Ø§Ø± ØªÙÙˆÙŠØ¶ Ø¬Ø¯ÙŠØ¯ Ù…Ù† Ø²Ø± "Ø¥ØµØ¯Ø§Ø± ØªÙÙˆÙŠØ¶ Ø¬Ø¯ÙŠØ¯" Ø¨Ø§Ù„Ø£Ø¹Ù„Ù‰.</span>
      <span class="small-note">
        Ø¥Ø°Ø§ ÙƒÙ†Øª Ù…ØªØ£ÙƒØ¯Ù‹Ø§ Ù…Ù† ÙˆØ¬ÙˆØ¯ ØªÙÙˆÙŠØ¶Ø§ØªØŒ ØªØ£ÙƒØ¯ Ù…Ù† Ø£Ù† Ø­Ø§Ù„Ø© Ø§Ù„ØªÙÙˆÙŠØ¶ Ù„Ù… ÙŠØªÙ… Ø¥Ù†Ù‡Ø§Ø¤Ù‡Ø§ Ø¨Ø§Ù„ÙØ¹Ù„ (close_date = NULL ÙÙ‚Ø· Ù‡ÙŠ Ø§Ù„ØªÙŠ ØªØ¸Ù‡Ø± Ù‡Ù†Ø§).
      </span>
    </div>
  </main>

  <script>
    let allAuthorizations = [];
    let filteredAuthorizations = [];

    document.addEventListener("DOMContentLoaded", () => {
      loadActiveAuthorizations();
    });

    // Ø¯Ø§Ù„Ø© Ø¨Ø³ÙŠØ·Ø© Ù„ØªØ­ÙˆÙŠÙ„ Ø§Ù„Ù†Øµ "YYYY-MM-DD HH:MM:SS" Ø£Ùˆ ISO Ø¥Ù„Ù‰ Date
    function parseDateTime(str) {
      if (!str) return null;
      try {
        if (str.includes("T")) return new Date(str);
        return new Date(str.replace(" ", "T"));
      } catch {
        return null;
      }
    }

    // ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØªÙÙˆÙŠØ¶Ø§Øª Ø§Ù„Ù†Ø´Ø·Ø© ÙÙ‚Ø·
    async function loadActiveAuthorizations() {
      showStatus("Ø¬Ø§Ø±Ù ØªØ­Ù…ÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„ØªÙÙˆÙŠØ¶Ø§Øª Ø§Ù„Ù†Ø´Ø·Ø©...", false);
      const container = document.getElementById("cardsContainer");
      container.innerHTML = "";
      document.getElementById("tableBody").innerHTML = "";

      try {
        const res = await fetch("/api/authorizations?status=active");
        if (!res.ok) {
          throw new Error("HTTP " + res.status);
        }
        const data = await res.json();
        allAuthorizations = Array.isArray(data) ? data : [];
        filteredAuthorizations = [...allAuthorizations];

        document.getElementById("activeCount").textContent = allAuthorizations.length;

        refreshViews();

        if (allAuthorizations.length === 0) {
          document.getElementById("emptyState").style.display = "block";
          showStatus("Ù„Ø§ ØªÙˆØ¬Ø¯ ØªÙÙˆÙŠØ¶Ø§Øª Ù†Ø´Ø·Ø© Ø­Ø§Ù„ÙŠÙ‹Ø§.", false);
        } else {
          document.getElementById("emptyState").style.display = "none";
          showStatus(`ØªÙ… ØªØ­Ù…ÙŠÙ„ ${allAuthorizations.length} ØªÙÙˆÙŠØ¶ Ù†Ø´Ø·.`, false);
        }
      } catch (err) {
        console.error(err);
        showStatus("ØªØ¹Ø°Ø± ØªØ­Ù…ÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„ØªÙÙˆÙŠØ¶Ø§Øª Ø§Ù„Ù†Ø´Ø·Ø©. ØªØ£ÙƒØ¯ Ù…Ù† Ø£Ù† Ø§Ù„Ø®Ø§Ø¯Ù… ÙŠØ¹Ù…Ù„.", true);
        document.getElementById("emptyState").style.display = "block";
      }
    }

    // Ø¹Ø±Ø¶ Ø±Ø³Ø§Ù„Ø© Ø­Ø§Ù„Ø©
    function showStatus(message, isError = false) {
      const bar = document.getElementById("statusBar");
      if (!message) {
        bar.style.display = "none";
        return;
      }
      bar.textContent = message;
      bar.className = "status-bar " + (isError ? "err" : "ok");
      bar.style.display = "block";
    }

    // ØªØ¬Ù‡ÙŠØ² Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª (ØªÙ…ÙŠÙŠØ² Ø§Ù„Ù…ØªØ£Ø®Ø±ÙŠÙ† + ØªØ±ØªÙŠØ¨)
    function enrichAndSort(list) {
      const now = new Date();

      const enriched = (list || []).map(a => {
        const issueDt = parseDateTime(a.issue_date);
        const startDt = parseDateTime(a.start_date);
        const plannedEndStr = a.end_date || a.planned_end_date || "";
        const plannedEndDt = parseDateTime(plannedEndStr);

        let isOverdue = false;
        let overdueDays = 0;

        if (plannedEndDt && now > plannedEndDt) {
          isOverdue = true;
          const diffMs = now.getTime() - plannedEndDt.getTime();
          overdueDays = Math.floor(diffMs / (1000 * 60 * 60 * 24));
          if (overdueDays < 0) overdueDays = 0;
        }

        return {
          raw: a,
          issueDt,
          startDt,
          plannedEndDt,
          isOverdue,
          overdueDays
        };
      });

      // âœ… ØªØ±ØªÙŠØ¨: Ø§Ù„Ù…ØªØ£Ø®Ø±ÙŠÙ† Ø£ÙˆÙ„Ø§Ù‹ØŒ Ø§Ù„Ø£ÙƒØ¨Ø± ØªØ£Ø®ÙŠØ±Ù‹Ø§ Ø¨Ø§Ù„Ø£Ø¹Ù„Ù‰ØŒ Ø«Ù… Ø§Ù„Ø¨Ø§Ù‚ÙŠ Ø­Ø³Ø¨ Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ø¬Ù…Ø¹Ø©
      enriched.sort((x, y) => {
        if (x.isOverdue && !y.isOverdue) return -1;
        if (!x.isOverdue && y.isOverdue) return 1;

        if (x.isOverdue && y.isOverdue) {
          return y.overdueDays - x.overdueDays;
        }

        if (x.plannedEndDt && y.plannedEndDt) {
          return x.plannedEndDt - y.plannedEndDt;
        }
        return 0;
      });

      return enriched;
    }

    function refreshViews() {
      const enriched = enrichAndSort(filteredAuthorizations);
      renderCards(enriched);
      renderTable(enriched);
    }

    // Ø±Ø³Ù… Ø§Ù„ÙƒØ±ÙˆØª (Ù…ÙˆØ¨Ø§ÙŠÙ„)
    function renderCards(enrichedList) {
      const container = document.getElementById("cardsContainer");
      container.innerHTML = "";

      if (!enrichedList || enrichedList.length === 0) return;

      enrichedList.forEach(item => {
        const a = item.raw;
        const isOverdue = item.isOverdue;
        const overdueDays = item.overdueDays;

        const card = document.createElement("article");
        card.className = "card" + (isOverdue ? " card-overdue" : "");

        const issueDate = a.issue_date || "";
        const startDate = a.start_date ? a.start_date.replace("T", " ").slice(0,19) : "";
        const plannedEnd = (a.end_date || a.planned_end_date || "");
        const dailyRent = a.daily_rent != null ? `${a.daily_rent} Ø±.Ø³/ÙŠÙˆÙ…` : "ØºÙŠØ± Ù…Ø­Ø¯Ø¯";
        const days = a.rental_days != null ? `${a.rental_days} ÙŠÙˆÙ…` : "â€”";
        let plannedAmount = "â€”";
        if (a.planned_amount != null) {
          const val = typeof a.planned_amount === "number"
            ? a.planned_amount.toFixed(2)
            : a.planned_amount;
          plannedAmount = `${val} Ø±.Ø³`;
        }

        const statusClass = "status-pill" + (isOverdue ? " overdue" : "");
        const durationClass = "value" + (isOverdue ? " value-overdue" : "");

        card.innerHTML = `
          <div class="card-header-line">
            <h3 class="card-title">
              <span class="pill-id">#${a.id}</span>
              <span>${a.car_number || "Ø¨Ø¯ÙˆÙ† Ø±Ù‚Ù…"} â€” ${(a.car_model || "")} ${(a.car_type || "")}</span>
            </h3>
            <span class="${statusClass}">
              ${isOverdue ? "Ù…Ø¤Ø¬Ø±Ø© â€” Ù…ØªØ¬Ø§ÙˆØ²Ø© Ù…Ø¯Ø© Ø§Ù„Ø£Ø³Ø¨ÙˆØ¹" : "Ù…Ø¤Ø¬Ø±Ø©"}
            </span>
          </div>

          <div class="row">
            <span>
              <span class="label">Ø§Ù„Ø³Ø§Ø¦Ù‚:</span>
              <span class="value">${a.driver_name || "â€”"}</span>
            </span>
            <span>
              <span class="label">Ø±Ø®ØµØ©:</span>
              <span class="value">${a.driver_license_no || "â€”"}</span>
            </span>
          </div>

          <div class="row">
            <span>
              <span class="label">ØªØ§Ø±ÙŠØ® Ø§Ù„Ø¥ØµØ¯Ø§Ø±:</span>
              <span class="value">${issueDate}</span>
            </span>
          </div>

          <div class="row">
            <span>
              <span class="label">Ø¨Ø¯Ø§ÙŠØ© Ø§Ù„ØªÙÙˆÙŠØ¶ (start_date):</span>
              <span class="value">${startDate || "â€”"}</span>
            </span>
          </div>

          <div class="row">
            <span>
              <span class="label">Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ø£Ø³Ø¨ÙˆØ¹ (Ø§Ù„Ø¬Ù…Ø¹Ø©):</span>
              <span class="value">${plannedEnd || "â€”"}</span>
            </span>
          </div>

          <div class="row">
            <span>
              <span class="label">Ø§Ù„Ø¥ÙŠØ¬Ø§Ø± Ø§Ù„ÙŠÙˆÙ…ÙŠ:</span>
              <span class="value">${dailyRent}</span>
            </span>
            <span>
              <span class="label">Ø¹Ø¯Ø¯ Ø§Ù„Ø£ÙŠØ§Ù… Ø§Ù„Ù…Ø­Ø§Ø³Ø¨ÙŠØ©:</span>
              <span class="${durationClass}">${days}</span>
            </span>
          </div>

          ${
            isOverdue
              ? `
              <div class="row">
                <span class="label">ğŸ”´ Ø£ÙŠØ§Ù… Ø§Ù„ØªØ£Ø®ÙŠØ± Ø¨Ø¹Ø¯ Ø§Ù„Ø¬Ù…Ø¹Ø©:</span>
                <span class="value-overdue">${overdueDays} ÙŠÙˆÙ…</span>
              </div>
              <div class="overdue-text">
                Ù‡Ø°Ø§ Ø§Ù„ØªÙÙˆÙŠØ¶ ØªØ¬Ø§ÙˆØ² Ù…Ø¯Ø© Ø§Ù„Ø£Ø³Ø¨ÙˆØ¹ Ø§Ù„Ù…Ø­Ø§Ø³Ø¨ÙŠØ© (Ù…Ù† Ø¨Ø¯Ø§ÙŠØ© Ø§Ù„ØªÙÙˆÙŠØ¶ Ø­ØªÙ‰ Ø§Ù„Ø¬Ù…Ø¹Ø©) ÙˆÙ„Ù… ÙŠØªÙ… Ø¥Ù‚ÙØ§Ù„Ù‡ Ø¨Ø¹Ø¯.
              </div>
              `
              : ""
          }

          <div class="row" style="margin-top:4px;">
            <span class="label">Ù‚ÙŠÙ…Ø© Ø§Ù„Ø¥ÙŠØ¬Ø§Ø± Ù„Ù„Ø£ÙŠØ§Ù… Ø§Ù„Ù…Ø®Ø·Ø·Ø© ØªÙ‚Ø±ÙŠØ¨Ù‹Ø§:</span>
            <span class="value-strong">${plannedAmount}</span>
          </div>

          <div class="divider"></div>

          <div class="row">
            <span class="label">Ù…Ù„Ø§Ø­Ø¸Ø§Øª:</span>
          </div>
          <div class="row">
            <span class="value">${a.details || "Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ù„Ø§Ø­Ø¸Ø§Øª Ù…Ø³Ø¬Ù„Ø©."}</span>
          </div>

          <div class="divider"></div>

          <div class="actions-row">
            <button class="btn-sm-primary" onclick="openReceipt(${a.id})">
              ğŸ§¾ Ø³Ù†Ø¯ ØªØ­ØµÙŠÙ„
            </button>

            <button class="btn-sm-danger" onclick="endAuthorization(${a.id}, this)">
              âœ… Ø¥Ù†Ù‡Ø§Ø¡ Ø§Ù„ØªÙÙˆÙŠØ¶
            </button>

            <button class="btn-sm-outline" onclick="viewAuthorizationDetails(${a.id})">
              ğŸ” ØªÙØ§ØµÙŠÙ„ Ø¥Ø¶Ø§ÙÙŠØ© (JSON)
            </button>
          </div>

          <p class="small-note">
            Ø¹Ù†Ø¯ Ø§Ù„Ø¶ØºØ· Ø¹Ù„Ù‰ "Ø¥Ù†Ù‡Ø§Ø¡ Ø§Ù„ØªÙÙˆÙŠØ¶" Ø³ÙŠØªÙ…:
            1) Ø­Ø³Ø§Ø¨ Ù‚ÙŠÙ…Ø© Ø§Ù„Ù…Ø¯Ø© Ù…Ù† Ø¨Ø¯Ø§ÙŠØ© Ø§Ù„ØªÙÙˆÙŠØ¶ Ø­ØªÙ‰ Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ø¬Ù…Ø¹Ø©ØŒ<br/>
            2) ØªØ³Ø¬ÙŠÙ„ Ù‚ÙŠØ¯ Ù…Ø­Ø§Ø³Ø¨ÙŠØŒ<br/>
            3) Ø¥Ù†Ø´Ø§Ø¡ ØªÙÙˆÙŠØ¶ Ø¬Ø¯ÙŠØ¯ Ù„Ù„Ø£Ø³Ø¨ÙˆØ¹ Ø§Ù„ØªØ§Ù„ÙŠ ØªÙ„Ù‚Ø§Ø¦ÙŠÙ‹Ø§ØŒ<br/>
            4) Ø¥Ø®ÙØ§Ø¡ Ù‡Ø°Ø§ Ø§Ù„ØªÙÙˆÙŠØ¶ Ù…Ù† Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø³ÙŠØ§Ø±Ø§Øª Ø§Ù„Ù…Ø¤Ø¬Ø±Ø©.
          </p>
        `;

        container.appendChild(card);
      });
    }

    // Ø±Ø³Ù… Ø§Ù„Ø¬Ø¯ÙˆÙ„ (Ù„Ø§Ø¨ ØªÙˆØ¨)
    function renderTable(enrichedList) {
      const tbody = document.getElementById("tableBody");
      tbody.innerHTML = "";

      if (!enrichedList || enrichedList.length === 0) return;

      enrichedList.forEach(item => {
        const a = item.raw;
        const isOverdue = item.isOverdue;
        const overdueDays = item.overdueDays;

        const tr = document.createElement("tr");
        if (isOverdue) tr.classList.add("row-overdue");

        const issueDate = a.issue_date || "";
        const startDate = a.start_date ? a.start_date.replace("T", " ").slice(0,19) : "";
        const plannedEnd = (a.end_date || a.planned_end_date || "");
        const days = a.rental_days != null ? a.rental_days : "â€”";
        const dailyRent = a.daily_rent != null ? a.daily_rent : "â€”";
        let plannedAmount = "â€”";
        if (a.planned_amount != null) {
          plannedAmount =
            typeof a.planned_amount === "number"
              ? a.planned_amount.toFixed(2)
              : a.planned_amount;
        }

        tr.innerHTML = `
          <td>${a.id}</td>
          <td>${a.car_number || "â€”"}<br/><span class="label">${(a.car_model || "")} ${(a.car_type || "")}</span></td>
          <td>${a.driver_name || "â€”"}</td>
          <td>${a.driver_license_no || "â€”"}</td>
          <td>${issueDate}</td>
          <td>${startDate || "â€”"}</td>
          <td>${plannedEnd || "â€”"}</td>
          <td class="${isOverdue ? "td-overdue" : ""}">${days}</td>
          <td class="${isOverdue ? "td-overdue" : ""}">${isOverdue ? overdueDays : "0"}</td>
          <td>${dailyRent !== "â€”" ? dailyRent + " Ø±.Ø³/ÙŠÙˆÙ…" : "ØºÙŠØ± Ù…Ø­Ø¯Ø¯"}</td>
          <td class="td-amount">${plannedAmount !== "â€”" ? plannedAmount + " Ø±.Ø³" : "â€”"}</td>
          <td>
            <div class="td-actions">
              <button class="btn-sm-primary" onclick="openReceipt(${a.id})">ğŸ§¾</button>
              <button class="btn-sm-danger" onclick="endAuthorization(${a.id}, this)">âœ…</button>
              <button class="btn-sm-outline" onclick="viewAuthorizationDetails(${a.id})">ğŸ”</button>
            </div>
          </td>
        `;

        tbody.appendChild(tr);
      });
    }

    // ÙÙ„ØªØ±Ø© Ø­Ø³Ø¨ Ø§Ù„Ø¨Ø­Ø« (Ø§Ø³Ù… Ø§Ù„Ø³Ø§Ø¦Ù‚ / Ø±Ù‚Ù… Ø§Ù„Ø³ÙŠØ§Ø±Ø© / Ø±Ù‚Ù… Ø§Ù„Ø±Ø®ØµØ©)
    function applyFilter() {
      const term = (document.getElementById("searchInput").value || "").trim().toLowerCase();
      if (!term) {
        filteredAuthorizations = [...allAuthorizations];
      } else {
        filteredAuthorizations = allAuthorizations.filter(a => {
          const driver = (a.driver_name || "").toLowerCase();
          const car = (a.car_number || "").toLowerCase();
          const license = (a.driver_license_no || "").toLowerCase();
          return driver.includes(term) || car.includes(term) || license.includes(term);
        });
      }
      refreshViews();
    }

    // ÙØªØ­ ØµÙØ­Ø© Ø³Ù†Ø¯ Ø§Ù„ØªØ­ØµÙŠÙ„ Ù…Ø¹ ØªÙ…Ø±ÙŠØ± Ø±Ù‚Ù… Ø§Ù„ØªÙÙˆÙŠØ¶
    function openReceipt(authId) {
      if (!authId) return;
      window.location.href = `/receipt?authorization_id=${authId}`;
    }

    // Ø¥Ù†Ù‡Ø§Ø¡ Ø§Ù„ØªÙÙˆÙŠØ¶
    async function endAuthorization(authId, btnEl) {
      if (!authId) return;

      const confirmed = window.confirm(
        "Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø¥Ù†Ù‡Ø§Ø¡ Ù‡Ø°Ø§ Ø§Ù„ØªÙÙˆÙŠØ¶ØŸ\nØ³ÙŠØªÙ… Ø­Ø³Ø§Ø¨ Ø§Ù„Ù…Ø¯Ø© Ù…Ù† Ø¨Ø¯Ø§ÙŠØ© Ø§Ù„ØªÙÙˆÙŠØ¶ Ø­ØªÙ‰ Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ø¬Ù…Ø¹Ø©ØŒ ØªØ³Ø¬ÙŠÙ„ Ù‚ÙŠØ¯ Ù…Ø­Ø§Ø³Ø¨ÙŠØŒ ÙˆØ¥Ù†Ø´Ø§Ø¡ ØªÙÙˆÙŠØ¶ Ø¬Ø¯ÙŠØ¯ Ù„Ù„Ø£Ø³Ø¨ÙˆØ¹ Ø§Ù„ØªØ§Ù„ÙŠ."
      );
      if (!confirmed) return;

      try {
        if (btnEl) {
          btnEl.disabled = true;
          btnEl.textContent = "Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø¥Ù†Ù‡Ø§Ø¡...";
        }
        showStatus("Ø¬Ø§Ø±Ù Ø¥Ù†Ù‡Ø§Ø¡ Ø§Ù„ØªÙÙˆÙŠØ¶ ÙˆØ¥Ù†Ø´Ø§Ø¡ Ø§Ù„ØªÙÙˆÙŠØ¶ Ø§Ù„Ø¬Ø¯ÙŠØ¯ Ù„Ù„Ø£Ø³Ø¨ÙˆØ¹ Ø§Ù„ØªØ§Ù„ÙŠ...", false);

        const res = await fetch(`/api/authorizations/${authId}/end`, {
          method: "PATCH",
        });

        let data = {};
        try {
          data = await res.json();
        } catch (_) {}

        if (!res.ok) {
          const msg = data.error || `Ù„Ù… ÙŠØªÙ… Ø¥Ù†Ù‡Ø§Ø¡ Ø§Ù„ØªÙÙˆÙŠØ¶ (HTTP ${res.status})`;
          showStatus(msg, true);
          if (btnEl) {
            btnEl.disabled = false;
            btnEl.textContent = "âœ… Ø¥Ù†Ù‡Ø§Ø¡ Ø§Ù„ØªÙÙˆÙŠØ¶";
          }
          return;
        }

        // Ø¥Ø²Ø§Ù„Ø© Ø§Ù„ØªÙÙˆÙŠØ¶ Ø§Ù„Ù…Ù†ØªÙ‡ÙŠ Ù…Ù† Ø§Ù„Ù‚Ø§ÙŠÙ…Ø© Ø§Ù„Ø­Ø§Ù„ÙŠØ©
        allAuthorizations = allAuthorizations.filter(a => String(a.id) !== String(authId));
        applyFilter(); // ÙŠØ¹ÙŠØ¯ Ø§Ù„Ø±Ø³Ù… Ù…Ø¹ ØªØ±ØªÙŠØ¨ Ø§Ù„Ù…ØªØ£Ø®Ø±ÙŠÙ†
        document.getElementById("activeCount").textContent = allAuthorizations.length;

        if (allAuthorizations.length === 0) {
          document.getElementById("emptyState").style.display = "block";
        }

        const totalAmount = data.total_amount != null ? data.total_amount : null;
        const msgExtra = totalAmount
          ? `ØŒ ÙˆÙ‚ÙŠÙ…Ø© Ø§Ù„Ø£ÙŠØ§Ù… Ø§Ù„Ù…Ø­Ø§Ø³Ø¨ÙŠØ© ØªÙ‚Ø±ÙŠØ¨Ù‹Ø§: ${
              totalAmount.toFixed ? totalAmount.toFixed(2) : totalAmount
            } Ø±.Ø³`
          : "";

        showStatus(
          `âœ… ØªÙ… Ø¥Ù†Ù‡Ø§Ø¡ Ø§Ù„ØªÙÙˆÙŠØ¶ Ø¨Ù†Ø¬Ø§Ø­ ÙˆØ¥Ù†Ø´Ø§Ø¡ ØªÙÙˆÙŠØ¶ Ø¬Ø¯ÙŠØ¯ Ù„Ù„Ø£Ø³Ø¨ÙˆØ¹ Ø§Ù„ØªØ§Ù„ÙŠ${msgExtra}.`,
          false
        );
      } catch (err) {
        console.error(err);
        showStatus("ØªØ¹Ø°Ø± Ø¥Ù†Ù‡Ø§Ø¡ Ø§Ù„ØªÙÙˆÙŠØ¶. ØªØ£ÙƒØ¯ Ù…Ù† Ø£Ù† Ø§Ù„Ø®Ø§Ø¯Ù… ÙŠØ¹Ù…Ù„ Ø«Ù… Ø£Ø¹Ø¯ Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø©.", true);
      } finally {
        if (btnEl) {
          btnEl.disabled = false;
          btnEl.textContent = "âœ… Ø¥Ù†Ù‡Ø§Ø¡ Ø§Ù„ØªÙÙˆÙŠØ¶";
        }
      }
    }

    // Ø¹Ø±Ø¶ JSON Ù„Ù„ØªÙÙˆÙŠØ¶ (Ù„Ù„ØªØµØ­ÙŠØ­ ÙÙ‚Ø·)
    function viewAuthorizationDetails(authId) {
      const auth = allAuthorizations.find(a => String(a.id) === String(authId));
      if (!auth) {
        alert("Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø¨ÙŠØ§Ù†Ø§Øª Ù‡Ø°Ø§ Ø§Ù„ØªÙÙˆÙŠØ¶ ÙÙŠ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø­Ø§Ù„ÙŠØ©.");
        return;
      }
      alert(JSON.stringify(auth, null, 2));
    }
  </script>
</body>
</html>
