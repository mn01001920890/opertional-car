<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>ğŸš— Ø§Ù„Ø³ÙŠØ§Ø±Ø§Øª Ø§Ù„Ù…Ø¤Ø¬Ø±Ø© (Ø§Ù„ØªÙÙˆÙŠØ¶Ø§Øª Ø§Ù„Ù†Ø´Ø·Ø©)</title>

  <style>
    :root {
      --main-blue: #0d6efd;
      --main-purple: #6c63ff;
      --card-radius: 14px;
      --shadow: 0 4px 12px rgba(0,0,0,0.25);
      --muted: #6b7280;
      --danger: #dc2626;
      --success: #16a34a;
    }

    * { box-sizing: border-box; }

    body {
      font-family: "Tajawal", system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      margin: 0;
      background: linear-gradient(135deg, var(--main-blue), var(--main-purple));
      color: #fff;
      min-height: 100vh;
    }

    .top-bar {
      position: fixed;
      top: 0; right: 0; left: 0;
      z-index: 1000;
      background: rgba(0, 0, 0, 0.25);
      backdrop-filter: blur(8px);
      padding: 10px 16px;
      display: flex;
      align-items: center;
      gap: 10px;
      flex-wrap: wrap;
    }

    .nav-group {
      display: flex;
      align-items: center;
      gap: 8px;
      flex-wrap: wrap;
    }

    .back-btn {
      border: none;
      border-radius: 999px;
      padding: 8px 16px;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      background: #fff;
      color: var(--main-blue);
      display: inline-flex;
      align-items: center;
      gap: 6px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.25);
      transition: 0.2s ease;
      white-space: nowrap;
      text-decoration: none;
    }

    .back-btn:hover {
      background: var(--main-blue);
      color: #fff;
      transform: translateY(-1px);
    }

    .page-title {
      margin: 0;
      font-size: 18px;
      font-weight: 700;
      flex: 1;
      text-align: center;
      color: #fff;
    }

    .top-right-actions {
      display: flex;
      align-items: center;
      gap: 8px;
      flex-wrap: wrap;
    }

    .small-link-btn {
      border: none;
      border-radius: 999px;
      padding: 7px 12px;
      font-size: 12px;
      font-weight: 600;
      cursor: pointer;
      background: rgba(255,255,255,0.12);
      color: #e5e7eb;
      transition: 0.2s ease;
      white-space: nowrap;
    }

    .small-link-btn:hover { background: rgba(255,255,255,0.22); }

    .page-content {
      max-width: 1200px;
      margin: 0 auto;
      padding: 80px 16px 24px;
    }

    h2 {
      text-align: center;
      font-size: 24px;
      margin-bottom: 6px;
    }

    .subtitle {
      text-align: center;
      font-size: 14px;
      opacity: 0.9;
      margin-bottom: 18px;
    }

    .toolbar { display: flex; flex-wrap: wrap; align-items: center; gap: 10px; margin-bottom: 12px; }

    .toolbar-card {
      background: rgba(255,255,255,0.95);
      color: #111827;
      border-radius: var(--card-radius);
      box-shadow: var(--shadow);
      padding: 10px 12px;
      display: flex;
      flex-wrap: wrap;
      align-items: center;
      gap: 10px;
      width: 100%;
    }

    .counter-pill {
      border-radius: 999px;
      padding: 6px 12px;
      background: #ecfdf3;
      color: #166534;
      font-size: 13px;
      font-weight: 700;
      display: inline-flex;
      align-items: center;
      gap: 6px;
      white-space: nowrap;
    }

    .search-group { display: flex; align-items: center; gap: 6px; flex: 1; min-width: 200px; }

    .search-input {
      width: 100%;
      border-radius: 999px;
      border: 1px solid #e5e7eb;
      padding: 7px 12px;
      font-size: 13px;
      outline: none;
      font-family: inherit;
    }

    .search-input:focus {
      border-color: var(--main-blue);
      box-shadow: 0 0 0 2px rgba(13,110,253,0.18);
    }

    .search-label { font-size: 12px; color: var(--muted); white-space: nowrap; }

    .badge {
      font-size: 11px;
      border-radius: 999px;
      padding: 4px 8px;
      background: #eff6ff;
      color: #1d4ed8;
      white-space: nowrap;
    }

    .cards-grid {
      display: grid;
      grid-template-columns: repeat(3, minmax(0, 1fr));
      gap: 12px;
    }

    @media (max-width: 1024px) {
      .cards-grid { grid-template-columns: repeat(2, minmax(0, 1fr)); }
    }

    @media (max-width: 700px) {
      .cards-grid { grid-template-columns: 1fr; }
    }

    .card {
      background: #ffffff;
      color: #111827;
      border-radius: var(--card-radius);
      box-shadow: var(--shadow);
      padding: 12px 12px 10px;
      display: flex;
      flex-direction: column;
      gap: 6px;
      border: 1px solid #e5e7eb;
    }

    .card-overdue {
      border: 2px solid var(--danger);
      box-shadow: 0 0 0 1px rgba(220,38,38,0.18), var(--shadow);
    }

    .card-header-line { display: flex; justify-content: space-between; align-items: center; gap: 6px; margin-bottom: 2px; }

    .card-title {
      margin: 0;
      font-size: 15px;
      font-weight: 700;
      color: #111827;
      display: flex;
      align-items: center;
      gap: 6px;
      flex-wrap: wrap;
    }

    .pill-id {
      border-radius: 999px;
      background: #eef2ff;
      color: #3730a3;
      padding: 3px 8px;
      font-size: 11px;
      font-weight: 700;
    }

    .status-pill {
      border-radius: 999px;
      padding: 3px 8px;
      font-size: 11px;
      font-weight: 600;
      background: #f97316;
      color: #fff;
      white-space: nowrap;
    }

    .status-pill.overdue { background: var(--danger); }

    .row { display: flex; justify-content: space-between; gap: 6px; font-size: 13px; }
    .row span { display: inline-flex; align-items: center; gap: 4px; }

    .label { color: var(--muted); font-size: 12px; }
    .value { font-weight: 600; }
    .value-strong { font-weight: 800; color: #16a34a; }
    .value-overdue { color: var(--danger); font-weight: 800; }

    .overdue-text { font-size: 11px; color: var(--danger); font-weight: 700; margin-top: 2px; }

    .divider { height: 1px; background: #e5e7eb; margin: 6px 0; }

    .actions-row { display: flex; flex-wrap: wrap; gap: 6px; margin-top: 4px; }

    .btn-sm-primary,
    .btn-sm-danger,
    .btn-sm-outline {
      border-radius: 999px;
      border: none;
      padding: 6px 10px;
      font-size: 12px;
      font-weight: 600;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      gap: 4px;
      transition: 0.18s ease;
      white-space: nowrap;
    }

    .btn-sm-primary {
      background: linear-gradient(135deg, var(--main-blue), var(--main-purple));
      color: #fff;
      box-shadow: 0 2px 6px rgba(0,0,0,0.25);
    }

    .btn-sm-primary:hover { transform: translateY(-1px); opacity: 0.95; }

    .btn-sm-danger {
      background: #fee2e2;
      color: var(--danger);
    }

    .btn-sm-danger:hover { background: #fecaca; }

    .btn-sm-outline {
      background: #f9fafb;
      color: #111827;
      border: 1px solid #e5e7eb;
    }

    .btn-sm-outline:hover { background: #e5e7eb; }

    .empty-state {
      margin-top: 18px;
      background: rgba(255,255,255,0.95);
      color: #111827;
      padding: 14px 16px;
      border-radius: var(--card-radius);
      box-shadow: var(--shadow);
      font-size: 14px;
      display: flex;
      flex-direction: column;
      gap: 4px;
    }

    .empty-state strong { font-weight: 700; }

    .status-bar {
      margin-top: 10px;
      font-size: 13px;
      padding: 6px 10px;
      border-radius: 999px;
      display: none;
    }

    .status-bar.ok {
      display: block;
      background: #ecfdf3;
      color: #166534;
      border: 1px solid #bbf7d0;
    }

    .status-bar.err {
      display: block;
      background: #fef2f2;
      color: #b91c1c;
      border: 1px solid #fecaca;
    }

    .small-note { font-size: 11px; color: #6b7280; margin-top: 4px; }

    .table-wrapper { display: none; margin-top: 14px; }

    .table-card {
      background: rgba(255,255,255,0.98);
      color: #111827;
      border-radius: var(--card-radius);
      box-shadow: var(--shadow);
      padding: 10px 12px;
      overflow-x: auto;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      font-size: 12px;
      direction: rtl;
      table-layout: fixed;
    }

    thead { background: #f3f4f6; }

    th, td {
      padding: 6px 6px;
      border-bottom: 1px solid #e5e7eb;
      text-align: right;
      white-space: nowrap;
    }

    th { font-weight: 700; font-size: 11.5px; color: #374151; }

    tbody tr:nth-child(even) { background: #f9fafb; }

    tbody tr.row-overdue { background: #fef2f2; }
    tbody tr.row-overdue td { border-bottom-color: #fecaca; }

    .td-overdue { color: var(--danger); font-weight: 700; }
    .td-amount { font-weight: 700; color: #16a34a; }

    .td-actions { display: flex; flex-wrap: wrap; gap: 4px; }

    .col-id      { width: 4%; }
    .col-car     { width: 14%; }
    .col-driver  { width: 11%; }
    .col-license { width: 9%; }
    .col-issue   { width: 10%; }
    .col-start   { width: 10%; }
    .col-end     { width: 11%; }
    .col-days    { width: 7%; text-align: center; }
    .col-delay   { width: 7%; text-align: center; }
    .col-rent    { width: 9%; }
    .col-week    { width: 10%; }
    .col-actions { width: 8%; }

    td.col-car,
    td.col-driver,
    td.col-issue,
    td.col-start,
    td.col-end { white-space: normal; line-height: 1.3; }

    @media (min-width: 900px) {
      .cards-grid { display: none; }
      .table-wrapper { display: block; }
    }

    @media (max-width: 899px) {
      .cards-grid { display: grid; }
      .table-wrapper { display: none; }
    }

    .modal-overlay {
      position: fixed;
      inset: 0;
      background: rgba(15,23,42,0.78);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 2000;
      padding: 16px;
    }

    .modal-card {
      width: 100%;
      max-width: 460px;
      max-height: 90vh;
      overflow-y: auto;
      background: #020617;
      color: #f9fafb;
      border-radius: 16px;
      box-shadow: 0 20px 60px rgba(0,0,0,0.6);
      padding: 16px 18px 14px;
      border: 1px solid rgba(148,163,184,0.6);
    }

    .modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 12px;
      margin-bottom: 8px;
    }

    .modal-header h3 {
      margin: 0;
      font-size: 1rem;
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .modal-close-btn {
      border: none;
      background: transparent;
      color: #9ca3af;
      cursor: pointer;
      font-size: 18px;
      line-height: 1;
      padding: 4px;
      border-radius: 999px;
      transition: 0.15s ease;
    }

    .modal-close-btn:hover {
      background: rgba(15,23,42,0.9);
      color: #e5e7eb;
    }

    .modal-body { font-size: 0.88rem; }

    .modal-row { display: flex; justify-content: space-between; gap: 6px; margin-bottom: 4px; }

    .modal-label { color: #9ca3af; font-size: 0.8rem; }
    .modal-value { font-weight: 600; }

    .modal-section-title {
      margin-top: 8px;
      margin-bottom: 4px;
      font-size: 0.85rem;
      font-weight: 700;
      color: #e5e7eb;
    }

    .modal-input,
    .modal-textarea {
      width: 100%;
      border-radius: 10px;
      border: 1px solid rgba(148,163,184,0.7);
      background: #020617;
      color: #f9fafb;
      padding: 7px 9px;
      font-family: inherit;
      font-size: 0.88rem;
      outline: none;
      transition: 0.15s ease;
    }

    .modal-input:focus,
    .modal-textarea:focus {
      border-color: var(--main-blue);
      box-shadow: 0 0 0 1px rgba(37,99,235,0.5);
    }

    .modal-textarea { min-height: 70px; resize: vertical; }

    .modal-footer {
      margin-top: 10px;
      display: flex;
      justify-content: flex-end;
      gap: 8px;
      flex-wrap: wrap;
    }

    .modal-btn {
      border-radius: 999px;
      border: none;
      padding: 7px 14px;
      font-size: 0.85rem;
      font-weight: 600;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      gap: 6px;
      transition: 0.15s ease;
    }

    .modal-btn.cancel {
      background: transparent;
      color: #e5e7eb;
      border: 1px solid rgba(148,163,184,0.7);
    }

    .modal-btn.cancel:hover { background: rgba(15,23,42,0.9); }

    .modal-btn.confirm {
      background: linear-gradient(135deg, #22c55e, #16a34a);
      color: #f9fafb;
      box-shadow: 0 8px 20px rgba(22,163,74,0.4);
    }

    .modal-btn.confirm[disabled] { opacity: 0.6; cursor: wait; box-shadow: none; }

    .modal-hint { font-size: 0.78rem; color: #9ca3af; margin-top: 2px; }

    .modal-choice-row { display: flex; flex-direction: column; gap: 4px; margin-top: 4px; }

    .modal-choice { display: flex; align-items: center; gap: 6px; font-size: 0.82rem; color: #e5e7eb; }
    .modal-choice input[type="radio"] { accent-color: #22c55e; cursor: pointer; }

    /* â­ Ø´Ø±ÙŠØ· ØµØºÙŠØ± Ù„ØªÙˆØ¶ÙŠØ­ Ø§Ù† Ø§Ù„ØªØ§Ø±ÙŠØ® Ø§ØªØºÙŠØ± */
    .mini-warn {
      margin-top: 6px;
      font-size: 0.78rem;
      padding: 6px 8px;
      border-radius: 10px;
      border: 1px dashed rgba(148,163,184,0.7);
      color: #e5e7eb;
      background: rgba(2,6,23,0.55);
      display: none;
    }
  </style>
</head>

<body>
  <header class="top-bar">
    <div class="nav-group">
      <button class="back-btn" onclick="location.href='/dashboard'">ğŸ  Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</button>
      <button class="back-btn" onclick="location.href='/cars'">ğŸš— Ø§Ù„Ø³ÙŠØ§Ø±Ø§Øª</button>
      <button class="back-btn" onclick="location.href='/drivers'">ğŸ§‘â€âœˆï¸ Ø§Ù„Ø³Ø§Ø¦Ù‚ÙˆÙ†</button>
      <button class="back-btn" onclick="location.href='/view'">ğŸ“„ Ø§Ù„ØªÙÙˆÙŠØ¶Ø§Øª</button>
      <button class="back-btn" onclick="location.href='/operations'">ğŸ§¾ Ø§Ù„Ø¹Ù…Ù„ÙŠØ§Øª</button>
    </div>

    <h1 class="page-title">ğŸš— Ø§Ù„Ø³ÙŠØ§Ø±Ø§Øª Ø§Ù„Ù…Ø¤Ø¬Ø±Ø© (Ø§Ù„ØªÙÙˆÙŠØ¶Ø§Øª Ø§Ù„Ù†Ø´Ø·Ø©)</h1>

    <div class="top-right-actions">
      <button class="small-link-btn" onclick="location.href='/issue'">â• Ø¥ØµØ¯Ø§Ø± ØªÙÙˆÙŠØ¶ Ø¬Ø¯ÙŠØ¯</button>
      <button class="small-link-btn" onclick="location.href='/receipt'">ğŸ§¾ Ø³Ù†Ø¯ ØªØ­ØµÙŠÙ„ Ø¬Ø¯ÙŠØ¯</button>
    </div>
  </header>

  <main class="page-content">
    <h2>Ø§Ù„Ø³ÙŠØ§Ø±Ø§Øª Ø§Ù„Ù…Ø¤Ø¬Ø±Ø© Ø­Ø§Ù„ÙŠÙ‹Ø§</h2>
    <p class="subtitle">
      Ù‡Ø°Ù‡ Ø§Ù„Ø´Ø§Ø´Ø© ØªØ¹Ø±Ø¶ <strong>ÙƒÙ„ Ø§Ù„ØªÙÙˆÙŠØ¶Ø§Øª Ø§Ù„Ù†Ø´Ø·Ø©</strong> (Ù„Ù… ÙŠØªÙ… Ø¥Ù†Ù‡Ø§Ø¤Ù‡Ø§ Ø¨Ø¹Ø¯)ØŒ Ù…Ø¹ ØªÙ…ÙŠÙŠØ²
      <strong>Ø§Ù„ØªÙÙˆÙŠØ¶Ø§Øª Ø§Ù„ØªÙŠ ØªØ¬Ø§ÙˆØ²Øª Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ø£Ø³Ø¨ÙˆØ¹ Ø§Ù„Ù…Ø­Ø§Ø³Ø¨ÙŠ (Ø§Ù„Ø¬Ù…Ø¹Ø©)</strong> Ø¨Ø§Ù„Ù„ÙˆÙ† Ø§Ù„Ø£Ø­Ù…Ø± ÙˆØªØ±ØªÙŠØ¨Ù‡Ø§ ÙÙŠ Ø¨Ø¯Ø§ÙŠØ© Ø§Ù„ØµÙØ­Ø©.
      <br/>
      Ø¹Ø¯Ø¯ Ø§Ù„Ø£ÙŠØ§Ù… Ø§Ù„Ù…Ø­Ø§Ø³Ø¨ÙŠØ© Ù…Ø­Ø³ÙˆØ¨ Ù…Ù† <strong>ØªØ§Ø±ÙŠØ® Ø¨Ø¯Ø§ÙŠØ© Ø§Ù„ØªÙÙˆÙŠØ¶ (start_date)</strong> Ø­ØªÙ‰
      <strong>Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ø¬Ù…Ø¹Ø© Ø§Ù„Ù…Ø­Ø§Ø³Ø¨ÙŠØ© (end_date)</strong>.
    </p>

    <section class="toolbar">
      <div class="toolbar-card">
        <div class="counter-pill">
          <span>Ø§Ù„ØªÙÙˆÙŠØ¶Ø§Øª Ø§Ù„Ù†Ø´Ø·Ø©:</span>
          <span id="activeCount">0</span>
        </div>

        <div class="search-group">
          <span class="search-label">Ø¨Ø­Ø« Ø¨Ø§Ø³Ù… Ø§Ù„Ø³Ø§Ø¦Ù‚ Ø£Ùˆ Ø±Ù‚Ù… Ø§Ù„Ø³ÙŠØ§Ø±Ø© Ø£Ùˆ Ø±Ù‚Ù… Ø§Ù„Ø±Ø®ØµØ©:</span>
          <input
            id="searchInput"
            type="text"
            class="search-input"
            placeholder="Ø§ÙƒØªØ¨ Ø¬Ø²Ø¡ Ù…Ù† Ø§Ø³Ù… Ø§Ù„Ø³Ø§Ø¦Ù‚ Ø£Ùˆ Ø±Ù‚Ù… Ø§Ù„Ø³ÙŠØ§Ø±Ø© Ø£Ùˆ Ø±Ù‚Ù… Ø§Ù„Ø±Ø®ØµØ©..."
            oninput="applyFilter()"
          />
        </div>

        <span class="badge">ğŸ” ÙŠØªÙ… ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ø¨Ø§Ø´Ø±Ø© Ù…Ù† Ø§Ù„Ø®Ø§Ø¯Ù…</span>
      </div>
    </section>

    <div id="statusBar" class="status-bar"></div>

    <section id="cardsContainer" class="cards-grid"></section>

    <section class="table-wrapper">
      <div class="table-card">
        <table>
          <thead>
            <tr>
              <th class="col-id">#</th>
              <th class="col-car">Ø§Ù„Ø³ÙŠØ§Ø±Ø©</th>
              <th class="col-driver">Ø§Ù„Ø³Ø§Ø¦Ù‚</th>
              <th class="col-license">Ø§Ù„Ø±Ø®ØµØ©</th>
              <th class="col-issue">Ø§Ù„Ø¥ØµØ¯Ø§Ø±</th>
              <th class="col-start">Ø§Ù„Ø¨Ø¯Ø§ÙŠØ©</th>
              <th class="col-end">Ù†Ù‡Ø§ÙŠØ© Ø§Ù„ØªÙÙˆÙŠØ¶</th>
              <th class="col-days">Ø£ÙŠØ§Ù… Ø§Ù„ØªÙÙˆÙŠØ¶</th>
              <th class="col-delay">Ø£ÙŠØ§Ù… Ø§Ù„ØªØ£Ø®ÙŠØ±</th>
              <th class="col-rent">Ø§Ù„ÙŠÙˆÙ…ÙŠ</th>
              <th class="col-week">Ø£Ø³Ø¨ÙˆØ¹ÙŠÙ‹Ø§</th>
              <th class="col-actions">Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª</th>
            </tr>
          </thead>
          <tbody id="tableBody"></tbody>
        </table>
      </div>
    </section>

    <div id="emptyState" class="empty-state" style="display:none;">
      <strong>Ù„Ø§ ØªÙˆØ¬Ø¯ Ø³ÙŠØ§Ø±Ø§Øª Ù…Ø¤Ø¬Ø±Ø© Ø­Ø§Ù„ÙŠÙ‹Ø§.</strong>
      <span>ÙŠÙ…ÙƒÙ†Ùƒ Ø¥ØµØ¯Ø§Ø± ØªÙÙˆÙŠØ¶ Ø¬Ø¯ÙŠØ¯ Ù…Ù† Ø²Ø± "Ø¥ØµØ¯Ø§Ø± ØªÙÙˆÙŠØ¶ Ø¬Ø¯ÙŠØ¯" Ø¨Ø§Ù„Ø£Ø¹Ù„Ù‰.</span>
      <span class="small-note">
        Ø¥Ø°Ø§ ÙƒÙ†Øª Ù…ØªØ£ÙƒØ¯Ù‹Ø§ Ù…Ù† ÙˆØ¬ÙˆØ¯ ØªÙÙˆÙŠØ¶Ø§ØªØŒ ØªØ£ÙƒØ¯ Ø£Ù† close_date = NULL.
      </span>
    </div>
  </main>

  <!-- ğŸŒ™ Ù…ÙˆØ¯Ø§Ù„ Ù…Ø±Ø§Ø¬Ø¹Ø© ÙˆØ¥Ù‚ÙØ§Ù„ Ø§Ù„ØªÙÙˆÙŠØ¶ -->
  <div id="closeModalOverlay" class="modal-overlay">
    <div class="modal-card">
      <div class="modal-header">
        <h3>âœ… Ù…Ø±Ø§Ø¬Ø¹Ø© Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„ØªÙÙˆÙŠØ¶ Ù‚Ø¨Ù„ Ø§Ù„Ø¥Ù‚ÙØ§Ù„</h3>
        <button class="modal-close-btn" type="button" onclick="cancelCloseModal()">âœ•</button>
      </div>

      <div class="modal-body">
        <div class="modal-row">
          <div>
            <div class="modal-label">Ø±Ù‚Ù… Ø§Ù„ØªÙÙˆÙŠØ¶:</div>
            <div class="modal-value" id="modalAuthId">â€”</div>
          </div>
          <div>
            <div class="modal-label">Ø§Ù„Ø³ÙŠØ§Ø±Ø©:</div>
            <div class="modal-value" id="modalCarInfo">â€”</div>
          </div>
        </div>

        <div class="modal-row">
          <div>
            <div class="modal-label">Ø§Ù„Ø³Ø§Ø¦Ù‚:</div>
            <div class="modal-value" id="modalDriverName">â€”</div>
          </div>
          <div>
            <div class="modal-label">Ø±Ø®ØµØ© Ø§Ù„Ø³Ø§Ø¦Ù‚:</div>
            <div class="modal-value" id="modalDriverLicense">â€”</div>
          </div>
        </div>

        <div class="modal-row">
          <div>
            <div class="modal-label">Ø§Ù„ÙØªØ±Ø© Ø§Ù„Ù…Ø­Ø§Ø³Ø¨ÙŠØ©:</div>
            <div class="modal-value" id="modalPeriod">â€”</div>
          </div>
        </div>

        <!-- âœ… NEW: ØªØ¹Ø¯ÙŠÙ„ ØªØ§Ø±ÙŠØ® Ù†Ù‡Ø§ÙŠØ© Ø§Ù„ØªÙÙˆÙŠØ¶ -->
        <div class="modal-section-title">ØªØ§Ø±ÙŠØ® Ù†Ù‡Ø§ÙŠØ© Ø§Ù„ØªÙÙˆÙŠØ¶ (ÙŠÙ…ÙƒÙ† ØªØ¹Ø¯ÙŠÙ„Ù‡ Ù‚Ø¨Ù„ Ø§Ù„Ø¥Ù‚ÙØ§Ù„)</div>
        <input id="closeEndDateInput" type="date" class="modal-input" />
        <div class="modal-hint">
          Ù„Ùˆ Ø¹Ø¯Ù‘Ù„Øª Ø§Ù„ØªØ§Ø±ÙŠØ® Ù‡Ù†Ø§ØŒ Ù‡ÙŠØªØºÙŠØ± Ø­Ø³Ø§Ø¨ Ø¹Ø¯Ø¯ Ø§Ù„Ø£ÙŠØ§Ù… ÙˆÙ‚ÙŠÙ…Ø© Ø§Ù„Ø£ÙŠØ§Ù… Ø§Ù„Ù…Ø®Ø·Ø·Ø© ØªÙ„Ù‚Ø§Ø¦ÙŠÙ‹Ø§ Ù‚Ø¨Ù„ Ø§Ù„Ø¥Ù‚ÙØ§Ù„.
        </div>

        <div id="endDateChangedHint" class="mini-warn">
          âš ï¸ ØªÙ… ØªØ¹Ø¯ÙŠÙ„ ØªØ§Ø±ÙŠØ® Ù†Ù‡Ø§ÙŠØ© Ø§Ù„ØªÙÙˆÙŠØ¶ â€” Ø³ÙŠØªÙ… Ø­ÙØ¸Ù‡ ÙÙŠ Ø§Ù„ØªÙÙˆÙŠØ¶ Ø¹Ù†Ø¯ Ø§Ù„Ø¥Ù‚ÙØ§Ù„.
        </div>

        <div class="modal-row" style="margin-top:8px;">
          <div>
            <div class="modal-label">Ø§Ù„Ø¥ÙŠØ¬Ø§Ø± Ø§Ù„ÙŠÙˆÙ…ÙŠ:</div>
            <div class="modal-value" id="modalDailyRent">â€”</div>
          </div>
          <div>
            <div class="modal-label">Ù‚ÙŠÙ…Ø© Ø§Ù„Ø£ÙŠØ§Ù… Ø§Ù„Ù…Ø®Ø·Ø·Ø©:</div>
            <div class="modal-value" id="modalPlannedAmount">â€”</div>
          </div>
        </div>

        <div class="modal-section-title">Ù‚ÙŠÙ…Ø© Ø§Ù„ØªÙÙˆÙŠØ¶ Ø¹Ù†Ø¯ Ø§Ù„Ø¥Ù‚ÙØ§Ù„</div>
        <input
          id="closeAmountInput"
          type="number"
          step="0.01"
          min="0"
          class="modal-input"
          placeholder="Ø§ÙƒØªØ¨ Ø§Ù„Ù‚ÙŠÙ…Ø© Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠØ© Ù„Ù„ØªÙÙˆÙŠØ¶ Ø¹Ù†Ø¯ Ø§Ù„Ø¥Ù‚ÙØ§Ù„"
        />
        <div class="modal-hint">
          ÙŠÙ…ÙƒÙ†Ùƒ ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ù‚ÙŠÙ…Ø© Ù‚Ø¨Ù„ Ø§Ù„Ø¥Ù‚ÙØ§Ù„ Ø­Ø³Ø¨ Ø§Ù„Ø±ØµÙŠØ¯ Ø§Ù„ÙØ¹Ù„ÙŠ Ù…Ø¹ Ø§Ù„Ø³Ø§Ø¦Ù‚.
        </div>

        <div class="modal-section-title">Ø¨ÙŠØ§Ù† Ø§Ù„Ø¥Ù‚ÙØ§Ù„</div>
        <textarea
          id="closeNoteInput"
          class="modal-textarea"
          placeholder="Ù…Ø«Ø§Ù„: Ø¥Ù‚ÙØ§Ù„ ØªÙÙˆÙŠØ¶ Ø£Ø³Ø¨ÙˆØ¹ÙŠ..."
        ></textarea>
        <div class="modal-hint">
          Ù‡Ø°Ø§ Ø§Ù„Ø¨ÙŠØ§Ù† Ø³ÙŠØ¸Ù‡Ø± Ù„Ø§Ø­Ù‚Ù‹Ø§ ÙÙŠ ØµÙØ­Ø© Ø§Ù„ØªÙÙˆÙŠØ¶Ø§Øª Ø§Ù„Ù…ØºÙ„Ù‚Ø© ÙˆØ§Ù„Ø¹Ù…Ù„ÙŠØ§Øª.
        </div>

        <div class="modal-section-title">Ø¨Ø¹Ø¯ Ø§Ù„Ø¥Ù‚ÙØ§Ù„</div>
        <div class="modal-hint">Ø§Ø®ØªØ± Ù…Ø§ Ø³ÙŠØ­Ø¯Ø« Ø¨Ø¹Ø¯ Ø§Ù„Ø¥Ù‚ÙØ§Ù„.</div>
        <div class="modal-choice-row">
          <label class="modal-choice">
            <input type="radio" name="renewOption" value="renew" checked />
            âœ… ØªØ¬Ø¯ÙŠØ¯ Ø§Ù„ØªÙÙˆÙŠØ¶ Ù„Ù„Ø£Ø³Ø¨ÙˆØ¹ Ø§Ù„ØªØ§Ù„ÙŠ (Ø§Ù„Ø³ÙŠØ§Ø±Ø© ØªØ¸Ù„ Ù…Ø¤Ø¬Ø±Ø©)
          </label>
          <label class="modal-choice">
            <input type="radio" name="renewOption" value="no_renew" />
            â›” Ù„Ø§ØŒ ØªØ­ÙˆÙŠÙ„ Ø§Ù„Ø³ÙŠØ§Ø±Ø© Ø¥Ù„Ù‰ Ù…ØªØ§Ø­Ø© Ø¨Ø¯ÙˆÙ† ØªÙÙˆÙŠØ¶ Ø¬Ø¯ÙŠØ¯
          </label>
        </div>

        <div class="modal-section-title">Ø·Ø±ÙŠÙ‚Ø© Ø§Ù„Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„Ù…Ø­Ø§Ø³Ø¨ÙŠØ©</div>
        <div class="modal-hint">
          Ù„Ùˆ Ø§Ø®ØªØ±Øª â€œØ¨Ø¯ÙˆÙ† Ù‚ÙŠØ¯â€ Ø³ÙŠØªÙ… ØªÙ…ÙŠÙŠØ² Ø§Ù„ØªÙÙˆÙŠØ¶ Ø¨Ø£Ù†Ù‡ Ù…ØºÙ„Ù‚ Ø¨Ø¯ÙˆÙ† Ø¹Ù…Ù„ÙŠØ© Ù…Ø­Ø§Ø³Ø¨ÙŠØ© Ù„ÙŠØ¸Ù‡Ø± ÙÙŠ ØµÙØ­Ø© Ø§Ù„ØªÙÙˆÙŠØ¶Ø§Øª Ø§Ù„Ù…ØºÙ„Ù‚Ø©.
        </div>
        <div class="modal-choice-row">
          <label class="modal-choice">
            <input type="radio" name="accountingOption" value="with_journal" checked />
            ğŸ“’ Ø¥Ù‚ÙØ§Ù„ Ø§Ù„ØªÙÙˆÙŠØ¶ Ù…Ø¹ Ù‚ÙŠØ¯ Ù…Ø­Ø§Ø³Ø¨ÙŠ
          </label>
          <label class="modal-choice">
            <input type="radio" name="accountingOption" value="no_journal" />
            ğŸš« Ø¥Ù‚ÙØ§Ù„ Ø§Ù„ØªÙÙˆÙŠØ¶ Ø¨Ø¯ÙˆÙ† Ù‚ÙŠØ¯ Ù…Ø­Ø§Ø³Ø¨ÙŠ
          </label>
        </div>
      </div>

      <div class="modal-footer">
        <button type="button" class="modal-btn cancel" onclick="cancelCloseModal()">Ø¥Ù„ØºØ§Ø¡</button>
        <button type="button" id="confirmCloseBtn" class="modal-btn confirm" onclick="confirmCloseAuthorization()">
          âœ… ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø¥Ù‚ÙØ§Ù„
        </button>
      </div>
    </div>
  </div>

  <script>
    let allAuthorizations = [];
    let filteredAuthorizations = [];
    let pendingCloseAuth = null;

    // Ù†Ø³ØªØ®Ø¯Ù…Ù‡Ø§ Ø¯Ø§Ø®Ù„ Ø§Ù„Ù…ÙˆØ¯Ø§Ù„ Ù„Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ø­Ø³Ø§Ø¨ Ø¹Ù†Ø¯ ØªØºÙŠÙŠØ± end_date
    let pendingModalCalc = {
      baseStartDate: null,     // Date (Ø¨Ø¯ÙˆÙ† ÙˆÙ‚Øª)
      dailyRentNum: null,      // Number
      originalEndDate: null,   // "YYYY-MM-DD"
      computedDays: null,
      computedPlannedAmount: null
    };

    document.addEventListener("DOMContentLoaded", () => {
      loadActiveAuthorizations();
    });

    function parseDateTime(str) {
      if (!str) return null;
      try {
        if (str.includes("T")) return new Date(str);
        return new Date(str.replace(" ", "T"));
      } catch {
        return null;
      }
    }

    function formatDateShort(str) {
      if (!str) return "â€”";
      const d = parseDateTime(str);
      if (!d || isNaN(d.getTime())) return str;
      const yyyy = d.getFullYear();
      const mm = String(d.getMonth() + 1).padStart(2, "0");
      const dd = String(d.getDate()).padStart(2, "0");
      return `${yyyy}-${mm}-${dd}`;
    }

    function dateOnly(d) {
      return new Date(d.getFullYear(), d.getMonth(), d.getDate());
    }

    function showStatus(message, isError = false) {
      const bar = document.getElementById("statusBar");
      if (!message) { bar.style.display = "none"; return; }
      bar.innerHTML = message;
      bar.className = "status-bar " + (isError ? "err" : "ok");
      bar.style.display = "block";
    }

    async function loadActiveAuthorizations() {
      showStatus("Ø¬Ø§Ø±Ù ØªØ­Ù…ÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„ØªÙÙˆÙŠØ¶Ø§Øª Ø§Ù„Ù†Ø´Ø·Ø©...", false);
      document.getElementById("cardsContainer").innerHTML = "";
      document.getElementById("tableBody").innerHTML = "";

      try {
        const res = await fetch("/api/authorizations?status=active");
        if (!res.ok) throw new Error("HTTP " + res.status);
        const data = await res.json();

        allAuthorizations = Array.isArray(data) ? data : [];
        filteredAuthorizations = [...allAuthorizations];

        document.getElementById("activeCount").textContent = allAuthorizations.length;
        refreshViews();

        if (allAuthorizations.length === 0) {
          document.getElementById("emptyState").style.display = "block";
          showStatus("Ù„Ø§ ØªÙˆØ¬Ø¯ ØªÙÙˆÙŠØ¶Ø§Øª Ù†Ø´Ø·Ø© Ø­Ø§Ù„ÙŠÙ‹Ø§.", false);
        } else {
          document.getElementById("emptyState").style.display = "none";
          showStatus(`ØªÙ… ØªØ­Ù…ÙŠÙ„ ${allAuthorizations.length} ØªÙÙˆÙŠØ¶ Ù†Ø´Ø·.`, false);
        }
      } catch (err) {
        console.error(err);
        showStatus("ØªØ¹Ø°Ø± ØªØ­Ù…ÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„ØªÙÙˆÙŠØ¶Ø§Øª Ø§Ù„Ù†Ø´Ø·Ø©. ØªØ£ÙƒØ¯ Ù…Ù† Ø£Ù† Ø§Ù„Ø®Ø§Ø¯Ù… ÙŠØ¹Ù…Ù„.", true);
        document.getElementById("emptyState").style.display = "block";
      }
    }

    function enrichAndSort(list) {
      const now = new Date();
      const enriched = (list || []).map(a => {
        const issueDt = parseDateTime(a.issue_date);
        const startDt = parseDateTime(a.start_date);
        const plannedEndStr = a.end_date || a.planned_end_date || "";
        const plannedEndDt = parseDateTime(plannedEndStr);

        let isOverdue = false;
        let overdueDays = 0;

        if (plannedEndDt && now > plannedEndDt) {
          isOverdue = true;
          const diffMs = now.getTime() - plannedEndDt.getTime();
          overdueDays = Math.floor(diffMs / (1000 * 60 * 60 * 24));
          if (overdueDays < 0) overdueDays = 0;
        }

        return { raw: a, issueDt, startDt, plannedEndDt, isOverdue, overdueDays };
      });

      enriched.sort((x, y) => {
        if (x.isOverdue && !y.isOverdue) return -1;
        if (!x.isOverdue && y.isOverdue) return 1;
        if (x.isOverdue && y.isOverdue) return y.overdueDays - x.overdueDays;
        if (x.plannedEndDt && y.plannedEndDt) return x.plannedEndDt - y.plannedEndDt;
        return 0;
      });

      return enriched;
    }

    function refreshViews() {
      const enriched = enrichAndSort(filteredAuthorizations);
      renderCards(enriched);
      renderTable(enriched);
    }

    function renderCards(enrichedList) {
      const container = document.getElementById("cardsContainer");
      container.innerHTML = "";
      if (!enrichedList || enrichedList.length === 0) return;

      enrichedList.forEach(item => {
        const a = item.raw;
        const isOverdue = item.isOverdue;
        const overdueDays = item.overdueDays;

        const card = document.createElement("article");
        card.className = "card" + (isOverdue ? " card-overdue" : "");

        const issueDate = a.issue_date || "";
        const startDate = a.start_date ? a.start_date.replace("T", " ").slice(0,19) : "";
        const plannedEnd = (a.end_date || a.planned_end_date || "");
        const dailyRent = a.daily_rent != null ? `${a.daily_rent} Ø±.Ø³/ÙŠÙˆÙ…` : "ØºÙŠØ± Ù…Ø­Ø¯Ø¯";
        const days = a.rental_days != null ? `${a.rental_days} ÙŠÙˆÙ…` : "â€”";

        let plannedAmount = "â€”";
        if (a.planned_amount != null) {
          const val = typeof a.planned_amount === "number" ? a.planned_amount.toFixed(2) : a.planned_amount;
          plannedAmount = `${val} Ø±.Ø³`;
        }

        const statusClass = "status-pill" + (isOverdue ? " overdue" : "");
        const durationClass = "value" + (isOverdue ? " value-overdue" : "");

        card.innerHTML = `
          <div class="card-header-line">
            <h3 class="card-title">
              <span class="pill-id">#${a.id}</span>
              <span>${a.car_number || "Ø¨Ø¯ÙˆÙ† Ø±Ù‚Ù…"} â€” ${(a.car_model || "")} ${(a.car_type || "")}</span>
            </h3>
            <span class="${statusClass}">${isOverdue ? "Ù…Ø¤Ø¬Ø±Ø© â€” Ù…ØªØ¬Ø§ÙˆØ²Ø© Ù…Ø¯Ø© Ø§Ù„Ø£Ø³Ø¨ÙˆØ¹" : "Ù…Ø¤Ø¬Ø±Ø©"}</span>
          </div>

          <div class="row">
            <span><span class="label">Ø§Ù„Ø³Ø§Ø¦Ù‚:</span><span class="value">${a.driver_name || "â€”"}</span></span>
            <span><span class="label">Ø±Ø®ØµØ©:</span><span class="value">${a.driver_license_no || "â€”"}</span></span>
          </div>

          <div class="row"><span><span class="label">ØªØ§Ø±ÙŠØ® Ø§Ù„Ø¥ØµØ¯Ø§Ø±:</span><span class="value">${issueDate}</span></span></div>
          <div class="row"><span><span class="label">Ø¨Ø¯Ø§ÙŠØ© Ø§Ù„ØªÙÙˆÙŠØ¶:</span><span class="value">${startDate || "â€”"}</span></span></div>
          <div class="row"><span><span class="label">Ù†Ù‡Ø§ÙŠØ© Ø§Ù„ØªÙÙˆÙŠØ¶:</span><span class="value">${plannedEnd || "â€”"}</span></span></div>

          <div class="row">
            <span><span class="label">Ø§Ù„Ø¥ÙŠØ¬Ø§Ø± Ø§Ù„ÙŠÙˆÙ…ÙŠ:</span><span class="value">${dailyRent}</span></span>
            <span><span class="label">Ø¹Ø¯Ø¯ Ø§Ù„Ø£ÙŠØ§Ù…:</span><span class="${durationClass}">${days}</span></span>
          </div>

          ${
            isOverdue
              ? `
              <div class="row">
                <span class="label">ğŸ”´ Ø£ÙŠØ§Ù… Ø§Ù„ØªØ£Ø®ÙŠØ± Ø¨Ø¹Ø¯ Ø§Ù„Ù†Ù‡Ø§ÙŠØ©:</span>
                <span class="value-overdue">${overdueDays} ÙŠÙˆÙ…</span>
              </div>
              <div class="overdue-text">Ù‡Ø°Ø§ Ø§Ù„ØªÙÙˆÙŠØ¶ ØªØ¬Ø§ÙˆØ² Ù…Ø¯Ø© Ø§Ù„Ø£Ø³Ø¨ÙˆØ¹ ÙˆÙ„Ù… ÙŠØªÙ… Ø¥Ù‚ÙØ§Ù„Ù‡ Ø¨Ø¹Ø¯.</div>
              `
              : ""
          }

          <div class="row" style="margin-top:4px;">
            <span class="label">Ù‚ÙŠÙ…Ø© Ø§Ù„Ø£ÙŠØ§Ù… Ø§Ù„Ù…Ø®Ø·Ø·Ø© ØªÙ‚Ø±ÙŠØ¨Ù‹Ø§:</span>
            <span class="value-strong">${plannedAmount}</span>
          </div>

          <div class="divider"></div>

          <div class="row"><span class="label">Ù…Ù„Ø§Ø­Ø¸Ø§Øª:</span></div>
          <div class="row"><span class="value">${a.details || "Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ù„Ø§Ø­Ø¸Ø§Øª Ù…Ø³Ø¬Ù„Ø©."}</span></div>

          <div class="divider"></div>

          <div class="actions-row">
            <button class="btn-sm-primary" onclick="openReceipt(${a.id})">ğŸ§¾ Ø³Ù†Ø¯ ØªØ­ØµÙŠÙ„</button>
            <button class="btn-sm-danger" onclick="endAuthorization(${a.id}, this)">âœ… Ø¥Ù†Ù‡Ø§Ø¡ Ø§Ù„ØªÙÙˆÙŠØ¶</button>
          </div>
        `;

        container.appendChild(card);
      });
    }

    function renderTable(enrichedList) {
      const tbody = document.getElementById("tableBody");
      tbody.innerHTML = "";
      if (!enrichedList || enrichedList.length === 0) return;

      enrichedList.forEach(item => {
        const a = item.raw;
        const isOverdue = item.isOverdue;
        const overdueDays = item.overdueDays;

        const tr = document.createElement("tr");
        if (isOverdue) tr.classList.add("row-overdue");

        const issueDate = a.issue_date || "";
        const startDate = a.start_date ? a.start_date.replace("T", " ").slice(0,19) : "";
        const plannedEnd = (a.end_date || a.planned_end_date || "");
        const days = a.rental_days != null ? a.rental_days : "â€”";
        const dailyRent = a.daily_rent != null ? a.daily_rent : "â€”";

        let plannedAmount = "â€”";
        if (a.planned_amount != null) {
          plannedAmount = typeof a.planned_amount === "number" ? a.planned_amount.toFixed(2) : a.planned_amount;
        }

        tr.innerHTML = `
          <td class="col-id">${a.id}</td>
          <td class="col-car">
            ${a.car_number || "â€”"}<br/>
            <span class="label">${(a.car_model || "")} ${(a.car_type || "")}</span>
          </td>
          <td class="col-driver">${a.driver_name || "â€”"}</td>
          <td class="col-license">${a.driver_license_no || "â€”"}</td>
          <td class="col-issue">${issueDate}</td>
          <td class="col-start">${startDate || "â€”"}</td>
          <td class="col-end">${plannedEnd || "â€”"}</td>
          <td class="col-days ${isOverdue ? "td-overdue" : ""}">${days}</td>
          <td class="col-delay ${isOverdue ? "td-overdue" : ""}">${isOverdue ? overdueDays : "0"}</td>
          <td class="col-rent">${dailyRent !== "â€”" ? dailyRent + " Ø±.Ø³/ÙŠÙˆÙ…" : "ØºÙŠØ± Ù…Ø­Ø¯Ø¯"}</td>
          <td class="col-week td-amount">${plannedAmount !== "â€”" ? plannedAmount + " Ø±.Ø³" : "â€”"}</td>
          <td class="col-actions">
            <div class="td-actions">
              <button class="btn-sm-primary" onclick="openReceipt(${a.id})">ğŸ§¾</button>
              <button class="btn-sm-danger" onclick="endAuthorization(${a.id}, this)">âœ…</button>
            </div>
          </td>
        `;

        tbody.appendChild(tr);
      });
    }

    function applyFilter() {
      const term = (document.getElementById("searchInput").value || "").trim().toLowerCase();
      if (!term) {
        filteredAuthorizations = [...allAuthorizations];
      } else {
        filteredAuthorizations = allAuthorizations.filter(a => {
          const driver = (a.driver_name || "").toLowerCase();
          const car = (a.car_number || "").toLowerCase();
          const license = (a.driver_license_no || "").toLowerCase();
          return driver.includes(term) || car.includes(term) || license.includes(term);
        });
      }
      refreshViews();
    }

    function openReceipt(authId) {
      if (!authId) return;
      window.location.href = `/receipt?authorization_id=${authId}`;
    }

    function endAuthorization(authId) {
      const auth = allAuthorizations.find(a => String(a.id) === String(authId));
      if (!auth) { alert("Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø¨ÙŠØ§Ù†Ø§Øª Ù‡Ø°Ø§ Ø§Ù„ØªÙÙˆÙŠØ¶."); return; }

      pendingCloseAuth = auth;

      const carInfo = `${auth.car_number || "Ø¨Ø¯ÙˆÙ† Ø±Ù‚Ù…"} â€” ${(auth.car_model || "")} ${(auth.car_type || "")}`.trim();

      const periodStart = formatDateShort(auth.start_date || auth.issue_date);
      const periodEnd = formatDateShort(auth.end_date || auth.planned_end_date);

      // ØªØ­Ø¶ÙŠØ± Ø£Ø³Ø§Ø³ Ø§Ù„Ø­Ø³Ø§Ø¨
      const baseStart = parseDateTime(auth.start_date || auth.issue_date);
      const dailyRentNum = auth.daily_rent != null ? Number(auth.daily_rent) : null;

      pendingModalCalc.baseStartDate = baseStart ? dateOnly(baseStart) : null;
      pendingModalCalc.dailyRentNum = (dailyRentNum != null && !Number.isNaN(dailyRentNum)) ? dailyRentNum : null;
      pendingModalCalc.originalEndDate = (periodEnd && periodEnd !== "â€”") ? periodEnd : "";

      // ØªØ¹Ø¨Ø¦Ø© Ø¨ÙŠØ§Ù†Ø§Øª Ø«Ø§Ø¨ØªØ©
      document.getElementById("modalAuthId").textContent = `#${auth.id}`;
      document.getElementById("modalCarInfo").textContent = carInfo || "â€”";
      document.getElementById("modalDriverName").textContent = auth.driver_name || "â€”";
      document.getElementById("modalDriverLicense").textContent = auth.driver_license_no || "â€”";

      document.getElementById("modalDailyRent").textContent =
        pendingModalCalc.dailyRentNum != null ? `${pendingModalCalc.dailyRentNum} Ø±.Ø³/ÙŠÙˆÙ…` : "ØºÙŠØ± Ù…Ø­Ø¯Ø¯";

      // âœ… NEW: ØªØ§Ø±ÙŠØ® Ù†Ù‡Ø§ÙŠØ© Ø§Ù„ØªÙÙˆÙŠØ¶ Ø¯Ø§Ø®Ù„ Ø§Ù„Ù…ÙˆØ¯Ø§Ù„
      const endDateInput = document.getElementById("closeEndDateInput");
      endDateInput.value = pendingModalCalc.originalEndDate || "";
      document.getElementById("endDateChangedHint").style.display = "none";

      // Ø¹Ù†Ø¯ ØªØºÙŠÙŠØ± end_date: Ù†Ø¹ÙŠØ¯ Ø§Ù„Ø­Ø³Ø§Ø¨ ÙˆÙ†Ø­Ø¯Ù‘Ø« Ø§Ù„Ø¹Ø±Ø¶
      endDateInput.oninput = () => {
        const changed = (endDateInput.value || "").trim() !== (pendingModalCalc.originalEndDate || "").trim();
        document.getElementById("endDateChangedHint").style.display = changed ? "block" : "none";
        recalcModalFigures();
      };

      // Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ø­Ø³Ø§Ø¨ Ù…Ø±Ø© Ø£ÙˆÙ„Ù‰ Ø¨Ù†Ø§Ø¡Ù‹ Ø¹Ù„Ù‰ Ø§Ù„ØªØ§Ø±ÙŠØ® Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠ
      recalcModalFigures();

      // Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠ Ù„Ù„Ø¥Ù‚ÙØ§Ù„ (Ù…Ù† plannedAmount Ø§Ù„Ù…Ø­Ø³ÙˆØ¨)
      const closeAmountInput = document.getElementById("closeAmountInput");
      const closeNoteInput = document.getElementById("closeNoteInput");

      const defaultAmount =
        auth.closed_amount != null
          ? Number(auth.closed_amount)
          : (pendingModalCalc.computedPlannedAmount != null ? Number(pendingModalCalc.computedPlannedAmount) : 0);

      closeAmountInput.value = (defaultAmount && !Number.isNaN(defaultAmount)) ? defaultAmount.toFixed(2) : "";

      closeNoteInput.value =
        auth.closing_note ||
        `Ø¥Ù‚ÙØ§Ù„ ØªÙÙˆÙŠØ¶ Ø±Ù‚Ù… ${auth.id} Ù„Ù„Ø³ÙŠØ§Ø±Ø© ${auth.car_number || ""} Ø¹Ù† Ø§Ù„ÙØªØ±Ø© Ù…Ù† ${periodStart} Ø¥Ù„Ù‰ ${endDateInput.value || periodEnd}`;

      // Ø§Ù„Ø§ÙØªØ±Ø§Ø¶Ø§Øª
      document.querySelectorAll('input[name="renewOption"]').forEach(r => r.checked = (r.value === "renew"));
      document.querySelectorAll('input[name="accountingOption"]').forEach(r => r.checked = (r.value === "with_journal"));

      document.getElementById("closeModalOverlay").style.display = "flex";
      closeAmountInput.focus();
    }

    function recalcModalFigures() {
      if (!pendingCloseAuth) return;

      const endDateStr = (document.getElementById("closeEndDateInput").value || "").trim();
      const baseStartDate = pendingModalCalc.baseStartDate;
      const dailyRentNum = pendingModalCalc.dailyRentNum;

      let days = null;
      let plannedAmount = null;

      if (baseStartDate && endDateStr && dailyRentNum != null) {
        // endDateStr = YYYY-MM-DD
        const [y, m, d] = endDateStr.split("-").map(Number);
        const endDate = new Date(y, (m - 1), d);
        const diffDays = Math.round((dateOnly(endDate) - dateOnly(baseStartDate)) / (1000*60*60*24)) + 1;
        days = diffDays < 0 ? 0 : diffDays;
        plannedAmount = days * dailyRentNum;
      } else {
        // fallback Ù„Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¬Ø§Ù‡Ø²Ø© Ù…Ù† Ø§Ù„Ø³ÙŠØ±ÙØ±
        days = pendingCloseAuth.rental_days != null ? pendingCloseAuth.rental_days : null;
        plannedAmount = pendingCloseAuth.planned_amount != null ? Number(pendingCloseAuth.planned_amount) : null;
      }

      pendingModalCalc.computedDays = days;
      pendingModalCalc.computedPlannedAmount = plannedAmount;

      const periodStart = formatDateShort(pendingCloseAuth.start_date || pendingCloseAuth.issue_date);
      const periodEnd = endDateStr || formatDateShort(pendingCloseAuth.end_date || pendingCloseAuth.planned_end_date);

      document.getElementById("modalPeriod").textContent =
        (periodStart && periodEnd && periodStart !== "â€”" && periodEnd !== "â€”")
          ? `Ù…Ù† ${periodStart} Ø¥Ù„Ù‰ ${periodEnd} (${days != null ? days + " ÙŠÙˆÙ…" : "â€”"})`
          : "â€”";

      document.getElementById("modalPlannedAmount").textContent =
        (plannedAmount != null && !Number.isNaN(plannedAmount))
          ? `${Number(plannedAmount).toFixed(2)} Ø±.Ø³`
          : "â€”";
    }

    function cancelCloseModal() {
      pendingCloseAuth = null;
      document.getElementById("closeModalOverlay").style.display = "none";
      const btn = document.getElementById("confirmCloseBtn");
      btn.disabled = false;
      btn.textContent = "âœ… ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø¥Ù‚ÙØ§Ù„";
    }

    async function confirmCloseAuthorization() {
      if (!pendingCloseAuth) { alert("Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¹Ù…Ù„ÙŠØ© Ø¥Ù‚ÙØ§Ù„ Ø¬Ø§Ø±ÙŠØ©."); return; }

      const btn = document.getElementById("confirmCloseBtn");
      const amountInput = document.getElementById("closeAmountInput");
      const noteInput = document.getElementById("closeNoteInput");
      const endDateInput = document.getElementById("closeEndDateInput");

      const amountStr = (amountInput.value || "").trim();
      if (!amountStr) { alert("Ù…Ù† ÙØ¶Ù„Ùƒ Ø£Ø¯Ø®Ù„ Ù‚ÙŠÙ…Ø© Ø§Ù„ØªÙÙˆÙŠØ¶ Ø¹Ù†Ø¯ Ø§Ù„Ø¥Ù‚ÙØ§Ù„."); amountInput.focus(); return; }

      const amountNum = Number(amountStr);
      if (Number.isNaN(amountNum) || amountNum < 0) { alert("Ù‚ÙŠÙ…Ø© Ø§Ù„ØªÙÙˆÙŠØ¶ Ø¹Ù†Ø¯ Ø§Ù„Ø¥Ù‚ÙØ§Ù„ ØºÙŠØ± ØµØ­ÙŠØ­Ø©."); amountInput.focus(); return; }

      const noteStr = (noteInput.value || "").trim();

      // renew
      let localRenew = true;
      document.querySelectorAll('input[name="renewOption"]').forEach(r => {
        if (r.checked && r.value === "no_renew") localRenew = false;
      });

      // accounting
      let withJournal = true;
      document.querySelectorAll('input[name="accountingOption"]').forEach(r => {
        if (r.checked && r.value === "no_journal") withJournal = false;
      });

      const overrideEndDate = (endDateInput.value || "").trim(); // YYYY-MM-DD

      const confirmText =
        `ØªØ£ÙƒÙŠØ¯ Ø¥Ù‚ÙØ§Ù„ Ø§Ù„ØªÙÙˆÙŠØ¶ØŸ\n` +
        `- Ø§Ù„Ù…Ø¨Ù„Øº: ${amountNum.toFixed(2)}\n` +
        `- ${withJournal ? "Ù…Ø¹ Ù‚ÙŠØ¯ Ù…Ø­Ø§Ø³Ø¨ÙŠ" : "Ø¨Ø¯ÙˆÙ† Ù‚ÙŠØ¯ Ù…Ø­Ø§Ø³Ø¨ÙŠ (Ø³ÙŠØªÙ… ØªÙ…ÙŠÙŠØ² Ø§Ù„ØªÙÙˆÙŠØ¶)"}\n` +
        `- ${localRenew ? "Ù…Ø¹ ØªØ¬Ø¯ÙŠØ¯ Ø£Ø³Ø¨ÙˆØ¹ Ø¬Ø¯ÙŠØ¯" : "Ø¨Ø¯ÙˆÙ† ØªØ¬Ø¯ÙŠØ¯"}\n` +
        (overrideEndDate ? `- Ù†Ù‡Ø§ÙŠØ© Ø§Ù„ØªÙÙˆÙŠØ¶: ${overrideEndDate}\n` : "");

      if (!window.confirm(confirmText)) return;

      try {
        btn.disabled = true;
        btn.textContent = "Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø¥Ù‚ÙØ§Ù„...";

        showStatus(
          withJournal
            ? "Ø¬Ø§Ø±Ù Ø¥Ù‚ÙØ§Ù„ Ø§Ù„ØªÙÙˆÙŠØ¶ ÙˆØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ù‚ÙŠØ¯ (Ø¥Ù† ÙˆÙØ¬Ø¯)..."
            : "Ø¬Ø§Ø±Ù Ø¥Ù‚ÙØ§Ù„ Ø§Ù„ØªÙÙˆÙŠØ¶ Ø¨Ø¯ÙˆÙ† ØªØ³Ø¬ÙŠÙ„ Ù‚ÙŠØ¯ (Ø³ÙŠØªÙ… ØªÙ…ÙŠÙŠØ²Ù‡)...",
          false
        );

        const payload = {
          closed_amount: amountNum,
          closing_note: noteStr,
          renew: localRenew,
          with_journal: withJournal,
          end_date_override: overrideEndDate || null,  // âœ… NEW
        };

        const res = await fetch(`/api/authorizations/${pendingCloseAuth.id}/end`, {
          method: "PATCH",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(payload)
        });

        let data = {};
        try { data = await res.json(); } catch (_) {}

        if (!res.ok) {
          const msg = data.error || `Ù„Ù… ÙŠØªÙ… Ø¥Ù‚ÙØ§Ù„ Ø§Ù„ØªÙÙˆÙŠØ¶ (HTTP ${res.status})`;
          showStatus(msg, true);
          btn.disabled = false;
          btn.textContent = "âœ… ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø¥Ù‚ÙØ§Ù„";
          return;
        }

        const serverRenew = typeof data.renew === "boolean" ? data.renew : localRenew;
        const serverWithJournal = typeof data.with_journal === "boolean" ? data.with_journal : withJournal;

        allAuthorizations = allAuthorizations.filter(a => String(a.id) !== String(pendingCloseAuth.id));

        const newAuth = data.new_authorization;
        if (serverRenew && newAuth && !newAuth.close_date) allAuthorizations.push(newAuth);

        applyFilter();
        document.getElementById("activeCount").textContent = allAuthorizations.length;
        document.getElementById("emptyState").style.display = allAuthorizations.length === 0 ? "block" : "none";

        const closedAuthId = (data.closed_authorization && data.closed_authorization.id) || pendingCloseAuth.id;

        let opsLinkHtml = "";
        if (serverWithJournal) {
          opsLinkHtml = `<a href="/operations?type=auth_close&auth_id=${closedAuthId}"
            style="margin-right:8px;color:#1d4ed8;text-decoration:underline;font-weight:600;">
            ğŸ“„ Ø¹Ø±Ø¶ Ø§Ù„Ù‚ÙŠØ¯ ÙÙŠ Ø§Ù„Ø¹Ù…Ù„ÙŠØ§Øª
          </a>`;
        }

        // âœ… Ù„Ùˆ Ø§ØªÙ‚ÙÙ„ Ø¨Ø¯ÙˆÙ† Ù‚ÙŠØ¯: Ù†ÙˆØ¶Ø­ Ø¯Ù‡
        const closedWithout = !!data.closed_without_journal;

        const msg = `
          âœ… ØªÙ… Ø¥Ù‚ÙØ§Ù„ Ø§Ù„ØªÙÙˆÙŠØ¶ Ø¨Ù†Ø¬Ø§Ø­.
          ${closedWithout ? "<br><b style='color:#b45309'>âš ï¸ ØªÙ… Ø§Ù„Ø¥Ù‚ÙØ§Ù„ Ø¨Ø¯ÙˆÙ† Ù‚ÙŠØ¯ Ù…Ø­Ø§Ø³Ø¨ÙŠ (Ø³ÙŠØ¸Ù‡Ø± Ø¨Ø¹Ù„Ø§Ù…Ø© ÙÙŠ ØµÙØ­Ø© Ø§Ù„Ù…ØºÙ„Ù‚).</b>" : ""}
          ${opsLinkHtml ? "<br>" + opsLinkHtml : ""}
        `;

        cancelCloseModal();
        showStatus(msg, false);

      } catch (err) {
        console.error(err);
        showStatus("ØªØ¹Ø°Ø± Ø¥Ù‚ÙØ§Ù„ Ø§Ù„ØªÙÙˆÙŠØ¶. ØªØ£ÙƒØ¯ Ù…Ù† Ø£Ù† Ø§Ù„Ø®Ø§Ø¯Ù… ÙŠØ¹Ù…Ù„ Ø«Ù… Ø£Ø¹Ø¯ Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø©.", true);
        btn.disabled = false;
        btn.textContent = "âœ… ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø¥Ù‚ÙØ§Ù„";
      }
    }
  </script>

  <script>
    document.addEventListener('contextmenu', function (e) { e.preventDefault(); });
    document.addEventListener('keydown', function (e) {
      if (e.key === "F12") e.preventDefault();
      if ((e.ctrlKey && e.shiftKey && (e.key === 'I' || e.key === 'J')) || (e.ctrlKey && e.key === 'U')) {
        e.preventDefault();
      }
    });
  </script>
</body>
</html>
