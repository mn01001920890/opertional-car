<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>ğŸ“œ Ø¹Ø±Ø¶ Ø§Ù„ØªÙÙˆÙŠØ¶Ø§Øª</title>
  <style>
    body{font-family:"Tajawal",sans-serif;background:linear-gradient(135deg,#0d6efd,#6c63ff);margin:0;padding:20px;color:#fff}
    h2{text-align:center;margin-bottom:20px;color:#fff;font-size:26px}
    .card{background:#fff;color:#333;padding:15px;margin-bottom:15px;border-radius:14px;box-shadow:0 4px 15px rgba(0,0,0,.25);animation:fadeIn .4s ease-in-out}
    @keyframes fadeIn{from{opacity:0;transform:translateY(10px)}to{opacity:1;transform:translateY(0)}}
    .row{margin:5px 0;font-size:15px}
    .label{font-weight:bold;color:#0d6efd}
    .btn{width:100%;padding:12px;border:none;border-radius:10px;background:#fff;color:#0d6efd;font-size:16px;font-weight:bold;margin-top:10px;box-shadow:0 4px 10px rgba(0,0,0,.3);transition:.3s;cursor:pointer}
    .btn:hover{background:#0d6efd;color:#fff;transform:scale(1.05)}
    .btn.end{background:#dc3545;color:#fff}
    .btn.end:hover{opacity:.9}
    a.link{color:#0d6efd;text-decoration:underline}
  </style>
</head>
<body>
  <h2>ğŸ“œ Ø¹Ø±Ø¶ Ø¬Ù…ÙŠØ¹ Ø§Ù„ØªÙÙˆÙŠØ¶Ø§Øª</h2>
  <div id="list"></div>
  <button class="btn" onclick="location.href='/'">ğŸ  Ø§Ù„Ø±Ø¬ÙˆØ¹ Ù„Ù„ØµÙØ­Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</button>

  <script>
    async function loadData(){
      const container=document.getElementById("list");
      container.innerHTML="<p style='text-align:center'>â³ Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...</p>";
      try{
        const res=await fetch("/api/authorizations");
        const data=await res.json();
        if(!Array.isArray(data)){container.innerHTML="<p>âš ï¸ Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø¨ÙŠØ§Ù†Ø§Øª.</p>";return;}
        container.innerHTML=data.map(item=>{
          const open=!item.end_date; // ØªÙÙˆÙŠØ¶ Ù…ÙØªÙˆØ­
          const driverLink=`/drivers#q=${encodeURIComponent(item.driver_name||"")}`;
          const carLink=`/cars#q=${encodeURIComponent(item.car_number||"")}`;
          return `
            <div class="card">
              <div class="row"><span class="label">Ø§Ù„Ø³Ø§Ø¦Ù‚:</span> <a class="link" href="${driverLink}">${item.driver_name}</a></div>
              <div class="row"><span class="label">Ø±Ù‚Ù… Ø§Ù„Ø³ÙŠØ§Ø±Ø©:</span> <a class="link" href="${carLink}">${item.car_number}</a></div>
              <div class="row"><span class="label">Ø§Ù„Ù…ÙˆØ¯ÙŠÙ„:</span> ${item.car_model||"â€”"}</div>
              <div class="row"><span class="label">Ø§Ù„Ù†ÙˆØ¹:</span> ${item.car_type||"â€”"}</div>
              <div class="row"><span class="label">Ø§Ù„Ø¨Ø¯Ø§ÙŠØ©:</span> ${item.start_date||"â€”"}</div>
              <div class="row"><span class="label">Ø§Ù„Ø¥ÙŠØ¬Ø§Ø± Ø§Ù„ÙŠÙˆÙ…ÙŠ:</span> ${item.daily_rent} Ø±ÙŠØ§Ù„</div>
              <div class="row"><span class="label">Ø§Ù„Ø­Ø§Ù„Ø©:</span> ${item.status||"â€”"}</div>
              <div class="row"><span class="label">Ø§Ù„Ø¨ÙŠØ§Ù†:</span> ${item.details||"â€”"}</div>
              <div class="row"><span class="label">ØªØ§Ø±ÙŠØ® Ø§Ù„Ø¥ØµØ¯Ø§Ø±:</span> ${item.issue_date||"â€”"}</div>
              <div class="row"><span class="label">ØªØ§Ø±ÙŠØ® Ø§Ù„Ø§Ù†ØªÙ‡Ø§Ø¡:</span> ${item.end_date||"â€”"}</div>
              ${open ? `<button class="btn end" onclick="endAuth(${item.id})">ğŸ›‘ Ø¥Ù†Ù‡Ø§Ø¡ Ø§Ù„ØªÙÙˆÙŠØ¶</button>` : ``}
            </div>
          `;
        }).join("");
        // ØªÙ…Ø±ÙŠØ± Ø§Ù„Ù‡Ø§Ø´ Ù„Ù„Ø¨Ø­Ø« Ø§Ù„Ø³Ø±ÙŠØ¹ Ø¨Ø§Ù„ØµÙØ­Ø§Øª Ø§Ù„Ø£Ø®Ø±Ù‰ (Ø³ÙŠÙÙØ¹Ù‘Ù„ Ù„Ø§Ø­Ù‚Ø§Ù‹ Ø¯Ø§Ø®Ù„ drivers.html / cars.html)
      }catch(err){
        console.error(err);
        container.innerHTML="<p>âŒ Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„ØªØ­Ù…ÙŠÙ„.</p>";
      }
    }

    async function endAuth(id){
      if(!confirm("ØªØ£ÙƒÙŠØ¯ Ø¥Ù†Ù‡Ø§Ø¡ Ø§Ù„ØªÙÙˆÙŠØ¶ØŸ")) return;
      const res = await fetch(`/api/authorizations/${id}/end`, {method:"PATCH"});
      if(res.ok){ loadData(); }
      else{
        const data = await res.json().catch(()=>({}));
        alert("âŒ Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¥Ù†Ù‡Ø§Ø¡: " + (data.error || "Ø®Ø·Ø£ ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ"));
      }
    }

    loadData();
  </script>
</body>
</html>
